<properties
   pageTitle="Αξιόπιστη συλλογές | Microsoft Azure"
   description="Υπηρεσίες κατάστασης υπηρεσίας δομής παρέχουν αξιόπιστη συλλογές που σας επιτρέπουν να γράψετε εφαρμογές cloud ιδιαίτερα διαθέσιμο, μεταβλητού μεγέθους και χαμηλής αδράνειας."
   services="service-fabric"
   documentationCenter=".net"
   authors="mcoskun"
   manager="timlt"
   editor="masnider,vturecek"/>

<tags
   ms.service="service-fabric"
   ms.devlang="dotnet"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="required"
   ms.date="10/18/2016"
   ms.author="mcoskun"/>

# <a name="introduction-to-reliable-collections-in-azure-service-fabric-stateful-services"></a>Εισαγωγή στο αξιόπιστη συλλογές σε υπηρεσίες κατάστασης δομής υπηρεσίας Azure

Αξιόπιστη συλλογές σάς επιτρέπουν να γράψετε εφαρμογές ιδιαίτερα διαθέσιμο, μεταβλητού μεγέθους και χαμηλής αδράνειας cloud σαν να γράφετε εφαρμογές μόνο υπολογιστή. Οι κλάσεις στο χώρο ονομάτων **Microsoft.ServiceFabric.Data.Collections** παρέχουν ένα σύνολο συλλογές εκτός του πλαισίου που δημιουργείται αυτόματα την κατάσταση ιδιαίτερα διαθέσιμη. Οι προγραμματιστές πρέπει να πρόγραμμα μόνο για τα API συλλογής αξιόπιστη και σας επιτρέπουν να αξιόπιστη συλλογές διαχείριση της κατάστασης από αναπαραγωγή και τοπικές.

Το πλήκτρο διαφορά μεταξύ αξιόπιστη συλλογές και άλλες τεχνολογίες υψηλής διαθεσιμότητας (όπως Redis, την υπηρεσία πινάκων του Azure και υπηρεσία ουράς Azure) είναι ότι η κατάσταση διατηρείται τοπικά στην παρουσία υπηρεσίας ενώ επίσης είναι ιδιαίτερα διαθέσιμα. Αυτό σημαίνει ότι:

- Διαβάζει όλα είναι τοπικά, που έχει ως αποτέλεσμα χαμηλή λανθάνων χρόνος και διαβάζει υψηλής ταχύτητας μετάδοσης.
- Όλες οι εγγραφές αναλαμβάνει τον ελάχιστο αριθμό IOs δικτύου, με αποτέλεσμα την κατώτερη λανθάνων χρόνος και εγγράφει υψηλής ταχύτητας μετάδοσης.

![Εικόνα του εξέλιξη των συλλογών.](media/service-fabric-reliable-services-reliable-collections/ReliableCollectionsEvolution.png)

Μπορεί να θεωρηθεί αξιόπιστος συλλογές ως η φυσική εξέλιξη των κλάσεων **System.Collections** : ένα νέο σύνολο συλλογών που έχουν σχεδιαστεί για τις εφαρμογές cloud και πολλών υπολογιστή χωρίς να αυξήσετε πολυπλοκότητα για τον προγραμματιστή. Ως εκ τούτου, είναι αξιόπιστη συλλογές:

- Αναπαραγωγή: Κατάσταση αλλαγές αναπαράγονται για υψηλή διαθεσιμότητα.
- Μόνιμες: Διατηρηθεί δεδομένων στο δίσκο για διάρκεια ζωής σε σχέση με ευρείας κλίμακας ΡΕΥΜΑΤΟΣ (για παράδειγμα, ένα κέντρο δεδομένων ρεύματος).
- Ασύγχρονη: APIs είναι ασύγχρονης για να βεβαιωθείτε ότι δεν αποκλείονται νήματα όταν προκαλώντας εισόδου/ΕΞΌΔΟΥ.
- Συναλλαγές: APIs χρησιμοποιούν την άντληση συναλλαγές, ώστε να μπορείτε να διαχειριστείτε πολλές συλλογές αξιόπιστη μέσα σε μια υπηρεσία εύκολα.

Αξιόπιστη συλλογές παρέχουν ισχυρό συνέπειας εγγυάται από το πλαίσιο για να διευκολύνετε την λογικής σχετικά με την κατάσταση εφαρμογής.
Ισχυρός συνέπειας είναι δυνατό, εξασφαλίζοντας συναλλαγής δεσμεύσεις λήξης μόνο αφού έχει καταγραφεί στο μεγαλύτερο μέρος απαρτία αντίγραφα, συμπεριλαμβανομένων των κύριων ολόκληρη η συναλλαγή.
Για να επιτύχετε πιο ασθενείς συνέπειας, εφαρμογές μπορούν να αποδεχτείτε προς τον υπολογιστή-πελάτη/αιτούντα πριν από την ολοκλήρωση ασύγχρονης επιστρέφει.

Τα αξιόπιστη API συλλογές είναι την εξέλιξη των ταυτόχρονες συλλογών APIs (βρίσκονται στο χώρο ονομάτων **System.Collections.Concurrent** ):

- Ασύγχρονη: Επιστρέφει μια εργασία δεδομένου ότι, σε αντίθεση με ταυτόχρονες συλλογές, οι λειτουργίες είναι αναπαραχθούν και να διατηρηθεί.
- Παράμετροι εξόδου δεν: χρησιμοποιεί `ConditionalValue<T>` για να επιστρέψει μια δυαδική τιμή και μια τιμή αντί παράμετροι εξόδου. `ConditionalValue<T>`είναι σαν `Nullable<T>` , αλλά δεν απαιτεί T για να δομή.
- Συναλλαγές: Χρησιμοποιεί ένα αντικείμενο συναλλαγής για να ενεργοποιήσετε το χρήστη σε ομάδα ενέργειες σε πολλές συλλογές αξιόπιστη σε μια συναλλαγή.

Σήμερα, **Microsoft.ServiceFabric.Data.Collections** περιέχει δύο συλλογές:

- [Αξιόπιστη λεξικό](https://msdn.microsoft.com/library/azure/dn971511.aspx): αντιπροσωπεύει μια συλλογή από αναπαραγωγή συναλλαγών και ασύγχρονης ζεύγη κλειδιού/τιμής. Παρόμοια με **ConcurrentDictionary**, τον αριθμό-κλειδί και την τιμή που μπορεί να είναι οποιουδήποτε τύπου.
- [Αξιόπιστη ουρά](https://msdn.microsoft.com/library/azure/dn971527.aspx): αντιπροσωπεύει έναν από αναπαραγωγή συναλλαγών και ασύγχρονης αυστηρών του εισόδου (FIFO) ουρά. Παρόμοια με **ConcurrentQueue**, η τιμή μπορεί να είναι οποιουδήποτε τύπου.

## <a name="isolation-levels"></a>Επίπεδα απομόνωσης
Επίπεδο απομόνωσης ορίζει τον βαθμό στον οποίο η συναλλαγή πρέπει να απομόνωσης από τροποποιήσεις που έγιναν από άλλους συναλλαγές.
Υπάρχουν δύο επίπεδα απομόνωσης που υποστηρίζονται σε αξιόπιστη συλλογές:

- **Επαναλαμβανόμενη ανάγνωση**: Καθορίζει ότι προτάσεις δεν μπορεί να διαβάσει δεδομένων που έχει τροποποιηθεί αλλά δεν έχει ακόμα δεσμευτεί από άλλες συναλλαγές και ότι δεν υπάρχει άλλες συναλλαγές να τροποποιήσετε δεδομένα τα οποία έχει διαβαστεί από την τρέχουσα συναλλαγή μέχρι να ολοκληρωθεί η τρέχουσα συναλλαγή. Για περισσότερες λεπτομέρειες, ανατρέξτε στο θέμα [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).
- **Στιγμιότυπο**: Καθορίζει ότι τα δεδομένα που διαβάζονται από οποιαδήποτε δήλωση σε μια συναλλαγή θα την ενημερώσετε συνεπή έκδοση των δεδομένων που υπήρχαν κατά την έναρξη της κίνησης.
Η συναλλαγή μπορεί να αναγνωρίζουν μόνο τροποποιήσεις δεδομένων που έχουν ολοκληρωθεί πριν από την έναρξη της κίνησης.
Τροποποιήσεις δεδομένων που έγιναν από άλλους συναλλαγές μετά την έναρξη της τρέχουσας συναλλαγής δεν είναι ορατές σε δηλώσεις εκτέλεση στην τρέχουσα συναλλαγή.
Το αποτέλεσμα είναι σαν τις προτάσεις σε μια συναλλαγή λάβετε ένα στιγμιότυπο των δεδομένων δεσμευμένη μορφή που είχε κατά την έναρξη της κίνησης.
Τα στιγμιότυπα είναι συνεπείς σε αξιόπιστη συλλογές.
Για περισσότερες λεπτομέρειες, ανατρέξτε στο θέμα [https://msdn.microsoft.com/library/ms173763.aspx](https://msdn.microsoft.com/library/ms173763.aspx).

Αξιόπιστη συλλογές επιλέξτε αυτόματα το επίπεδο απομόνωσης για να χρησιμοποιήσετε για μια δεδομένη λειτουργία ανάγνωσης ανάλογα με τη λειτουργία και του ρόλου των στη ρεπλίκα κατά τη δημιουργία της συναλλαγής του.
Ακολουθεί ο πίνακας που απεικονίζει προεπιλογών επιπέδου απομόνωσης για λειτουργίες αξιόπιστη λεξικό και ουρά.

| Η λειτουργία \ ρόλων      | Κύρια          | Δευτερεύον        |
| --------------------- | :--------------- | :--------------- |
| Ανάγνωση μόνο οντότητα    | Επαναλαμβανόμενη ανάγνωση  | Στιγμιότυπο         |
| Απαρίθμηση \ Count   | Στιγμιότυπο         | Στιγμιότυπο         |

>[AZURE.NOTE] Είναι συνηθισμένα παραδείγματα για μία μόνο οντότητα λειτουργίες `IReliableDictionary.TryGetValueAsync`, `IReliableQueue.TryPeekAsync`.

Το λεξικό αξιόπιστη και αξιόπιστη ουρά υποστηρίζει εγγράφει η ανάγνωση.
Με άλλα λόγια, οποιαδήποτε εγγραφή μέσα σε μια συναλλαγή θα είναι ορατό σε ένα αναγνωσμένο παρακάτω που ανήκει στην ίδια συναλλαγή.

## <a name="locking"></a>Κλείδωμα
Στο στοιχείο συλλογές αξιόπιστη, όλες οι συναλλαγές είναι δύο χρονολογικής φάσης: συναλλαγή δεν αφήστε το κλείδωμα του αποκτήσει μέχρι η συναλλαγή καταγγελία με μια ματαίωση ή μια ολοκλήρωση.

Αξιόπιστη λεξικό χρησιμοποιεί κλείδωμα για όλες τις εργασίες μία οντότητα σε επίπεδο γραμμής.
Αξιόπιστη ουρά θυσιάζει ταυτόχρονης εκτέλεσης για αυστηρών συναλλαγών ιδιότητα FIFO.
Αξιόπιστη ουρά χρησιμοποιεί λειτουργία επιπέδου κλειδωμάτων επιτρέποντάς μία συναλλαγή `TryPeekAsync` ή/και `TryDequeueAsync` και μία συναλλαγή με `EnqueueAsync` κάθε φορά.
Σημειώστε ότι για να διατηρήσετε FIFO, εάν μια `TryPeekAsync` ή `TryDequeueAsync` ποτέ τηρεί που αξιόπιστη ουρά είναι κενό, κλειδώνει επίσης `EnqueueAsync`.

Γράψτε λειτουργίες παίρνουν πάντα κλειδωμάτων για αποκλειστική χρήση.
Για λειτουργίες ανάγνωσης, το κλείδωμα εξαρτάται από δύο παράγοντες.
Οποιαδήποτε λειτουργία ανάγνωσης έτοιμοι να χρησιμοποιώντας απομόνωσης στιγμιότυπο είναι δωρεάν κλειδώματος.
Οποιαδήποτε λειτουργία επαναλαμβανόμενη ανάγνωση από προεπιλογή μεταφέρει κλειδωμάτων κοινή χρήση.
Ωστόσο, για οποιαδήποτε λειτουργία ανάγνωσης που υποστηρίζει επαναλαμβανόμενη ανάγνωση, ο χρήστης μπορεί να ζητούν από ένα κλείδωμα ενημέρωση αντί για το κλείδωμα κοινή χρήση.
Κλείδωμα μια ενημερωμένη έκδοση είναι μια ασύμμετρη κλειδώματος που χρησιμοποιούνται για την αποτροπή συνήθη αδιεξόδου πραγματοποιείται όταν πολλές συναλλαγές κλείδωμα πόρους για πιθανές ενημερώσεις αργότερα.

Μπορείτε να βρείτε τον πίνακα συμβατότητας κλείδωμα κάτω από:

| Αίτηση \ εκχωρηθεί | Κανένας         | Κοινή χρήση       | Ενημέρωση      | Αποκλειστική χρήση    |
| ----------------- | :----------- | :----------- | :---------- | :----------- |
| Κοινή χρήση            | Δεν υπάρχει διένεξη  | Δεν υπάρχει διένεξη  | Διένεξη    | Διένεξη     |
| Ενημέρωση            | Δεν υπάρχει διένεξη  | Δεν υπάρχει διένεξη  | Διένεξη    | Διένεξη     |
| Αποκλειστική χρήση         | Δεν υπάρχει διένεξη  | Διένεξη     | Διένεξη    | Διένεξη     |

Σημειώστε ότι ένα όρισμα λήξης χρονικού ορίου στα την αξιόπιστη API συλλογές χρησιμοποιείται για τον εντοπισμό αδιεξόδου.
Για παράδειγμα, δύο συναλλαγές (Τ1 και Τ2) προσπαθείτε να διαβάζετε και να ενημερώνετε K1.
Είναι δυνατό να αδιέξοδο, επειδή οι δύο μεταφέρεστε αντιμετωπίζετε το κλείδωμα κοινή χρήση.
Σε αυτήν την περίπτωση, ένα ή και τα δύο από τις λειτουργίες θα λήξει το χρονικό όριο.

Σημειώστε ότι το παραπάνω σενάριο αδιεξόδου είναι μια εξαιρετική παράδειγμα πώς ένα κλείδωμα ενημέρωση να αποτρέψετε προβλήματα.

## <a name="persistence-model"></a>Μοντέλο διατήρησης
Η αξιόπιστη Διαχείριση κατάστασης και αξιόπιστη συλλογές ακολουθήστε ένα μοντέλο διατήρησης που ονομάζεται αρχείο καταγραφής και σημείο ελέγχου.
Αυτό είναι ένα μοντέλο όπου κάθε αλλαγή κατάστασης είναι συνδεδεμένοι στο δίσκο και εφαρμόζονται μόνο στη μνήμη.
Η πλήρης κατάσταση ίδια έχει διατηρηθεί μόνο περιστασιακά (ρομποτική Σημείο ελέγχου).
Το πλεονέκτημα είναι ότι δέλτα ενεργοποιούνται σε διαδοχικές μόνο για Προσάρτηση εγγραφών στο δίσκο για βελτιωμένη απόδοση.

Για να κατανοήσετε καλύτερα το αρχείο καταγραφής και σημείο ελέγχου μοντέλο, ας πρώτα μια ματιά στον το σενάριο άπειρο δίσκου.
Ο διευθυντής αξιόπιστη κατάσταση καταγράφει κάθε λειτουργίας πριν από την αναπαραγωγή.
Αυτό σας επιτρέπει τη συλλογή αξιόπιστη για να εφαρμόσετε μόνο τη λειτουργία στη μνήμη.
Επειδή το αρχεία καταγραφής διατηρούνται, ακόμα και όταν η ρεπλίκα αποτυγχάνει και πρέπει να γίνει επανεκκίνηση, ο διευθυντής αξιόπιστη κατάσταση έχει αρκετές πληροφορίες σε τα αρχεία καταγραφής για επανάληψη αναπαραγωγής της όλες οι λειτουργίες στη ρεπλίκα έχει χαθεί.
Καθώς ο δίσκος είναι άπειρο, εγγραφές καταγραφής πρέπει ποτέ να καταργηθούν και τη συλλογή αξιόπιστη πρέπει να Διαχείριση μόνο την κατάσταση στη μνήμη.

Τώρα ας ρίξουμε μια ματιά το σενάριο πεπερασμένο δίσκου.
Καθώς συσσωρεύονται εγγραφές καταγραφής, τη Διαχείριση αξιόπιστη κατάσταση θα εξαντλείται ο χώρος στο δίσκο.
Πριν από την σε αυτήν την περίπτωση, η αξιόπιστη Διαχείριση κατάστασης πρέπει να περικοπή του αρχείου καταγραφής για να κάνετε χώρο για τις νεότερες εγγραφές.
Θα ζητά την αξιόπιστη συλλογές σε σημείο ελέγχου κατάστασή τους στη μνήμη στο δίσκο.
Είναι ευθύνη των συλλογών αξιόπιστη για να παραμένει στην κατάσταση μέχρι εκείνη τη στιγμή.
Αφού τις συλλογές αξιόπιστη ολοκλήρωσης τους σημεία ελέγχου, τη Διαχείριση αξιόπιστη κατάσταση μπορεί να περικόψει το αρχείο καταγραφής για να αποδεσμεύσετε χώρο στο δίσκο.
Με αυτόν τον τρόπο, όταν η ρεπλίκα πρέπει να γίνει επανεκκίνηση, αξιόπιστη συλλογές θα ανάκτηση checkpointed κατάστασή τους και τη Διαχείριση αξιόπιστη κατάσταση θα ανάκτηση και αναπαραγωγή όλες τις αλλαγές κατάστασης που έγιναν από το σημείο ελέγχου.

>[AZURE.NOTE] Προσθέστε μια άλλη τιμή των σημείων ελέγχου είναι ότι το βελτιώνει την απόδοση αποκατάστασης στις συνήθεις περιπτώσεις.
Αυτό συμβαίνει επειδή τα σημεία ελέγχου περιέχουν μόνο τις πιο πρόσφατες εκδόσεις.

## <a name="recommendations"></a>Συστάσεις

- Μην τροποποιείτε ένα αντικείμενο προσαρμοσμένου τύπου που επιστρέφονται από λειτουργίες ανάγνωσης (π.χ., `TryPeekAsync` ή `TryGetValueAsync`). Αξιόπιστη συλλογές, όπως ακριβώς ταυτόχρονες συλλογές, να επιστρέφει αναφορά σε τα αντικείμενα και όχι ένα αντίγραφο.
- Κάντε το αντικείμενο που επιστρέφεται από έναν προσαρμοσμένο τύπο βαθύ αντίγραφο πριν από την τροποποίηση του. Επειδή οι δομές και τύποι ενσωματωμένη είναι πέρασμα κατά τιμή, δεν χρειάζεται να κάνετε ένα αντίγραφο βαθύ σε αυτά.
- Μην χρησιμοποιείτε `TimeSpan.MaxValue` για διακοπές. Λήξη περιόδων πρέπει να χρησιμοποιείται για τον εντοπισμό προβλήματα.
- Μην χρησιμοποιείτε συναλλαγή αφού έχει ολοκληρωθεί, ματαιώθηκε, ή διάθεση.
- Μην χρησιμοποιείτε αρίθμηση εκτός του αντικειμένου συναλλαγής που δημιουργήθηκε στο.
- Δεν είναι η δημιουργία μιας συναλλαγής σε άλλη συναλλαγή `using` δήλωση επειδή μπορεί να προκαλέσει προβλήματα.
- Βεβαιωθείτε ότι το `IComparable<TKey>` υλοποίηση είναι σωστή. Το σύστημα μεταφέρει εξάρτηση για αυτή την επιλογή για τη συγχώνευση σημεία ελέγχου.
- Χρησιμοποιήστε ενημέρωση κλειδώματος κατά την ανάγνωση ενός στοιχείου με την πρόθεσή για να την ενημερώσετε για να αποτρέψετε μια συγκεκριμένη κλάση προβλήματα.
- Εξετάστε το ενδεχόμενο χρήσης δημιουργίας αντιγράφων ασφαλείας και επαναφορά της λειτουργικότητας να έχουν αποκατάσταση.
- Αποφύγετε την ανάμιξη λειτουργίες μία οντότητα και λειτουργίες πολλαπλών οντότητα (π.χ. `GetCountAsync`, `CreateEnumerableAsync`) στην ίδια συναλλαγή λόγω των επιπέδων διαφορετικό απομόνωσης.

Ακολουθούν ορισμένα πράγματα που πρέπει να λάβετε υπόψη:

- Το χρονικό όριο προεπιλογή είναι 4 δευτερολέπτων για όλα τα αξιόπιστη API συλλογής. Οι περισσότεροι χρήστες δεν θα πρέπει να παρακάμψετε αυτό.
- Είναι το προεπιλεγμένο διακριτικό ακύρωσης `CancellationToken.None` στα όλα αξιόπιστη API συλλογών.
- Η παράμετρος κλειδί, πληκτρολογήστε (*TKey*) για μια αξιόπιστη λεξικό σωστά πρέπει να υλοποιήσετε `GetHashCode()` και `Equals()`. Πλήκτρα πρέπει να είναι αμετάβλητες.
- Για να επιτύχετε υψηλής διαθεσιμότητας για τις συλλογές αξιόπιστη, κάθε υπηρεσία θα πρέπει να έχετε τουλάχιστον ένα προορισμού και ελάχιστες ρεπλίκα ορίστε μέγεθος του 3.
- Λειτουργίες ανάγνωσης σε τη δευτερεύουσα μπορεί να διαβάσει εκδόσεις που δεν είναι απαρτίας δεσμευμένου.
Αυτό σημαίνει ότι μια έκδοση των δεδομένων που είναι ανάγνωση από μία δευτερεύον μπορεί να είναι false προχωρήσει.
Φυσικά, διαβάζει από πρωτεύοντα πάντα είναι σταθερές: μπορεί να ποτέ είναι false προχωρήσει.

## <a name="next-steps"></a>Επόμενα βήματα

- [Αξιόπιστη υπηρεσίες γρήγορης εκκίνησης](service-fabric-reliable-services-quick-start.md)
- [Εργασία με αξιόπιστη συλλογές](service-fabric-work-with-reliable-collections.md)
- [Αξιόπιστη υπηρεσίες ειδοποιήσεων](service-fabric-reliable-services-notifications.md)
- [Αξιόπιστη υπηρεσίες αντιγράφων ασφαλείας και επαναφοράς (αποκατάσταση)](service-fabric-reliable-services-backup-restore.md)
- [Ρύθμιση παραμέτρων διαχείρισης αξιόπιστη κατάσταση](service-fabric-reliable-services-configuration.md)
- [Γρήγορα αποτελέσματα με το API Web της υπηρεσίας ύφασμα υπηρεσιών](service-fabric-reliable-services-communication-webapi.md)
- [Χρήση των υπηρεσιών αξιόπιστη προγραμματισμού μοντέλου για προχωρημένους](service-fabric-reliable-services-advanced-usage.md)
- [Αναφορά προγραμματιστών για αξιόπιστη συλλογές](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)
