<properties
   pageTitle="Παράδειγμα DMZ – Δημιουργήστε ένα DMZ για την προστασία δικτύων με ένα τείχος προστασίας, UDR και NSG | Microsoft Azure"
   description="Δημιουργήσετε ένα DMZ με ένα τείχος προστασίας, ορίζονται από το χρήστη δρομολόγησης (UDR) και τις ομάδες ασφαλείας δικτύου (NSG)"
   services="virtual-network"
   documentationCenter="na"
   authors="tracsman"
   manager="rossort"
   editor=""/>

<tags
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="02/01/2016"
   ms.author="jonor;sivae"/>

# <a name="example-3--build-a-dmz-to-protect-networks-with-a-firewall-udr-and-nsg"></a>Παράδειγμα 3-Δημιουργήστε μια DMZ για την προστασία δικτύων με ένα τείχος προστασίας, UDR και NSG

[Επιστρέψτε στη σελίδα βέλτιστες πρακτικές ασφαλείας όριο][HOME]

Αυτό το παράδειγμα θα δημιουργήσει μια DMZ με ένα τείχος προστασίας, τέσσερις διακομιστές των windows, τη δρομολόγηση που ορίζονται από το χρήστη, προώθηση IP και τις ομάδες ασφαλείας δικτύου. Αυτό θα επίσης καθοδηγήσει κάθε μία από τις σχετικές εντολές για την παροχή κατανοήσει βαθύτερη κάθε βήμα. Υπάρχει επίσης μια ενότητα σενάριο κίνηση για την παροχή ενός αναλυτικά βήμα προς βήμα πώς εξελίσσεται κίνηση μέσω των επιπέδων άμυνας για το DMZ. Τέλος, στις αναφορές ενότητα είναι τον πλήρη κωδικό και οδηγίες για τη δημιουργία αυτού του περιβάλλοντος για να δοκιμάσετε και να πειραματιστείτε με διάφορες σενάρια. 

![DMZ διπλής κατεύθυνσης με NVA, NSG και UDR][1]

## <a name="environment-setup"></a>Εγκατάσταση περιβάλλοντος
Σε αυτό το παράδειγμα, υπάρχει μια συνδρομή που περιέχει τα εξής:

- Τρία cloud services: "SecSvc001", "FrontEnd001" και "BackEnd001"
- Ένα εικονικό δίκτυο "CorpNetwork", με τρία δευτερεύοντα δίκτυα: "SecNet", "FrontEnd" και "Παρασκηνίου"
- Μια συσκευή εικονικού δικτύου, σε αυτό το παράδειγμα τείχος προστασίας, συνδεδεμένο με το υποδίκτυο SecNet
- Σε Windows Server που αντιπροσωπεύει ένα διακομιστή εφαρμογών web ("IIS01")
- Διακομιστές δύο παράθυρα που αναπαριστά την εφαρμογή ξανά Τερματισμός διακομιστές ("AppVM01", "AppVM02")
- Σε Windows server που αντιπροσωπεύει ένα διακομιστή DNS ("DNS01")

Στην ενότητα "Αναφορές" κάτω από το στοιχείο υπάρχει μια δέσμη ενεργειών του PowerShell που θα δημιουργήσετε πιο του περιβάλλοντος που περιγράφονται παραπάνω. Δημιουργία του ΣΠΣ και εικονικού δίκτυα, παρόλο που εκτελούνται από το παράδειγμα δέσμης ενεργειών, δεν περιγράφονται αναλυτικά σε αυτό το έγγραφο.

Για να δημιουργήσετε το περιβάλλον:

  1.    Αποθηκεύστε το αρχείο xml ρύθμισης παραμέτρων δικτύου που περιλαμβάνονται στην ενότητα αναφορές (ενημερώνονται με ονόματα, θέση και IP διευθύνσεις ώστε να ταιριάζει με το δεδομένο σενάριο)
  2.    Ενημερώστε τις μεταβλητές χρήστη στη δέσμη ενεργειών για να ταιριάζει με το περιβάλλον που πρόκειται να εκτελεστεί σε σχέση με (συνδρομές, ονόματα υπηρεσιών, κλπ) της δέσμης ενεργειών
  3.    Εκτέλεση της δέσμης ενεργειών σε PowerShell

**Σημείωση**: της περιοχής που καθορίζεται στη δέσμη ενεργειών PowerShell πρέπει να συμφωνεί με την περιοχή που καθορίζεται από το αρχείο xml ρύθμισης παραμέτρων δικτύου.

Όταν η δέσμη ενεργειών εκτελείται με επιτυχία, ενδέχεται να ληφθεί τα ακόλουθα βήματα μετά τη δέσμη ενεργειών:

1.  Ρύθμιση τους κανόνες τείχους προστασίας, αυτό καλύπτεται στην παρακάτω ενότητα με τίτλο: περιγραφής του κανόνα τείχους προστασίας.
2.  Προαιρετικά στην ενότητα αναφορές είναι δύο δέσμες ενεργειών για να ρυθμίσετε το διακομιστή web και εφαρμογή διακομιστή με μια εφαρμογή web απλό για να επιτρέψετε δοκιμών με αυτήν τη ρύθμιση παραμέτρων DMZ.

Όταν η δέσμη ενεργειών εκτελείται με επιτυχία το τείχος προστασίας κανόνες θα πρέπει να ολοκληρωθούν, αυτό καλύπτεται στην ενότητα με τίτλο: κανόνες τείχους προστασίας.

## <a name="user-defined-routing-udr"></a>Δρομολόγηση (UDR) ορίζονται από το χρήστη
Από προεπιλογή, οι παρακάτω διαδρομές συστήματος ορίζονται ως εξής:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.0.0/16}     VNETLocal                            Active   Default    
         {0.0.0.0/0}       Internet                             Active   Default    
         {10.0.0.0/8}      Null                                 Active   Default    
         {100.64.0.0/10}   Null                                 Active   Default    
         {172.16.0.0/12}   Null                                 Active   Default    
         {192.168.0.0/16}  Null                                 Active   Default

Το VNETLocal είναι πάντα η καθορισμένη διεύθυνση prefix(es) από το VNet για αυτό το συγκεκριμένο δίκτυο (ie αυτό θα αλλάξει από VNet VNet ανάλογα με τον τρόπο ορισμού κάθε συγκεκριμένο VNet). Το υπόλοιπο δρομολογεί σύστημα είναι στατική και προεπιλεγμένη όπως παραπάνω.

Όπως για την προτεραιότητα, δρομολογεί πραγματοποιείται μέσω της μεθόδου μεγαλύτερου πρόθεμα Match (LPM), έτσι η πιο συγκεκριμένη δρομολόγηση στον πίνακα θα ισχύουν για μια διεύθυνση προορισμού που δίνεται.

Γι ' αυτό, θα δρομολογούνται κατά μήκος του VNet στον προορισμό λόγω τη διαδρομή 10.0.0.0/16 κυκλοφορία (για παράδειγμα στο διακομιστή DNS01, 10.0.2.4) που προορίζονται για το τοπικό δίκτυο (10.0.0.0/16). Με άλλα λόγια, 10.0.2.4, τη διαδρομή 10.0.0.0/16 είναι η πιο συγκεκριμένες δρομολόγηση, παρόλο που η 10.0.0.0/8 και 0.0.0.0/0 επίσης ήταν δυνατή η εφαρμογή, αλλά επειδή είναι μικρότερο συγκεκριμένες δεν επηρεάζουν την κυκλοφορία. Επομένως, η κίνηση για να 10.0.2.4 θα έχετε μια επόμενης μεταπήδησης το τοπικό VNet και απλώς δρομολόγηση στον προορισμό.

Εάν κίνηση ήταν προορίζονται για 10.1.1.1, για παράδειγμα, δεν θα ισχύουν τη διαδρομή 10.0.0.0/16, αλλά το 10.0.0.0/8 θα είναι η πιο συγκεκριμένες και αυτό θα ήταν η κίνηση αποτεθεί ("μαύρο holed") από την επόμενη μεταπήδηση είναι Null. 

Εάν ο προορισμός δεν ισχύουν για οποιοδήποτε από τα προθέματα Null ή τα προθέματα VNETLocal και, στη συνέχεια, αυτό θα ακολουθήσετε λιγότερο συγκεκριμένη δρομολόγηση, 0.0.0.0/0 και να δρομολογούνται στο Internet ως την επόμενη μεταπήδηση και, επομένως, εκτός του Azure internet άκρο.

Εάν υπάρχουν δύο όμοια προθέματα στον πίνακα δρομολόγηση, ακολουθεί τη σειρά προτίμησης με βάση την ιδιότητα "Προέλευση" διαδρομές:

1.  "VirtualAppliance" = Δρομολόγηση ορίστηκε χρήστη με μη αυτόματο τρόπο προστίθενται στον πίνακα
2.  "VPNGateway" = μια δυναμική διαδρομή (πρωτόκολλο BGP όταν χρησιμοποιείται με τα δίκτυα υβριδική), προστεθεί από ένα πρωτόκολλο δυναμικής δικτύου, αυτές οι διαδρομές ενδέχεται να αλλάξουν μέσα στο χρόνο ως το πρωτόκολλο δυναμικής αντανακλά αυτόματα τις αλλαγές στο peered δικτύου
3.  "Προεπιλογή" = τις διαδρομές συστήματος, τα τοπικά VNet και τις καταχωρήσεις στατικής, όπως φαίνεται στο παραπάνω πίνακα διαδρομών.

>[AZURE.NOTE] Τώρα, μπορείτε να χρησιμοποιήσετε χρήστη που καθορίζονται από τη δρομολόγηση (UDR) με ExpressRoute και των πυλών VPN για να επιβάλετε εξερχόμενη και η εισερχόμενη κυκλοφορία σταυρό εσωτερικής εγκατάστασης στο να δρομολογηθούν σε μια συσκευή εικονικού δικτύου (NVA).

#### <a name="creating-the-local-routes"></a>Δημιουργία τοπικού διαδρομές

Σε αυτό το παράδειγμα, απαιτούνται δύο πίνακες δρομολόγησης, μία κάθε για το πρόγραμμα προσκηνίου και παρασκηνίου δευτερεύοντα δίκτυα. Κάθε πίνακας έχει φορτωθεί με στατικές διαδρομές κατάλληλα για το συγκεκριμένο υποδίκτυο. Για αυτό το παράδειγμα, κάθε πίνακας έχει τρεις δρομολογεί:

1. Κίνηση τοπικό υποδίκτυο με δεν υπάρχει επόμενη άλματος που ορίζονται από το για να επιτρέψετε την κυκλοφορία τοπικό υποδίκτυο να παρακάμψει το τείχος προστασίας
2. Εικονικό κίνηση του δικτύου με μια επόμενη άλματος ορίζεται ως τείχος προστασίας, αυτό αντικαθιστά τον προεπιλεγμένο κανόνα που επιτρέπει την τοπική VNet κίνηση για να δρομολογήσετε απευθείας
3. Όλη την υπόλοιπη κυκλοφορία (0 0) με ένα επόμενου άλματος ορίζεται ως το τείχος προστασίας

Όταν δημιουργούνται οι πίνακες δρομολόγησης αυτές είναι συνδεδεμένες με τους δευτερεύοντα δίκτυα. Για το υποδίκτυο Frontend πίνακα δρομολόγησης, αφού δημιουργηθεί και συνδεδεμένο με το υποδίκτυο θα πρέπει να μοιάζει ως εξής:

        Effective routes : 
         Address Prefix    Next hop type    Next hop IP address Status   Source     
         --------------    -------------    ------------------- ------   ------     
         {10.0.1.0/24}     VNETLocal                            Active 
         {10.0.0.0/16}     VirtualAppliance 10.0.0.4            Active    
         {0.0.0.0/0}       VirtualAppliance 10.0.0.4            Active


Για αυτό το παράδειγμα, οι ακόλουθες εντολές που χρησιμοποιούνται για να δημιουργήσει τον πίνακα δρομολόγηση, να προσθέσετε μια διαδρομή που ορίζονται από το χρήστη και, στη συνέχεια, να συνδέσετε τον πίνακα δρομολόγηση με ένα δευτερεύον (Σημείωση, όλα τα στοιχεία κάτω από το στοιχείο που ξεκινά με ένα σύμβολο δολαρίου (π.χ.: $BESubnet) είναι μεταβλητές που ορίζονται από το χρήστη από τη δέσμη ενεργειών στην ενότητα αναφορά αυτού του εγγράφου):

1.  Πρώτα πρέπει να δημιουργηθεί το βασικό πίνακα δρομολόγησης. Σε αυτό το τμήμα κώδικα δείχνει τη δημιουργία του πίνακα για το υποδίκτυο παρασκηνίου. Στη δέσμη ενεργειών, μια αντίστοιχη πίνακας δημιουργείται επίσης για το υποδίκτυο Frontend.

        New-AzureRouteTable -Name $BERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $BESubnet subnet"

2.  Όταν δημιουργηθεί ο πίνακας δρομολόγησης, μπορούν να προστεθούν δρομολογεί ορίζονται από το συγκεκριμένο χρήστη. Σε αυτό αποκομμένων, όλη την κυκλοφορία (0.0.0.0/0) θα δρομολογούνται μέσω εικονικών συσκευής (μια μεταβλητή, $VMIP [0], χρησιμοποιείται για τη μεταβίβαση τη διεύθυνση IP που έχουν ανατεθεί όταν το εικονικό μηχάνημα που δημιουργήθηκε προηγουμένως στη δέσμη ενεργειών). Στη δέσμη ενεργειών, μια αντίστοιχη κανόνας δημιουργείται επίσης στον πίνακα Frontend.

        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]

3. Η παραπάνω καταχώρηση δρομολόγηση θα αντικαταστήσει την προεπιλεγμένη "0.0.0.0/0" δρομολόγηση, αλλά ο προεπιλεγμένος κανόνας 10.0.0.0/16 εξακολουθεί να υπάρχουσες που θα επιτρέψετε την κυκλοφορία εντός του VNet για να δρομολογήσετε την απευθείας στον προορισμό και να μην συσκευής εικονικού δικτύου. Για να σωστά αυτή η συμπεριφορά τον κανόνα παρακολούθηση πρέπει να προστεθεί.

        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]

4. Σε αυτό το σημείο υπάρχει επιλογή να γίνουν. Με τις δύο παραπάνω διαδρομές όλη την κυκλοφορία θα δρομολόγηση στο τείχος προστασίας για εκτίμηση, ακόμα και την κυκλοφορία μέσα σε ένα μόνο υποδίκτυο. Αυτό μπορεί να είναι επιθυμητοί, ωστόσο, για να επιτρέψετε την κυκλοφορία μέσα σε ένα υποδίκτυο για τη δρομολόγηση τοπικά χωρίς την παρέμβαση από το τείχος προστασίας τρίτο, μπορούν να προστεθούν πολύ συγκεκριμένο κανόνα. Αυτή η δρομολόγηση δηλώνει ότι οποιαδήποτε διεύθυνση destine για να μόνο τοπικό υποδίκτυο εκεί δρομολόγηση απευθείας (NextHopType = VNETLocal).

        Get-AzureRouteTable $BERouteTableName | `
            Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal

5.  Τέλος, με τον πίνακα δρομολόγησης δημιουργούνται και συμπληρωμένο με μια δρομολογεί ορίζονται από το χρήστη, ο πίνακας πρέπει τώρα να συνδεθεί με ένα δευτερεύον. Στη δέσμη ενεργειών, τον πίνακα δρομολόγησης προσκηνίου συνδέεται επίσης με το υποδίκτυο Frontend. Ακολουθεί η δέσμη ενεργειών σύνδεσης για το υποδίκτυο παρασκηνίου.

        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
           -SubnetName $BESubnet `
           -RouteTableName $BERouteTableName

## <a name="ip-forwarding"></a>Προώθηση IP
Δυνατότητα συνοδευτικό UDR, είναι προώθησης IP. Αυτή είναι μια ρύθμιση σε μια εικονική συσκευή που σας επιτρέπει να λαμβάνει την κυκλοφορία δεν συγκεκριμένα απευθύνεται στη συσκευή και, στη συνέχεια, προώθηση η κυκλοφορία στον προορισμό ultimate.

Ως παράδειγμα, εάν κίνησης από AppVM01 κάνει μια αίτηση στο διακομιστή DNS01, UDR να δρομολογήσετε αυτό για το τείχος προστασίας. Με IP προώθηση ενεργοποιημένη, η κίνηση για τον προορισμό DNS01 (10.0.2.4) θα γίνουν αποδεκτά από τη συσκευή (10.0.0.4) και, στη συνέχεια, να προωθούνται στον προορισμό ultimate (10.0.2.4). Χωρίς προώθηση IP με δυνατότητα στο τείχος προστασίας κίνηση θα γίνονται αποδεκτά από συσκευής Παρόλο που ο πίνακας δρομολόγηση έχει το τείχος προστασίας ως την επόμενη μεταπήδηση. 

>[AZURE.IMPORTANT] Είναι σημαντικό να θυμάστε για να ενεργοποιήσετε την προώθηση IP σε συνδυασμό με τη δρομολόγηση που ορίζονται από το χρήστη.

Ρύθμιση προώθησης IP είναι μια απλή εντολή και μπορεί να γίνει κατά τη δημιουργία Εικονική. Για τη ροή αυτό το παράδειγμα, το τμήμα κώδικα είναι προς το τέλος της δέσμης ενεργειών και ομαδοποιημένα με τις εντολές UDR:

1.  Καλέστε την παρουσία Εικονική που είναι σε αυτήν την περίπτωση το εικονικό συσκευής, το τείχος προστασίας και να ενεργοποιήσετε την προώθηση IP (Σημείωση, οποιοδήποτε στοιχείο κόκκινο που ξεκινά με ένα σύμβολο δολαρίου (π.χ.: $VMName[0]) είναι μια μεταβλητή που ορίζονται από το χρήστη από τη δέσμη ενεργειών στην ενότητα αναφορά αυτού του εγγράφου. Το μηδέν μέσα σε αγκύλες, [0], αντιπροσωπεύει την πρώτη εικονική Μηχανή στον πίνακα του ΣΠΣ, για να εργαστείτε χωρίς τροποποίηση δέσμη ενεργειών το παράδειγμα, το πρώτο Εικονική (Εικονική 0) πρέπει να είναι το τείχος προστασίας):

        Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] | `
           Set-AzureIPForwarding -Enable

## <a name="network-security-groups-nsg"></a>Ομάδες ασφαλείας δικτύου (NSG)
Σε αυτό το παράδειγμα, μια ομάδα NSG είναι ενσωματωμένη και, στη συνέχεια, φόρτωση με έναν κανόνα. Αυτήν την ομάδα, στη συνέχεια, συνδέεται μόνο για το πρόγραμμα προσκηνίου και παρασκηνίου δευτερεύοντα δίκτυα (μην το SecNet). Δηλωτικά δημιουργείται τον εξής κανόνα:

1.  Δεν επιτρέπεται η οποιαδήποτε κυκλοφορία (όλες οι θύρες) από το Internet για να το ολόκληρο VNet (όλα τα δευτερεύοντα δίκτυα)

Παρόλο που NSGs χρησιμοποιούνται σε αυτό το παράδειγμα, είναι το κύριο σκοπό ως δευτερεύουσα επίπεδο άμυνας από μη αυτόματη εσφαλμένη ρύθμιση παραμέτρων. Θέλουμε να αποκλείσετε όλα εισερχόμενη κυκλοφορία από το internet είτε το πρόγραμμα στο προσκήνιο ή μόνο θα πρέπει να ροής δευτερεύοντα δίκτυα παρασκηνίου, κίνηση μέσω του υποδικτύου SecNet για το τείχος προστασίας (και μετά, εάν των κατάλληλων με το πρόγραμμα στο προσκήνιο ή παρασκηνίου δευτερεύοντα δίκτυα). Επιπλέον, με τους κανόνες UDR στη θέση, οποιαδήποτε κίνηση που έχει αλλάξει τη μετατρέψετε σε το Frontend ή παρασκηνίου δευτερεύοντα δίκτυα θα κατευθύνεται ανάληψη για το τείχος προστασίας (ευχαριστήριο UDR). Το τείχος προστασίας θα δείτε αυτό ως μια ασύμμετρη ροής και θα αποθέστε την εξερχόμενη κυκλοφορία. Επομένως, υπάρχουν τρία επίπεδα ασφαλείας προστασία των δευτερευόντων προσκηνίου και παρασκηνίου δικτύων; 1) χωρίς άνοιγμα τελικά σημεία στο FrontEnd001 και BackEnd001 στο cloud services, 2) NSGs την απόρριψη κυκλοφορία από το Internet, 3) την κυκλοφορία ασύμμετρη πτώση τείχος προστασίας.

Ένα σημείο ενδιαφέρον σχετικά με την ομάδα ασφαλείας δικτύου σε αυτό το παράδειγμα είναι ότι περιέχει μόνο έναν κανόνα, φαίνεται παρακάτω, που είναι να μην επιτρέπεται η κυκλοφορία internet σε ολόκληρο το εικονικό δίκτυο που να περιλαμβάνει το υποδίκτυο ασφαλείας. 

    Get-AzureNetworkSecurityGroup -Name $NSGName | `
        Set-AzureNetworkSecurityRule -Name "Isolate the $VNetName VNet `
        from the Internet" `
        -Type Inbound -Priority 100 -Action Deny `
        -SourceAddressPrefix INTERNET -SourcePortRange '*' `
        -DestinationAddressPrefix VIRTUAL_NETWORK `
        -DestinationPortRange '*' `
        -Protocol *

Ωστόσο, επειδή το NSG μόνο είναι συνδεδεμένο με το πρόγραμμα προσκηνίου και παρασκηνίου δευτερεύοντα δίκτυα, ο κανόνας δεν υποβάλλεται σε επεξεργασία σε κυκλοφορία εισερχομένων στο υποδίκτυο ασφαλείας. Ως αποτέλεσμα, παρόλο που ο κανόνας NSG αναφέρει ότι δεν υπάρχει κυκλοφορία Internet για οποιαδήποτε διεύθυνση στην το VNet, επειδή το NSG ποτέ ήταν συνδεδεμένο στο υποδίκτυο ασφαλείας, θα ροής κυκλοφορίας στο υποδίκτυο ασφαλείας.

    Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
        -SubnetName $FESubnet -VirtualNetworkName $VNetName
    
    Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName `
        -SubnetName $BESubnet -VirtualNetworkName $VNetName

## <a name="firewall-rules"></a>Κανόνες τείχους προστασίας
Το τείχος προστασίας, κανόνες προώθησης θα πρέπει να δημιουργηθεί. Επειδή το τείχος προστασίας είναι ο αποκλεισμός ή προώθηση όλων εισαγωγής, εξαγωγής και εντός VNet κυκλοφορία απαιτούνται πολλούς κανόνες τείχους προστασίας. Επίσης, όλη την εισερχόμενη κυκλοφορία θα πατήσετε στη δημόσια διεύθυνση IP της υπηρεσίας ασφαλείας (σε διαφορετικές θύρες), για να υποστεί επεξεργασία από το τείχος προστασίας. Βέλτιστη πρακτική είναι να διαγράμματος τις λογικές ροές πριν να ρυθμίσετε το δευτερεύοντα δίκτυα και τροποποιήστε κανόνες τείχους προστασίας για την αποφυγή αργότερα. Στην παρακάτω εικόνα είναι μια λογική προβολή από τους κανόνες τείχους προστασίας για αυτό το παράδειγμα:
 
![Προβολή λογικών από τους κανόνες τείχους προστασίας][2]

>[AZURE.NOTE] Βάσει της συσκευής εικονικού δικτύου που χρησιμοποιείται, ποικίλλει, τις θύρες διαχείρισης. Σε αυτό το παράδειγμα γίνεται αναφορά από ένα τείχος προστασίας NextGen Barracuda που χρησιμοποιεί θύρες 22 801 και 807. Ανατρέξτε στην τεκμηρίωση προμηθευτή συσκευή για να βρείτε τις ακριβείς θύρες που χρησιμοποιούνται για τη διαχείριση της συσκευής που χρησιμοποιείται.

### <a name="logical-rule-description"></a>Περιγραφή λογική κανόνα
Στο λογική παραπάνω διάγραμμα, το υποδίκτυο ασφαλείας δεν εμφανίζεται επειδή το τείχος προστασίας είναι το μοναδικό πόρο στο συγκεκριμένο υποδίκτυο και αυτό το διάγραμμα που δείχνει τους κανόνες τείχους προστασίας και πώς αυτές λογικά επιτρέψετε ή να απορρίψετε την κίνηση ροών και όχι την πραγματική διαδρομή δρομολόγησης. Επίσης, τις εξωτερικές θύρες επιλέξατε για την κυκλοφορία RDP βρίσκονται σε υψηλότερη κυμαινόταν θύρες (8014 – 8026) και έχουν επιλεγεί για να στοιχίσετε κάπως με τα δύο τελευταία οκτέτα του στην τοπική διεύθυνση IP για πιο εύκολη αναγνωσιμότητα (π.χ. διεύθυνση του τοπικού διακομιστή 10.0.1.4 σχετίζεται με εξωτερική θύρα 8014), ωστόσο μπορούν να χρησιμοποιηθούν οποιαδήποτε υψηλότερη θύρες δεν δημιουργεί διένεξη.

Για αυτό το παράδειγμα, χρειαζόμαστε 7 τύποι κανόνων, αυτοί οι τύποι κανόνα περιγράφονται ως εξής:

- Εξωτερική κανόνες (για την εισερχόμενη κίνηση):
  1.    Κανόνας διαχείρισης τείχους προστασίας: Αυτός ο κανόνας Redirect εφαρμογής επιτρέπει την κυκλοφορία στο μεταβιβάζουν τις θύρες διαχείρισης της συσκευής εικονικού δικτύου.
  2.    Κανόνες RDP (για κάθε windows server): αυτά τα τέσσερα κανόνες (μία για κάθε διακομιστή) θα επιτρέπεται η διαχείριση των μεμονωμένων διακομιστών μέσω RDP. Αυτό θα μπορούσε να επίσης να μέσα σε έναν κανόνα, ανάλογα με τις δυνατότητες της συσκευής εικονικού δικτύου που χρησιμοποιείται.
  3.    Εφαρμογή κανόνων κίνηση: Υπάρχουν δύο κανόνες κίνηση εφαρμογής, το πρώτο για την κυκλοφορία web προσκηνίου και το δεύτερο για την κυκλοφορία παρασκηνίου (π.χ. διακομιστή web σε σειρά δεδομένων). Η ρύθμιση παραμέτρων για αυτούς τους κανόνες θα εξαρτώνται από την αρχιτεκτονική δικτύου (όπου τοποθετούνται διακομιστές σας) και κυκλοφορίας ροών (ποια κατεύθυνση χρησιμοποιούνται οι ροές κίνηση και ποιες θύρες).
      - Ο πρώτος κανόνας επιτρέπει την κυκλοφορία πραγματική εφαρμογή για την επίτευξη στο διακομιστή εφαρμογών. Ενώ οι άλλοι κανόνες που επιτρέπουν για την ασφάλεια, διαχείριση, κ.λπ., εφαρμογή κανόνων είναι τι να επιτρέπεται σε εξωτερικούς χρήστες ή τις υπηρεσίες για να αποκτήσετε πρόσβαση τις εφαρμογές. Για αυτό το παράδειγμα, υπάρχει ένα διακομιστή web μία στη θύρα 80, επομένως, έναν κανόνα εφαρμογή μόνο τείχος προστασίας θα σας ανακατευθύνει εισερχόμενη κυκλοφορία για το εξωτερικό IP, με τη διεύθυνση IP web διακομιστών εσωτερικής. Η περίοδος λειτουργίας ανακατεύθυνσης κίνηση θα είναι NAT έπρεπε να εσωτερικού διακομιστή.
      - Τον δεύτερο κανόνα κυκλοφορίας εφαρμογής είναι ο κανόνας παρασκηνίου για να επιτρέψετε σε διακομιστή Web για να συνομιλήσετε με το διακομιστή AppVM01 (αλλά όχι AppVM02) μέσω οποιαδήποτε θύρα.
- Εσωτερικός (για την κυκλοφορία εντός VNet)
  4.    Εξερχομένων Internet κανόνα: Αυτός ο κανόνας θα επιτρέπεται η κυκλοφορία από οποιοδήποτε δίκτυο για τη μεταβίβαση για την επιλεγμένη δίκτυα. Αυτός ο κανόνας είναι συνήθως ένα προεπιλεγμένο κανόνα ήδη στο τείχος προστασίας, αλλά σε κατάσταση απενεργοποίησης. Αυτός ο κανόνας θα πρέπει να είναι ενεργοποιημένη για αυτό το παράδειγμα.
  5.    Κανόνας DNS: Αυτός ο κανόνας επιτρέπει μόνο η κυκλοφορία DNS (θύρα 53) για τη μεταβίβαση στο διακομιστή DNS. Για αυτό το περιβάλλον έχει αποκλειστεί κίνησης περισσότερες από το Frontend στον υπολογιστή στο παρασκήνιο, αυτός ο κανόνας επιτρέπει συγκεκριμένα DNS από οποιαδήποτε τοπικό υποδίκτυο.
  6.    Υποδίκτυο να υποδικτύου κανόνα: Αυτός ο κανόνας είναι για να επιτρέψετε σε οποιονδήποτε διακομιστή στο υποδίκτυο παρασκηνίου για να συνδεθείτε σε οποιονδήποτε διακομιστή στο δευτερεύον προσκηνίου (αλλά όχι το αντίστροφο).
- Ασφαλής κανόνα (για την κίνηση που δεν πληροί οποιοδήποτε από τα παραπάνω):
  7.    Απόρριψη όλων κανόνα κυκλοφορίας: Αυτό πρέπει να είναι πάντοτε τον τελικό κανόνα (όσον αφορά την προτεραιότητα) και ως τέτοια αποτυγχάνει εάν μια κίνηση ρέει ώστε να ταιριάζει με οποιοδήποτε από τα προηγούμενα κανόνες θα καταργηθούν από αυτόν τον κανόνα. Αυτός είναι ένας κανόνας προεπιλογή και συνήθως ενεργοποιημένο, χωρίς τροποποιήσεις γενικά χρειάζονται.

>[AZURE.TIP] Στην τον δεύτερο κανόνα κυκλοφορίας εφαρμογής, οποιαδήποτε θύρα επιτρέπεται για εύκολη από αυτό το παράδειγμα, σε ένα σενάριο πραγματικό τη θύρα πιο συγκεκριμένες και περιοχές διευθύνσεων πρέπει να χρησιμοποιείται για να μειώσετε την επιφάνεια επίθεση αυτού του κανόνα.

<br />

>[AZURE.IMPORTANT] Όταν δημιουργούνται όλους τους παραπάνω κανόνες, είναι σημαντικό να αναθεωρήσετε την προτεραιότητα της κάθε κανόνα για να βεβαιωθείτε ότι θα επιτρέπεται ή δεν επιτρέπεται η σύμφωνα με τις επιθυμίες κίνηση. Για αυτό το παράδειγμα, οι κανόνες είναι στη σειρά προτεραιότητας. Είναι εύκολο να είναι κλειδωμένο από το τείχος προστασίας λόγω λανθασμένα ταξινομημένη κανόνων. Τουλάχιστον, βεβαιωθείτε ότι το διαχείρισης για το τείχος προστασίας στην ίδια είναι πάντα η απόλυτη κανόνα υψηλότερη προτεραιότητα.

### <a name="rule-prerequisites"></a>Προαπαιτούμενα στοιχεία κανόνα
Μία προϋπόθεση για την εικονική μηχανή εκτελείται το τείχος προστασίας είναι δημόσια τελικά σημεία. Για το τείχος προστασίας για την επεξεργασία κίνηση τα τελικά σημεία κατάλληλη δημόσια πρέπει να είναι ανοιχτό. Υπάρχουν τρεις τύποι κίνησης σε αυτό το παράδειγμα, Κίνηση RDP 1) διαχείριση κυκλοφορίας σε έλεγχο το τείχος προστασίας και κανόνες τείχους προστασίας, 2) για να ελέγξετε τους διακομιστές των windows, και την κυκλοφορία εφαρμογή 3). Αυτές είναι οι τρεις στήλες με τύπους κίνηση στην επάνω ήμισυ λογική προβολή από τους κανόνες τείχους προστασίας των παραπάνω.

>[AZURE.IMPORTANT] Δείτε εδώ ένα πλήκτρο takeway είναι να θυμάστε ότι **όλη** την κυκλοφορία να παραδίδεται μέσω του τείχους προστασίας. Επομένως, για να απομακρυσμένης επιφάνειας εργασίας με το διακομιστή IIS01, παρόλο που είναι στην υπηρεσία Cloud τέλος εμπρός και στο προσκήνιο υποδίκτυο, για να αποκτήσετε πρόσβαση σε αυτόν το διακομιστή θα πρέπει να RDP για το τείχος προστασίας στη θύρα 8014, και, στη συνέχεια, να επιτρέπεται το τείχος προστασίας για να δρομολογήσετε την αίτηση RDP εσωτερικά στη θύρα RDP IIS01. Κουμπί "Σύνδεση" της πύλης Azure δεν λειτουργούν, επειδή δεν υπάρχει καμία απευθείας διαδρομή RDP για IIS01 (όσον αφορά την πύλη μπορούν να δουν). Αυτό σημαίνει ότι θα είναι όλες οι συνδέσεις από το internet για την υπηρεσία ασφαλείας και μια θύρα, π.χ. secscv001.cloudapp.net:xxxx (αναφορά το παραπάνω διάγραμμα για την αντιστοίχιση της εξωτερικής θύρας και εσωτερικό IP και τη θύρα).

Ένα τελικό σημείο μπορεί να ανοίξει είτε τη στιγμή της δημιουργίας Εικονική ή δημοσιεύστε Δόμηση ως έχει γίνει στη δέσμη ενεργειών παράδειγμα και να φαίνεται παρακάτω σε αυτό το τμήμα κώδικα (Σημείωση, οποιοδήποτε στοιχείο που ξεκινά με ένα σύμβολο δολαρίου (π.χ.: $VMName[$i]) είναι μια μεταβλητή που ορίζονται από το χρήστη από τη δέσμη ενεργειών στην ενότητα αναφορά αυτού του εγγράφου. Το "$i" μέσα σε αγκύλες, [$i], αντιπροσωπεύει τον αριθμό πίνακα από μια συγκεκριμένη Εικονική στα ένας πίνακας με ΣΠΣ):

    Add-AzureEndpoint -Name "HTTP" -Protocol tcp -PublicPort 80 -LocalPort 80 `
        -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | `
        Update-AzureVM

Παρόλο που δεν με σαφήνεια εμφανίζεται λόγω της χρήσης του μεταβλητές, αλλά τελικά σημεία ακολουθούν **μόνο** ανοίξει στην υπηρεσία Cloud ασφαλείας. Πρόκειται για να διασφαλίσετε ότι γίνεται όλη την εισερχόμενη κυκλοφορία (δρομολόγησης, NAT είχε, αποτεθεί) από το τείχος προστασίας.

Ένα πρόγραμμα-πελάτης διαχείρισης θα πρέπει να έχει εγκατασταθεί σε έναν Υπολογιστή για να διαχειριστείτε το τείχος προστασίας και να δημιουργήσετε τις ρυθμίσεις παραμέτρων, είναι απαραίτητο. Σχετικά με τον τρόπο για να διαχειριστείτε τη συσκευή, ανατρέξτε στο θέμα τον προμηθευτή τεκμηρίωση από το τείχος προστασίας σας (ή άλλα NVA). Το υπόλοιπο της αυτής της ενότητας και στην επόμενη ενότητα, δημιουργία κανόνες τείχους προστασίας, θα περιγράφουν τη ρύθμιση παραμέτρων του τείχους προστασίας μόνη της, μέσω του προμηθευτές διαχείρισης προγράμματος-πελάτη (δηλαδή, δεν Azure πύλη ή PowerShell).

Οδηγίες για τη λήψη του προγράμματος-πελάτη και τη σύνδεση με το Barracuda που χρησιμοποιούνται σε αυτό το παράδειγμα, μπορείτε να βρείτε εδώ: [Barracuda ΣΗ διαχείρισης](https://techlib.barracuda.com/NG61/NGAdmin)

Αφού έχετε συνδεθεί στο το τείχος προστασίας, αλλά πριν να δημιουργήσετε κανόνες τείχους προστασίας, υπάρχουν δύο κατηγορίες προαπαιτούμενες αντικείμενο που μπορούν να κάνουν τη δημιουργία των κανόνων ευκολότερη; Αντικείμενα & υπηρεσία δικτύου.

Για αυτό το παράδειγμα, τρεις αντικείμενα με όνομα δικτύου πρέπει να είναι καθορισμένο (μία για το υποδίκτυο Frontend και το υποδίκτυο παρασκηνίου, επίσης ένα αντικείμενο δικτύου για τη διεύθυνση IP του διακομιστή DNS). Για να δημιουργήσετε ένα επώνυμο δίκτυο. ξεκινώντας από τον πίνακα εργαλείων του προγράμματος-πελάτη Barracuda ΣΗ διαχείρισης, μεταβείτε στην καρτέλα ρύθμισης παραμέτρων, στην ενότητα λειτουργικές παραμέτρους, κάντε κλικ στην επιλογή Ruleset, στη συνέχεια, κάντε κλικ στην επιλογή "Δίκτυα" στην περιοχή του μενού αντικείμενα τείχος προστασίας και κατόπιν κάντε κλικ στην επιλογή "Δημιουργία" στο μενού Επεξεργασία δίκτυα. Το αντικείμενο δικτύου μπορούν τώρα να δημιουργηθούν, προσθέτοντας το όνομα και το πρόθεμα:

![Δημιουργία ενός αντικειμένου FrontEnd δικτύου][3]
 
Αυτό θα δημιουργήσει μια καθορισμένη δικτύου για το υποδίκτυο FrontEnd, θα πρέπει να δημιουργηθεί ένα παρόμοιο αντικείμενο για δευτερεύον παρασκηνίου. Τώρα των δευτερευόντων δικτύων μπορούν να χρησιμοποιηθούν πιο εύκολα με βάση το όνομα στο τους κανόνες τείχους προστασίας.

Για το αντικείμενο διακομιστή DNS:

![Δημιουργήστε ένα αντικείμενο διακομιστή DNS][4]

Αυτή η μία αναφορά διεύθυνση IP θα χρησιμοποιηθεί σε έναν κανόνα DNS αργότερα στο έγγραφο.

Το δεύτερο προαπαιτούμενες αντικείμενα είναι οι υπηρεσίες αντικείμενα. Αυτές θα αντιπροσωπεύουν τις θύρες σύνδεσης RDP για κάθε διακομιστή. Επειδή το υπάρχον αντικείμενο υπηρεσίας RDP είναι συνδεδεμένο με την προεπιλεγμένη θύρα RDP, 3389, νέων υπηρεσιών μπορούν να δημιουργηθούν για να επιτρέψετε την κυκλοφορία από τις εξωτερικές θύρες (8014-8026). Οι νέες θύρες θα μπορούσε να προστεθούν επίσης στην υπάρχουσα υπηρεσία RDP, αλλά για διευκόλυνση της επίδειξης, μπορεί να δημιουργηθεί ένα μεμονωμένο κανόνα για κάθε διακομιστή. Για να δημιουργήσετε έναν νέο κανόνα RDP για ένα διακομιστή. ξεκινώντας από τον πίνακα εργαλείων του προγράμματος-πελάτη Barracuda ΣΗ διαχείρισης, μεταβείτε στην καρτέλα ρύθμισης παραμέτρων, στην ενότητα λειτουργικές παραμέτρους, κάντε κλικ στην επιλογή Ruleset, στη συνέχεια, κάντε κλικ στην επιλογή "Υπηρεσίες" στην περιοχή του μενού τείχος προστασίας των αντικειμένων, κύλιση προς τα κάτω στη λίστα των υπηρεσιών και επιλέξτε την υπηρεσία "RDP". Κάντε δεξί κλικ και επιλέξτε Αντιγραφή, στη συνέχεια, κάντε δεξί κλικ και επιλέξτε Επικόλληση. Υπάρχει πλέον ένα αντικείμενο υπηρεσίας RDP Copy1 που μπορούν να υποστούν επεξεργασία. Κάντε δεξί κλικ RDP Copy1 και επιλέξτε Επεξεργασία, το αντικείμενο υπηρεσίας επεξεργασία παράθυρο θα εμφανιστεί επάνω, όπως φαίνεται εδώ:

![Αντίγραφο της προεπιλεγμένης RDP κανόνα][5]

Στη συνέχεια, μπορείτε να επεξεργαστείτε τις τιμές για να αντιπροσωπεύει την υπηρεσία RDP για ένα συγκεκριμένο διακομιστή. Για AppVM01 τον παραπάνω προεπιλεγμένο κανόνα RDP θα πρέπει να τροποποιηθούν ώστε να αντικατοπτρίζει ένα νέο όνομα της υπηρεσίας, περιγραφή και εξωτερική θύρα RDP που χρησιμοποιείται στο διάγραμμα σχήμα 8 (Σημείωση: οι θύρες αλλάζουν από την προεπιλογή RDP 3389 σε εξωτερική θύρα που χρησιμοποιείται για αυτόν το διακομιστή, στην περίπτωση AppVM01 εξωτερική θύρα είναι 8025) εμφανίζεται κάτω από την υπηρεσία που έχουν τροποποιηθεί :

![AppVM01 κανόνα][6]
 
Πρέπει να επαναλαμβάνεται αυτή η διαδικασία για τη δημιουργία υπηρεσιών RDP των υπόλοιπων διακομιστών; AppVM02 DNS01 και IIS01. Η δημιουργία αυτών των υπηρεσιών θα κάνουν τη δημιουργία κανόνα απλούστερο και πιο εμφανή στην επόμενη ενότητα.

>[AZURE.NOTE] Μια υπηρεσία RDP για το τείχος προστασίας δεν είναι απαραίτητος για δύο λόγους. το τείχος προστασίας Εικονική είναι μια εικόνα Linux με βάση, ώστε να SSH θα χρησιμοποιηθεί στη θύρα 22 για τη Διαχείριση Εικονική αντί για RDP και 2) θύρα 22 και δύο άλλους θύρες διαχείρισης επιτρέπονται στον πρώτο κανόνα διαχείρισης που περιγράφεται παρακάτω για να επιτρέψετε τη Διαχείριση συνδεσιμότητας πρώτης 1).

### <a name="firewall-rules-creation"></a>Δημιουργία κανόνων τείχους προστασίας
Υπάρχουν τρεις τύποι κανόνες τείχους προστασίας που χρησιμοποιούνται σε αυτό το παράδειγμα, όλοι έχουν distinct εικονίδια:

Ο κανόνας εφαρμογής ανακατεύθυνση: ![Ανακατεύθυνση εικονίδιο εφαρμογής][7]

Ο κανόνας NAT προορισμός: ![Εικονίδιο NAT προορισμού][8]

Ο κανόνας πέρασμα: ![Μεταβιβάζουν εικονίδιο][9]

Μπορείτε να βρείτε περισσότερες πληροφορίες σχετικά με αυτούς τους κανόνες στην τοποθεσία web του Barracuda.

Για να δημιουργήσετε τους παρακάτω κανόνες (ή να επαληθεύσετε υπάρχοντα προεπιλεγμένους κανόνες), ξεκινώντας από τον πίνακα εργαλείων του προγράμματος-πελάτη Barracuda ΣΗ διαχείρισης, μεταβείτε στην καρτέλα ρύθμισης παραμέτρων, στη ρύθμιση παραμέτρων λειτουργίας ενότητας, κάντε κλικ στην επιλογή Ruleset. Ένα πλέγμα που ονομάζεται, "Κύριες κανόνων" θα εμφανίζονται οι υπάρχοντες κανόνες ενεργό και απενεργοποιημένη σε αυτό το τείχος προστασίας. Στην επάνω δεξιά γωνία του πλέγματος αυτό είναι ένα μικρό, πράσινο "+" κουμπί, κάντε κλικ για να δημιουργήσετε έναν νέο κανόνα (Σημείωση: το τείχος προστασίας σας μπορεί να είναι "κλειδωμένο" για τις αλλαγές, εάν δείτε ένα κουμπί σήμανση "Κλείδωμα" και δεν μπορείτε να δημιουργήσετε ή να επεξεργαστείτε τους κανόνες, επιλέξτε αυτό το κουμπί για να "Ξεκλείδωμα" το σύνολο κανόνων και να επιτρέπεται η επεξεργασία). Εάν θέλετε να επεξεργαστείτε έναν υπάρχοντα κανόνα, επιλέξτε αυτόν τον κανόνα, κάντε δεξί κλικ και επιλέξτε Επεξεργασία κανόνα.

Μόλις κανόνων σας έχουν δημιουργηθεί ή/και τροποποίηση, να προωθούνται στις το τείχος προστασίας και, στη συνέχεια, ενεργοποιηθεί, εάν αυτό δεν γίνεται τις αλλαγές κανόνα θα τεθούν σε ισχύ. Η διαδικασία push και την ενεργοποίηση περιγράφεται παρακάτω περιγραφές των κανόνων λεπτομέρειες.

Το λεπτομέρειες σχετικά με κάθε κανόνα που απαιτείται για την ολοκλήρωση αυτό το παράδειγμα περιγράφονται ως εξής:

- **Τείχος προστασίας διαχείρισης κανόνα**: επιτρέπει την ανακατεύθυνση αυτή εφαρμογή κανόνα κυκλοφορίας μεταβιβάζουν τις θύρες διαχείρισης της συσκευής εικονικού δικτύου, σε αυτό το παράδειγμα τείχος προστασίας NextGen Barracuda. Οι θύρες διαχείρισης είναι 801, 807 και προαιρετικά 22. Οι θύρες εξωτερικών και εσωτερικών είναι η ίδια (δηλαδή, δεν υπάρχει μετάφραση θύρας). Αυτό κανόνα, ΡΎΘΜΙΣΗ Διαχείρισης ΠΡΌΣΒΑΣΗ, είναι ένας κανόνας προεπιλογή και ενεργοποιημένες από προεπιλογή (στο τείχος προστασίας NextGen Barracuda έκδοση 6.1).

    ![Κανόνας διαχείρισης τείχους προστασίας][10]

>[AZURE.TIP] Ο χώρος διεύθυνσης προέλευσης αυτός ο κανόνας είναι οποιαδήποτε, εάν η διαχείριση περιοχές διευθύνσεων IP είναι γνωστό, η μείωση αυτή την εμβέλεια επίσης να μειωθεί η επιφάνεια επίθεση για τις θύρες διαχείρισης.

- **Κανόνες RDP**: κανόνες αυτών των NAT προορισμού θα επιτρέπεται η διαχείριση των μεμονωμένων διακομιστών μέσω RDP.
Υπάρχουν τέσσερις κρίσιμης πεδία που απαιτούνται για να δημιουργήσετε αυτόν τον κανόνα:
  1.    Προέλευση – για να επιτρέψετε RDP από οπουδήποτε, η αναφορά "Οποιαδήποτε" χρησιμοποιείται στο πεδίο προέλευσης.
  2.    Υπηρεσία-χρησιμοποιήστε το κατάλληλο αντικείμενο υπηρεσίας που δημιουργήσατε νωρίτερα, σε αυτήν την περίπτωση "AppVM01 RDP", οι εξωτερικές θύρες ανακατεύθυνση για να την τοπική διεύθυνση IP διακομιστές και στη θύρα 3386 (η προεπιλεγμένη θύρα RDP). Αυτός ο κανόνας συγκεκριμένες είναι για την πρόσβαση RDP AppVM01.
  3.    Προορισμός – πρέπει να είναι η *τοπική θύρα του τείχους προστασίας*, "DCHP 1 τοπική διεύθυνση IP" ή eth0 Εάν χρησιμοποιείτε στατικές διευθύνσεις IP. Ο αριθμός σειράς (eth0, eth1, κλπ) μπορεί να διαφέρουν εάν σας συσκευής δικτύου έχει πολλές τοπικές διασυνδέσεις. Πρόκειται για τη θύρα στέλνει το τείχος προστασίας εκτός από (μπορεί να είναι ίδια με τη λήψη θύρα), είναι η πραγματική δρομολόγηση προορισμού στο πεδίο λίστα προορισμού.
  4.    Ανακατεύθυνση – αυτή η ενότητα σας ενημερώνει εικονικού συσκευής πού να τελικά ανακατευθύνετε την κίνηση σε αυτό. Την ανακατεύθυνση απλούστερος είναι να τοποθετήσετε (προαιρετικό) η διεύθυνση IP και θύρες στο πεδίο λίστα προορισμού. Εάν δεν υπάρχει θύρα χρησιμοποιείται στη θύρα προορισμού σε εισερχόμενης αίτησης θα χρησιμοποιούνται (ie δεν υπάρχει μετάφραση), εάν μια θύρα έχει προσδιοριστεί τη θύρα θα είναι επίσης NAT θα μαζί με το IP διεύθυνση.

    ![Κανόνας RDP τείχους προστασίας][11]

    Ένα σύνολο κανόνων τέσσερις RDP θα πρέπει να δημιουργηθεί: 

  	|   Όνομα κανόνα    | Διακομιστή  |   Υπηρεσία   |  Λίστα προορισμού  |
  	|----------------|---------|-------------|---------------|
  	| RDP-IIS01   | IIS01   | IIS01 RDP   | 10.0.1.4:3389 |
  	| RDP-DNS01   | DNS01   | DNS01 RDP   | 10.0.2.4:3389 |
  	| RDP-AppVM01 | AppVM01 | AppVM01 RDP | 10.0.2.5:3389 |
  	| RDP-AppVM02 | AppVM02 | AppVm02 RDP | 10.0.2.6:3389 |
  
>[AZURE.TIP] Απομόνωση προς τα κάτω το εύρος των πεδίων προέλευσης και υπηρεσία θα μειωθεί η επιφάνεια επίθεση. Πρέπει να χρησιμοποιείται η πιο περιορισμένο εύρος που θα σας επιτρέψει λειτουργίες.

- **Εφαρμογή κανόνων κίνηση**: υπάρχουν δύο κανόνες κίνηση εφαρμογής, το πρώτο για την κυκλοφορία web προσκηνίου και το δεύτερο για την κυκλοφορία παρασκηνίου (π.χ. διακομιστή web σε σειρά δεδομένων). Αυτοί οι κανόνες θα εξαρτώνται από την αρχιτεκτονική δικτύου (όπου τοποθετούνται διακομιστές σας) και κυκλοφορίας ροών (ποια κατεύθυνση χρησιμοποιούνται οι ροές κίνηση και ποιες θύρες).

    Πρώτα αναφέρονται είναι ο κανόνας προσκηνίου για την κίνηση web:

    ![Κανόνας Web τείχους προστασίας][12]
 
    Αυτός ο κανόνας προορισμού NAT επιτρέπει την κυκλοφορία πραγματική εφαρμογή για την επίτευξη στο διακομιστή εφαρμογών. Ενώ οι άλλοι κανόνες που επιτρέπουν για την ασφάλεια, διαχείριση, κ.λπ., εφαρμογή κανόνων είναι τι να επιτρέπεται σε εξωτερικούς χρήστες ή τις υπηρεσίες για να αποκτήσετε πρόσβαση τις εφαρμογές. Για αυτό το παράδειγμα, υπάρχει ένα διακομιστή web μόνο στη θύρα 80, επομένως, ο κανόνας εφαρμογής μόνο τείχος προστασίας θα ανακατευθύνετε την κίνηση εισερχομένων για την εξωτερική IP, με τη διεύθυνση IP web διακομιστών εσωτερικής.

    **Σημείωση**: που δεν έχει θύρα στους οποίους έχουν ανατεθεί στο πεδίο λίστα προορισμού, έτσι θα χρησιμοποιηθεί η εισερχόμενη θύρα 80 (ή 443 για την υπηρεσία επιλεγμένο) στο την ανακατεύθυνση του διακομιστή web. Εάν ο διακομιστής web λαμβάνει σε διαφορετική θύρα, για παράδειγμα θύρα 8080, η λίστα προορισμού θα μπορούσε να ενημερωθούν ώστε να 10.0.1.4:8080 για να επιτρέψετε την ανακατεύθυνση θύρας καθώς και.

    Η επόμενη κανόνα κυκλοφορίας εφαρμογής είναι ο κανόνας παρασκηνίου για να επιτρέψετε σε διακομιστή Web για να συνομιλήσετε με το διακομιστή AppVM01 (αλλά όχι AppVM02) μέσω οποιαδήποτε υπηρεσία:

    ![Κανόνας AppVM01 τείχους προστασίας][13]

    Αυτός ο κανόνας πέρασμα επιτρέπει σε οποιονδήποτε διακομιστή των υπηρεσιών IIS στο υποδίκτυο Frontend για την επίτευξη του AppVM01 (διεύθυνση IP 10.0.2.5) σε οποιαδήποτε θύρα, χρησιμοποιώντας οποιαδήποτε πρωτόκολλο για πρόσβαση σε δεδομένα απαιτείται από την εφαρμογή web.

    Σε αυτήν την οθόνη στιγμιότυπο ενός "\<ρητή προορισμού\>" χρησιμοποιείται στο πεδίο προορισμού για να δείχνει 10.0.2.5 ως προορισμό. Αυτό θα μπορούσε να είτε ρητή όπως φαίνεται ή με το όνομα αντικειμένου δικτύου (όπως είχε γίνει τις προϋποθέσεις για το διακομιστή DNS). Αυτό είναι έως και ο διαχειριστής του τείχους προστασίας για το ποιος θα χρησιμοποιηθεί μέθοδο. Για να προσθέσετε 10.0.2.5 ως μια Explict Desitnation, κάντε διπλό κλικ στην πρώτη κενή γραμμή στην περιοχή \<ρητή προορισμού\> και πληκτρολογήστε τη διεύθυνση στο παράθυρο που αναδύεται.

    Με αυτόν τον μεταβιβάζουν κανόνα, χωρίς NAT είναι απαραίτητο, επειδή πρόκειται για εσωτερική κυκλοφορία, ώστε η μέθοδος σύνδεσης μπορεί να οριστεί σε "Χωρίς SNAT".

    **Σημείωση**: Η προέλευση δικτύου σε αυτόν τον κανόνα είναι οποιαδήποτε πόρων στο υποδίκτυο FrontEnd, εάν θα είναι μόνο μία ή ένα συγκεκριμένο πλήθος γνωστά διακομιστές web, έναν πόρο αντικείμενο δικτύου ήταν δυνατή η δημιουργία να είναι πιο συγκεκριμένες σε αυτές τις ακριβείς διευθύνσεις IP, αντί για το ολόκληρο υποδίκτυο Frontend.

>[AZURE.TIP] Αυτός ο κανόνας χρησιμοποιεί την υπηρεσία "" για να κάνετε πιο εύκολη για να εγκαταστήσετε και να χρησιμοποιήσετε το δείγμα εφαρμογής, αυτό σας επιτρέπει επίσης ICMPv4 (ping) σε έναν κανόνα. Ωστόσο, αυτό δεν συνιστάται. Για να την ελάχιστη δυνατή που επιτρέπει τη λειτουργία της εφαρμογής για να μειώσετε την επιφάνεια επίθεση σε αυτό το όριο, θα πρέπει να είναι εντοπιστεί τις θύρες και πρωτόκολλα ("Υπηρεσίες").

<br />

>[AZURE.TIP] Αν και αυτός ο κανόνας εμφανίζει μια αναφορά ρητή προορισμού που χρησιμοποιείται, μια συνεπή προσέγγιση πρέπει να χρησιμοποιούνται σε όλη τη ρύθμιση παραμέτρων του τείχους προστασίας. Συνιστάται να ότι το αντικείμενο με όνομα δικτύου να χρησιμοποιηθεί σε όλο το για πιο εύκολη αναγνωσιμότητα και δυνατότητα υποστήριξης. Τα ρητά προορισμού χρησιμοποιείται εδώ μόνο για να εμφανίσετε μια μέθοδο εναλλακτικές αναφοράς και δεν συνιστάται Γενικά (ειδικά για σύνθετες ρυθμίσεις παραμέτρων).

- **Εξερχόμενα Internet κανόνα**: αυτό περνούν κανόνα θα επιτρέψετε την κυκλοφορία από οποιοδήποτε δίκτυο προέλευσης για τη μεταβίβαση για την επιλεγμένη δίκτυα προορισμού. Αυτός ο κανόνας είναι ένας κανόνας προεπιλεγμένη συνήθως ήδη το τείχος προστασίας Barracuda NextGen, αλλά είναι σε κατάσταση απενεργοποίησης. Δεξί κλικ σε αυτόν τον κανόνα να αποκτήσετε πρόσβαση στην εντολή ενεργοποίηση του κανόνα. Ο κανόνας που φαίνεται εδώ έχει τροποποιηθεί για να προσθέσετε δύο τοπικό δευτερεύοντα δίκτυα που έχουν δημιουργηθεί με αναφορές στην ενότητα προαπαιτούμενες αυτού του εγγράφου στο χαρακτηριστικό προέλευσης αυτού του κανόνα.

    ![Κανόνας εξερχομένων τείχους προστασίας][14]

- **Κανόνας DNS**: αυτό περνούν κανόνας επιτρέπει μόνο η κυκλοφορία DNS (θύρα 53) για τη μεταβίβαση στο διακομιστή DNS. Για αυτό το περιβάλλον έχει αποκλειστεί κίνησης περισσότερες από το FrontEnd στον υπολογιστή στο παρασκήνιο, αυτός ο κανόνας επιτρέπει συγκεκριμένα DNS.

    ![Κανόνας DNS τείχους προστασίας][15]

    **Σημείωση**: σε αυτήν την οθόνη περιλαμβάνεται στιγμιότυπο της μεθόδου σύνδεσης. Επειδή αυτός ο κανόνας είναι για εσωτερική IP για εσωτερική κυκλοφορία διεύθυνση IP, NATing δεν είναι απαραίτητο, αυτή η μέθοδος σύνδεσης έχει οριστεί σε "Χωρίς SNAT" για αυτόν τον κανόνα πέρασμα.

- **Υποδίκτυο να υποδικτύου κανόνα**: αυτό περνούν κανόνας είναι ένας κανόνας προεπιλογή που έχει ενεργοποιηθεί και τροποποίηση για να επιτρέψετε σε οποιονδήποτε διακομιστή στο υποδίκτυο παρασκηνίου για να συνδεθείτε σε οποιονδήποτε διακομιστή στο υποδίκτυο προσκηνίου. Αυτός ο κανόνας είναι όλες οι εσωτερικές κίνηση, ώστε η μέθοδος σύνδεσης μπορεί να οριστεί σε όχι SNAT.

    ![Κανόνας εντός VNet τείχους προστασίας][16]

    **Σημείωση**: το πλαίσιο ελέγχου διπλής κατεύθυνσης δεν είναι επιλεγμένο (ούτε είναι η μεταβίβαση ελέγχου του οι περισσότεροι κανόνες), αυτό είναι σημαντικό για αυτόν τον κανόνα σε που το κάνει αυτό κανόνα "μία προς μία κατεύθυνση", μπορεί να ενεργοποιηθεί και μια σύνδεση από το υποδίκτυο παρασκηνίου για το δίκτυο του υπολογιστή-πελάτη, αλλά όχι το αντίστροφο. Εάν αυτό το πλαίσιο ελέγχου έχει επιλεγεί, αυτός ο κανόνας θα Ενεργοποίηση κίνηση διπλής κατεύθυνσης, που δεν είναι επιθυμητό από μας λογική διάγραμμα.

- **Απόρριψη όλων κανόνα κυκλοφορίας**: αυτό πρέπει να είναι πάντοτε τον τελικό κανόνα (όσον αφορά την προτεραιότητα) και, όπως εάν μια κίνηση ρέει αποτυγχάνει ώστε να ταιριάζει με οποιοδήποτε από το προηγούμενο κανόνες θα καταργηθούν από αυτόν τον κανόνα. Αυτός είναι ένας κανόνας προεπιλογή και συνήθως ενεργοποιημένο, χωρίς τροποποιήσεις γενικά χρειάζονται. 

    ![Τείχος προστασίας αρνηθεί κανόνα][17]

>[AZURE.IMPORTANT] Όταν δημιουργούνται όλους τους παραπάνω κανόνες, είναι σημαντικό να αναθεωρήσετε την προτεραιότητα της κάθε κανόνα για να βεβαιωθείτε ότι θα επιτρέπεται ή δεν επιτρέπεται η σύμφωνα με τις επιθυμίες κίνηση. Για αυτό το παράδειγμα, οι κανόνες είναι με τη σειρά που πρέπει να εμφανίζονται στο πλέγμα κύριες κανόνες στο πρόγραμμα-πελάτη διαχείρισης Barracuda προώθησης.

## <a name="rule-activation"></a>Ενεργοποίηση του κανόνα
Με το ruleset τροποποίησης για την προδιαγραφή του διαγράμματος λογικής, το ruleset πρέπει να αποστείλει σε το τείχος προστασίας και, στη συνέχεια, ενεργοποιηθεί.

![Ενεργοποίηση του κανόνα τείχους προστασίας][18]
 
Στην επάνω δεξιά γωνία του προγράμματος-πελάτη διαχείρισης είναι ένα σύμπλεγμα κουμπιών. Κάντε κλικ στο κουμπί "Αποστολή αλλαγών" για να στείλετε τους κανόνες που έχουν τροποποιηθεί σε το τείχος προστασίας και, στη συνέχεια, κάντε κλικ στο κουμπί "Ενεργοποίηση".
 
Με την ενεργοποίηση του ruleset το τείχος προστασίας αυτό το παράδειγμα περιβάλλον build έχει ολοκληρωθεί.

## <a name="traffic-scenarios"></a>Κίνηση σενάρια
>[AZURE.IMPORTANT] Ένα πλήκτρο takeway είναι να θυμάστε ότι **όλη** την κυκλοφορία να παραδίδεται μέσω του τείχους προστασίας. Επομένως, για να απομακρυσμένης επιφάνειας εργασίας με το διακομιστή IIS01, παρόλο που είναι στην υπηρεσία Cloud τέλος εμπρός και στο προσκήνιο υποδίκτυο, για να αποκτήσετε πρόσβαση σε αυτόν το διακομιστή θα πρέπει να RDP για το τείχος προστασίας στη θύρα 8014, και, στη συνέχεια, να επιτρέπεται το τείχος προστασίας για να δρομολογήσετε την αίτηση RDP εσωτερικά στη θύρα RDP IIS01. Κουμπί "Σύνδεση" της πύλης Azure δεν λειτουργούν, επειδή δεν υπάρχει καμία απευθείας διαδρομή RDP για IIS01 (όσον αφορά την πύλη μπορούν να δουν). Αυτό σημαίνει ότι θα είναι όλες οι συνδέσεις από το internet για την υπηρεσία ασφαλείας και μια θύρα, π.χ. secscv001.cloudapp.net:xxxx.

Για αυτά τα σενάρια, τους παρακάτω κανόνες τείχους προστασίας πρέπει να είναι στη θέση:

1.  Διαχείριση τείχους προστασίας
2.  RDP για IIS01
3.  RDP για DNS01
4.  RDP για AppVM01
5.  RDP για AppVM02
6.  Εφαρμογή κίνησης στο Web
7.  Εφαρμογή κίνησης σε AppVM01
8.  Εξερχομένων στο Internet
9.  Frontend να DNS01
10. Κίνηση εντός υποδικτύου (πίσω end για να προσκηνίου μόνο)
11. Απόρριψη όλων

Η πραγματική τείχος προστασίας ruleset πιθανότατα θα υπάρχει πολλές άλλες κανόνες εκτός από τα εξής, τους κανόνες για κάθε δεδομένο τείχος προστασίας θα έχει επίσης τους αριθμούς διαφορετική προτεραιότητα από αυτές που παρατίθενται εδώ. Αυτό λίστας και οι σχετικές αριθμούς είναι για την παροχή συνάφεια μεταξύ απλώς αυτούς τους κανόνες έντεκα και τη σχετική προτεραιότητα μεταξύ τους. Με άλλα λόγια, το πραγματικό τείχος προστασίας, το "RDP να IIS01" μπορεί να είναι αριθμός κανόνα 5, αλλά με την προϋπόθεση ότι είναι κάτω από τον κανόνα "Διαχείριση τείχους προστασίας" και επάνω από τον κανόνα "RDP DNS01" θα στοίχιση, με σκοπό την αυτήν τη λίστα. Η λίστα θα βοηθήσει επίσης στις τα παρακάτω σενάρια επιτρέποντάς συντομία; π.χ. "FW κανόνα 9 (DNS)". Επίσης για συντομία, οι τέσσερις κανόνες RDP θα αποτελούν συνολικά ονομάζεται, "τους κανόνες RDP" όταν το σενάριο κίνηση δεν σχετίζεται με το RDP.

Ανάκληση επίσης ότι οι ομάδες ασφαλείας δικτύου είναι στην ίδια θέση για την εισερχόμενη κυκλοφορία internet σε τα δευτερεύοντα δίκτυα προσκηνίου και παρασκηνίου.

#### <a name="allowed-internet-to-web-server"></a>(Επιτρέπεται) Internet σε διακομιστή Web
1.  Σελίδα χρήστη HTTP αιτήσεις Internet από SecSvc001.CloudApp.Net (Internet υπηρεσία Cloud αντικριστές)
2.  Κίνηση φάσεις υπηρεσία cloud μέσω Άνοιγμα τελικό σημείο στη θύρα 80 τείχους προστασίας του περιβάλλοντος εργασίας σε 10.0.0.4:80
3.  Δεν υπάρχει NSG στους οποίους έχουν ανατεθεί υποδικτύου ασφαλείας, ώστε οι κανόνες NSG συστήματος επιτρέψετε την κυκλοφορία στο τείχος προστασίας
4.  Κίνηση επισκέψεις εσωτερική διεύθυνση IP του τείχους προστασίας (10.0.1.4)
5.  Τείχος προστασίας αρχίζει Επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Κανόνες FW 2-5 (RDP κανόνες) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνα 6 (εφαρμογή: Web) εφαρμόσετε, κυκλοφορία επιτρέπεται, NAT τείχους προστασίας για να 10.0.1.4 (IIS01)
6.  Το υποδίκτυο Frontend αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    Δεν ισχύει NSG κανόνας 1 (μπλοκ Internet) (αυτήν την κυκλοφορία ήταν NAT θα από το τείχος προστασίας, επομένως η διεύθυνση προέλευσης είναι τώρα το τείχος προστασίας, το οποίο βρίσκεται στο υποδίκτυο ασφαλείας και ορατό από το υποδίκτυο Frontend NSG να είναι "τοπικό" κίνηση και, επομένως, επιτρέπεται), μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
7.  IIS01 κάνει ακρόαση για κυκλοφορία web, λάβει αυτό το αίτημα και ξεκινά η επεξεργασία της αίτησης
8.  Απόπειρα IIS01 ξεκινά μια περίοδο λειτουργίας FTP να AppVM01 στο υποδίκτυο παρασκηνίου
9.  Τη διαδρομή UDR Frontend υποδικτύου καθιστά το τείχος προστασίας στην επόμενη αναπήδηση
10. Δεν υπάρχει κανόνες εξερχόμενων στο προσκήνιο υποδίκτυο, επιτρέπεται κίνηση
11. Τείχος προστασίας αρχίζει Επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Κανόνας FW 2-5 (RDP κανόνες) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνα 6 (εφαρμογή: Web) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  4.    FW κανόνα 7 (εφαρμογή: παρασκηνίου) εφαρμόσετε, κυκλοφορία επιτρέπεται, τείχος προστασίας προωθεί την κυκλοφορία στο 10.0.2.5 (AppVM01)
12. Το υποδίκτυο παρασκηνίου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    NSG κανόνας 1 (μπλοκ Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
13.  AppVM01 λαμβάνει την αίτηση και ξεκινά η περίοδος λειτουργίας και αποκρίνεται
14. Τη διαδρομή UDR στο υποδίκτυο παρασκηνίου καθιστά το τείχος προστασίας στην επόμενη αναπήδηση
15. Εφόσον δεν υπάρχουν εξερχομένων κανόνες NSG στο υποδίκτυο παρασκηνίου επιτρέπεται η απόκριση
16. Επειδή αυτό επιστρέφει την κυκλοφορία σε μια περίοδο λειτουργίας δημιουργίας το τείχος προστασίας περνά την απάντηση στο διακομιστή web (IIS01)
17. Frontend υποδικτύου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    NSG κανόνας 1 (μπλοκ Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
18. Ο διακομιστής των υπηρεσιών IIS λαμβάνει την απάντηση, ολοκληρώνει τη συναλλαγή με AppVM01 και, στη συνέχεια, ολοκληρώνεται η δημιουργία της απόκρισης HTTP, αυτή η απόκριση HTTP αποστέλλεται αιτούντα
19. Εφόσον δεν υπάρχουν εξερχομένων κανόνες NSG στο υποδίκτυο Frontend επιτρέπεται η απόκριση
20. Η απόκριση HTTP επισκέψεις το τείχος προστασίας και, επειδή αυτή είναι η απάντηση σε περίοδο λειτουργίας δημιουργίας NAT απαντηθεί από το τείχος προστασίας
21. Στη συνέχεια, το τείχος προστασίας ανακατευθύνει την απόκριση πίσω στο χρήστη στο Internet
22. Καθώς υπάρχουν δεν εξερχομένων NSG κανόνες ή μεταπηδήσεων UDR στο υποδίκτυο Frontend επιτρέπεται η απόκριση και ο χρήστης Internet λαμβάνει την ιστοσελίδα που ζητήθηκε.

#### <a name="allowed-internet-rdp-to-backend"></a>(Επιτρέπεται) Internet RDP για υπολογιστή στο παρασκήνιο
1.  Διαχειριστής του διακομιστή στο internet αιτήσεις RDP περίοδο λειτουργίας να AppVM01 μέσω SecSvc001.CloudApp.Net:8025, όπου 8025 είναι ο αριθμός θύρας χρήστη που έχουν εκχωρηθεί για τον κανόνα "RDP AppVM01" Τείχος προστασίας
2.  Η υπηρεσία cloud μεταφέρει την κίνηση μέσω το άνοιγμα τελικό σημείο στη θύρα 8025 τείχους προστασίας του περιβάλλοντος εργασίας σε 10.0.0.4:8025
3.  Δεν υπάρχει NSG στους οποίους έχουν ανατεθεί υποδικτύου ασφαλείας, ώστε οι κανόνες NSG συστήματος επιτρέψετε την κυκλοφορία στο τείχος προστασίας
4.  Τείχος προστασίας αρχίζει Επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    FW κανόνα 2 (RDP IIS) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνα 3 (RDP DNS01) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  4.    Εφαρμογή κανόνα FW 4 (RDP AppVM01), επιτρέπεται κίνηση, NAT τείχους προστασίας για να 10.0.2.5:3386 (θύρα RDP στον AppVM01)
5.  Το υποδίκτυο παρασκηνίου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    Δεν ισχύει NSG κανόνας 1 (μπλοκ Internet) (αυτήν την κυκλοφορία ήταν NAT θα από το τείχος προστασίας, επομένως η διεύθυνση προέλευσης είναι τώρα το τείχος προστασίας, το οποίο βρίσκεται στο υποδίκτυο ασφαλείας και ορατό από το υποδίκτυο παρασκηνίου NSG να είναι "τοπικό" κίνηση και, επομένως, επιτρέπεται), μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
6.  AppVM01 κάνει ακρόαση για κυκλοφορία RDP και απαντούν
7.  Με καμία κανόνες εξερχόμενων NSG προεπιλεγμένους κανόνες ισχύουν και επιτρέπεται η κυκλοφορία επιστροφής
8.  UDR δρομολογεί την εξερχόμενη κυκλοφορία για το τείχος προστασίας ως την επόμενη μεταπήδηση
9.  Επειδή αυτό επιστρέφει την κυκλοφορία σε μια περίοδο λειτουργίας δημιουργίας το τείχος προστασίας περνά την απόκριση πίσω στο χρήστη στο internet
10. Είναι ενεργοποιημένη η περίοδος RDP
11. AppVM01 ζητά κωδικού πρόσβασης χρήστη

#### <a name="allowed-web-server-dns-lookup-on-dns-server"></a>(Επιτρέπεται) Αναζήτηση DNS διακομιστή Web στο διακομιστή DNS
1.  Web Server, IIS01, τροφοδοσία δεδομένων στο www.data.gov τις ανάγκες, αλλά πρέπει να επιλύσετε τη διεύθυνση.
2.  Η ρύθμιση παραμέτρων δικτύου για τις λίστες VNet DNS01 (10.0.2.4 στο υποδίκτυο παρασκηνίου) ως πρωτεύοντα διακομιστή DNS, IIS01 στέλνει την αίτηση DNS για να DNS01
3.  UDR δρομολογεί την εξερχόμενη κυκλοφορία για το τείχος προστασίας ως την επόμενη μεταπήδηση
4.  Δεν υπάρχει κανόνες εξερχόμενων NSG είναι συνδεδεμένες με το υποδίκτυο Frontend, επιτρέπεται κίνηση
5.  Τείχος προστασίας αρχίζει Επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Κανόνας FW 2-5 (RDP κανόνες) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνες 6 και 7 (εφαρμογή κανόνων) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  4.    FW κανόνα 8 (στο Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  5.    Εφαρμογή FW κανόνα 9 (DNS), κυκλοφορία επιτρέπεται, τείχος προστασίας προωθεί την κυκλοφορία στο 10.0.2.4 (DNS01)
6.  Το υποδίκτυο παρασκηνίου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    NSG κανόνας 1 (μπλοκ Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
7.  Διακομιστή DNS λαμβάνει την αίτηση
8.  Διακομιστής DNS δεν έχει τη διεύθυνση στο cache και ζητά από ένα διακομιστή DNS ρίζας στο internet
9.  UDR δρομολογεί την εξερχόμενη κυκλοφορία για το τείχος προστασίας ως την επόμενη μεταπήδηση
10. Δεν υπάρχει NSG κανόνες εξερχόμενων υποδικτύου παρασκηνίου, επιτρέπεται κίνηση
11. Τείχος προστασίας αρχίζει Επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Κανόνας FW 2-5 (RDP κανόνες) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνες 6 και 7 (εφαρμογή κανόνων) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  4.     Εφαρμογή κανόνα FW 8 (στο Internet), κυκλοφορία επιτρέπεται, περιόδου λειτουργίας είναι SNAT ανάληψη στον ριζικό διακομιστή DNS στο Internet
12. Απόκριση διακομιστή DNS στο Internet, επειδή αυτήν την περίοδο λειτουργίας ξεκίνησε από το τείχος προστασίας, την απάντηση απαντηθεί από το τείχος προστασίας
13. Καθώς πρόκειται για μια περίοδο λειτουργίας δημιουργίας, το τείχος προστασίας προωθεί την απάντηση στο διακομιστή προετοιμασία, DNS01
14. Το υποδίκτυο παρασκηνίου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    NSG κανόνας 1 (μπλοκ Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
15. Ο διακομιστής DNS λαμβάνει και αποθηκεύει προσωρινά την απόκριση και, στη συνέχεια, απαντούν στην αρχική αίτηση επιστροφής σε IIS01
16. Τη διαδρομή UDR στο υποδίκτυο παρασκηνίου καθιστά το τείχος προστασίας στην επόμενη αναπήδηση
17. Δεν υπάρχει κανόνες εξερχόμενων NSG υπάρχει στο υποδίκτυο παρασκηνίου, επιτρέπεται κίνηση
18. Αυτή είναι μια περίοδο λειτουργίας δημιουργίας του τείχους προστασίας, η απόκριση προωθείται από το τείχος προστασίας στο διακομιστή των υπηρεσιών IIS
19. Frontend υποδικτύου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    Δεν υπάρχει κανένας κανόνας NSG που ισχύει για εισερχόμενα κίνησης από το υποδίκτυο παρασκηνίου στο προσκήνιο υποδίκτυο, ώστε να κανένα από τα NSG κανόνες ισχύουν
  2.    Ο προεπιλεγμένος κανόνας σύστημα επιτρέποντας την κυκλοφορία μεταξύ δευτερευόντων δικτύων να επιτρέψετε την κυκλοφορία αυτό, ώστε να επιτρέπεται η κίνηση
20. IIS01 λαμβάνει την απάντηση από DNS01

#### <a name="allowed-backend-server-to-frontend-server"></a>(Επιτρέπεται) Διακομιστή παρασκηνίου Frontend διακομιστή
1.  Ο διαχειριστής συνδεδεμένοι στο AppVM02 μέσω RDP ζητά ένα αρχείο απευθείας από το διακομιστή IIS01 μέσω Εξερεύνηση αρχείων των windows
2.  Τη διαδρομή UDR στο υποδίκτυο παρασκηνίου καθιστά το τείχος προστασίας στην επόμενη αναπήδηση
3.  Εφόσον δεν υπάρχουν εξερχομένων κανόνες NSG στο υποδίκτυο παρασκηνίου επιτρέπεται η απόκριση
4.  Τείχος προστασίας αρχίζει Επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Κανόνας FW 2-5 (RDP κανόνες) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνες 6 και 7 (εφαρμογή κανόνων) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  4.    FW κανόνα 8 (στο Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  5.    FW κανόνα 9 (DNS) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  6.    Εφαρμογή κανόνα 10 FW (εντός-υποδίκτυο), κυκλοφορία επιτρέπεται, τείχος προστασίας μεταφέρει κίνηση 10.0.1.4 (IIS01)
5.  Frontend υποδικτύου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    NSG κανόνας 1 (μπλοκ Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
6.  Υπό την προϋπόθεση ότι proper ελέγχου ταυτότητας και εξουσιοδότησης, IIS01 αποδέχεται το αίτημα και απαντούν
7.  Τη διαδρομή UDR Frontend υποδικτύου καθιστά το τείχος προστασίας στην επόμενη αναπήδηση
8.  Εφόσον δεν υπάρχουν εξερχομένων κανόνες NSG στο υποδίκτυο Frontend επιτρέπεται η απόκριση
9.  Καθώς πρόκειται για μια υπάρχουσα περίοδο λειτουργίας του τείχους προστασίας επιτρέπεται αυτή η απόκριση και το τείχος προστασίας επιστρέφει την απάντηση AppVM02
10. Υποδίκτυο παρασκηνίου αρχίζει Επεξεργασία κανόνα εισερχομένων:
  1.    NSG κανόνας 1 (μπλοκ Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Προεπιλεγμένους κανόνες NSG επιτρέψετε την κυκλοφορία υποδικτύου σε υποδίκτυο, κυκλοφορία επιτρέπεται, διακόψτε NSG Επεξεργασία κανόνα
11. AppVM02 λαμβάνει την απάντηση

#### <a name="denied-internet-direct-to-web-server"></a>(Δεν επιτρέπεται η) Απευθείας σε διακομιστή Web στο Internet
1.  Χρήστης του Internet προσπαθεί να αποκτήσει πρόσβαση στο διακομιστή web, IIS01, μέσω της υπηρεσίας FrontEnd001.CloudApp.Net
2.  Καθώς υπάρχουν ανοιχτά για την κίνηση HTTP χωρίς τα τελικά σημεία, αυτό θα δεν διέρχονται από την υπηρεσία Cloud και δεν θα επικοινωνήσει με το διακομιστή
3.  Εάν τα τελικά σημεία ανοιχτό για κάποιο λόγο, η NSG (μπλοκ Internet) στο υποδίκτυο Frontend να αποκλείσετε αυτήν την κυκλοφορία
4.  Τέλος, τη διαδρομή Frontend υποδικτύου UDR στέλνατε οποιοδήποτε εξερχόμενη κυκλοφορία από IIS01 για το τείχος προστασίας ως την επόμενη μεταπήδηση και το τείχος προστασίας θα δείτε αυτό ως ασύμμετρη κυκλοφορία και αποθέστε την εξερχόμενη απάντηση, επομένως, υπάρχουν τουλάχιστον τρεις ανεξάρτητες επίπεδα άμυνας ανάμεσα στο internet και IIS01 μέσω υπηρεσία cloud αποτροπή μη εξουσιοδοτημένο/ακατάλληλου πρόσβασης.

#### <a name="denied-internet-to-backend-server"></a>(Δεν επιτρέπεται η) Internet για να διακομιστή παρασκηνίου
1.  Internet χρήστης προσπαθήσει να αποκτήσετε πρόσβαση σε ένα αρχείο στο AppVM01 μέσω της υπηρεσίας BackEnd001.CloudApp.Net
2.  Καθώς υπάρχουν χωρίς τα τελικά σημεία ανοιχτό για κοινή χρήση αρχείων, αυτό θα περάσει την υπηρεσία Cloud και δεν θα επικοινωνήσει με το διακομιστή
3.  Εάν τα τελικά σημεία ανοιχτό για κάποιο λόγο, η NSG (μπλοκ Internet) να αποκλείσετε αυτήν την κυκλοφορία
4.  Τέλος, τη διαδρομή UDR στέλνατε οποιοδήποτε εξερχόμενη κυκλοφορία από AppVM01 για το τείχος προστασίας ως την επόμενη μεταπήδηση και το τείχος προστασίας θα δείτε αυτό ως ασύμμετρη κυκλοφορία και αποθέστε την εξερχόμενη απάντηση, επομένως, υπάρχουν τουλάχιστον τρεις ανεξάρτητες επίπεδα άμυνας ανάμεσα στο internet και AppVM01 μέσω υπηρεσία cloud αποτροπή μη εξουσιοδοτημένο/ακατάλληλου πρόσβασης.

#### <a name="denied-frontend-server-to-backend-server"></a>(Δεν επιτρέπεται η) Frontend διακομιστή σε διακομιστή παρασκηνίου
1.  Ας υποθέσουμε IIS01 έχει παραβιαστεί και εκτελεί κακόβουλο κώδικα που προσπαθείτε να σαρώσετε τους διακομιστές υποδικτύου παρασκηνίου.
2.  Τη διαδρομή Frontend υποδικτύου UDR θα στείλετε οποιαδήποτε εξερχόμενη κυκλοφορία από IIS01, για να το τείχος προστασίας ως την επόμενη μεταπήδηση. Αυτό δεν είναι κάτι που μπορεί να τροποποιηθεί από την εικονική Μηχανή έχει παραβιαστεί.
3.  Το τείχος προστασίας θα επεξεργαστεί την κυκλοφορία, αν το αίτημα ήταν AppVM01 ή σε διακομιστή DNS για αναζητήσεις DNS που κίνηση θα μπορούσε πιθανώς να επιτρέπεται από το τείχος προστασίας (λόγω FW κανόνες 7 και 9). Όλη την κυκλοφορία άλλων θα έχει αποκλειστεί από FW κανόνα 11 (απόρριψη όλων).
4.  Εάν για προχωρημένους εντοπισμού απειλή ενεργοποιήθηκε το τείχος προστασίας (που δεν καλύπτεται σε αυτό το έγγραφο, ανατρέξτε στην τεκμηρίωση προμηθευτή για το συγκεκριμένο δίκτυο συσκευής προηγμένων δυνατοτήτων απειλή), ακόμα και την κυκλοφορία που θα επιτρέπεται από τους κανόνες βασικές προώθησης που αναφέρονται σε αυτό το έγγραφο μπορεί να μην επιτρέπεται εάν η κίνηση που περιέχονται γνωστά υπογραφές ή μοτίβα που επισημάνετε έναν κανόνα για προχωρημένους απειλή.

#### <a name="denied-internet-dns-lookup-on-dns-server"></a>(Δεν επιτρέπεται η) Αναζήτηση στο Internet DNS στο διακομιστή DNS
1.  Internet χρήστης προσπαθήσει να αναζητήσετε μια εσωτερική εγγραφή DNS στην DNS01 μέσω της υπηρεσίας BackEnd001.CloudApp.Net 
2.  Εφόσον δεν υπάρχουν ανοιχτά για την κίνηση DNS χωρίς τα τελικά σημεία, αυτό θα δεν διέρχονται από την υπηρεσία Cloud και δεν θα επικοινωνήσει με το διακομιστή
3.  Εάν τα τελικά σημεία ανοιχτό για κάποιο λόγο, ο κανόνας NSG (μπλοκ Internet) στο υποδίκτυο Frontend να αποκλείσετε αυτήν την κυκλοφορία
4.  Τέλος, τη διαδρομή UDR υποδικτύου παρασκηνίου στέλνατε οποιοδήποτε εξερχόμενη κυκλοφορία από DNS01 για το τείχος προστασίας ως την επόμενη μεταπήδηση και το τείχος προστασίας θα δείτε αυτό ως ασύμμετρη κυκλοφορία και αποθέστε την απάντηση εξερχομένων, επομένως, υπάρχουν τουλάχιστον τρεις ανεξάρτητες επίπεδα άμυνας ανάμεσα στο internet και DNS01 μέσω υπηρεσία cloud αποτροπή μη εξουσιοδοτημένο/ακατάλληλου πρόσβασης.

#### <a name="denied-internet-to-sql-access-through-firewall"></a>(Δεν επιτρέπεται η) Internet για πρόσβαση σε SQL μέσω του τείχους προστασίας
1.  Internet χρήστης ζητάει δεδομένα SQL από SecSvc001.CloudApp.Net (Internet υπηρεσία Cloud αντικριστές)
2.  Εφόσον δεν τα τελικά σημεία είναι ανοιχτό για SQL, αυτό δεν θα μεταβιβάζουν την υπηρεσία Cloud και δεν θα επίτευξη το τείχος προστασίας
3.  Εάν τελικά σημεία SQL ανοιχτό για κάποιο λόγο, το τείχος προστασίας θα ξεκινήσει η επεξεργασία κανόνα:
  1.    FW κανόνας 1 (διαχείρισης FW) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  2.    Κανόνες FW 2-5 (RDP κανόνες) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  3.    FW κανόνα 6 και 7 (εφαρμογή κανόνων) δεν ισχύουν, μετακίνηση στο επόμενο κανόνα
  4.    FW κανόνα 8 (στο Internet) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  5.    FW κανόνα 9 (DNS) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  6.    10 κανόνα FW (εντός-υποδίκτυο) δεν εφαρμόζονται, μετακίνηση στο επόμενο κανόνα
  7.    Εφαρμογή FW κανόνα 11 (απόρριψη όλων), κίνηση είναι αποκλεισμένοι, διακόψτε κανόνα επεξεργασίας


## <a name="references"></a>Αναφορές
### <a name="main-script-and-network-config"></a>Κύρια δέσμη ενεργειών και ρύθμισης παραμέτρων δικτύου
Αποθηκεύστε την πλήρη δέσμη ενεργειών σε ένα αρχείο δέσμης ενεργειών του PowerShell. Αποθηκεύστε το ρύθμισης παραμέτρων δικτύου, σε ένα αρχείο με το όνομα "NetworkConf2.xml".
Τροποποιήστε τις μεταβλητές που ορίζονται από το χρήστη, όπως απαιτείται. Εκτελέστε τη δέσμη ενεργειών και, στη συνέχεια, ακολουθήστε τις οδηγίες της εγκατάστασης κανόνα του τείχους προστασίας που είναι παραπάνω.

#### <a name="full-script"></a>Πλήρης δέσμης ενεργειών
Αυτή η δέσμη ενεργειών θα, με βάση τις μεταβλητές που ορίζονται από το χρήστη:

1.  Σύνδεση με μια συνδρομή του Azure
2.  Δημιουργία νέου λογαριασμού χώρου αποθήκευσης
3.  Δημιουργήστε μια νέα VNet και τρία δευτερεύοντα δίκτυα όπως ορίζεται στο αρχείο ρύθμισης παραμέτρων δικτύου
4.  Δημιουργία πέντε εικονικές μηχανές; 1 τείχος προστασίας και 4 windows server ΣΠΣ
5.  Ρύθμιση παραμέτρων του UDR όπως:
  1.    Δημιουργία δύο νέων δρομολόγηση πινάκων
  2.    Προσθήκη δρομολογεί στους πίνακες
  3.    Συνδέσετε πίνακες με κατάλληλο δευτερεύοντα δίκτυα
6.  Ενεργοποίηση της προώθησης IP σε το NVA
7.  Ρύθμιση παραμέτρων NSG όπως:
  1.    Δημιουργία μιας NSG
  2.    Προσθήκη κανόνα
  3.    Σύνδεση του NSG με το κατάλληλο δευτερεύοντα δίκτυα

Αυτή η δέσμη ενεργειών PowerShell πρέπει να εκτελείται τοπικά και στο internet συνδεδεμένοι PC ή το διακομιστή.

>[AZURE.IMPORTANT] Κατά την εκτέλεση αυτής της δέσμης ενεργειών, μπορεί να υπάρχουν προειδοποιήσεις ή άλλα μηνύματα πληροφοριών που pop στο PowerShell. Μόνο τα μηνύματα σφάλματος σε κόκκινο χρώμα είναι αιτία για το πρόβλημα.

    <# 
     .SYNOPSIS
      Example of DMZ and User Defined Routing in an isolated network (Azure only, no hybrid connections)
    
     .DESCRIPTION
      This script will build out a sample DMZ setup containing:
       - A default storage account for VM disks
       - Three new cloud services
       - Three Subnets (SecNet, FrontEnd, and BackEnd subnets)
       - A Network Virtual Appliance (NVA), in this case a Barracuda NextGen Firewall
       - One server on the FrontEnd Subnet
       - Three Servers on the BackEnd Subnet
       - IP Forwading from the FireWall out to the internet
       - User Defined Routing FrontEnd and BackEnd Subnets to the NVA
    
      Before running script, ensure the network configuration file is created in
      the directory referenced by $NetworkConfigFile variable (or update the
      variable to reflect the path and file name of the config file being used).
    
     .Notes
      Everyone's security requirements are different and can be addressed in a myriad of ways.
      Please be sure that any sensitive data or applications are behind the appropriate
      layer(s) of protection. This script serves as an example of some of the techniques
      that can be used, but should not be used for all scenarios. You are responsible to
      assess your security needs and the appropriate protections needed, and then effectively
      implement those protections.
    
      Security Service (SecNet subnet 10.0.0.0/24)
       myFirewall - 10.0.0.4
     
      FrontEnd Service (FrontEnd subnet 10.0.1.0/24)
       IIS01      - 10.0.1.4
     
      BackEnd Service (BackEnd subnet 10.0.2.0/24)
       DNS01      - 10.0.2.4
       AppVM01    - 10.0.2.5
       AppVM02    - 10.0.2.6
    
    #>
    
    # Fixed Variables
        $LocalAdminPwd = Read-Host -Prompt "Enter Local Admin Password to be used for all VMs"
        $VMName = @()
        $ServiceName = @()
        $VMFamily = @()
        $img = @()
        $size = @()
        $SubnetName = @()
        $VMIP = @()
    
    # User Defined Global Variables
      # These should be changes to reflect your subscription and services
      # Invalid options will fail in the validation section
    
      # Subscription Access Details
        $subID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    
      # VM Account, Location, and Storage Details
        $LocalAdmin = "theAdmin"
        $DeploymentLocation = "Central US"
        $StorageAccountName = "vmstore02"
    
      # Service Details
        $SecureService = "SecSvc001"
        $FrontEndService = "FrontEnd001"
        $BackEndService = "BackEnd001"
    
      # Network Details
        $VNetName = "CorpNetwork"
        $VNetPrefix = "10.0.0.0/16"
        $SecNet = "SecNet"
        $FESubnet = "FrontEnd"
        $FEPrefix = "10.0.1.0/24"
        $BESubnet = "BackEnd"
        $BEPrefix = "10.0.2.0/24"
        $NetworkConfigFile = "C:\Scripts\NetworkConf3.xml"
    
      # VM Base Disk Image Details
        $SrvImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Windows Server 2012 R2 Datacenter'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}
        $FWImg = Get-AzureVMImage | Where {$_.ImageFamily -match 'Barracuda NextGen Firewall'} | sort PublishedDate -Descending | Select ImageName -First 1 | ForEach {$_.ImageName}
    
      # UDR Details
        $FERouteTableName = "FrontEndSubnetRouteTable"
        $BERouteTableName = "BackEndSubnetRouteTable"
    
      # NSG Details
        $NSGName = "MyVNetSG"
    
    # User Defined VM Specific Config
        # Note: To ensure UDR and IP forwarding is setup
        # properly this script requires VM 0 be the NVA.
    
        # VM 0 - The Network Virtual Appliance (NVA)
          $VMName += "myFirewall"
          $ServiceName += $SecureService
          $VMFamily += "Firewall"
          $img += $FWImg
          $size += "Small"
          $SubnetName += $SecNet
          $VMIP += "10.0.0.4"
    
        # VM 1 - The Web Server
          $VMName += "IIS01"
          $ServiceName += $FrontEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $FESubnet
          $VMIP += "10.0.1.4"
    
        # VM 2 - The First Appliaction Server
          $VMName += "AppVM01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.5"
    
        # VM 3 - The Second Appliaction Server
          $VMName += "AppVM02"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.6"
    
        # VM 4 - The DNS Server
          $VMName += "DNS01"
          $ServiceName += $BackEndService
          $VMFamily += "Windows"
          $img += $SrvImg
          $size += "Standard_D3"
          $SubnetName += $BESubnet
          $VMIP += "10.0.2.4"
    
    # ----------------------------- #
    # No User Defined Varibles or   #
    # Configuration past this point #
    # ----------------------------- #
    
      # Get your Azure accounts
        Add-AzureAccount
        Set-AzureSubscription –SubscriptionId $subID -ErrorAction Stop
        Select-AzureSubscription -SubscriptionId $subID -Current -ErrorAction Stop
    
      # Create Storage Account
        If (Test-AzureName -Storage -Name $StorageAccountName) { 
            Write-Host "Fatal Error: This storage account name is already in use, please pick a diffrent name." -ForegroundColor Red
            Return}
        Else {Write-Host "Creating Storage Account" -ForegroundColor Cyan 
              New-AzureStorageAccount -Location $DeploymentLocation -StorageAccountName $StorageAccountName}
    
      # Update Subscription Pointer to New Storage Account
        Write-Host "Updating Subscription Pointer to New Storage Account" -ForegroundColor Cyan 
        Set-AzureSubscription –SubscriptionId $subID -CurrentStorageAccountName $StorageAccountName -ErrorAction Stop
    
    # Validation
    $FatalError = $false
    
    If (-Not (Get-AzureLocation | Where {$_.DisplayName -eq $DeploymentLocation})) {
         Write-Host "This Azure Location was not found or available for use" -ForegroundColor Yellow
         $FatalError = $true}
    
    If (Test-AzureName -Service -Name $SecureService) { 
        Write-Host "The SecureService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The FrontEndService service name is valid for use." -ForegroundColor Green}
    
    If (Test-AzureName -Service -Name $FrontEndService) { 
        Write-Host "The FrontEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The FrontEndService service name is valid for use" -ForegroundColor Green}
    
    If (Test-AzureName -Service -Name $BackEndService) { 
        Write-Host "The BackEndService service name is already in use, please pick a different service name." -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The BackEndService service name is valid for use." -ForegroundColor Green}
    
    If (-Not (Test-Path $NetworkConfigFile)) { 
        Write-Host 'The network config file was not found, please update the $NetworkConfigFile variable to point to the network config xml file.' -ForegroundColor Yellow
        $FatalError = $true}
    Else { Write-Host "The network config file was found" -ForegroundColor Green
            If (-Not (Select-String -Pattern $DeploymentLocation -Path $NetworkConfigFile)) {
                Write-Host 'The deployment location was not found in the network config file, please check the network config file to ensure the $DeploymentLocation varible is correct and the netowrk config file matches.' -ForegroundColor Yellow
                $FatalError = $true}
            Else { Write-Host "The deployment location was found in the network config file." -ForegroundColor Green}}
    
    If ($FatalError) {
        Write-Host "A fatal error has occured, please see the above messages for more information." -ForegroundColor Red
        Return}
    Else { Write-Host "Validation passed, now building the environment." -ForegroundColor Green}
    
    # Create VNET
        Write-Host "Creating VNET" -ForegroundColor Cyan 
        Set-AzureVNetConfig -ConfigurationPath $NetworkConfigFile -ErrorAction Stop
    
    # Create Services
        Write-Host "Creating Services" -ForegroundColor Cyan
        New-AzureService -Location $DeploymentLocation -ServiceName $SecureService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $FrontEndService -ErrorAction Stop
        New-AzureService -Location $DeploymentLocation -ServiceName $BackEndService -ErrorAction Stop
    
    # Build VMs
        $i=0
        $VMName | Foreach {
            Write-Host "Building $($VMName[$i])" -ForegroundColor Cyan
            If ($VMFamily[$i] -eq "Firewall") 
                { 
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Linux -LinuxUser $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                # Set up all the EndPoints we'll need once we're up and running
                # Note: All traffic goes through the firewall, so we'll need to set up all ports here.
                #       Also, the firewall will be redirecting traffic to a new IP and Port in a forwarding
                #       rule, so all of these endpoint have the same public and local port and the firewall
                #       will do the mapping, NATing, and/or redirection as declared in the firewall rules.
                Add-AzureEndpoint -Name "MgmtPort1" -Protocol tcp -PublicPort 801  -LocalPort 801  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "MgmtPort2" -Protocol tcp -PublicPort 807  -LocalPort 807  -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "HTTP"      -Protocol tcp -PublicPort 80   -LocalPort 80   -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPWeb"    -Protocol tcp -PublicPort 8014 -LocalPort 8014 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp1"   -Protocol tcp -PublicPort 8025 -LocalPort 8025 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPApp2"   -Protocol tcp -PublicPort 8026 -LocalPort 8026 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                Add-AzureEndpoint -Name "RDPDNS01"  -Protocol tcp -PublicPort 8024 -LocalPort 8024 -VM (Get-AzureVM -ServiceName $ServiceName[$i] -Name $VMName[$i]) | Update-AzureVM
                # Note: A SSH endpoint is automatically created on port 22 when the appliance is created.
                }
            Else
                {
                New-AzureVMConfig -Name $VMName[$i] -ImageName $img[$i] –InstanceSize $size[$i] | `
                    Add-AzureProvisioningConfig -Windows -AdminUsername $LocalAdmin -Password $LocalAdminPwd  | `
                    Set-AzureSubnet  –SubnetNames $SubnetName[$i] | `
                    Set-AzureStaticVNetIP -IPAddress $VMIP[$i] | `
                    Set-AzureVMMicrosoftAntimalwareExtension -AntimalwareConfiguration '{"AntimalwareEnabled" : true}' | `
                    Remove-AzureEndpoint -Name "RemoteDesktop" | `
                    Remove-AzureEndpoint -Name "PowerShell" | `
                    New-AzureVM –ServiceName $ServiceName[$i] -VNetName $VNetName -Location $DeploymentLocation
                }
            $i++
        }
    
    # Configure UDR and IP Forwarding
        Write-Host "Configuring UDR" -ForegroundColor Cyan
    
      # Create the Route Tables
        Write-Host "Creating the Route Tables" -ForegroundColor Cyan 
        New-AzureRouteTable -Name $BERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $BESubnet subnet"
        New-AzureRouteTable -Name $FERouteTableName `
            -Location $DeploymentLocation `
            -Label "Route table for $FESubnet subnet"
    
      # Add Routes to Route Tables
        Write-Host "Adding Routes to the Route Tables" -ForegroundColor Cyan 
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $BERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $BEPrefix `
            -NextHopType VNETLocal
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "All traffic to FW" -AddressPrefix 0.0.0.0/0 `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Internal traffic to FW" -AddressPrefix $VNetPrefix `
            -NextHopType VirtualAppliance `
            -NextHopIpAddress $VMIP[0]
        Get-AzureRouteTable $FERouteTableName `
            |Set-AzureRoute -RouteName "Allow Intra-Subnet Traffic" -AddressPrefix $FEPrefix `
            -NextHopType VNETLocal
    
      # Assoicate the Route Tables with the Subnets
        Write-Host "Binding Route Tables to the Subnets" -ForegroundColor Cyan 
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $BESubnet `
            -RouteTableName $BERouteTableName
        Set-AzureSubnetRouteTable -VirtualNetworkName $VNetName `
            -SubnetName $FESubnet `
            -RouteTableName $FERouteTableName
    
     # Enable IP Forwarding on the Virtual Appliance
        Get-AzureVM -Name $VMName[0] -ServiceName $ServiceName[0] `
            |Set-AzureIPForwarding -Enable
    
    # Configure NSG
        Write-Host "Configuring the Network Security Group (NSG)" -ForegroundColor Cyan
    
      # Build the NSG
        Write-Host "Building the NSG" -ForegroundColor Cyan
        New-AzureNetworkSecurityGroup -Name $NSGName -Location $DeploymentLocation -Label "Security group for $VNetName subnets in $DeploymentLocation"
    
      # Add NSG Rule
        Write-Host "Writing rules into the NSG" -ForegroundColor Cyan
        Get-AzureNetworkSecurityGroup -Name $NSGName | Set-AzureNetworkSecurityRule -Name "Isolate the $VNetName VNet from the Internet" -Type Inbound -Priority 100 -Action Deny `
            -SourceAddressPrefix INTERNET -SourcePortRange '*' `
            -DestinationAddressPrefix VIRTUAL_NETWORK -DestinationPortRange '*' `
            -Protocol *
    
      # Assign the NSG to two Subnets
        # The NSG is *not* bound to the Security Subnet. The result
        # is that internet traffic flows only to the Security subnet
        # since the NSG bound to the Frontend and Backback subnets
        # will Deny internet traffic to those subnets.
        Write-Host "Binding the NSG to two subnets" -ForegroundColor Cyan
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $FESubnet -VirtualNetworkName $VNetName
        Set-AzureNetworkSecurityGroupToSubnet -Name $NSGName -SubnetName $BESubnet -VirtualNetworkName $VNetName
    
    # Optional Post-script Manual Configuration
      # Configure Firewall
      # Install Test Web App (Run Post-Build Script on the IIS Server)
      # Install Backend resource (Run Post-Build Script on the AppVM01)
      Write-Host
      Write-Host "Build Complete!" -ForegroundColor Green
      Write-Host
      Write-Host "Optional Post-script Manual Configuration Steps" -ForegroundColor Gray
      Write-Host " - Configure Firewall" -ForegroundColor Gray
      Write-Host " - Install Test Web App (Run Post-Build Script on the IIS Server)" -ForegroundColor Gray
      Write-Host " - Install Backend resource (Run Post-Build Script on the AppVM01)" -ForegroundColor Gray
      Write-Host
    

#### <a name="network-config-file"></a>Αρχείο ρύθμισης παραμέτρων δικτύου
Αποθήκευση αυτού του αρχείου xml με ενημερωμένη θέση και να προσθέσετε τη σύνδεση σε αυτό το αρχείο στη μεταβλητή $NetworkConfigFile στη δέσμη ενεργειών παραπάνω.

    <NetworkConfiguration xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://schemas.microsoft.com/ServiceHosting/2011/07/NetworkConfiguration">
      <VirtualNetworkConfiguration>
        <Dns>
          <DnsServers>
            <DnsServer name="DNS01" IPAddress="10.0.2.4" />
            <DnsServer name="Level3" IPAddress="209.244.0.3" />
          </DnsServers>
        </Dns>
        <VirtualNetworkSites>
          <VirtualNetworkSite name="CorpNetwork" Location="Central US">
            <AddressSpace>
              <AddressPrefix>10.0.0.0/16</AddressPrefix>
            </AddressSpace>
            <Subnets>
              <Subnet name="SecNet">
                <AddressPrefix>10.0.0.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="FrontEnd">
                <AddressPrefix>10.0.1.0/24</AddressPrefix>
              </Subnet>
              <Subnet name="BackEnd">
                <AddressPrefix>10.0.2.0/24</AddressPrefix>
              </Subnet>
            </Subnets>
            <DnsServersRef>
              <DnsServerRef name="DNS01" />
              <DnsServerRef name="Level3" />
            </DnsServersRef>
          </VirtualNetworkSite>
        </VirtualNetworkSites>
      </VirtualNetworkConfiguration>
    </NetworkConfiguration>

#### <a name="sample-application-scripts"></a>Δείγμα εφαρμογής δεσμών ενεργειών
Εάν θέλετε να εγκαταστήσετε μια εφαρμογή του δείγματος για αυτό και άλλα παραδείγματα DMZ, μία έχει παρασχεθεί στην ακόλουθη σύνδεση: [Εφαρμογή δείγματος δέσμης ενεργειών][SampleApp]

<!--Image References-->
[1]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3design.png "DMZ διπλής κατεύθυνσης με NVA, NSG και UDR"
[2]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/example3firewalllogical.png "Προβολή λογικών από τους κανόνες τείχους προστασίας"
[3]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectfrontend.png "Δημιουργία ενός αντικειμένου FrontEnd δικτύου"
[4]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectdns.png "Δημιουργήστε ένα αντικείμενο διακομιστή DNS"
[5]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpa.png "Αντίγραφο της προεπιλεγμένης RDP κανόνα"
[6]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/createnetworkobjectrdpb.png "AppVM01 κανόνα"
[7]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconapplicationredirect.png "Εικονίδιο εφαρμογής ανακατεύθυνσης"
[8]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/icondestinationnat.png "Εικονίδιο NAT προορισμού"
[9]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/iconpass.png "Εικονίδιο φάση"
[10]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulefirewall.png "Κανόνας διαχείρισης τείχους προστασίας"
[11]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/rulerdp.png "Κανόνας RDP τείχους προστασίας"
[12]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleweb.png "Κανόνας Web τείχους προστασίας"
[13]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleappvm01.png "Κανόνας AppVM01 τείχους προστασίας"
[14]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleoutbound.png "Κανόνας εξερχομένων τείχους προστασίας"
[15]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledns.png "Κανόνας DNS τείχους προστασίας"
[16]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruleintravnet.png "Κανόνας εντός VNet τείχους προστασίας"
[17]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/ruledeny.png "Τείχος προστασίας αρνηθεί κανόνα"
[18]: ./media/virtual-networks-dmz-nsg-fw-udr-asm/firewallruleactivate.png "Ενεργοποίηση του κανόνα τείχους προστασίας"

<!--Link References-->
[HOME]: ../best-practices-network-security.md
[SampleApp]: ./virtual-networks-sample-app.md
