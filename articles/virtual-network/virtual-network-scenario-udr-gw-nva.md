<properties 
   pageTitle="Υβριδική σύνδεσης με εφαρμογή 2 επιπέδων | Microsoft Azure"
   description="Μάθετε πώς μπορείτε να αναπτύξετε το εικονικό συσκευές και UDR για να δημιουργήσετε ένα περιβάλλον πολλαπλών επιπέδων εφαρμογή στο Azure"
   services="virtual-network"
   documentationCenter="na"
   authors="jimdial"
   manager="carmonm"
   editor="tysonn" />
<tags 
   ms.service="virtual-network"
   ms.devlang="na"
   ms.topic="article"
   ms.tgt_pltfrm="na"
   ms.workload="infrastructure-services"
   ms.date="05/05/2016"
   ms.author="jdial" />

# <a name="virtual-appliance-scenario"></a>Σενάριο εικονικού συσκευής

Ένα συνηθισμένο σενάριο μεταξύ των μεγαλύτερων Azure πελάτη είναι την ανάγκη για την παροχή μιας εφαρμογής δύο επιπέδων εκτίθεται στο Internet, ενώ δίνει τη δυνατότητα πρόσβασης στο επίπεδο πίσω από ένα κέντρο δεδομένων εσωτερικής εγκατάστασης. Αυτό το έγγραφο θα σας καθοδηγήσει ένα σενάριο χρησιμοποιώντας διαδρομές που ορίζονται από το χρήστη (UDR), μια πύλη VPN και συσκευές εικονικού δικτύου για να αναπτύξετε ένα περιβάλλον δύο επιπέδων που ικανοποιεί τις ακόλουθες απαιτήσεις:

- Εφαρμογή Web πρέπει να είναι προσβάσιμα μέσω Internet μόνο.
- Διακομιστή Web που φιλοξενεί την εφαρμογή πρέπει να είναι μπορούν να έχουν πρόσβαση σε ένα διακομιστή εφαρμογής παρασκηνίου.
- Όλη την κυκλοφορία από το Internet για την εφαρμογή web πρέπει να ακολουθήσετε μια εικονική συσκευή τείχους προστασίας. Αυτό εικονικού συσκευής θα χρησιμοποιηθεί για την κυκλοφορία Internet μόνο.
- Όλη την κυκλοφορία μεταβαίνοντας στο διακομιστή της εφαρμογής πρέπει να ακολουθήσετε μια εικονική συσκευή τείχους προστασίας. Αυτό εικονικού συσκευής θα χρησιμοποιηθεί για πρόσβαση στο διακομιστή τέλος παρασκηνίου και πρόσβασης σύντομα μέσω μιας πύλης VPN από το δίκτυο εσωτερικής εγκατάστασης.
- Οι διαχειριστές πρέπει να μπορούν να διαχειρίζονται το εικονικό συσκευές τείχους προστασίας από τους υπολογιστές εσωτερικής εγκατάστασης, χρησιμοποιώντας το τρίτο, τείχος προστασίας εικονικού συσκευής χρησιμοποιούνται αποκλειστικά για σκοπούς διαχείρισης.

Αυτό είναι ένα τυπικό σενάριο DMZ με μια DMZ και ένα κοινόχρηστο στοιχείο προστατευμένου δικτύου. Τέτοιο σενάριο είναι δυνατό να δημιουργηθεί στο Azure χρησιμοποιώντας NSGs, εικονικό συσκευές τείχους προστασίας ή ένας συνδυασμός των δύο. Ο παρακάτω πίνακας παρουσιάζει ορισμένα από τα πλεονεκτήματα και μειονεκτήματα μεταξύ NSGs και εικονικού συσκευές τείχους προστασίας.

||Οι επαγγελματίες τεχνολογιών πληροφορικής|Τα μειονεκτήματα|
|---|---|---|
|NSG|Χωρίς κόστος. <br/>Ενσωματωμένο στο Azure RBAC. <br/>Κανόνες μπορούν να δημιουργηθούν σε πρότυπα ARM.|Πολυπλοκότητα μπορεί να διαφέρουν σε μεγαλύτερα περιβάλλοντα. |
|Τείχος προστασίας|Πλήρη έλεγχο σε επίπεδο δεδομένων. <br/>Κεντρική διαχείριση μέσω του τείχους προστασίας κονσόλας.|Κόστος της συσκευής τείχους προστασίας. <br/>Ενσωματωμένο δεν Azure RBAC.|

Η παρακάτω λύση χρησιμοποιεί εικονικού συσκευές τείχους προστασίας για να υλοποιήσετε ένα σενάριο δικτύου DMZ/προστατευμένη.

## <a name="considerations"></a>Ζητήματα

Μπορείτε να αναπτύξετε το περιβάλλον που περιγράφεται παραπάνω σε Azure χρησιμοποιώντας διαφορετικές δυνατότητες που είναι διαθέσιμες σήμερα, ως εξής.

- **Εικονική δικτύου (VNet)**. Μια VNet Azure λειτουργεί με παρόμοιο τρόπο σε ένα δίκτυο εσωτερικής εγκατάστασης και να φέρουν κατά διαστήματα σε ένα ή περισσότερα δευτερεύοντα δίκτυα, να δώσετε κίνηση απομόνωσης και διαχωρισμού των ανησυχίες.
- **Εικονική συσκευή**. Διάφορες συνεργάτες παρέχουν εικονικού συσκευές στην αγορά Azure που μπορούν να χρησιμοποιηθούν για τα τρία τείχη προστασίας που περιγράφονται παραπάνω. 
- **Δρομολογεί (UDR) ορίζονται από το χρήστη**. Δρομολόγηση πίνακες μπορούν να περιέχουν UDRs χρησιμοποιούνται από Azure δικτύωση για τον έλεγχο της ροής των πακέτων μέσα σε ένα VNet. Σε αυτούς τους πίνακες δρομολόγηση μπορούν να εφαρμοστούν σε δευτερεύοντα δίκτυα. Μία από τις νεότερες δυνατότητες στο Azure είναι η δυνατότητα για να εφαρμόσετε έναν πίνακα δρομολόγηση του GatewaySubnet, παρέχοντας τη δυνατότητα να προωθήσετε όλη την κυκλοφορία εισέρχονται το Azure VNet από μια σύνδεση υβριδική μια εικονική συσκευή.
- **Προώθηση IP**. Από προεπιλογή, το μηχανισμό Azure κοινωνικής δικτύωσης προώθηση πακέτων σε κάρτες περιβάλλοντος εργασίας εικονικού δικτύου (NIC) μόνο εάν η διεύθυνση IP προορισμού πακέτο ταιριάζει με τη διεύθυνση NIC IP. Γι ' αυτό, εάν μια UDR Καθορίζει ότι ένα πακέτο πρέπει να σταλεί σε μια δεδομένη εικονικού συσκευής, ο μηχανισμός Azure κοινωνικής δικτύωσης θα απόθεση πακέτου. Για να εξασφαλίσετε την παράδοση του πακέτου σε μια Εικονική (σε αυτήν την περίπτωση, ένα εικονικό συσκευής) που δεν είναι η πραγματική προορισμού για το πακέτο, πρέπει να ενεργοποιήσετε την προώθηση IP για το εικονικό μηχάνημα.
- **Ομάδες ασφαλείας δικτύου (NSGs)**. Το παρακάτω παράδειγμα δεν κάνει χρήση των NSGs, αλλά μπορείτε να χρησιμοποιήσετε NSGs εφαρμοστεί στο δευτερεύοντα δίκτυα ή/και NIC σε αυτήν τη λύση για να φιλτράρετε περαιτέρω την κυκλοφορία και έξοδος από αυτά τα δευτερεύοντα δίκτυα και NIC.


![Συνδεσιμότητα IPv6](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

Σε αυτό το παράδειγμα, υπάρχει μια συνδρομή που περιέχει τα εξής:

- 2 ομάδες πόρων, δεν εμφανίζεται στο διάγραμμα. 
    - **ONPREMRG**. Περιέχει όλους τους πόρους που είναι απαραίτητο να προσομοιώνουν ένα δίκτυο εσωτερικής εγκατάστασης.
    - **AZURERG**. Περιέχει όλους τους πόρους που απαιτούνται για το Azure εικονικό περιβάλλον δικτύου. 
- Μια VNet με το όνομα **onpremvnet** χρησιμοποιείται για τη μίμηση του αποτελέσματος ενός κέντρου δεδομένων εσωτερικής εγκατάστασης που φέρουν κατά διαστήματα όπως αναφέρονται παρακάτω.
    - **onpremsn1**. Υποδικτύου που περιέχει μια εικονική μηχανή (Εικονική) που εκτελεί Ubuntu να μιμηθείτε ένα διακομιστή εσωτερικής εγκατάστασης.
    - **onpremsn2**. Υποδικτύου που περιέχει μια Εικονική εκτελείται Ubuntu να μίμηση του αποτελέσματος ενός υπολογιστή εσωτερικής εγκατάστασης που χρησιμοποιείται από ένα διαχειριστή.
- Υπάρχει ένα τείχος προστασίας εικονικού συσκευής που ονομάζεται **OPFW** σε **onpremvnet** χρησιμοποιείται για να διατηρήσετε μια διοχέτευση προς **azurevnet**.
- Μια VNet με το όνομα **azurevnet** φέρουν κατά διαστήματα όπως αναφέρονται παρακάτω.
    - **azsn1**. Εξωτερικό τείχος προστασίας υποδικτύου χρησιμοποιούνται αποκλειστικά για το εξωτερικό τείχος προστασίας. Όλη την κυκλοφορία Internet να παραδίδεται έως αυτό το υποδίκτυο. Αυτό το υποδίκτυο περιέχει μόνο ένα NIC συνδεδεμένο με το εξωτερικό τείχος προστασίας.
    - **azsn2**. Προσκηνίου υποδικτύου φιλοξενίας μια Εικονική εκτελείται ως διακομιστή web που θα υπάρχει πρόσβαση από το Internet.
    - **azsn3**. Υποδίκτυο υποστήριξης φιλοξενία μια Εικονική εκτελεί διακομιστή εφαρμογής παρασκηνίου που θα υπάρχει πρόσβαση από το διακομιστή web προσκηνίου.
    - **azsn4**. Διαχείριση υποδικτύου χρησιμοποιείται αποκλειστικά για την παροχή πρόσβασης διαχείρισης όλα εικονικού συσκευές τείχους προστασίας. Αυτό το υποδίκτυο περιέχει μόνο ένα NIC για κάθε συσκευή εικονικού τείχος προστασίας που χρησιμοποιούνται στη λύση.
    - **GatewaySubnet**. Υποδίκτυο σύνδεσης Azure υβριδική απαιτείται για ExpressRoute και την πύλη VPN για την παροχή σύνδεσης μεταξύ Azure VNets και άλλα δίκτυα. 
- Υπάρχουν 3 εικονικού συσκευές τείχους προστασίας του δικτύου **azurevnet** . 
    - **AZF1**. Εξωτερικό τείχος προστασίας που εκτίθεται δημόσια στο Internet με χρήση του πόρου δημόσια διεύθυνση IP στο Azure. Πρέπει να βεβαιωθείτε ότι έχετε ένα πρότυπο από το Marketplace ή απευθείας από τον προμηθευτή της συσκευής, που διατάξεις μια εικονική συσκευή 3-NIC.
    - **AZF2**. Εσωτερική τείχος προστασίας που χρησιμοποιείται για τον έλεγχο κίνηση μεταξύ **azsn2** και **azsn3**. Αυτό είναι επίσης μια εικονική συσκευή 3 NIC.
    - **AZF3**. Διαχείριση τείχος προστασίας προσβάσιμα στους διαχειριστές από το κέντρο δεδομένων εσωτερικής εγκατάστασης και συνδεδεμένο με ένα δευτερεύον διαχείρισης που χρησιμοποιούνται για τη Διαχείριση όλες οι συσκευές τείχους προστασίας. Μπορείτε να βρείτε 2-NIC πρότυπα εικονικού συσκευής στην αγορά ή ζητήστε ένα απευθείας από τον προμηθευτή της συσκευής.

## <a name="user-defined-routing-udr"></a>Δρομολόγηση (UDR) ορίζονται από το χρήστη

Κάθε υποδίκτυο στο Azure μπορούν να συνδεθούν με UDR πίνακα που χρησιμοποιείται για να ορίσετε πώς κίνηση που ξεκινούν από σε που δρομολογείται υποδικτύου. Εάν δεν υπάρχει UDRs έχουν οριστεί, Azure χρησιμοποιεί προεπιλεγμένες διαδρομές για να επιτρέψετε την κυκλοφορία να ρέει από μία υποδικτύου σε μια άλλη. Για να κατανοήσετε καλύτερα UDRs, επισκεφθείτε [Τι είναι οι διαδρομές που ορίζονται από το χρήστη και την προώθηση IP](./virtual-networks-udr-overview.md#ip-forwarding).

Για να βεβαιωθείτε ότι γίνεται επικοινωνία μέσω συσκευής δεξιά τείχος προστασίας, με βάση την τελευταία απαίτηση παραπάνω, πρέπει να δημιουργήσετε τον παρακάτω πίνακα δρομολόγηση που περιέχει UDRs σε **azurevnet**.

### <a name="azgwudr"></a>azgwudr

Σε αυτό το σενάριο, το μόνο κίνηση ρέει από εσωτερικής προς Azure θα χρησιμοποιηθεί για να διαχειριστείτε τα τείχη προστασίας κατά τη σύνδεση σε **AZF3**και η κυκλοφορία πρέπει να μεταβείτε μέσω του εσωτερικού τείχους προστασίας, **AZF2**. Επομένως, μόνο μία οδός είναι απαραίτητο στο **GatewaySubnet** όπως φαίνεται παρακάτω.

|Προορισμού|Επόμενη μεταπήδηση|Επεξήγηση|
|---|---|---|
|10.0.4.0/24|10.0.3.11|Επιτρέπει την κυκλοφορία εσωτερικής εγκατάστασης για την επίτευξη τείχος προστασίας διαχείρισης **AZF3**|

### <a name="azsn2udr"></a>azsn2udr

|Προορισμού|Επόμενη μεταπήδηση|Επεξήγηση|
|---|---|---|
|10.0.3.0/24|10.0.2.11|Επιτρέπει την κίνηση στο υποδίκτυο παρασκηνίου που φιλοξενεί το διακομιστή της εφαρμογής μέσω **AZF2**|
|0.0.0.0/0|10.0.2.10|Επιτρέπει όλη την κυκλοφορία άλλους να δρομολογηθούν μέσω **AZF1**|

### <a name="azsn3udr"></a>azsn3udr

|Προορισμού|Επόμενη μεταπήδηση|Επεξήγηση|
|---|---|---|
|10.0.2.0/24|10.0.3.10|Επιτρέπει την κυκλοφορία στο **azsn2** να ρέει από το διακομιστή εφαρμογής για το webserver μέσω **AZF2**|

Πρέπει επίσης να δημιουργήσετε πίνακες διαδρομών για τα δευτερεύοντα δίκτυα στο **onpremvnet** για να μιμηθείτε το κέντρο δεδομένων εσωτερικής εγκατάστασης.

### <a name="onpremsn1udr"></a>onpremsn1udr

|Προορισμού|Επόμενη μεταπήδηση|Επεξήγηση|
|---|---|---|
|192.168.2.0/24|192.168.1.4|Επιτρέπει την κυκλοφορία στο **onpremsn2** έως **OPFW**|

### <a name="onpremsn2udr"></a>onpremsn2udr

|Προορισμού|Επόμενη μεταπήδηση|Επεξήγηση|
|---|---|---|
|10.0.3.0/24|192.168.2.4|Επιτρέπει την κυκλοφορία στο δευτερεύον αντίγραφα ασφαλείας στο Azure μέσω **OPFW**|
|192.168.1.0/24|192.168.2.4|Επιτρέπει την κυκλοφορία στο **onpremsn1** έως **OPFW**|

## <a name="ip-forwarding"></a>Προώθηση IP 

UDR και την προώθηση IP είναι δυνατότητες που μπορείτε να χρησιμοποιήσετε σε συνδυασμό για να επιτρέψετε εικονικού συσκευές που θα χρησιμοποιηθεί για τον έλεγχο της ροής κυκλοφορίας σε μια VNet Azure.  Μια εικονική συσκευή είναι τίποτε από μια Εικονική που εκτελεί μια εφαρμογή που χρησιμοποιείται για το χειρισμό κίνηση του δικτύου με κάποιον τρόπο, όπως ένα τείχος προστασίας ή μια συσκευή NAT.

Αυτό εικονικού συσκευής Εικονική πρέπει να μπορούν να λαμβάνουν εισερχόμενη κυκλοφορία που δεν απευθύνεται στον εαυτό. Για να επιτρέψετε μια Εικονική να λαμβάνει κυκλοφορία απευθύνεται σε άλλους προορισμούς, πρέπει να ενεργοποιήσετε προώθησης IP για την εικονική Μηχανή. Αυτή είναι μια Azure, όχι μια ρύθμιση στο λειτουργικό σύστημα επισκέπτη. Το εικονικό συσκευής εξακολουθεί να πρέπει να εκτελέσετε ορισμένες τον τύπο της εφαρμογής για να χειριστείτε τα εισερχόμενα δεδομένα και να δρομολογήσετε σωστά.

Για να μάθετε περισσότερα σχετικά με την προώθηση IP, επισκεφθείτε [Τι είναι οι διαδρομές που ορίζονται από το χρήστη και την προώθηση IP](./virtual-networks-udr-overview.md#ip-forwarding).

Ως παράδειγμα, φανταστείτε ότι έχετε τα ακόλουθα εγκατάστασης σε ένα Azure vnet:

- Υποδικτύου **onpremsn1** περιέχει μια Εικονική με το όνομα **onpremvm1**.
- Υποδικτύου **onpremsn2** περιέχει μια Εικονική με το όνομα **onpremvm2**.
- Μια εικονική συσκευή με το όνομα **OPFW** είναι συνδεδεμένο σε **onpremsn1** και **onpremsn2**.
- Μια διαδρομή που ορίζονται από το χρήστη που συνδέεται με **onpremsn1** Καθορίζει ότι πρέπει να αποστέλλεται όλη την κυκλοφορία στο **onpremsn2** **OPFW**.

Σε αυτό το σημείο, εάν **onpremvm1** προσπαθεί να δημιουργήσει μια σύνδεση με **onpremvm2**, θα χρησιμοποιηθεί το UDR και κίνηση θα αποσταλούν **OPFW** ως την επόμενη μεταπήδηση. Μην ξεχνάτε ότι δεν θα αλλάξουν προορισμού του πραγματικού πακέτου, εξακολουθεί να εμφανίζεται η ένδειξη **onpremvm2** αποτελεί τον προορισμό. 

Χωρίς προώθηση IP ενεργοποιηθεί για **OPFW**της Azure εικονικού κοινωνικής δικτύωσης λογικής θα αποθέστε τα πακέτα, καθώς επιτρέπει μόνο πακέτα που θα σταλεί σε μια Εικονική αν η Εικονική διεύθυνση IP είναι ο προορισμός για το πακέτο.

Με την προώθηση IP, της λογικής Azure εικονικού δικτύου θα προωθεί τα πακέτα για να OPFW, χωρίς να αλλάξετε την αρχική διεύθυνση προορισμού. **OPFW** πρέπει να χειριστείτε τα πακέτα και να προσδιορίσετε τι πρέπει να κάνετε με αυτά.

Για το παραπάνω σενάριο για να εργαστείτε, πρέπει να ενεργοποιήσετε το IP προώθηση κλήσεων σε το NIC για **OPFW**, **AZF1**, **AZF2**και **AZF3** που χρησιμοποιούνται για τη δρομολόγηση (NIC όλα εκτός από αυτά που συνδέονται με το υποδίκτυο διαχείρισης). 

## <a name="firewall-rules"></a>Κανόνες τείχους προστασίας

Όπως περιγράφεται παραπάνω, IP προώθησης μόνο εξασφαλίζει πακέτα στην οποία αποστέλλονται οι εικονικές συσκευές. Σας συσκευής εξακολουθεί να πρέπει να αποφασίσετε τι θέλετε να κάνετε με αυτά τα πακέτα. Στο παραπάνω σενάριο, θα πρέπει να δημιουργήσετε τους παρακάτω κανόνες στο τις συσκευές:

### <a name="opfw"></a>OPFW

OPFW αντιπροσωπεύει μια συσκευή εσωτερικής εγκατάστασης που περιέχει τους παρακάτω κανόνες:

- **Δρομολόγηση**: όλη την κυκλοφορία στο 10.0.0.0/16 (**azurevnet**) πρέπει να αποστέλλεται μέσω διοχέτευσης **ONPREMAZURE**.
- **Πολιτική**: επιτρέπει όλη την κυκλοφορία διπλής κατεύθυνσης μεταξύ **port2** και **ONPREMAZURE**.
 
### <a name="azf1"></a>AZF1

AZF1 αντιπροσωπεύει μια Azure εικονικού συσκευής που περιέχει τους παρακάτω κανόνες:

- **Πολιτική**: επιτρέπει όλη την κυκλοφορία διπλής κατεύθυνσης μεταξύ **port1** και **port2**.

### <a name="azf2"></a>AZF2

AZF2 αντιπροσωπεύει μια Azure εικονικού συσκευής που περιέχει τους παρακάτω κανόνες:

- **Δρομολόγηση**: όλη την κυκλοφορία στο 10.0.0.0/16 (**onpremvnet**) πρέπει να αποσταλούν στη διεύθυνση IP της πύλης Azure (δηλαδή 10.0.0.1) έως **port1**.
- **Πολιτική**: επιτρέπει όλη την κυκλοφορία διπλής κατεύθυνσης μεταξύ **port1** και **port2**.

## <a name="network-security-groups-nsgs"></a>Ομάδες ασφαλείας δικτύου (NSGs)

Σε αυτό το σενάριο, NSGs δεν χρησιμοποιούνται. Ωστόσο, μπορείτε να εφαρμόσετε NSGs για κάθε υποδίκτυο περιορισμού της εισερχόμενης και εξερχόμενης κίνησης. Για παράδειγμα, μπορείτε να εφαρμόσετε τους παρακάτω κανόνες NSG στο εξωτερικό υποδίκτυο FW.

**Εισερχομένων**

- Να επιτρέπεται όλη την κυκλοφορία TCP από το Internet στη θύρα 80 σε οποιαδήποτε Εικονική στο δευτερεύον.
- Απόρριψη όλη την κυκλοφορία άλλα από το Internet.

**Εξερχόμενη**
- Απόρριψη όλη την κυκλοφορία στο Internet.

## <a name="high-level-steps"></a>Τα βήματα υψηλού επιπέδου

Για να αναπτύξετε αυτό το σενάριο, ακολουθήστε τα παρακάτω βήματα υψηλού επιπέδου.

1.  Συνδεθείτε στο Azure τη συνδρομή σας.
2.  Εάν θέλετε να αναπτύξετε μια VNet για να μιμηθείτε το δίκτυο εσωτερικής εγκατάστασης, προμήθεια τους πόρους που αποτελούν μέρος της **ONPREMRG**.
3.  Παροχή στους πόρους που αποτελούν μέρος της **AZURERG**.
4.  Παροχή διοχέτευσης από **onpremvnet** σε **azurevnet**.
5.  Όταν έχουν παρασχεθεί όλους τους πόρους, συνδεθείτε με **onpremvm2** και κάντε ping 10.0.3.101, για να ελέγξετε τη σύνδεση μεταξύ **onpremsn2** και **azsn3**.
