<properties
    pageTitle="Υπηρεσία ελέγχου ταυτότητας κεφαλαίου για τις εφαρμογές API στο Azure εφαρμογής υπηρεσίας | Microsoft Azure"
    description="Μάθετε πώς να προστατεύσετε εφαρμογής API στο Azure εφαρμογής υπηρεσίας για σενάρια υπηρεσία εξυπηρέτησης."
    services="app-service\api"
    documentationCenter=".net"
    authors="tdykstra"
    manager="wpickett"
    editor=""/>

<tags
    ms.service="app-service-api"
    ms.workload="na"
    ms.tgt_pltfrm="dotnet"
    ms.devlang="na"
    ms.topic="article"
    ms.date="06/30/2016" 
    ms.author="rachelap"/>

# <a name="service-principal-authentication-for-api-apps-in-azure-app-service"></a>Υπηρεσία ελέγχου ταυτότητας κεφαλαίου για τις εφαρμογές API στο Azure εφαρμογής υπηρεσίας

## <a name="overview"></a>Επισκόπηση

Σε αυτό το άρθρο εξηγεί τον τρόπο χρήσης της εφαρμογής υπηρεσίας ελέγχου ταυτότητας για την *εσωτερική* πρόσβαση σε εφαρμογές του API. Μια εσωτερική σενάριο είναι όπου έχετε μια εφαρμογή API που θέλετε να είναι ΑΝΑΛΩΣΙΜΩΝ μόνο με το δικό σας κώδικα της εφαρμογής. Το συνιστώμενο τρόπο για την υλοποίηση αυτό το σενάριο στην εφαρμογή υπηρεσίας είναι να χρησιμοποιήσετε Azure AD για να προστατεύσετε την εφαρμογή που ονομάζεται API. Μπορείτε να καλέσετε την προστατευμένη εφαρμογή API με διακριτικό φορέα που λαμβάνετε από το Azure AD, παρέχοντας ταυτότητα της εφαρμογής διαπιστευτήρια (υπηρεσία κεφαλαίου). Για εναλλακτικές λύσεις με τη χρήση του Azure AD, ανατρέξτε στην ενότητα **υπηρεσία εξυπηρέτησης ελέγχου ταυτότητας** από την [Επισκόπηση ελέγχου ταυτότητας Azure εφαρμογής υπηρεσίας](../app-service/app-service-authentication-overview.md#service-to-service-authentication).

Σε αυτό το άρθρο, θα μάθετε:

* Πώς μπορείτε να χρησιμοποιήσετε Azure Active Directory (Azure AD) για την προστασία εφαρμογής API από την access χωρίς έλεγχο ταυτότητας.
* Τρόπος για την εκμετάλλευση μια προστατευμένη εφαρμογή API από μια εφαρμογή API, εφαρμογή web ή εφαρμογή για κινητές συσκευές, χρησιμοποιώντας τα διαπιστευτήρια κεφάλαιο (εφαρμογή ταυτότητα) υπηρεσίας Azure AD. Για πληροφορίες σχετικά με τον τρόπο για την εκμετάλλευση από μια εφαρμογή λογικής, ανατρέξτε στο θέμα [χρήση το προσαρμοσμένο API φιλοξενούνται σε εφαρμογής υπηρεσίας με λογική εφαρμογές](../app-service-logic/app-service-logic-custom-hosted-api.md).
* Πώς να βεβαιωθείτε ότι την προστατευμένη εφαρμογή API δεν μπορεί να γίνει κλήσης από ένα πρόγραμμα περιήγησης, έχετε συνδεθεί σε χρήστες.
* Τρόπος για να βεβαιωθείτε ότι η προστατευμένη εφαρμογή API να κλήση μόνο με μια συγκεκριμένη Azure AD service κεφάλαιο.

Το άρθρο περιέχει δύο ενότητες:

* Στην ενότητα [πώς μπορείτε να ρυθμίσετε τις παραμέτρους κεφαλαίου έλεγχος ταυτότητας της υπηρεσίας στο Azure εφαρμογής υπηρεσίας](#authconfig) γενικά εξηγεί πώς μπορείτε να ρυθμίσετε τις παραμέτρους του ελέγχου ταυτότητας για οποιαδήποτε εφαρμογή του API και τον τρόπο για την εκμετάλλευση της εφαρμογής API προστατευμένο. Αυτή η ενότητα ισχύει και για όλα τα πλαίσια που υποστηρίζονται από το εφαρμογής υπηρεσίας, συμπεριλαμβανομένης της .NET, Node.js και Java.

* Ξεκινώντας με την ενότητα [συνεχίσετε τα προγράμματα εκμάθησης για το .NET γρήγορα αποτελέσματα](#tutorialstart) , το πρόγραμμα εκμάθησης σας καθοδηγεί τη ρύθμιση των παραμέτρων ενός σεναρίου "εσωτερική access" για μια εφαρμογή δείγμα .NET εκτελείται στο εφαρμογής υπηρεσίας. 

## <a id="authconfig"></a>Τρόπος ρύθμισης των παραμέτρων ελέγχου ταυτότητας κεφαλαίου υπηρεσίας στο Azure εφαρμογής υπηρεσίας

Αυτή η ενότητα παρέχει γενικές οδηγίες που ισχύουν για οποιαδήποτε εφαρμογή API. Για συγκεκριμένα βήματα για να το δείγμα εφαρμογής για να την κάνετε .NET σε λίστα, επιλέξτε για να [συνεχίσετε τη σειρά προγραμμάτων εκμάθησης .NET API εφαρμογές](#tutorialstart).

1. Στην [πύλη του Azure](https://portal.azure.com/), μεταβείτε στο το blade **ρυθμίσεων** της εφαρμογής API που θέλετε να προστατεύσετε, και, στη συνέχεια, βρείτε την ενότητα **δυνατότητες** και κάντε κλικ στην επιλογή **ελέγχου ταυτότητας / εξουσιοδότησης**.

    ![Έλεγχος ταυτότητας/εξουσιοδότησης στην πύλη του Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)

3. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ **στο**.

4. Στην αναπτυσσόμενη λίστα **ενέργεια κατά την αίτηση δεν έχει γίνει έλεγχος ταυτότητας** , επιλέξτε **συνδεθείτε με Azure Active Directory** .

5. Στην περιοχή **Υπηρεσιών παροχής ελέγχου ταυτότητας**, επιλέξτε **Azure Active Directory**.

    ![Έλεγχος ταυτότητας/εξουσιοδότησης blade στην πύλη του Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)

6. Ρύθμιση παραμέτρων του blade **Azure Active Directory ρυθμίσεις** για να δημιουργήσετε μια νέα εφαρμογή Azure AD ή να χρησιμοποιήσετε μια υπάρχουσα εφαρμογή Azure AD εάν έχετε ήδη ένα που θέλετε να χρησιμοποιήσετε.

    Εσωτερική σενάρια αφορούν συνήθως εφαρμογής API κλήση API εφαρμογής. Μπορείτε να χρησιμοποιήσετε το νέο Azure AD εφαρμογές για κάθε εφαρμογή API ή ένα μόνο εφαρμογή Azure AD.

    Για λεπτομερείς οδηγίες σχετικά με αυτό blade, δείτε [πώς μπορείτε να ρυθμίσετε τις παραμέτρους του εφαρμογής υπηρεσίας εφαρμογών για να χρησιμοποιήσετε login Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md).

7. Όταν ολοκληρώσετε την εργασία με το blade ρύθμισης παραμέτρων υπηρεσίας παροχής ελέγχου ταυτότητας, κάντε κλικ στο **κουμπί OK**.

7. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Κάντε κλικ στην επιλογή Αποθήκευση](./media/app-service-api-dotnet-service-principal-auth/authsave.png)

Μόλις γίνει αυτό, εφαρμογής υπηρεσίας επιτρέπει μόνο προσκλήσεις από καλούντες στο το ρυθμισμένο Azure AD μισθωτή. Χωρίς έλεγχο ταυτότητας ή εξουσιοδότησης κώδικα είναι απαραίτητη στην εφαρμογή API προστατευμένο. Το διακριτικό φορέα που του μεταβιβάστηκε η εφαρμογή API μαζί με συνήθως χρησιμοποιούνται αξιώσεων στις κεφαλίδες HTTP και, μπορείτε να διαβάσετε αυτά τα στοιχεία στον κώδικα για την επικύρωση ότι οι αιτήσεις είναι από μια συγκεκριμένη καλούντος, όπως ένα κεφάλαιο υπηρεσίας.

Αυτή η λειτουργία ελέγχου ταυτότητας λειτουργεί με τον ίδιο τρόπο για όλες τις γλώσσες που υποστηρίζει εφαρμογής υπηρεσίας, συμπεριλαμβανομένης της .NET, Node.js και Java. 

#### <a name="how-to-consume-the-protected-api-app"></a>Τρόπος για την εκμετάλλευση της προστατευμένο εφαρμογής API

Ο καλών πρέπει να παρέχει ένα διακριτικό φορέα Azure AD με τις κλήσεις API. Για να λάβετε ένα διακριτικό φορέα χρησιμοποιώντας τα διαπιστευτήρια κεφαλαίου υπηρεσίας, τον καλούντα χρησιμοποιεί βιβλιοθήκη ελέγχου ταυτότητας Active Directory (ADAL για [.NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory), [Node.js](https://github.com/AzureAD/azure-activedirectory-library-for-nodejs)ή [Java](https://github.com/AzureAD/azure-activedirectory-library-for-java)). Για να λάβετε ένα διακριτικό, τον κώδικα που καλεί ADAL παρέχει στους ADAL τις ακόλουθες πληροφορίες:

* Το όνομα του μισθωτή του Azure AD.
* Το Αναγνωριστικό υπολογιστή-πελάτη και προγράμματος-πελάτη μυστικό (πλήκτρο εφαρμογής) της εφαρμογής Azure AD που σχετίζεται με τον καλούντα.
* Το Αναγνωριστικό υπολογιστή-πελάτη της εφαρμογής Azure AD που σχετίζεται με την εφαρμογή API προστατευμένο. (Εάν χρησιμοποιείται μόνο μία εφαρμογή Azure AD, αυτό είναι το ίδιο Αναγνωριστικό υπολογιστή-πελάτη με τον τομέα για τον καλούντα.)

Αυτές οι τιμές είναι διαθέσιμες στις σελίδες Azure AD της [Azure κλασική πύλη](https://manage.windowsazure.com/).

Μόλις το διακριτικό αποκτήθηκε, τον καλούντα περιλαμβάνει, με αιτήσεις HTTP στην κεφαλίδα της εξουσιοδότησης.  Εφαρμογή υπηρεσίας επικυρώσει το διακριτικό και σας επιτρέπει τις αιτήσεις για την επίτευξη της εφαρμογής API προστατευμένο.

#### <a name="how-to-protect-the-api-app-from-access-by-users-in-the-same-tenant"></a>Πώς να προστατεύσετε την εφαρμογή API από την access από τους χρήστες στον ίδιο μισθωτή

Διακριτικά φορέα για τους χρήστες στον ίδιο μισθωτή θεωρούνται έγκυροι για την εφαρμογή API προστατευμένο.  Εάν θέλετε να εξασφαλίσετε ότι μόνο ένα κεφάλαιο υπηρεσίας να καλέσετε την προστατευμένη εφαρμογή API, προσθέστε κώδικα στην προστατευμένη εφαρμογή API για να επικυρώσει τα ακόλουθα αξιώσεων από το διακριτικό:

* `appid`πρέπει να είναι το Αναγνωριστικό πελάτη της εφαρμογής Azure AD που σχετίζεται με τον καλούντα. 
* `oid`(`objectidentifier`) πρέπει να είναι το Αναγνωριστικό υπηρεσίας κεφαλαίου του καλούντος. 

Η υπηρεσία εφαρμογής παρέχει επίσης την `objectidentifier` διεκδίκηση στην κεφαλίδα X-MS-Αναγνωριστικό υπολογιστή-ΠΕΛΆΤΗ-κεφάλαιο.

### <a name="how-to-protect-the-api-app-from-browser-access"></a>Πώς να προστατεύσετε την εφαρμογή API από πρόσβαση σε πρόγραμμα περιήγησης

Εάν δεν μπορείτε να επικυρώσετε αξιώσεων στον κώδικα στην προστατευμένη εφαρμογή API και εάν χρησιμοποιείτε μια ξεχωριστή εφαρμογή Azure AD για την εφαρμογή προστατευμένο API, βεβαιωθείτε ότι διεύθυνση URL της εφαρμογής Azure AD απάντηση δεν είναι ίδια με την εφαρμογή του API βασική διεύθυνση URL. Εάν η διεύθυνση URL απάντηση σημείων απευθείας στην εφαρμογή του προστατευμένου API, ένας χρήστης στον ίδιο μισθωτή Azure AD θα μπορούσε να μεταβείτε στην εφαρμογή API, να συνδεθείτε και να κλήσεων με επιτυχία το API.

## <a id="tutorialstart"></a>Συνεχίσετε τη σειρά προγραμμάτων εκμάθησης εφαρμογές API .NET

Εάν ακολουθείτε τη σειρά προγραμμάτων εκμάθησης Node.js ή Java για τις εφαρμογές του API, μεταβείτε στην ενότητα [επόμενα βήματα](#next-steps) . 

Το υπόλοιπο αυτού του άρθρου συνεχίζεται η σειρά προγραμμάτων εκμάθησης .NET API εφαρμογές και προϋποθέτει ότι έχετε ολοκληρώσει το [πρόγραμμα εκμάθησης τον έλεγχο ταυτότητας χρήστη](app-service-api-dotnet-user-principal-auth.md) και έχετε το δείγμα εφαρμογής που εκτελείται στο Azure με έλεγχο ταυτότητας χρήστη με δυνατότητα.

## <a name="set-up-authentication-in-azure"></a>Ρύθμιση του ελέγχου ταυτότητας στο Azure

Σε αυτήν την ενότητα ρυθμίζετε τις παραμέτρους εφαρμογής υπηρεσίας, έτσι ώστε το μόνο αιτήματα HTTP σας επιτρέπει να αποκτήσετε πρόσβαση στην εφαρμογή API σειρά δεδομένων είναι εκείνα που έχουν έγκυρες Azure AD φορέα διακριτικά. 

Στην παρακάτω ενότητα, μπορείτε να ρυθμίσετε την εφαρμογή μεσαίας API για αποστολή εφαρμογής διαπιστευτήρια Azure AD, να επιστρέψετε ένα διακριτικό φορέα και στείλτε το διακριτικό φορέα στην εφαρμογή API σειρά δεδομένων. Αυτή η διαδικασία απεικονίζεται στο διάγραμμα.

![Διάγραμμα ελέγχου ταυτότητας υπηρεσίας](./media/app-service-api-dotnet-service-principal-auth/appdiagram.png)

Εάν αντιμετωπίσετε προβλήματα κατά την ακολουθώντας τις οδηγίες του προγράμματος εκμάθησης, ανατρέξτε στην ενότητα [Αντιμετώπιση προβλημάτων](#troubleshooting) στο τέλος του προγράμματος εκμάθησης. 

1. Στην [πύλη του Azure](https://portal.azure.com/), μεταβείτε για να το blade **ρυθμίσεων** της εφαρμογής API που δημιουργήσατε για την εφαρμογή API (επίπεδο δεδομένων) ToDoListDataAPI και, στη συνέχεια, κάντε κλικ στην επιλογή **Ρυθμίσεις**.

2. Στο το blade **Ρυθμίσεις** , βρείτε την ενότητα **δυνατοτήτων** και, στη συνέχεια, κάντε κλικ στην επιλογή **ελέγχου ταυτότητας / εξουσιοδότησης**.

    ![Έλεγχος ταυτότητας/εξουσιοδότησης στην πύλη του Azure](./media/app-service-api-dotnet-user-principal-auth/features.png)

3. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ **στο**.

4. Στην αναπτυσσόμενη λίστα **ενέργεια κατά την αίτηση δεν έχει γίνει έλεγχος ταυτότητας** , επιλέξτε **συνδεθείτε με Azure Active Directory**.

    Αυτή είναι η ρύθμιση που προκαλεί εφαρμογής υπηρεσίας για να βεβαιωθείτε ότι που μόνο ελεγχθεί η ταυτότητά αιτήσεις reach την εφαρμογή API. Για τις αιτήσεις που έχουν έγκυρες φορέα διακριτικά, εφαρμογής υπηρεσίας μεταφέρει τα διακριτικά κατά μήκος της εφαρμογής API και συμπληρώνει κεφαλίδες HTTP με αξιώσεων που χρησιμοποιείται συχνά για τη διάθεση αυτές τις πληροφορίες πιο εύκολα να τον κωδικό.

5. Στην περιοχή **Υπηρεσιών παροχής ελέγχου ταυτότητας**, κάντε κλικ στην επιλογή **Azure Active Directory**.

    ![Έλεγχος ταυτότητας/εξουσιοδότησης blade στην πύλη του Azure](./media/app-service-api-dotnet-user-principal-auth/authblade.png)

6. Στο το blade **Azure Active Directory ρυθμίσεις** , κάντε κλικ στην επιλογή **Express**.

    Με το **Express** Azure την επιλογή να δημιουργήσετε αυτόματα μια εφαρμογή AAD στο [μισθωτή](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant)του Azure AD. 

    Δεν χρειάζεται να δημιουργήσετε ένα μισθωτή, επειδή κάθε λογαριασμός Azure έχει αυτόματα μία.

7. Στην περιοχή **Διαχείριση λειτουργία**, κάντε κλικ στην επιλογή **Δημιουργία νέας εφαρμογής AD** , εάν δεν είναι ήδη επιλεγμένο.

    Η πύλη συνδέεται πλαίσιο εισαγωγής **Δημιουργία εφαρμογής** με προεπιλεγμένη τιμή. Από προεπιλογή, η εφαρμογή Azure AD είναι το ίδιο όνομα με την εφαρμογή API. Εάν προτιμάτε, μπορείτε να εισαγάγετε ένα διαφορετικό όνομα.
    
    ![Azure AD ρυθμίσεις](./media/app-service-api-dotnet-service-principal-auth/aadsettings.png)

    **Σημείωση**: ως εναλλακτική λύση, μπορείτε να χρησιμοποιήσετε ένα μεμονωμένο Azure AD εφαρμογής για την εφαρμογή API κλήσης και την εφαρμογή API προστατευμένο. Εάν επιλέξατε αυτή η εναλλακτική λύση, δεν θα πρέπει η επιλογή **Δημιουργία νέας εφαρμογής AD** εδώ επειδή έχετε ήδη δημιουργήσει μια εφαρμογή του Azure AD νωρίτερα σε το πρόγραμμα εκμάθησης τον έλεγχο ταυτότητας χρήστη. Για αυτό το πρόγραμμα εκμάθησης, θα χρησιμοποιήσετε Διαχωρίστε τις εφαρμογές Azure AD για την εφαρμογή API κλήσης και την προστατευμένη εφαρμογή API.

8. Σημειώστε την τιμή που βρίσκεται στο πλαίσιο **Δημιουργία εφαρμογή** εισαγωγής. θα μπορείτε να αναζητήσετε αυτήν AAD την εφαρμογή στην πύλη του Azure κλασική αργότερα.

7. Κάντε κλικ στο **κουμπί OK**.

10. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Κάντε κλικ στην επιλογή Αποθήκευση](./media/app-service-api-dotnet-service-principal-auth/saveauth.png)

    Εφαρμογής υπηρεσίας δημιουργεί μια εφαρμογή του Azure Active Directory με **σύνδεση διεύθυνσης URL** και ρύθμιση αυτόματα **Απάντηση διεύθυνση URL** για τη διεύθυνση URL της εφαρμογής σας API. Η τελευταία τιμή επιτρέπει στους χρήστες στο μισθωτή σας AAD για να συνδεθείτε και να αποκτήσετε πρόσβαση στην εφαρμογή API.

### <a name="verify-that-the-api-app-is-protected"></a>Βεβαιωθείτε ότι η εφαρμογή API είναι προστατευμένο

1. Σε ένα πρόγραμμα περιήγησης, μεταβείτε στη διεύθυνση URL της εφαρμογής API: στο την **εφαρμογή API** blade στην πύλη του Azure, κάντε κλικ στη σύνδεση στην περιοχή **διεύθυνση URL**. 

    Ανακατευθύνεστε σε οθόνη login επειδή δεν επιτρέπονται αιτήσεις χωρίς έλεγχο ταυτότητας για την επίτευξη της εφαρμογής API. 

    Εάν το πρόγραμμα περιήγησης, μεταβείτε σε Swagger περιβάλλον εργασίας Χρήστη του, το πρόγραμμα περιήγησης ήδη ενδέχεται να είστε συνδεδεμένοι στο--σε αυτήν την περίπτωση, ανοίξτε ένα παράθυρο InPrivate ή Incognito και μεταβείτε στη διεύθυνση URL Swagger περιβάλλοντος εργασίας Χρήστη.

18. Συνδεθείτε με τα διαπιστευτήρια ενός χρήστη στο μισθωτή σας AAD.

    Όταν είστε συνδεδεμένος, εμφανίζεται η σελίδα "δημιουργήθηκε με επιτυχία" στο πρόγραμμα περιήγησης.

## <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a>Ρύθμιση παραμέτρων του ToDoListAPI έργου για να αποκτήσετε και να στείλετε το διακριτικό Azure AD

Σε αυτήν την ενότητα μπορείτε να κάνετε τις ακόλουθες εργασίες:

* Προσθήκη κώδικα στην εφαρμογή API μεσαίας που χρησιμοποιεί τα διαπιστευτήρια Azure AD εφαρμογής για να αποκτήσετε ένα διακριτικό και στείλτε το με αιτήσεις HTTP στην εφαρμογή API σειρά δεδομένων.
* Λάβετε τα διαπιστευτήρια που χρειάζεστε από το Azure AD.
* Εισαγάγετε τα διαπιστευτήρια στο ρυθμίσεων περιβάλλοντος χρόνου εκτέλεσης Azure εφαρμογής υπηρεσίας στο μεσαίο επίπεδο εφαρμογής API. 

### <a name="configure-the-todolistapi-project-to-acquire-and-send-the-azure-ad-token"></a>Ρύθμιση παραμέτρων του ToDoListAPI έργου για να αποκτήσετε και να στείλετε το διακριτικό Azure AD

Κάντε τις ακόλουθες αλλαγές στο έργο ToDoListAPI στο Visual Studio.

1. Καταργήστε τα σχόλια από όλο τον κώδικα στο αρχείο *ServicePrincipal.cs* .

    Αυτός είναι ο κωδικός που χρησιμοποιεί ADAL για .NET για να αποκτήσετε το διακριτικό φορέα Azure AD.  Χρησιμοποιεί πολλές τιμές παραμέτρων που θα ορίσετε στο περιβάλλον χρόνου εκτέλεσης Azure αργότερα. Ακολουθεί ο κώδικας: 

        public static class ServicePrincipal
        {
            static string authority = ConfigurationManager.AppSettings["ida:Authority"];
            static string clientId = ConfigurationManager.AppSettings["ida:ClientId"];
            static string clientSecret = ConfigurationManager.AppSettings["ida:ClientSecret"];
            static string resource = ConfigurationManager.AppSettings["ida:Resource"];
        
            public static AuthenticationResult GetS2SAccessTokenForProdMSA()
            {
                return GetS2SAccessToken(authority, resource, clientId, clientSecret);
            }
        
            static AuthenticationResult GetS2SAccessToken(string authority, string resource, string clientId, string clientSecret)
            {
                var clientCredential = new ClientCredential(clientId, clientSecret);
                AuthenticationContext context = new AuthenticationContext(authority, false);
                AuthenticationResult authenticationResult = context.AcquireToken(
                    resource,
                    clientCredential);
                return authenticationResult;
            }
        }

    **Σημείωση:** Αυτός ο κωδικός απαιτεί το ADAL για πακέτο .NET NuGet (Microsoft.IdentityModel.Clients.ActiveDirectory), η οποία έχει ήδη εγκατασταθεί στο έργο. Εάν δημιουργείτε αυτό το έργο από την αρχή, θα πρέπει να εγκαταστήσετε αυτό το πακέτο. Αυτό το πακέτο δεν έχει εγκατασταθεί αυτόματα από το πρότυπο API εφαρμογή νέο έργο.

2. Στο *Ελεγκτές/ToDoListController*, καταργήστε τα σχόλια από τον κώδικα στο το `NewDataAPIClient` μέθοδο που προσθέτει το διακριτικό HTTP αιτήσεις στην κεφαλίδα της εξουσιοδότησης.

        client.HttpClient.DefaultRequestHeaders.Authorization =
            new AuthenticationHeaderValue("Bearer", ServicePrincipal.GetS2SAccessTokenForProdMSA().AccessToken);

3. Αναπτύξτε το έργο ToDoListAPI. (Κάντε δεξί κλικ στο έργο και, στη συνέχεια, κάντε κλικ στην επιλογή **Δημοσίευση > Δημοσίευση**.)

    Visual Studio ανάπτυξη του έργου και ανοίγει ένα πρόγραμμα περιήγησης για να βασική διεύθυνση URL του web app. Αυτό θα εμφανιστεί μια σελίδα σφάλματος 403, η οποία είναι κανονική για μιας προσπάθειας για να μεταβείτε σε μια διεύθυνση URL βάσης Web API από ένα πρόγραμμα περιήγησης.

4. Κλείστε το πρόγραμμα περιήγησης.

### <a name="get-azure-ad-configuration-values"></a>Λήψη Azure AD τιμές ρύθμισης παραμέτρων

11. Στην [πύλη του Azure κλασική](https://manage.windowsazure.com/), μεταβείτε στο **Azure Active Directory**.

12. Στην καρτέλα **καταλόγου** , κάντε κλικ στο μισθωτή σας AAD.

14. Κάντε κλικ στην επιλογή **εφαρμογές > εφαρμογές ανήκει η εταιρεία μου**, και, στη συνέχεια, κάντε κλικ στο σημάδι ελέγχου.

15. Στη λίστα των εφαρμογών, κάντε κλικ στο όνομα αυτό που δημιουργήσατε Azure για εσάς όταν έχετε ενεργοποιήσει ελέγχου ταυτότητας για την εφαρμογή API του ToDoListDataAPI (επίπεδο δεδομένων).

16. Κάντε κλικ στην καρτέλα **Ρύθμιση παραμέτρων** .

5. Αντιγράψτε την τιμή **Αναγνωριστικό υπολογιστή-πελάτη** και αποθηκεύστε το κάπου μπορείτε να προμηθευτείτε από αργότερα. 

8. Στην πύλη του Azure κλασική μετάβαση προς τα πίσω στη λίστα των **εφαρμογών που ανήκει η εταιρεία μου**και κάντε κλικ στην εφαρμογή AAD που δημιουργήσατε για την εφαρμογή ToDoListAPI API μεσαίας (αυτό που δημιουργήσατε στην προηγούμενη εκμάθηση, όχι αυτό που δημιουργήσατε σε αυτό το πρόγραμμα εκμάθησης).

16. Κάντε κλικ στην καρτέλα **Ρύθμιση παραμέτρων** .

5. Αντιγράψτε την τιμή **Αναγνωριστικό υπολογιστή-πελάτη** και αποθηκεύστε το κάπου μπορείτε να προμηθευτείτε από αργότερα.

6. Στην περιοχή **αριθμών-κλειδιών**, επιλέξτε **1 έτος** από την αναπτυσσόμενη λίστα **Επιλέξτε διάρκεια** .

6. Κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Δημιουργία εφαρμογής κλειδιού](./media/app-service-api-dotnet-service-principal-auth/genkey.png)

7. Αντιγράψτε την τιμή του κλειδιού και αποθηκεύστε το κάπου μπορείτε να προμηθευτείτε από αργότερα.

    ![Αντιγραφή νέο αριθμό-κλειδί εφαρμογής](./media/app-service-api-dotnet-service-principal-auth/genkeycopy.png)

### <a name="configure-azure-ad-settings-in-the-middle-tier-api-apps-runtime-environment"></a>Ρύθμιση παραμέτρων Azure AD στο περιβάλλον χρόνου εκτέλεσης της εφαρμογής του μεσαίας API

1. Μεταβείτε στην [πύλη του Azure](https://portal.azure.com/)και, στη συνέχεια, αναζητήστε την **Εφαρμογή API** blade για την εφαρμογή API που φιλοξενεί το έργο TodoListAPI (Μεσαία σειρά).

2. Κάντε κλικ στην επιλογή **Ρυθμίσεις > Ρυθμίσεις εφαρμογής**.

3. Στην ενότητα **Ρυθμίσεις εφαρμογής** , προσθέστε τα ακόλουθα κλειδιά και τιμές:

  	| **Πλήκτρο** | IDA: αρχή έκδοσης πιστοποιητικών |
  	|---|---|
  	| **Τιμή** | https://Login.microsoftonline.com/ {Azure AD μισθωτή ονόματος} |
  	| **Παράδειγμα** | https://Login.microsoftonline.com/contoso.onmicrosoft.com |

  	| **Πλήκτρο** | IDA: ClientId |
  	|---|---|
  	| **Τιμή** | Αναγνωριστικό υπολογιστή-πελάτη από την εφαρμογή κλήσης (μεσαίας - ToDoListAPI) |
  	| **Παράδειγμα** | 960adec2-b74a-484a-960adec2-b74a-484a |

  	| **Πλήκτρο** | IDA: ClientSecret |
  	|---|---|
  	| **Τιμή** | Πλήκτρο εφαρμογής από την εφαρμογή κλήσης (Μεσαία σειρά - ToDoListAPI) |
  	| **Παράδειγμα** | e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8 |

  	| **Πλήκτρο** | IDA: πόρων |
  	|---|---|
  	| **Τιμή** | Αναγνωριστικό υπολογιστή-πελάτη της εφαρμογής που ονομάζεται (επίπεδο δεδομένων - ToDoListDataAPI) |
  	| **Παράδειγμα** | e65e8fc9-5f6b-48e8-e65e8fc9-5f6b-48e8 |

    **Σημείωση**: για `ida:Resource`, βεβαιωθείτε ότι μπορείτε να χρησιμοποιήσετε την εφαρμογή που ονομάζεται **Αναγνωριστικό υπολογιστή-πελάτη** και όχι το **URI Αναγνωριστικό εφαρμογής**.

    `ida:ClientId`και `ida:Resource` είναι διαφορετικές τιμές για αυτό το πρόγραμμα εκμάθησης, επειδή χρησιμοποιείτε να διαχωρίσετε Azure AD applicaations για το μεσαίο επίπεδο και σειρά δεδομένων. Εάν χρησιμοποιείτε ένα μόνο εφαρμογή Azure AD για την εφαρμογή κλήσης API και η προστατευμένη εφαρμογή API, μπορείτε να χρησιμοποιήσετε την ίδια τιμή τόσο `ida:ClientId` και `ida:Resource`.

    Ο κώδικας χρησιμοποιεί ConfigurationManager για να λάβετε αυτές τις τιμές, ώστε να μπορεί να είναι αποθηκευμένα στο αρχείο Web.config του έργου ή στο περιβάλλον Azure χρόνου εκτέλεσης. Ενώ εκτελείται μια εφαρμογή του ASP.NET στο Azure εφαρμογής υπηρεσίας, ρυθμίσεων περιβάλλοντος παρακάμπτουν αυτόματα τις ρυθμίσεις από Web.config. Ρυθμίσεις περιβάλλοντος γενικά είναι μια [πιο ασφαλής τρόπος για να αποθηκεύσετε ευαίσθητες πληροφορίες σε σύγκριση με ένα αρχείο Web.config](http://www.asp.net/identity/overview/features-api/best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure).

6. Κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Κάντε κλικ στην επιλογή Αποθήκευση](./media/app-service-api-dotnet-service-principal-auth/appsettings.png)

### <a name="test-the-application"></a>Δοκιμή της εφαρμογής

1. Σε ένα πρόγραμμα περιήγησης, μεταβείτε στη διεύθυνση URL HTTPS της εφαρμογής web προσκηνίου AngularJS.

2. Κάντε κλικ στην καρτέλα **Λίστα εκκρεμών εργασιών** και συνδεθείτε με τα διαπιστευτήρια για ένα χρήστη στο μισθωτή του Azure AD. 

4. Προσθήκη εκκρεμών εργασιών για να βεβαιωθείτε ότι λειτουργεί η εφαρμογή.

    ![Λίστα εκκρεμών εργασιών σελίδας](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

    Εάν η εφαρμογή δεν λειτουργεί με τον αναμενόμενο τρόπο, ελέγξτε ξανά σε όλες τις ρυθμίσεις που καταχωρήσατε στην πύλη του Azure. Εάν όλες οι ρυθμίσεις εμφανίζονται σωστά, ανατρέξτε στην ενότητα [Αντιμετώπιση προβλημάτων](#troubleshooting) παρακάτω σε αυτό το πρόγραμμα εκμάθησης.

## <a name="protect-the-api-app-from-browser-access"></a>Προστασία της εφαρμογής API από πρόσβαση σε πρόγραμμα περιήγησης

Για αυτό το πρόγραμμα εκμάθησης που δημιουργήσατε μια ξεχωριστή εφαρμογή Azure AD για την εφαρμογή API ToDoListDataAPI (επίπεδο δεδομένων). Καθώς που έχετε δει, όταν εφαρμογής υπηρεσίας δημιουργεί μια εφαρμογή AAD, ρυθμίζει την εφαρμογή AAD με τον τρόπο που επιτρέπει στο χρήστη να μεταβείτε στη διεύθυνση URL του API της εφαρμογής σε ένα πρόγραμμα περιήγησης και συνδεθείτε. Αυτό σημαίνει ότι είναι δυνατή για τον τελικό χρήστη στο Azure AD μισθωτή σας, όχι μόνο μια υπηρεσία κεφαλαίου, για να αποκτήσετε πρόσβαση το API. 

Εάν θέλετε να αποτρέψετε την πρόσβαση σε πρόγραμμα περιήγησης χωρίς τη σύνταξη κώδικα στην προστατευμένη εφαρμογή API, μπορείτε να αλλάξετε τη **Διεύθυνση URL απάντηση** στην εφαρμογή AAD ώστε να είναι διαφορετική από την εφαρμογή του API βασική διεύθυνση URL. 

### <a name="disable-browser-access"></a>Απενεργοποίηση πρόσβαση σε πρόγραμμα περιήγησης

1. Στην καρτέλα **Ρύθμιση παραμέτρων** της πύλης κλασική για την εφαρμογή AAD που δημιουργήθηκε για το TodoListService, αλλάξτε την τιμή στο πεδίο **Διεύθυνση URL απάντηση** έτσι ώστε να είναι μια έγκυρη διεύθυνση URL, αλλά όχι διεύθυνση URL του API της εφαρμογής.
 
2. Κάντε κλικ στην επιλογή **Αποθήκευση**.

### <a name="verify-browser-access-no-longer-works"></a>Επαληθεύστε την πρόσβαση σε πρόγραμμα περιήγησης δεν λειτουργεί πλέον

Παλαιότερη έκδοση που έχει επαληθευτεί ότι μπορείτε να μεταβείτε στη διεύθυνση URL εφαρμογής API από ένα πρόγραμμα περιήγησης, πραγματοποιώντας σύνδεση με τα διαπιστευτήρια ενός μεμονωμένου χρήστη. Σε αυτήν την ενότητα, μπορείτε να επαληθεύσετε ότι αυτό δεν είναι πλέον δυνατή. 

1. Σε ένα νέο παράθυρο του προγράμματος περιήγησης, μεταβείτε στη διεύθυνση URL της εφαρμογής API ξανά.

2. Συνδεθείτε στο όταν σας ζητηθεί να το κάνετε.

3. Σύνδεση ολοκληρωθεί με επιτυχία, αλλά οδηγεί σε μια σελίδα σφάλματος.

    Έχετε ρυθμίσει τις παραμέτρους της εφαρμογής AAD ώστε οι χρήστες στο μισθωτή AAD δεν είναι δυνατό να συνδεθείτε στο και πρόσβαση το API από ένα πρόγραμμα περιήγησης. Εξακολουθείτε να μπορείτε να αποκτήσετε πρόσβαση στην εφαρμογή API, χρησιμοποιώντας μια υπηρεσία κεφαλαίου διακριτικό, το οποίο μπορείτε να επαληθεύσετε, μεταβαίνοντας στη διεύθυνση URL του web app και προσθήκη περισσότερων εκκρεμών εργασιών.

## <a name="restrict-access-to-a-particular-service-principal"></a>Περιορισμός πρόσβασης σε μια συγκεκριμένη υπηρεσία κεφάλαιο  

Προς το παρόν, οποιαδήποτε καλούντος που μπορεί να λάβετε ένα διακριτικό για ένα χρήστη ή υπηρεσία κεφάλαιο στο μισθωτή του Azure AD να καλέσετε την εφαρμογή API TodoListDataAPI (επίπεδο δεδομένων). Ενδέχεται να θέλετε να βεβαιωθείτε ότι η εφαρμογή API σειρά δεδομένων δέχεται μόνο κλήσεις από την εφαρμογή API (μεσαίας) TodoListAPI και μόνο από μια συγκεκριμένη υπηρεσία κεφάλαιο. 

Μπορείτε να προσθέσετε αυτούς τους περιορισμούς, προσθέτοντας κώδικα για να επικυρώσετε τη `appid` και `objectidentifier` αξιώσεων σε εισερχόμενες κλήσεις.

Για αυτό το πρόγραμμα εκμάθησης μπορείτε να τοποθετήσετε τον κώδικα που επικυρώσει Αναγνωριστικό εφαρμογής και κεφαλαίου Αναγνωριστικό υπηρεσίας απευθείας στο ενεργειών ελεγκτή σας.  Εναλλακτικές λύσεις είναι να χρησιμοποιήσετε μια προσαρμοσμένη `Authorize` χαρακτηριστικών ή για να γίνει αυτή η επικύρωση σε σας εκκίνησης ακολουθία (π.χ. το ενδιάμεσο OWIN). Για ένα παράδειγμα των τελευταίων, ανατρέξτε στο θέμα [αυτού του δείγματος εφαρμογής](https://github.com/mohitsriv/EasyAuthMultiTierSample/blob/master/MyDashDataAPI/Startup.cs). 

Κάντε τις ακόλουθες αλλαγές στο έργο TodoListDataAPI.

2. Ανοίξτε το αρχείο *Controllers/TodoListController.cs* .

3. Καταργήστε τα σχόλια από τις γραμμές που Ορισμός `trustedCallerClientId` και `trustedCallerServicePrincipalId`.

        private static string trustedCallerClientId = ConfigurationManager.AppSettings["todo:TrustedCallerClientId"];
        private static string trustedCallerServicePrincipalId = ConfigurationManager.AppSettings["todo:TrustedCallerServicePrincipalId"];

4. Καταργήστε τα σχόλια από τον κώδικα στη μέθοδο CheckCallerId. Αυτή η μέθοδος ονομάζεται κατά την έναρξη της κάθε μέθοδο ενέργεια στον ελεγκτή. 

        private static void CheckCallerId()
        {
            string currentCallerClientId = ClaimsPrincipal.Current.FindFirst("appid").Value;
            string currentCallerServicePrincipalId = ClaimsPrincipal.Current.FindFirst("http://schemas.microsoft.com/identity/claims/objectidentifier").Value;
            if (currentCallerClientId != trustedCallerClientId || currentCallerServicePrincipalId != trustedCallerServicePrincipalId)
            {
                throw new HttpResponseException(new HttpResponseMessage { StatusCode = HttpStatusCode.Unauthorized, ReasonPhrase = "The appID or service principal ID is not the expected value." });
            }
        }

5. Αναπτύξτε ξανά το έργο ToDoListDataAPI να Azure εφαρμογής υπηρεσίας.

6. Στο πρόγραμμα περιήγησης, μεταβείτε στη διεύθυνση URL HTTPS AngularJS προσκηνίου εφαρμογή web της και στην αρχική σελίδα, κάντε κλικ στην καρτέλα **Λίστα εκκρεμών εργασιών** .

    Η εφαρμογή δεν λειτουργεί επειδή αποτυγχάνουν κλήσεων στο παρασκήνιο. Ελέγχει το νέο κωδικό πραγματική αναγνωριστικό εφαρμογής και objectidentifier, αλλά ακόμα δεν έχει τις σωστές τιμές για να ελέγξετε τους σε σχέση με. Κονσόλα εργαλεία για προγραμματιστές αναφέρει ότι ο διακομιστής επιστρέφει ένα σφάλμα HTTP 401 στο πρόγραμμα περιήγησης.

    ![Κονσόλα Εργαλεία σφάλματος στο για προγραμματιστές](./media/app-service-api-dotnet-service-principal-auth/webapperror.png)

    Στα παρακάτω βήματα μπορείτε να ρυθμίσετε τις αναμενόμενες τιμές.

8. Χρήση του Azure AD PowerShell, εμφανίζεται η τιμή του κύριου υπηρεσίας για την εφαρμογή Azure AD που δημιουργήσατε για το έργο TodoListWebApp.

    μια. Για οδηγίες σχετικά με την εγκατάσταση του Azure PowerShell και να συνδεθείτε με τη συνδρομή σας, ανατρέξτε στο θέμα [Χρήση του PowerShell Azure με τη διαχείριση πόρων Azure](../powershell-azure-resource-manager.md).

    β. Για να λάβετε μια λίστα με τις αρχές υπηρεσίας, εκτελέστε το `Login-AzureRmAccount` εντολή και, στη συνέχεια, το `Get-AzureRmADServicePrincipal` εντολή.

    c. Βρείτε το objectid για το κεφάλαιο υπηρεσίας της εφαρμογής TodoListAPI και αποθηκεύστε το σε μια θέση, μπορείτε να αντιγράψετε από αργότερα.

7. Στην πύλη του Azure, μεταβείτε το blade εφαρμογής API για την εφαρμογή API που αναπτυχθεί το έργο ToDoListDataAPI να.

9. Κάντε κλικ στην επιλογή **Ρυθμίσεις > Ρυθμίσεις εφαρμογής**.

3. Στην ενότητα **Ρυθμίσεις εφαρμογής** , προσθέστε τα ακόλουθα κλειδιά και τιμές:

  	| **Πλήκτρο** | Todo:TrustedCallerServicePrincipalId |
  	|---|---|
  	| **Τιμή** | Αναγνωριστικό υπηρεσίας κεφαλαίου κλήσεις εφαρμογής |
  	| **Παράδειγμα** | 4f4a94a4-6f0d-4072-4f4a94a4-6f0d-4072 |

  	| **Πλήκτρο** | Todo:TrustedCallerClientId |
  	|---|---|
  	| **Τιμή** | Αναγνωριστικό υπολογιστή-πελάτη κλήσεις εφαρμογή - αντιγραφεί από την εφαρμογή TodoListAPI Azure AD |
  	| **Παράδειγμα** | 960adec2-b74a-484a-960adec2-b74a-484a |

6. Κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Κάντε κλικ στην επιλογή Αποθήκευση](./media/app-service-api-dotnet-service-principal-auth/trustedcaller.png)

6. Στο πρόγραμμα περιήγησης, επιστρέψτε στη διεύθυνση URL του web app και στην αρχική σελίδα, κάντε κλικ στην καρτέλα **Λίστα εκκρεμών εργασιών** .

    Αυτήν τη στιγμή η εφαρμογή λειτουργεί όπως αναμένεται, επειδή η εφαρμογή αξιόπιστων καλούντος Αναγνωριστικό και Αναγνωριστικό υπηρεσίας κεφαλαίου είναι τις αναμενόμενες τιμές.

    ![Λίστα εκκρεμών εργασιών σελίδας](./media/app-service-api-dotnet-service-principal-auth/mvchome.png)

## <a name="building-the-projects-from-scratch"></a>Δημιουργία τα έργα από την αρχή

Τα δύο έργα Web API δημιουργήθηκαν χρησιμοποιώντας το πρότυπο έργου **Εφαρμογής API Azure** και αντικατάστασης του ελεγκτή προεπιλεγμένες τιμές με έναν ελεγκτή ToDoList. Σχετικά με την απόκτηση Azure AD υπηρεσίας κεφαλαίου διακριτικά του έργου ToDoListAPI, το πακέτο NuGet [Active Directory ελέγχου ταυτότητας βιβλιοθήκης (ADAL) για το .NET](https://www.nuget.org/packages/Microsoft.IdentityModel.Clients.ActiveDirectory/) έχει εγκατασταθεί.
 
Για πληροφορίες σχετικά με τον τρόπο για να δημιουργήσετε μια εφαρμογή μίας σελίδας AngularJS με μια παρασκηνίου Web API όπως ToDoListAngular, ανατρέξτε στο θέμα [χέρια σε εργαστήριο: Δημιουργήστε μια μεμονωμένη εφαρμογή σελίδας (SPA) με το API Web ASP.NET και Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs). Για πληροφορίες σχετικά με τον τρόπο για να προσθέσετε κώδικα Azure AD ελέγχου ταυτότητας, ανατρέξτε στο θέμα [Ασφάλιση AngularJS μία μόνο σελίδα εφαρμογών με το Azure AD](../active-directory/active-directory-devquickstarts-angular.md).

## <a name="troubleshooting"></a>Αντιμετώπιση προβλημάτων

[AZURE.INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* Βεβαιωθείτε ότι έχετε Μην συγχέετε ToDoListAPI (Μεσαίο επίπεδο) και ToDoListDataAPI (επίπεδο δεδομένων). Για παράδειγμα, σε αυτό το πρόγραμμα εκμάθησης προσθέτετε τον έλεγχο ταυτότητας της εφαρμογής API σειρά δεδομένων, **αλλά το πλήκτρο εφαρμογής πρέπει να προέρχεται από την εφαρμογή Azure AD που δημιουργήσατε για την εφαρμογή μεσαίας API**.

## <a name="next-steps"></a>Επόμενα βήματα

Αυτό είναι το τελευταίο πρόγραμμα εκμάθησης της σειράς API εφαρμογές. 

Για περισσότερες πληροφορίες σχετικά με το Azure Active Directory, ανατρέξτε στους ακόλουθους πόρους.

* [Οδηγός Azure AD τους προγραμματιστές'](http://aka.ms/aaddev)
* [Azure AD σενάρια](http://aka.ms/aadscenarios)
* [Azure AD δείγματα](http://aka.ms/aadsamples)

    Το δείγμα [WebApp-WebAPI-OAuth2-AppIdentity-DotNet](http://github.com/AzureADSamples/WebApp-WebAPI-OAuth2-AppIdentity-DotNet) είναι παρόμοιο με αυτό που φαίνεται στο παρόν πρόγραμμα εκμάθησης, αλλά χωρίς τη χρήση ελέγχου ταυτότητας εφαρμογής υπηρεσίας.

Για πληροφορίες σχετικά με άλλους τρόπους για να αναπτύξετε τα έργα Visual Studio σε εφαρμογές API, με χρήση του Visual Studio ή με [Αυτοματοποίηση ανάπτυξης](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/continuous-integration-and-continuous-delivery) από ένα [σύστημα ελέγχου προέλευσης](http://www.asp.net/aspnet/overview/developing-apps-with-windows-azure/building-real-world-cloud-apps-with-windows-azure/source-control), δείτε [πώς μπορείτε να αναπτύξετε μια εφαρμογή Azure εφαρμογής υπηρεσίας](../app-service-web/web-sites-deploy.md).
