<properties
    pageTitle="Έλεγχος ταυτότητας χρήστη για τις εφαρμογές API στο Azure εφαρμογής υπηρεσίας | Microsoft Azure"
    description="Μάθετε πώς να προστατεύσετε εφαρμογής API στο Azure εφαρμογής υπηρεσίας όταν επιτρέπετε την πρόσβαση μόνο σε χρήστες με έλεγχο ταυτότητας."
    services="app-service\api"
    documentationCenter=".net"
    authors="tdykstra"
    manager="wpickett"
    editor=""/>

<tags
    ms.service="app-service-api"
    ms.workload="na"
    ms.tgt_pltfrm="dotnet"
    ms.devlang="na"
    ms.topic="article"
    ms.date="06/30/2016"
    ms.author="rachelap"/>

# <a name="user-authentication-for-api-apps-in-azure-app-service"></a>Έλεγχος ταυτότητας χρήστη για τις εφαρμογές API στο Azure εφαρμογής υπηρεσίας

## <a name="overview"></a>Επισκόπηση

Σε αυτό το άρθρο δείχνει πώς να προστατεύσετε εφαρμογής Azure API, έτσι ώστε μόνο οι εξουσιοδοτημένοι χρήστες να καλέσετε αυτό. Το άρθρο προϋποθέτει ότι έχετε διαβάσει το [Azure εφαρμογής υπηρεσίας Επισκόπηση ελέγχου ταυτότητας](../app-service/app-service-authentication-overview.md).

Θα μάθετε:

* Μάθετε πώς μπορείτε να ρυθμίσετε μια υπηρεσία παροχής ελέγχου ταυτότητας, με λεπτομέρειες για το Azure Active Directory (Azure AD).
* Τρόπος για την εκμετάλλευση μια προστατευμένη εφαρμογή API με τη χρήση του [Active Directory ελέγχου ταυτότητας βιβλιοθήκης (ADAL) για JavaScript](https://github.com/AzureAD/azure-activedirectory-library-for-js).

Το άρθρο περιέχει δύο ενότητες:

* Στην ενότητα [πώς μπορείτε να ρυθμίσετε τον έλεγχο ταυτότητας χρήστη στην υπηρεσία εφαρμογής Azure](#authconfig) γενικά εξηγεί πώς μπορείτε να ρυθμίσετε τον έλεγχο ταυτότητας χρήστη για οποιαδήποτε εφαρμογή του API και ισχύει και για όλα τα πλαίσια που υποστηρίζονται από το εφαρμογής υπηρεσίας, συμπεριλαμβανομένης της .NET, Node.js και Java.

* Ξεκινώντας με την ενότητα [συνεχίσετε τα προγράμματα εκμάθησης για το .NET API εφαρμογές](#tutorialstart) , τους οδηγούς άρθρο σας καθοδηγεί στη ρύθμιση των παραμέτρων μιας εφαρμογής δείγμα με ένα .NET πίσω τέλος και το τέλος μιας εμπρός AngularJS έτσι ώστε να χρησιμοποιεί Azure Active Directory για τον έλεγχο ταυτότητας χρήστη. 

## <a id="authconfig"></a>Πώς να ρυθμίζετε τον έλεγχο ταυτότητας χρήστη στο Azure εφαρμογής υπηρεσίας

Αυτή η ενότητα παρέχει γενικές οδηγίες που ισχύουν για οποιαδήποτε εφαρμογή API. Για συγκεκριμένα βήματα για να το δείγμα εφαρμογής για να την κάνετε .NET σε λίστα, μεταβείτε σε [συνεχείς τα προγράμματα εκμάθησης για το .NET γρήγορα αποτελέσματα](#tutorialstart).

1. Στην [πύλη του Azure](https://portal.azure.com/), μεταβείτε στο το blade **ρυθμίσεων** της εφαρμογής API που θέλετε να προστατεύσετε, βρείτε την ενότητα **δυνατοτήτων** και, στη συνέχεια, κάντε κλικ στην επιλογή **ελέγχου ταυτότητας / εξουσιοδότησης**.

    ![Έλεγχος ταυτότητας/εξουσιοδότησης Azure πύλη](./media/app-service-api-dotnet-user-principal-auth/features.png)

3. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ **στο**.

4. Επιλέξτε μία από τις επιλογές από την αναπτυσσόμενη λίστα **ενέργεια κατά την αίτηση δεν έχει γίνει έλεγχος ταυτότητας** .

    * Εάν θέλετε μόνο με έλεγχο ταυτότητας κλήσεις για την επίτευξη της εφαρμογής σας API, επιλέξτε μία από τις επιλογές που **συνδέονται με...** . Αυτή η επιλογή σάς επιτρέπει να προστατεύσετε την εφαρμογή API χωρίς τη σύνταξη κώδικα που εκτελείται σε αυτό.

    * Εάν θέλετε όλες οι κλήσεις για την επίτευξη της εφαρμογής σας API, επιλέξτε **Αποδοχή αίτησης (καμία ενέργεια)**. Μπορείτε να χρησιμοποιήσετε αυτήν την επιλογή για να κατευθύνετε καλούντες χωρίς έλεγχο ταυτότητας με μια ποικιλία από υπηρεσίες παροχής ελέγχου ταυτότητας. Με αυτήν την επιλογή πρέπει να σύνταξη κώδικα για το χειρισμό εξουσιοδότησης.

    Για περισσότερες πληροφορίες, ανατρέξτε στο θέμα [Έλεγχος ταυτότητας και εξουσιοδότησης για τις εφαρμογές API στο Azure εφαρμογής υπηρεσίας](app-service-api-authentication.md#multiple-protection-options).

5. Επιλέξτε μία ή περισσότερες από τις **Υπηρεσίες παροχής ελέγχου ταυτότητας**.

    Η εικόνα εμφανίζει τις επιλογές που απαιτούν όλες οι καλούντες να γίνει έλεγχος ταυτότητας με Azure AD.
 
    ![Azure blade ελέγχου ταυτότητας/εξουσιοδότησης πύλης](./media/app-service-api-dotnet-user-principal-auth/authblade.png)

    Όταν επιλέγετε μια υπηρεσία παροχής ελέγχου ταυτότητας, την πύλη Εμφανίζει μια blade ρύθμισης παραμέτρων για αυτήν την υπηρεσία παροχής. 

    Για λεπτομερείς οδηγίες που εξηγούν τον τρόπο για να ρυθμίσετε τις λεπίδες ρύθμισης παραμέτρων υπηρεσίας παροχής ελέγχου ταυτότητας, δείτε [πώς μπορείτε να ρυθμίσετε τις παραμέτρους του εφαρμογής υπηρεσίας εφαρμογών για να χρησιμοποιήσετε login Azure Active Directory](../app-service-mobile/app-service-mobile-how-to-configure-active-directory-authentication.md). (Μεταβαίνει στη σύνδεση για ένα άρθρο σχετικά με το Azure AD, αλλά το ίδιο το άρθρο περιέχει καρτέλες που συνδέονται με άρθρα για τις άλλες υπηρεσίες παροχής ελέγχου ταυτότητας.)

7. Όταν ολοκληρώσετε την εργασία με το blade ρύθμισης παραμέτρων υπηρεσίας παροχής ελέγχου ταυτότητας, κάντε κλικ στο **κουμπί OK**.

7. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ στην επιλογή **Αποθήκευση**.

Μόλις γίνει αυτό, εφαρμογής υπηρεσίας πραγματοποιεί έλεγχο ταυτότητας όλες τις κλήσεις API πριν από την πάροδο της εφαρμογής API. Οι υπηρεσίες ελέγχου ταυτότητας λειτουργούν με τον ίδιο για όλες τις γλώσσες που υποστηρίζει εφαρμογής υπηρεσίας, συμπεριλαμβανομένης της .NET, Node.js και Java. 

Για να κάνετε κλήσεις με έλεγχο ταυτότητας API, τον καλούντα περιλαμβάνει το διακριτικό φορέα OAuth 2.0 της υπηρεσίας παροχής ελέγχου ταυτότητας στην κεφαλίδα της εξουσιοδότησης των αιτήσεων HTTP. Το διακριτικό μπορεί να είναι απόκτηση με τη χρήση της υπηρεσίας παροχής ελέγχου ταυτότητας SDK.

## <a id="tutorialstart"></a>Συνέχιση τα προγράμματα εκμάθησης για το .NET API εφαρμογές

Εάν ακολουθείτε τα προγράμματα εκμάθησης Node.js ή Java για τις εφαρμογές του API, μεταβείτε στο επόμενο άρθρο, [υπηρεσία κεφαλαίου ελέγχου ταυτότητας για τις εφαρμογές του API](app-service-api-dotnet-service-principal-auth.md). 

Εάν ακολουθείτε τη σειρά προγραμμάτων εκμάθησης .NET για τις εφαρμογές API και έχετε ήδη αναπτύξει το δείγμα εφαρμογής σύμφωνα με τα προγράμματα εκμάθησης για το [πρώτο](app-service-api-dotnet-get-started.md) και το [δεύτερο](app-service-api-cors-consume-javascript.md) οδηγίες, μεταβείτε στην ενότητα [Ρύθμιση του ελέγχου ταυτότητας σε εφαρμογής υπηρεσίας και Azure AD](#azureauth) .

Εάν θέλετε να παρακολουθήσετε αυτό το πρόγραμμα εκμάθησης χωρίς να διέρχονται από τα προγράμματα εκμάθησης για το πρώτο και το δεύτερο, ακολουθήστε τα παρακάτω βήματα που εξηγούν τον τρόπο για να ξεκινήσετε, χρησιμοποιώντας μια αυτοματοποιημένη διαδικασία για να αναπτύξετε το δείγμα εφαρμογής.

>[AZURE.NOTE] Ακολουθήστε τα παρακάτω βήματα σας βοηθήσουν να στο ίδιο σημείο έναρξης σαν που κάνατε τα πρώτα δύο προγράμματα εκμάθησης, με μία εξαίρεση: Visual Studio ήδη δεν γνωρίζετε ποια εφαρμογή web ή εφαρμογή API που κάθε έργο λαμβάνει αναπτυχθεί σε. Αυτό σημαίνει ότι δεν θα έχετε ακριβή οδηγίες σε αυτό το πρόγραμμα εκμάθησης που εξηγούν τον τρόπο ανάπτυξης για να τους στόχους δεξιά. Εάν δεν είστε εξοικειωμένοι με την κατανόηση πώς μπορείτε να κάνετε τα βήματα ανάπτυξης μόνοι σας, είναι καλύτερα να ακολουθήσετε τη σειρά προγραμμάτων εκμάθησης από την [πρώτη πρόγραμμα εκμάθησης](app-service-api-dotnet-get-started.md) από για να ξεκινήσετε με αυτήν τη διαδικασία αυτοματοποιημένης ανάπτυξης.

1. Βεβαιωθείτε ότι έχετε όλες τις προϋποθέσεις που αναφέρονται στην [πρώτη πρόγραμμα εκμάθησης](app-service-api-dotnet-get-started.md). Εκτός από τις προϋποθέσεις που αναγράφονται, αυτά τα προγράμματα εκμάθησης για τον έλεγχο ταυτότητας λαμβάνεται ως δεδομένο ότι έχετε εργαστεί με εφαρμογές web της υπηρεσίας εφαρμογών και API εφαρμογές στο Visual Studio και την πύλη του Azure.

2. Κάντε κλικ στο κουμπί **Ανάπτυξη να Azure** στο [αρχείο readme αποθετήριο δείγμα λίστα εκκρεμών εργασιών](https://github.com/azure-samples/app-service-api-dotnet-todo-list/blob/master/readme.md) για να αναπτύξετε τις εφαρμογές του API και την εφαρμογή web. Σημειώστε την ομάδα Azure πόρων που λαμβάνει δημιουργήθηκε, όπως μπορείτε να το χρησιμοποιήσετε αργότερα για να αναζητήσετε web app και το API εφαρμογή ονομάτων.
 
3. Κάντε λήψη ή κλωνοποίηση στο [αποθετήριο δεδομένων δείγματος λίστα εκκρεμών εργασιών](https://github.com/Azure-Samples/app-service-api-dotnet-todo-list) για να λάβετε τον κωδικό που θα λειτουργούν με τοπικά στο Visual Studio.

## <a id="azureauth"></a>Ρύθμιση του ελέγχου ταυτότητας σε εφαρμογής υπηρεσίας και Azure AD

Τώρα έχετε την εφαρμογή που εκτελείται στο Azure εφαρμογής υπηρεσίας χωρίς να απαιτείται ότι οι χρήστες να γίνει έλεγχος ταυτότητας. Σε αυτήν την ενότητα, μπορείτε να προσθέσετε τον έλεγχο ταυτότητας, κάνοντας τα εξής:

* Ρύθμιση παραμέτρων εφαρμογής υπηρεσίας ώστε να απαιτεί έλεγχο ταυτότητας Azure Active Directory (Azure AD) για την κλήση της εφαρμογής μεσαίας API.
* Δημιουργία μιας εφαρμογής Azure AD.
* Ρύθμιση παραμέτρων της εφαρμογής Azure AD για να στείλετε το διακριτικό φορέα μετά τη σύνδεση σε προσκηνίου της AngularJS. 

Εάν αντιμετωπίσετε προβλήματα κατά την ακολουθώντας τις οδηγίες του προγράμματος εκμάθησης, ανατρέξτε στην ενότητα [Αντιμετώπιση προβλημάτων](#troubleshooting) στο τέλος του προγράμματος εκμάθησης. 
 
### <a name="configure-authentication-for-the-middle-tier-api-app"></a>Ρύθμιση παραμέτρων ελέγχου ταυτότητας για την εφαρμογή API Μεσαία σειρά

1. Στην [πύλη του Azure](https://portal.azure.com/), μεταβείτε το blade **ρυθμίσεων** της εφαρμογής API που δημιουργήσατε για το έργο ToDoListAPI, βρείτε την ενότητα **δυνατοτήτων** και, στη συνέχεια, κάντε κλικ στην επιλογή **ελέγχου ταυτότητας / εξουσιοδότησης**.

    ![Έλεγχος ταυτότητας/εξουσιοδότησης Azure πύλη](./media/app-service-api-dotnet-user-principal-auth/features.png)

3. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ **στο**.

4. Στην αναπτυσσόμενη λίστα **ενέργεια κατά την αίτηση δεν έχει γίνει έλεγχος ταυτότητας** , επιλέξτε **συνδεθείτε με Azure Active Directory**.

    Αυτή η επιλογή εξασφαλίζει ότι δεν υπάρχει αιτήσεις unauathenticated θα φτάνουν την εφαρμογή API. 

5. Στην περιοχή **Υπηρεσιών παροχής ελέγχου ταυτότητας**, κάντε κλικ στην επιλογή **Azure Active Directory**.

    ![Azure blade ελέγχου ταυτότητας/εξουσιοδότησης πύλης](./media/app-service-api-dotnet-user-principal-auth/authblade.png)

6. Στο το blade **Azure Active Directory ρυθμίσεις** , κάντε κλικ στην επιλογή **Express**

    ![Azure πύλης επιλογή ελέγχου ταυτότητας/εξουσιοδότησης Express](./media/app-service-api-dotnet-user-principal-auth/aadsettings.png)

    Με την επιλογή **Express** , εφαρμογής υπηρεσίας να δημιουργήσετε αυτόματα μια εφαρμογή του Azure AD στο [μισθωτή](https://msdn.microsoft.com/en-us/library/azure/jj573650.aspx#BKMK_WhatIsAnAzureADTenant)του Azure AD. 

    Δεν χρειάζεται να δημιουργήσετε ένα μισθωτή, επειδή κάθε λογαριασμός Azure έχει αυτόματα μία.

7. Στην περιοχή **Διαχείριση λειτουργία**, κάντε κλικ στην επιλογή **Δημιουργία νέας εφαρμογής AD** , εάν δεν είναι ήδη επιλεγμένη και παρατηρήστε την τιμή που βρίσκεται στο πλαίσιο κειμένου **Δημιουργία την εφαρμογή** . θα μπορείτε να αναζητήσετε αυτήν AAD την εφαρμογή στην πύλη του Azure κλασική αργότερα.

    ![Ρυθμίσεις πύλης Azure Azure AD](./media/app-service-api-dotnet-user-principal-auth/aadsettings2.png)

    Azure δημιουργεί αυτόματα μια εφαρμογή του Azure AD με το όνομα του καθορισμένου στο μισθωτή του Azure AD. Από προεπιλογή, η εφαρμογή Azure AD είναι το ίδιο όνομα με την εφαρμογή API. Εάν προτιμάτε, μπορείτε να εισαγάγετε ένα διαφορετικό όνομα.
 
7. Κάντε κλικ στο **κουμπί OK**.

7. Στο το **ελέγχου ταυτότητας / εξουσιοδότησης** blade, κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Κάντε κλικ στην επιλογή Αποθήκευση](./media/app-service-api-dotnet-user-principal-auth/authsave.png)

Τώρα, μόνο οι χρήστες στο μισθωτή του Azure AD να καλέσετε την εφαρμογή API.

### <a name="optional-test-the-api-app"></a>Προαιρετικό: Δοκιμή της εφαρμογής API

1. Σε ένα πρόγραμμα περιήγησης, μεταβείτε στη διεύθυνση URL της εφαρμογής API: στο την **εφαρμογή API** blade στην πύλη του Azure, κάντε κλικ στη σύνδεση στην περιοχή **διεύθυνση URL**.  

    Ανακατευθύνεστε σε οθόνη login επειδή δεν επιτρέπονται αιτήσεις χωρίς έλεγχο ταυτότητας για την επίτευξη της εφαρμογής API.

    Εάν το πρόγραμμα περιήγησης μεταβαίνει στη σελίδα "δημιουργήθηκε με επιτυχία", ήδη ενδέχεται να είστε συνδεδεμένοι στο πρόγραμμα περιήγησης και στο--σε αυτήν την περίπτωση, ανοίξτε ένα παράθυρο InPrivate ή Incognito και μεταβείτε στη διεύθυνση URL του API της εφαρμογής.

2. Συνδεθείτε χρησιμοποιώντας τα διαπιστευτήρια για ένα χρήστη στο μισθωτή του Azure AD.

    Όταν είστε συνδεδεμένος, εμφανίζεται η σελίδα "δημιουργήθηκε με επιτυχία" στο πρόγραμμα περιήγησης.

9. Κλείστε το πρόγραμμα περιήγησης.

### <a name="configure-the-azure-ad-application"></a>Ρύθμιση παραμέτρων της εφαρμογής Azure AD

Όταν έχετε ρυθμίσει τις παραμέτρους Azure AD ελέγχου ταυτότητας, εφαρμογής υπηρεσίας δημιουργείται μια εφαρμογή του Azure AD για εσάς. Από προεπιλογή, το νέο Azure AD εφαρμογή έχει ρυθμιστεί για την παροχή το διακριτικό φορέα διεύθυνση URL του API της εφαρμογής. Σε αυτήν την ενότητα μπορείτε να ρυθμίσετε την εφαρμογή Azure AD για την παροχή το διακριτικό φορέα για AngularJS προσκηνίου της αντί απευθείας στην εφαρμογή του μεσαίας API. Προσκηνίου της AngularJS θα σας στείλει το διακριτικό στην εφαρμογή API όταν καλεί την εφαρμογή API.

>[AZURE.NOTE] Για να διατηρήσετε τη διαδικασία ως απλή όσο το δυνατόν πιο, αυτό χρησιμοποιεί προγραμμάτων εκμάθησης μια μεμονωμένη Azure AD εφαρμογής για το προσκήνιο και τη μέση σειρά API εφαρμογής. Μια άλλη επιλογή είναι να χρησιμοποιήσετε δύο Azure AD εφαρμογών. Σε αυτήν την περίπτωση θα πρέπει να δώσετε δικαιώματα εφαρμογής Azure AD του προσκηνίου της για να καλέσετε εφαρμογή Azure AD στο μεσαίο επίπεδο. Αυτή η προσέγγιση πολλαπλών εφαρμογής θα σας δώσει πιο λεπτομερές έλεγχο δικαιώματα για κάθε επίπεδο.

11. Στην [πύλη του Azure κλασική](https://manage.windowsazure.com/), μεταβείτε στο **Azure Active Directory**.

    Πρέπει να χρησιμοποιήσουν την πύλη κλασική επειδή ορισμένες ρυθμίσεις Azure Active Directory που πρέπει να έχετε πρόσβαση σε δεν είναι ακόμη διαθέσιμες στην πύλη του τρέχοντος Azure.

12. Στην καρτέλα **καταλόγου** , κάντε κλικ στο μισθωτή σας AAD.

    ![Azure AD στην κλασική πύλη](./media/app-service-api-dotnet-user-principal-auth/selecttenant.png)

14. Κάντε κλικ στην επιλογή **εφαρμογές > εφαρμογές ανήκει η εταιρεία μου**, και, στη συνέχεια, κάντε κλικ στο σημάδι ελέγχου.

    Ίσως χρειαστεί επίσης να ανανεώσετε τη σελίδα για να δείτε τη νέα εφαρμογή.

15. Στη λίστα των εφαρμογών, κάντε κλικ στο όνομα από αυτήν που Azure δημιουργείται για εσάς όταν έχετε ενεργοποιήσει ελέγχου ταυτότητας για την εφαρμογή σας API.

    ![Καρτέλα Azure AD εφαρμογές](./media/app-service-api-dotnet-user-principal-auth/appstab.png)

16. Κάντε κλικ στην επιλογή **Ρύθμιση παραμέτρων**.

    ![Καρτέλα Azure AD ρύθμιση παραμέτρων](./media/app-service-api-dotnet-user-principal-auth/configure.png)

17. Ρύθμιση **καθολικής σύνδεσης διεύθυνσης URL** για τη διεύθυνση URL για την εφαρμογή web AngularJS, χωρίς κάθετο.

    Για παράδειγμα: https://todolistangular.azurewebsites.net

    ![Σύνδεση διεύθυνσης URL](./media/app-service-api-dotnet-user-principal-auth/signonurlazure.png)

17. Ορισμός **Διεύθυνσης URL απάντηση** στη διεύθυνση URL για την εφαρμογή web της, χωρίς κάθετο.

    Για παράδειγμα: https://todolistsangular.azurewebsites.net

16. Κάντε κλικ στην επιλογή **Αποθήκευση**.

    ![Διεύθυνση URL απάντηση](./media/app-service-api-dotnet-user-principal-auth/replyurlazure.png)

15. Στο κάτω μέρος της σελίδας, κάντε κλικ στην επιλογή **δηλωτικό Διαχείριση > λήψη δηλωτικό**.

    ![Λήψη δηλωτικό](./media/app-service-api-dotnet-user-principal-auth/downloadmanifest.png)

17. Κάντε λήψη του αρχείου σε μια θέση όπου μπορείτε να το επεξεργαστείτε.

16. Το αρχείο που έχετε λάβει δήλωσης, αναζητήστε το `oauth2AllowImplicitFlow` την ιδιότητα. Αλλαγή της τιμής αυτής της ιδιότητας από `false` σε `true`, και, στη συνέχεια, αποθηκεύστε το αρχείο.

    Αυτή η ρύθμιση είναι απαραίτητες για την πρόσβαση από μια εφαρμογή JavaScript μίας σελίδας. Ενεργοποιεί το διακριτικό φορέα Oauth 2.0 θα επιστραφεί στο τμήμα της διεύθυνσης URL.

16. Κάντε κλικ στην επιλογή **δηλωτικό Διαχείριση > Αποστολή δηλωτικό**, και στείλτε το αρχείο που θα ενημερωθούν στο προηγούμενο βήμα.

    ![Αποστολή δήλωσης](./media/app-service-api-dotnet-user-principal-auth/uploadmanifest.png)

17. Αντιγράψτε την τιμή **Αναγνωριστικό υπολογιστή-πελάτη** και αποθηκεύστε το κάπου μπορείτε να προμηθευτείτε από αργότερα.

## <a name="configure-the-todolistangular-project-to-use-authentication"></a>Ρύθμιση παραμέτρων του ToDoListAngular έργου για να χρησιμοποιήσετε τον έλεγχο ταυτότητας

Σε αυτήν την ενότητα Αλλαγή προσκηνίου της AngularJS έτσι ώστε να χρησιμοποιεί Active Directory ελέγχου ταυτότητας βιβλιοθήκης (ADAL) για JS να αποκτήσετε ένα διακριτικό φορέα για το χρήστη είναι συνδεδεμένος από Azure AD. Ο κώδικας θα περιλαμβάνει το διακριτικό στο HTTP προσκλήσεις που αποστέλλονται στο μεσαίο επίπεδο, όπως φαίνεται στο ακόλουθο διάγραμμα. 

![Διάγραμμα ελέγχου ταυτότητας χρήστη](./media/app-service-api-dotnet-user-principal-auth/appdiagram.png)

Κάνετε τις ακόλουθες αλλαγές σε αρχεία του έργου ToDoListAngular.

1. Ανοίξτε το αρχείο *index.html* .

2. Καταργήστε τα σχόλια από τις γραμμές που αναφέρονται το Active Directory ελέγχου ταυτότητας βιβλιοθήκη (ADAL) για τις δέσμες ενεργειών JS.

        <script src="app/scripts/adal.js"></script>
        <script src="app/scripts/adal-angular.js"></script>

1. Ανοίξτε το αρχείο *app/scripts/app.js* .

2. Σχόλιο από το τμήμα κώδικα που έχει επισημανθεί για "χωρίς έλεγχο ταυτότητας" και καταργήστε τα σχόλια από το τμήμα κώδικα που έχει επισημανθεί για "με έλεγχο ταυτότητας".

    Αυτή η αλλαγή αναφέρεται η υπηρεσία παροχής ελέγχου ταυτότητας ADAL JS και παρέχει τιμές παραμέτρων σε αυτήν. Στα παρακάτω βήματα μπορείτε να ορίσετε τις τιμές παραμέτρων για το API εφαρμογής και εφαρμογή Azure AD.

8. Στον κώδικα που ορίζει το `endpoints` μεταβλητή, ορίστε τη διεύθυνση URL API στη διεύθυνση URL της εφαρμογής API που δημιουργήσατε για το έργο ToDoListAPI, και ορίστε το Αναγνωριστικό εφαρμογής Azure AD για το Αναγνωριστικό πελάτη που αντιγράψατε από το Azure κλασική πύλη.

    Ο κωδικός τώρα είναι παρόμοιο με το παρακάτω παράδειγμα.

        var endpoints = {
            "https://todolistapi0121.azurewebsites.net/": "1cf55bc9-9ed8-4df31cf55bc9-9ed8-4df3"
        };

9. Στην κλήση για `adalProvider.init`, ορίστε `tenant` στο όνομα του μισθωτή σας και `clientId` ίδια τιμή που χρησιμοποιήσατε στο προηγούμενο βήμα.

    Ο κωδικός τώρα είναι παρόμοιο με το παρακάτω παράδειγμα.

        adalProvider.init(
            {
                instance: 'https://login.microsoftonline.com/', 
                tenant: 'contoso.onmicrosoft.com',
                clientId: '1cf55bc9-9ed8-4df31cf55bc9-9ed8-4df3',
                extraQueryParameter: 'nux=1',
                endpoints: endpoints
            },
            $httpProvider
            );

    Αυτών των αλλαγών σε `app.js` να καθορίσετε ότι ο κώδικας κλήσης και το API που ονομάζεται στην ίδια εφαρμογή Azure AD.

1. Ανοίξτε το αρχείο *app/scripts/homeCtrl.js* .

2. Σχόλιο από το τμήμα κώδικα που έχει επισημανθεί για "χωρίς έλεγχο ταυτότητας" και καταργήστε τα σχόλια από το τμήμα κώδικα που έχει επισημανθεί για "με έλεγχο ταυτότητας".

1. Ανοίξτε το αρχείο *app/scripts/indexCtrl.js* .

2. Σχόλιο από το τμήμα κώδικα που έχει επισημανθεί για "χωρίς έλεγχο ταυτότητας" και καταργήστε τα σχόλια από το τμήμα κώδικα που έχει επισημανθεί για "με έλεγχο ταυτότητας".

### <a name="deploy-the-todolistangular-project-to-azure"></a>Αναπτύξτε το έργο ToDoListAngular στον Azure

8. Στην **Εξερεύνηση λύσεων**, κάντε δεξί κλικ στο έργο ToDoListAngular και, στη συνέχεια, κάντε κλικ στο κουμπί **Δημοσίευση**.

9. Κάντε κλικ στο κουμπί **Δημοσίευση**.

    Visual Studio ανάπτυξη του έργου και ανοίγει ένα πρόγραμμα περιήγησης για να βασική διεύθυνση URL του web app. Αυτό θα εμφανιστεί μια σελίδα σφάλματος 403, η οποία είναι κανονική για μιας προσπάθειας για να μεταβείτε σε μια διεύθυνση URL βάσης Web API από ένα πρόγραμμα περιήγησης.

    Εξακολουθείτε να έχετε να κάνετε μια αλλαγή στην εφαρμογή API μεσαίας πριν μπορείτε να ελέγξετε την εφαρμογή.

10. Κλείστε το πρόγραμμα περιήγησης.

## <a name="configure-the-todolistapi-project-to-use-authentication"></a>Ρύθμιση παραμέτρων του ToDoListAPI έργου για να χρησιμοποιήσετε τον έλεγχο ταυτότητας

Προς το παρόν στέλνει το έργο ToDoListAPI "*" ως το `owner` τιμή που πρέπει να ToDoListDataAPI. Σε αυτήν την ενότητα μπορείτε να αλλάξετε τον κωδικό για να στείλετε το Αναγνωριστικό του χρήστη είναι συνδεδεμένος.

Κάντε τις ακόλουθες αλλαγές στο έργο ToDoListAPI.

1. Ανοίξτε το αρχείο *Controllers/ToDoListController.cs* και καταργήστε τα σχόλια από τη γραμμή σε κάθε μέθοδο ενέργεια που ορίζει `owner` για να το Azure AD `NameIdentifier` διεκδίκηση τιμή. Για παράδειγμα:

        owner = ((ClaimsIdentity)User.Identity).FindFirst(ClaimTypes.NameIdentifier).Value;

    **Σημαντικό**: δεν Ενεργοποίηση κωδικός στο το `ToDoListDataAPI` μέθοδο. θα κάνετε που αργότερα για το πρόγραμμα εκμάθησης κεφαλαίου ελέγχου ταυτότητας υπηρεσίας.

### <a name="deploy-the-todolistapi-project-to-azure"></a>Αναπτύξτε το έργο ToDoListAPI στον Azure

8. Στην **Εξερεύνηση λύσεων**, κάντε δεξί κλικ στο έργο ToDoListAPI και, στη συνέχεια, κάντε κλικ στο κουμπί **Δημοσίευση**.

9. Κάντε κλικ στο κουμπί **Δημοσίευση**.

    Visual Studio ανάπτυξη του έργου και ανοίγει ένα πρόγραμμα περιήγησης για την εφαρμογή του API βασική διεύθυνση URL.

10. Κλείστε το πρόγραμμα περιήγησης.

### <a name="test-the-application"></a>Δοκιμή της εφαρμογής

9. Μεταβείτε στη διεύθυνση URL της εφαρμογής web, **χρησιμοποιώντας το HTTPS, δεν HTTP**.

8. Κάντε κλικ στην καρτέλα **Λίστα εκκρεμών εργασιών** .

    Θα σας ζητηθεί να συνδεθείτε.

9. Συνδεθείτε με τα διαπιστευτήρια ενός χρήστη στο μισθωτή σας AAD.

10. Εμφανίζεται η σελίδα **Λίστα εκκρεμών εργασιών** .

    ![Λίστα εκκρεμών εργασιών σελίδας](./media/app-service-api-dotnet-user-principal-auth/webappindex.png)

    Δεν υπάρχει εκκρεμή στοιχεία εμφανίζονται επειδή μέχρι τώρα όλα έχουν κατόχου "*". Τώρα στο μεσαίο επίπεδο ζητά στοιχεία για το χρήστη είναι συνδεδεμένος και καμία έχει δημιουργηθεί ακόμη.

11. Προσθήκη νέων στοιχείων εκκρεμών εργασιών για να βεβαιωθείτε ότι λειτουργεί η εφαρμογή.

12. Σε ένα άλλο παράθυρο προγράμματος περιήγησης, μεταβείτε στην Swagger διεύθυνση URL περιβάλλοντος εργασίας Χρήστη για την εφαρμογή ToDoListDataAPI API και κάντε κλικ στην επιλογή **ToDoList > λήψη**. Πληκτρολογήστε έναν αστερίσκο για το `owner` παράμετρο, και, στη συνέχεια, κάντε κλικ στην επιλογή **προσπαθήστε να το εμφανίσετε**.

    Απάντηση δείχνει ότι η νέα εκκρεμή στοιχεία έχουν την πραγματική Azure AD Αναγνωριστικό χρήστη στην ιδιότητα κατόχου.

    ![Αναγνωριστικό κατόχου JSON απάντηση](./media/app-service-api-dotnet-user-principal-auth/todolistapiauth.png)


## <a name="building-the-projects-from-scratch"></a>Δημιουργία τα έργα από την αρχή

Τα δύο έργα Web API δημιουργήθηκαν χρησιμοποιώντας το πρότυπο έργου **Εφαρμογής API Azure** και αντικατάστασης του ελεγκτή προεπιλεγμένες τιμές με έναν ελεγκτή ToDoList. 

Για πληροφορίες σχετικά με τον τρόπο για να δημιουργήσετε μια εφαρμογή μίας σελίδας AngularJS με μια παρασκηνίου Web API 2, ανατρέξτε στο θέμα [χέρια σε εργαστήριο: Δημιουργήστε μια μεμονωμένη εφαρμογή σελίδας (SPA) με το API Web ASP.NET και Angular.js](http://www.asp.net/web-api/overview/getting-started-with-aspnet-web-api/build-a-single-page-application-spa-with-aspnet-web-api-and-angularjs). Για πληροφορίες σχετικά με τον τρόπο για να προσθέσετε κώδικα Azure AD ελέγχου ταυτότητας, ανατρέξτε στους ακόλουθους πόρους:

* Η [ασφάλεια των AngularJS μίας σελίδας εφαρμογών με το Azure AD](../active-directory/active-directory-devquickstarts-angular.md).
* [Εισαγωγή v1 ADAL JS](http://www.cloudidentity.com/blog/2015/02/19/introducing-adal-js-v1/)

## <a name="troubleshooting"></a>Αντιμετώπιση προβλημάτων

[AZURE.INCLUDE [troubleshooting](../../includes/app-service-api-auth-troubleshooting.md)]

* Βεβαιωθείτε ότι έχετε Μην συγχέετε ToDoListAPI (Μεσαίο επίπεδο) και ToDoListDataAPI (επίπεδο δεδομένων). Για παράδειγμα, βεβαιωθείτε ότι έχετε προσθέσει τον έλεγχο ταυτότητας για την εφαρμογή μεσαίας API, δεν η σειρά δεδομένων. 
* Βεβαιωθείτε ότι ο κωδικός προέλευσης AngularJS αναφορές τη διεύθυνση URL εφαρμογής μεσαίας API (ToDoListAPI, δεν ToDoListDataAPI) και τη σωστή Azure AD αναγνωριστικό υπολογιστή-πελάτη 

## <a name="next-steps"></a>Επόμενα βήματα

Σε αυτό το πρόγραμμα εκμάθησης μάθατε πώς μπορείτε να χρησιμοποιήσετε τον έλεγχο ταυτότητας εφαρμογής υπηρεσίας για μια εφαρμογή API και πώς μπορείτε να καλέσετε την εφαρμογή API χρησιμοποιώντας τη βιβλιοθήκη ADAL JS. Στο το επόμενο πρόγραμμα εκμάθησης θα μάθετε πώς να [ασφαλή πρόσβαση σε εφαρμογή API για σενάρια υπηρεσία εξυπηρέτησης](app-service-api-dotnet-service-principal-auth.md).

