<properties
    pageTitle="Clusterize MySQL με εξισορρόπηση φόρτου σύνολα | Microsoft Azure"
    description="Ρύθμιση μιας εξισορρόπηση φόρτου υψηλής διαθεσιμότητας Linux MySQL σύμπλεγμα που δημιουργήθηκαν με το μοντέλο κλασική ανάπτυξης στην Azure"
    services="virtual-machines-linux"
    documentationCenter=""
    authors="bureado"
    manager="timlt"
    editor=""
    tags="azure-service-management"/>

<tags
    ms.service="virtual-machines-linux"
    ms.workload="infrastructure-services"
    ms.tgt_pltfrm="vm-linux"
    ms.devlang="na"
    ms.topic="article"
    ms.date="04/14/2015"
    ms.author="jparrel"/>

# <a name="using-load-balanced-sets-to-clusterize-mysql-on-linux"></a>Χρήση εξισορρόπηση φόρτου σύνολα για clusterize MySQL σε Linux

[AZURE.INCLUDE [learn-about-deployment-models](../../includes/learn-about-deployment-models-classic-include.md)]


Είναι ο σκοπός της σε αυτό το άρθρο για να εξερευνήσετε και να απεικονίζουν τις διαφορετικές μεθόδους διαθέσιμη για την ανάπτυξη ιδιαίτερα διαθέσιμες υπηρεσίες Linux βασίζεται στο Microsoft Azure, Εξερεύνηση διακομιστής MySQL υψηλή διαθεσιμότητα ως ένα κύριο βήμα. Βίντεο που απεικονίζει αυτής της προσέγγισης είναι διαθέσιμη στο [κανάλι 9](http://channel9.msdn.com/Blogs/Open/Load-balancing-highly-available-Linux-services-on-Windows-Azure-OpenLDAP-and-MySQL).

Θα σας Εφαρμόστε διάρθρωση σε μια κοινή χρήση τίποτα δύο κόμβου μοναδικού κύριου MySQL υψηλή διαθεσιμότητα λύση βασισμένη σε DRBD, Corosync και Pacemaker. Μόνο ένα κόμβο εκτελείται MySQL κάθε φορά. Ανάγνωση και εγγραφή από τον πόρο DRBD περιορίζεται επίσης κόμβο μόνο μία κάθε φορά.

Δεν χρειάζεται για μια λύση VIP όπως LVS επειδή χρησιμοποιούμε σύνολα εξισορρόπηση φόρτου Microsoft Azure για την παροχή τόσο τη λειτουργικότητα round robin και το τελικό σημείο ανίχνευσης, κατάργηση και φυσιολογική αποκατάσταση της το VIP. Το VIP είναι μια δυνατότητα δρομολόγησης καθολικά διεύθυνση IPv4 που έχουν εκχωρηθεί από το Windows Azure όταν δημιουργούμε πρώτα την υπηρεσία cloud.

Υπάρχουν άλλες αρχιτεκτονικές πιθανές για MySQL συμπεριλαμβανομένων σύμπλεγμα την επόμενη εργάσιμη ΗΜΈΡΑ, Percona και Galera καθώς και διάφορες λύσεις ενδιάμεσο, συμπεριλαμβανομένων των τουλάχιστον μία διαθέσιμη ως μια Εικονική στην [Αποθήκη Εικονική](http://vmdepot.msopentech.com). Με την προϋπόθεση ότι αυτές οι λύσεις να αναπαραγάγετε στην απλή έναντι πολλαπλή ή μετάδοση και δεν βασίζονται σε κοινόχρηστο χώρο αποθήκευσης ή πολλές διασυνδέσεις δικτύου, πρέπει να είναι εύκολο να αναπτύξετε στο Microsoft Azure τα σενάρια.

Φυσικά αυτά τα συμπλέγματος αρχιτεκτονικές μπορεί να επεκταθεί σε άλλα προϊόντα όπως PostgreSQL και OpenLDAP στον παρόμοιο τρόπο. Για παράδειγμα, αυτό εξισορρόπησης διαδικασία με κοινόχρηστα τίποτα φόρτου έχει ελεγχθεί με επιτυχία με πολλές υπόδειγμα OpenLDAP και μπορείτε να το παρακολουθήσετε στο ιστολόγιό μας 9 καναλιού.

## <a name="getting-ready"></a>Ετοιμασία

Θα χρειαστείτε ένα λογαριασμό Microsoft Azure με μια έγκυρη συνδρομή μπορούν να δημιουργούν ΣΠΣ τουλάχιστον δύο (2) (XS που χρησιμοποιήθηκε σε αυτό το παράδειγμα), ένα δίκτυο και ένα υποδίκτυο, μια ομάδα συσχέτισης και διαθεσιμότητα ορίσετε, καθώς και τη δυνατότητα να δημιουργήσετε νέα VHD στην ίδια περιοχή ως την υπηρεσία cloud, και για να τα επισυνάψετε του ΣΠΣ Linux.

### <a name="tested-environment"></a>Δοκιμή περιβάλλοντος

- Ubuntu 13.10
  - DRBD
  - Διακομιστής MySQL
  - Corosync και Pacemaker

### <a name="affinity-group"></a>Ομάδα συσχέτισης

Μια ομάδα συσχέτισης για τη λύση δημιουργείται με σύνδεση με το Azure κλασική πύλης κύλιση προς τα κάτω, ρυθμίσεις και τη δημιουργία μιας νέας ομάδας συνάφεια. Εκχωρούνται εκχωρημένων πόρων δημιουργήθηκε αργότερα σε αυτήν την ομάδα συσχέτισης.

### <a name="networks"></a>Δίκτυα

Δημιουργείται ένα νέο δίκτυο και δημιουργείται ένα υποδίκτυο μέσα στο δίκτυο. Επιλέγουμε 10.10.10.0/24 δίκτυο με μία μόνο /24 υποδικτύου μέσα.

### <a name="virtual-machines"></a>Εικονικές μηχανές

Η πρώτη Εικονική 13.10 Ubuntu είναι δημιουργήθηκε με μια εικόνα Endorsed Ubuntu συλλογή και ονομάζεται `hadb01`. Κατά τη διαδικασία, που ονομάζεται hadb δημιουργείται μια νέα υπηρεσία στο cloud. Ονομάζουμε το αυτόν τον τρόπο για την απεικόνιση της φύσης κοινόχρηστο, εξισορρόπησης φόρτου που θα έχετε την υπηρεσία όταν προσθέσουμε περισσότερους πόρους. Η δημιουργία `hadb01` είναι uneventful και ολοκληρωμένες με την πύλη. Δημιουργείται αυτόματα ένα τελικό σημείο για SSH και δικτύου που έχουν δημιουργηθεί μας είναι επιλεγμένο. Θα σας επιλέξτε επίσης για να δημιουργήσετε μια νέα διαθεσιμότητα ρύθμιση για το ΣΠΣ.

Όταν δημιουργηθεί η πρώτη Εικονική (τεχνικά, όταν δημιουργείται η υπηρεσία στο cloud) συνεχίσουμε για να δημιουργήσετε το δεύτερο Εικονική `hadb02`. Για το δεύτερο Εικονική θα χρησιμοποιήσουμε επίσης Εικονική 13.10 Ubuntu από τη συλλογή με την πύλη, αλλά θα σας θα επιλέξετε να χρησιμοποιήσετε μια υπάρχουσα υπηρεσία cloud, `hadb.cloudapp.net`, αντί να δημιουργήσετε ένα νέο. Το σύνολο δικτύου και τη διαθεσιμότητα πρέπει να επιλεγεί αυτόματα για μας. Ένα τελικό σημείο SSH θα δημιουργηθεί, πολύ.

Αφού έχουν δημιουργηθεί και τα δύο ΣΠΣ, θα κάνουμε Σημείωση για τη θύρα SSH για `hadb01` (TCP 22) και `hadb02` (που έχουν αντιστοιχιστεί αυτόματα από Azure)

### <a name="attached-storage"></a>Αποθήκευση συνημμένων

Θα σας να επισυνάψετε ένα νέο δίσκο σε δύο ΣΠΣ και δημιουργία νέων δίσκων 5 GB στη διαδικασία. Δίσκων θα να φιλοξενείται στο κοντέινερ VHD χρησιμοποιείται για το κύριο λειτουργικό σύστημα δίσκων. Όταν δημιουργούνται και συνημμένα δίσκων δεν χρειάζεται για να μπορέσουμε να ξεκινήστε πάλι Linux, όπως τον πυρήνα θα βλέπουν τη νέα συσκευή (συνήθως `/dev/sdc`, μπορείτε να ελέγξετε `dmesg` για το αποτέλεσμα)

Σε κάθε Εικονική συνεχίσετε για να δημιουργήσετε μια νέα διαμερίσματα με χρήση `cfdisk` (κύρια, διαμερισμάτων του Linux) και να γράφετε τον νέο πίνακα διαμερισμάτων. **Μην δημιουργήσετε ένα σύστημα αρχείων σε αυτήν διαμερίσματα** .

## <a name="setting-up-the-cluster"></a>Ρύθμιση του συμπλέγματος

Σε δύο VM Ubuntu, πρέπει να χρησιμοποιήσετε APT για να εγκαταστήσετε το Corosync, Pacemaker και DRBD. Χρήση `apt-get`:

    sudo apt-get install corosync pacemaker drbd8-utils.

**Μην εγκαταστήσετε MySQL αυτήν τη στιγμή** . Debian και δεσμών ενεργειών εγκατάστασης Ubuntu θα προετοιμαστεί έναν κατάλογο δεδομένων MySQL σε `/var/lib/mysql`, αλλά επειδή ο κατάλογος θα να αντικατασταθούν από ένα σύστημα αρχείων DRBD, πρέπει να το κάνετε αυτό αργότερα.

Σε αυτό το σημείο θα πρέπει επίσης επαληθευτεί (χρησιμοποιώντας `/sbin/ifconfig`) που χρησιμοποιούν και τα δύο ΣΠΣ διευθύνσεις στο δευτερεύον 10.10.10.0/24 και ότι αυτές μπορούν να κάνετε ping μεταξύ τους με βάση το όνομα. Εάν θέλετε μπορείτε επίσης να χρησιμοποιήσετε `ssh-keygen` και `ssh-copy-id` για να βεβαιωθείτε ότι και οι δύο ΣΠΣ να επικοινωνείτε μέσω SSH χωρίς να απαιτείται κωδικός πρόσβασης.

### <a name="setting-up-drbd"></a>Ρύθμιση DRBD

Θα δημιουργήσουμε έναν πόρο DRBD που χρησιμοποιεί το υποκείμενο `/dev/sdc1` διαμερίσματα για την παραγωγή μια `/dev/drbd1` πόρων μπορούν να είναι μορφοποιημένο με χρήση ext3 και να χρησιμοποιηθεί σε κύριες και δευτερεύουσες κόμβους. Για να το κάνετε αυτό, ανοίξτε `/etc/drbd.d/r0.res` και αντιγράψτε τον παρακάτω ορισμό πόρων. Κάντε τα εξής στο ΣΠΣ και τα δύο:

    resource r0 {
      on `hadb01` {
        device  /dev/drbd1;
        disk   /dev/sdc1;
        address  10.10.10.4:7789;
        meta-disk internal;
      }
      on `hadb02` {
        device  /dev/drbd1;
        disk   /dev/sdc1;
        address  10.10.10.5:7789;
        meta-disk internal;
      }
    }

Μετά από αυτό, η προετοιμασία του πόρου με χρήση `drbdadm` σε δύο VM:

    sudo drbdadm -c /etc/drbd.conf role r0
    sudo drbdadm up r0

Και τέλος, στην κύρια (`hadb01`) επιβάλετε όσον αφορά την κατοχή (κύρια) ο πόρος DRBD:

    sudo drbdadm primary --force r0

Εάν εξετάσετε τα περιεχόμενα του/διαδικασία/drbd (`sudo cat /proc/drbd`) σε δύο VM, θα πρέπει να βλέπετε `Primary/Secondary` σε `hadb01` και `Secondary/Primary` σε `hadb02`, σύμφωνα με τη λύση σε αυτό το σημείο. Ο δίσκος 5 GB θα συγχρονιστούν μέσω του δικτύου 10.10.10.0/24 χωρίς χρέωση στους πελάτες.

Μόλις ο δίσκος έχει συγχρονιστεί μπορείτε να δημιουργήσετε το σύστημα αρχείων σε `hadb01`. Για σκοπούς δοκιμής χρησιμοποιήσαμε ext2 αλλά τις παρακάτω οδηγίες θα δημιουργήσει ένα σύστημα αρχείων ext3:

    mkfs.ext3 /dev/drbd1

### <a name="mounting-the-drbd-resource"></a>Τοποθέτηση του πόρου DRBD

Στην `hadb01` τώρα είστε έτοιμοι να ενεργοποίησης τους πόρους DRBD. Χρήση debian και προϊόντα `/var/lib/mysql` ως κατάλογο δεδομένων του MySQL. Δεδομένου ότι θα σας δεν έχετε εγκαταστήσει MySQL, θα δημιουργήσετε τον κατάλογο και ενεργοποίησης του πόρου DRBD. On `hadb01`:

    sudo mkdir /var/lib/mysql
    sudo mount /dev/drbd1 /var/lib/mysql

## <a name="setting-up-mysql"></a>Ρύθμιση MySQL

Τώρα είστε έτοιμοι να εγκαταστήσετε το MySQL σε `hadb01`:

    sudo apt-get install mysql-server

Για `hadb02`, έχετε δύο επιλογές. Μπορείτε να εγκαταστήσετε διακομιστή mysql τώρα, που θα δημιουργήσετε /var/lib/mysql και συμπληρώσετε με έναν νέο κατάλογο δεδομένων και, στη συνέχεια, προχωρήστε για να καταργήσετε τα περιεχόμενα. On `hadb02`:

    sudo apt-get install mysql-server
    sudo service mysql stop
    sudo rm –rf /var/lib/mysql/*

Η δεύτερη επιλογή είναι η δυνατότητα ανακατεύθυνσης σε `hadb02` και, στη συνέχεια, εγκαταστήστε mysql-διακομιστή, υπάρχουν (δέσμες ενεργειών εγκατάστασης θα παρατηρήσετε της υπάρχουσας εγκατάστασης και δεν θα το αφής)

On `hadb01`:

    sudo drbdadm secondary –force r0

On `hadb02`:

    sudo drbdadm primary –force r0
    sudo apt-get install mysql-server

Εάν δεν σκοπεύετε να ανακατεύθυνσης DRBD τώρα, την πρώτη επιλογή είναι ευκολότερη Παρόλο που αναμφισβήτητα λιγότερο κομψές. Αφού ρυθμίσετε αυτή, μπορείτε να ξεκινήσετε να εργάζεστε με τη βάση δεδομένων MySQL. Στην `hadb02` (ή όποια τους διακομιστές είναι ενεργό, ανάλογα με το DRBD):

    mysql –u root –p
    CREATE DATABASE azureha;
    CREATE TABLE things ( id SERIAL, name VARCHAR(255) );
    INSERT INTO things VALUES (1, "Yet another entity");
    GRANT ALL ON things.\* TO root;

**Προειδοποίηση**: αυτήν τη δήλωση τελευταία απενεργοποιεί αποτελεσματική ελέγχου ταυτότητας για το ριζικό χρήστη σε αυτόν τον πίνακα. Αυτό πρέπει να αντικατασταθεί από την παραγωγή-βαθμολογίας ΕΚΧΏΡΗΣΗ προτάσεις και περιλαμβάνεται μόνο για επεξήγηση.

Πρέπει επίσης να ενεργοποιήσετε δικτύωση για MySQL εάν θέλετε να κάνετε ερωτήματα από το εκτός του ΣΠΣ, δηλαδή το σκοπό αυτού του οδηγού. Σε δύο VM, ανοίξτε το `/etc/mysql/my.cnf` και αναζητήστε `bind-address`, αλλαγή από 127.0.0.1 0.0.0.0. Μετά την αποθήκευση του αρχείου, θεμάτων μια `sudo service mysql restart` στον πρωτεύοντα τρέχουσα.

### <a name="creating-the-mysql-load-balanced-set"></a>Δημιουργία η φόρτωση MySQL εξισορρόπηση σύνολο

Θα επιστρέψετε στην πύλη και αναζητήστε το `hadb01` Εικονική, στη συνέχεια, τα τελικά σημεία. Ενημερώνουμε θα δημιουργήσετε ένα νέο τελικό σημείο, επιλέξτε MySQL (TCP 3306) από την αναπτυσσόμενη λίστα και υποδιαίρεσης στο πλαίσιο *Δημιουργία νέου φόρτωση εξισορρόπηση σύνολο* . Θα ονομάζουμε μας τελικού σημείου εξισορρόπησης φόρτου `lb-mysql`. Θα σας αφήνει τις περισσότερες από τις επιλογές από μόνο του εκτός από την ώρα που θα μπορούμε να μειώσουμε έως 5 (δευτερόλεπτα, ελάχιστο)

Αφού δημιουργηθεί το τελικό σημείο φυσικά πάμε στο `hadb02`, τα τελικά σημεία, και δημιουργήστε ένα νέο τελικό σημείο, αλλά θα σας θα επιλέξετε `lb-mysql`, στη συνέχεια, επιλέξτε MySQL από το αναπτυσσόμενο μενού. Μπορείτε επίσης να χρησιμοποιήσετε το CLI Azure για αυτό το βήμα.

Αυτήν τη στιγμή που έχετε όλα όσα χρειαζόμαστε για μια μη αυτόματη λειτουργία του συμπλέγματος.

### <a name="testing-the-load-balanced-set"></a>Δοκιμές η φόρτωση εξισορρόπηση σύνολο

Δοκιμές μπορεί να εκτελεστεί από έναν υπολογιστή που δεν περιλαμβάνονται, χρησιμοποιώντας οποιοδήποτε πρόγραμμα-πελάτη MySQL, καθώς και τις εφαρμογές (για παράδειγμα, phpMyAdmin εκτελείται ως μια τοποθεσία Web του Azure) σε αυτήν την περίπτωση, χρησιμοποιήσαμε το εργαλείο γραμμής εντολών του MySQL σε άλλο πλαίσιο Linux:

    mysql azureha –u root –h hadb.cloudapp.net –e "select * from things;"

### <a name="manually-failing-over"></a>Με μη αυτόματο τρόπο αποτυγχάνει πάνω από

Μπορείτε να προσομοιώσετε ανακατευθύνσεις τώρα τερματισμό MySQL, η αλλαγή του DRBD κύρια και ξεκινήσετε ξανά MySQL.

Στην hadb01:

    service mysql stop && umount /var/lib/mysql ; drbdadm secondary r0

Στη συνέχεια, στην hadb02:

    drbdadm primary r0 ; mount /dev/drbd1 /var/lib/mysql && service mysql start

Αφού έχετε ανακατεύθυνσης με μη αυτόματο τρόπο, μπορείτε να επαναλάβετε απομακρυσμένο το ερώτημά σας και θα πρέπει να να εργάζονται τέλεια.

## <a name="setting-up-corosync"></a>Ρύθμιση Corosync

Corosync είναι το υποκείμενο υποδομή σύμπλεγμα απαιτούνται για το Pacemaker για να εργαστείτε. Για τους χρήστες v1 και v2 συγχρονισμό (και άλλες μέθοδοι όπως Ultramonkey) Corosync είναι διαίρεσης του λειτουργίες CRM, ενώ Pacemaker παραμένει πιο παρόμοια με Hearbeat σε λειτουργία.

Το κύριο περιορισμό για Corosync σε Azure είναι ότι Corosync προτιμά πολλαπλής μέσω μετάδοση μέσω των επικοινωνιών μοναδικής διανομής, αλλά δικτύωση Microsoft Azure υποστηρίζει μόνο μοναδικής διανομής.

Ευτυχώς, Corosync έχει μια κατάσταση λειτουργίας μοναδικής διανομής εργασία και ο μοναδικός πραγματικός περιορισμός είναι ότι, καθώς όλους τους κόμβους δεν επικοινωνούν μεταξύ τους *automagically*, πρέπει να ορίσετε τους κόμβους στο αρχείο ρύθμισης παραμέτρων, συμπεριλαμβανομένων των διευθύνσεις IP. Μπορούμε να χρησιμοποιήσουμε τα αρχεία παράδειγμα Corosync για απλή και αλλαγή απλώς δεσμεύσετε διεύθυνση, λίστες κόμβο και καταγραφή καταλόγου (χρησιμοποιεί Ubuntu `/var/log/corosync` ενώ το παράδειγμα αρχεία χρήση `/var/log/cluster`) και την ενεργοποίηση απαρτίας εργαλεία.

**Σημείωση το `transport: udpu` οδηγία παρακάτω και το καθορισμένο με μη αυτόματο τρόπο διευθύνσεις IP για τους κόμβους**.

Στην `/etc/corosync/corosync.conf` για τους δύο κόμβους:

    totem {
      version: 2
      crypto_cipher: none
      crypto_hash: none
      interface {
        ringnumber: 0
        bindnetaddr: 10.10.10.0
        mcastport: 5405
        ttl: 1
      }
      transport: udpu
    }

    logging {
      fileline: off
      to_logfile: yes
      to_syslog: yes
      logfile: /var/log/corosync/corosync.log
      debug: off
      timestamp: on
      logger_subsys {
        subsys: QUORUM
        debug: off
        }
      }

    nodelist {
      node {
        ring0_addr: 10.10.10.4
        nodeid: 1
      }

      node {
        ring0_addr: 10.10.10.5
        nodeid: 2
      }
    }

    quorum {
      provider: corosync_votequorum
    }

Εργαζόμαστε αντιγράψτε αυτό το αρχείο ρύθμισης παραμέτρων σε δύο VM και ξεκινήστε Corosync οι κόμβοι:

    sudo service start corosync

Αμέσως μετά την εκκίνηση της υπηρεσίας του συμπλέγματος πρέπει να καθοριστούν με την τρέχουσα κλήση και θα πρέπει να έχει σύνθεση απαρτίας. Θα σας να ελέγξετε αυτή η λειτουργία με την αναθεώρηση των αρχείων καταγραφής ή:

    sudo corosync-quorumtool –l

Πρέπει να ακολουθήσετε παρόμοια με την εικόνα που ακολουθεί το αποτέλεσμα:

![corosync-quorumtool - l δείγμα εξόδου](media/virtual-machines-linux-classic-mysql-cluster/image001.png)

## <a name="setting-up-pacemaker"></a>Ρύθμιση Pacemaker

Pacemaker χρησιμοποιεί το σύμπλεγμα για να παρακολουθείτε για τους πόρους, ορισμός όταν μεταβείτε βασικά χρώματα προς τα κάτω και εναλλαγή αυτούς τους πόρους για να secondaries. Πόροι μπορούν να οριστούν από ένα σύνολο διαθέσιμες δέσμες ενεργειών ή από LSB (προετοιμασία-like) οι δέσμες ενεργειών, μεταξύ των άλλων επιλογών.

Θέλουμε Pacemaker σε "κάτοχος" ο πόρος DRBD, το Σημείο_μονταρίσματος και την υπηρεσία MySQL. Εάν Pacemaker να ενεργοποίηση και απενεργοποίηση DRBD, ενεργοποίησης του / umount it και Έναρξη/διακοπή MySQL με τη σωστή σειρά όταν κάτι εσφαλμένες συμβαίνει με την κύρια, το πρόγραμμα εγκατάστασης έχει ολοκληρωθεί.

Όταν εγκαθιστάτε πρώτα Pacemaker, της ρύθμισης παραμέτρων πρέπει να είναι αρκετά, απλή κάτι όπως:

    node $id="1" hadb01
      attributes standby="off"
    node $id="2" hadb02
      attributes standby="off"

Ελέγξτε το, εκτελώντας `sudo crm configure show`. Τώρα, δημιουργήστε ένα αρχείο (πείτε `/tmp/cluster.conf`) με τους ακόλουθους πόρους:

    primitive drbd_mysql ocf:linbit:drbd \
          params drbd_resource="r0" \
          op monitor interval="29s" role="Master" \
          op monitor interval="31s" role="Slave"

    ms ms_drbd_mysql drbd_mysql \
          meta master-max="1" master-node-max="1" \
            clone-max="2" clone-node-max="1" \
            notify="true"

    primitive fs_mysql ocf:heartbeat:Filesystem \
          params device="/dev/drbd/by-res/r0" \
          directory="/var/lib/mysql" fstype="ext3"

    primitive mysqld lsb:mysql

    group mysql fs_mysql mysqld

    colocation mysql_on_drbd \
           inf: mysql ms_drbd_mysql:Master

    order mysql_after_drbd \
           inf: ms_drbd_mysql:promote mysql:start

    property stonith-enabled=false

    property no-quorum-policy=ignore

Και τώρα να το φορτώσετε στο τη ρύθμιση παραμέτρων (μόνο πρέπει να το κάνετε αυτό σε έναν κόμβο):

    sudo crm configure
      load update /tmp/cluster.conf
      commit
      exit

Επίσης, βεβαιωθείτε ότι Pacemaker ξεκινά κατά την εκκίνηση στο και στους δύο κόμβους:

    sudo update-rc.d pacemaker defaults

Μετά από μερικά δευτερόλεπτα, και τη χρήση `sudo crm_mon –L`, βεβαιωθείτε ότι μία από τις κόμβους έχει γίνει στο υπόδειγμα για το σύμπλεγμα και εκτελεί όλους τους πόρους. Μπορείτε να χρησιμοποιήσετε Τοποθέτησης και ps για να ελέγξετε ότι οι πόροι εκτελούνται.

Το παρακάτω στιγμιότυπο οθόνης εμφανίζει `crm_mon` με έναν κόμβο έγινε διακοπή (Έξοδος με χρήση ελέγχου-C)

![Έγινε διακοπή κόμβο crm_mon](media/virtual-machines-linux-classic-mysql-cluster/image002.png)

Και στους δύο κόμβους, με ένα υπόδειγμα και μία εξαρτώμενη εμφανίζει αυτό το στιγμιότυπο οθόνης:

![crm_mon λειτουργικές κύριες/εξαρτώμενες](media/virtual-machines-linux-classic-mysql-cluster/image003.png)

## <a name="testing"></a>Δοκιμές

Είστε έτοιμοι για ένα προσομοίωσης αυτόματη ανακατεύθυνση. Υπάρχουν δύο τρόποι για να αυτή η ενέργεια: απαλές και δύσκολο. Το απαλές τρόπος είναι να χρησιμοποιήσετε το σύμπλεγμα τερματισμού συνάρτηση: ``crm_standby -U `uname -n` -v on``. Χρησιμοποιώντας αυτό στο υπόδειγμα, η εξαρτώμενη θα αναλάβετε τον έλεγχο. Μην ξεχάσετε να ορίσετε ξανά την απενεργοποίηση (crm_mon θα σας ενημερώσει έναν κόμβο είναι διαφορετικά σε αναμονή)

Το δύσκολο τρόπο είναι τερματισμό την κύρια εικονική Μηχανή (hadb01) μέσω της πύλης ή αλλάζοντας το runlevel σε η Εικονική (π.χ., διακόπτει, τερματισμού), στη συνέχεια, θα σας βοηθάτε Corosync και Pacemaker από σηματοδότηση του υποδείγματος ξεκινήστε προς τα κάτω. Μπορούμε να ελέγξουμε αυτό (χρήσιμο για συντήρηση windows), αλλά θα σας, επίσης, να επιβάλετε το σενάριο, απλώς σταθεροποιώντας η Εικονική.

## <a name="stonith"></a>STONITH

Θα πρέπει να είναι δυνατό να εκδώσετε μια Εικονική τερματισμού μέσω του Azure CLI αντί για μια δέσμη ενεργειών STONITH που ελέγχει μια φυσική συσκευή. Μπορείτε να χρησιμοποιήσετε `/usr/lib/stonith/plugins/external/ssh` ως βάση και ενεργοποίηση STONITH στη ρύθμιση παραμέτρων του συμπλέγματος. Azure CLI πρέπει να εγκατασταθούν καθολικά και θα πρέπει να τοποθετηθεί το ρυθμίσεων δημοσίευση/προφίλ για το σύμπλεγμα χρήστη.

Δείγμα κώδικα για τον πόρο που είναι διαθέσιμα σε [GitHub](https://github.com/bureado/aztonith). Πρέπει να αλλάξετε ρύθμισης παραμέτρων του συμπλέγματος, προσθέτοντας τα εξής για να `sudo crm configure`:

    primitive st-azure stonith:external/azure \
      params hostlist="hadb01 hadb02" \
      clone fencing st-azure \
      property stonith-enabled=true \
      commit

**Σημείωση:** τη δέσμη ενεργειών δεν μπορεί να εκτελέσει επάνω/κάτω ελέγχων. Τον αρχικό πόρο SSH είχατε 15 έλεγχοι ping αλλά χρόνου ανάκτησης για μια Εικονική Azure μπορεί να είναι περισσότερες μεταβλητή.

## <a name="limitations"></a>Περιορισμοί

Οι παρακάτω περιορισμοί ισχύουν:

- Η δέσμη ενεργειών linbit DRBD πόρων που διαχειρίζεται το DRBD ως πόρο στο χρησιμοποιεί Pacemaker `drbdadm down` κατά τον τερματισμό έναν κόμβο, ακόμα και αν ο κόμβος πρόκειται απλώς αναμονής. Αυτό δεν είναι ιδανική εφόσον η εξαρτώμενη θα δεν συγχρονίζει τον πόρο DRBD ενώ το υπόδειγμα λαμβάνει εγγραφές. Εάν το υπόδειγμα δεν αποτυγχάνει graciously, η εξαρτώμενη μπορεί να διαρκέσει επάνω σε μια παλαιότερη κατάσταση συστήματος αρχείων. Υπάρχουν δύο πιθανές τρόποι για την επίλυση αυτό:
  - Ενεργοποίηση μιας `drbdadm up r0` σε όλους τους κόμβους συμπλέγματος μέσω ενός τοπικού φύλαξης (δεν clusterized), ή,
  - Επεξεργασία του linbit DRBD δέσμης ενεργειών εξασφαλίζοντας ότι `down` δεν καλείται, σε `/usr/lib/ocf/resource.d/linbit/drbd`.
- Εξισορρόπηση φόρτου χρειάζεται τουλάχιστον 5 δευτερόλεπτα για να απαντήσετε, ώστε να εφαρμογές πρέπει να γνωρίζουν σύμπλεγμα και να είναι πιο ανοχή σφαλμάτων χρονικού ορίου; άλλες αρχιτεκτονικές μπορεί επίσης να σας βοηθήσει, για παράδειγμα ουρές της εφαρμογής, middlewares ερωτήματος, κ.λπ.
- Ρύθμιση MySQL είναι απαραίτητο για να βεβαιωθείτε ότι γίνεται συγγραφής sane ρυθμό και γίνεται η εκκαθάριση μνήμης cache στο δίσκο όσο συχνά όσο το δυνατόν να ελαχιστοποιήσετε τις απώλειες μνήμης
- Γράψτε απόδοση θα είναι εξαρτημένα σε Εικονική διασύνδεση στο εικονικού διακόπτη καθώς πρόκειται για το μηχανισμό που χρησιμοποιούνται από DRBD να αναπαραγάγετε τη συσκευή
