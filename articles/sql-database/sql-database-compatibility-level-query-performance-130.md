<properties
    pageTitle="Επίπεδο συμβατότητας, πώς μπορείτε να αξιολογήσετε | Microsoft Azure"
    description="Τα βήματα και εργαλεία για τον καθορισμό του επιπέδου συμβατότητας που είναι καλύτερη για τη βάση δεδομένων στη βάση δεδομένων SQL Azure ή του Microsoft SQL Server"
    services="sql-database"
    documentationCenter=""
    authors="alainlissoir"
    manager="jhubbard"
    editor=""/>

<tags
    ms.service="sql-database"
    ms.workload="data-management"
    ms.devlang="NA"
    ms.tgt_pltfrm="NA"
    ms.topic="article"
    ms.date="08/08/2016"
    ms.author="alainl"/>


# <a name="improved-query-performance-with-compatibility-level-130-in-azure-sql-database"></a>Βελτιωμένες επιδόσεις ερωτημάτων με τη συμβατότητα επίπεδο 130 σε βάση δεδομένων SQL Azure


Βάση δεδομένων SQL του Azure εκτελείται με διαφάνεια εκατοντάδες χιλιάδες βάσεις δεδομένων σε πολλές διαφορετικές συμβατότητας επίπεδα, διατήρηση και διασφάλιση τη συμβατότητα με προηγούμενες εκδόσεις στην αντίστοιχη έκδοση του Microsoft SQL Server για όλους τους πελάτες!

Επομένως, τίποτα δεν εμποδίζει τους πελάτες που τροποποιήσουν τις υπάρχουσες βάσεις δεδομένων για την πιο πρόσφατη επίπεδο συμβατότητας να επωφεληθούν από το νέο ερώτημα βελτιστοποίηση και δυνατότητες επεξεργαστή ερωτήματος. Ως υπενθύμιση του ιστορικού, της στοίχισης εκδόσεις του SQL για τα προεπιλεγμένα επίπεδα συμβατότητας είναι οι εξής:

- 100: στο SQL Server 2008 και Azure SQL βάσης δεδομένων V11:.
- 110: στο SQL Server 2012 και Azure SQL βάσης δεδομένων V11:.
- 120: στο SQL Server 2014 και Azure SQL βάσης δεδομένων V12.
- 130: στο SQL Server 2016 και Azure SQL βάσης δεδομένων V12.


> [AZURE.IMPORTANT] Εκκίνηση στο **2016 mid Ιουνίου**, σε βάση δεδομένων SQL Azure, το προεπιλεγμένο επίπεδο συμβατότητας θα 130 αντί για 120 για βάσεις δεδομένων που **δημιουργήθηκαν πρόσφατα** .
> 
> Θα βάσεις δεδομένων που δημιουργήθηκαν πριν από την mid Ιουνίου 2016 *δεν* επηρεάζονται και θα διατηρεί το τρέχον επίπεδο συμβατότητας (100, 110 ή 120). Βάσεις δεδομένων που μετεγκατάσταση από βάση δεδομένων SQL Azure έκδοση V11: για να V12 δεν θα έχουν το επίπεδο συμβατότητας αλλαχθεί είτε.


Σε αυτό το άρθρο εξετάσουμε τα πλεονεκτήματα της επίπεδο συμβατότητας 130 και πώς να αξιοποιήσετε αυτά τα πλεονεκτήματα. Θα σας διεύθυνση τα πιθανά αποτελέσματα πλευρά τις επιδόσεις ερωτημάτων για τις υπάρχουσες εφαρμογές SQL.


## <a name="about-compatibility-level-130"></a>Σχετικά με το επίπεδο συμβατότητας 130


Πρώτα, εάν θέλετε να μάθετε το τρέχον επίπεδο συμβατότητας της βάσης δεδομένων σας, εκτελέστε την ακόλουθη πρόταση Transact-SQL.


```
SELECT compatibility_level
    FROM sys.databases
    WHERE name = '<YOUR DATABASE_NAME>’;
```


Πριν από αυτήν την αλλαγή στο επίπεδο 130 συμβαίνει για τις βάσεις δεδομένων **που μόλις** δημιουργήσατε, ας Ελέγξτε ποιες αυτή η αλλαγή είναι όλα σχετικά με παραδειγμάτων πολύ βασικό ερώτημα και, ανατρέξτε στο θέμα Πώς όλα τα άτομα μπορούν να επωφεληθούν από αυτήν.

Επεξεργασία ερωτήματος σε σχεσιακές βάσεις δεδομένων μπορεί να είναι πολύ σύνθετη και μπορεί να οδηγήσει σε πολλές επιστήμης υπολογιστή και μαθηματικών να κατανοήσετε τις επιλογές εγγενή σχεδίασης και συμπεριφορές. Σε αυτό το έγγραφο, το περιεχόμενο έχει σκόπιμα απλοποιηθεί για να βεβαιωθείτε ότι όλα τα άτομα με ορισμένες ελάχιστο τεχνική φόντου να κατανοήσετε την επίδραση της αλλαγής επιπέδου συμβατότητας και να καθορίσετε πώς μπορείτε να αξιοποιήσετε τις εφαρμογές.

Ας ρίξουμε μια γρήγορη ματιά στο τι το επίπεδο συμβατότητας 130 εμφανίζει τον πίνακα.  Μπορείτε να βρείτε περισσότερες λεπτομέρειες για το επίπεδο [ΤΡΟΠΟΠΟΙΉΣΟΥΝ βάσης ΔΕΔΟΜΈΝΩΝ συμβατότητας (Transact-SQL)](https://msdn.microsoft.com/library/bb510680.aspx), αλλά υπάρχει μια σύντομη περίληψη:

- Η λειτουργία Εισαγωγή μιας πρότασης επιλογής με εισαγωγή μπορεί να είναι πολυνηματικού ή να έχετε ένα πρόγραμμα παράλληλες, ενώ πριν από αυτήν τη λειτουργία ήταν μονού νήματος.
- Μνήμη Optimized πίνακα και πίνακα μεταβλητές ερωτημάτων μπορούν πλέον να έχουν παράλληλες προγράμματα, ενώ πριν από αυτήν τη λειτουργία έχει επίσης μονού νήματος.
- Στατιστικά στοιχεία για βελτιστοποίηση μνήμης πίνακα τώρα μπορούν να δημιουργηθούν δείγματα και είναι ενημερωθεί αυτόματα. Ανατρέξτε στο θέμα [Τι νέο υπάρχει στο του μηχανισμού βάσεων δεδομένων: Συναλλαγής στη μνήμη](https://msdn.microsoft.com/library/bb510411.aspx#InMemory) για περισσότερες λεπτομέρειες.
- Μαζική λειτουργία v/s λειτουργία γραμμής αλλάζει με ευρετήρια στηλών Store
  - Ταξινομεί σε έναν πίνακα με ένα ευρετήριο στήλης αποθήκευσης βρίσκονται τώρα σε κατάσταση λειτουργίας δέσμης.
  - Άνοιγμα παραθύρου συγκεντρώσεις λειτουργούν πλέον σε κατάσταση λειτουργίας δέσμης όπως δηλώσεις ΑΠΌΚΡΙΣΗΣ TSQL/υποψήφιου ΠΕΛΆΤΗ.
  - Τα ερωτήματα σε πίνακες Store στήλης με πολλούς όρους distinct λειτουργούν σε κατάσταση λειτουργίας δέσμης.
  - Ερωτήματα που εκτελούνται στην περιοχή DOP = 1 ή με μια σειρά πρόγραμμα επίσης εκτέλεση σε κατάσταση λειτουργίας δέσμης.
- Τελευταία, βελτιώσεις προτεραιότητα εκτίμησης στην πραγματικότητα σύντομα με το επίπεδο συμβατότητας 120, αλλά για όσους από εσάς στο κάτω επίπεδο συμβατότητας (δηλαδή 100 ή 110), τη μετακίνηση για να εκτελείται συμβατότητας επίπεδο 130 θα εμφανιστεί επίσης αυτές τις βελτιώσεις και αυτές μπορούν να επωφεληθούν επίσης τις επιδόσεις ερωτημάτων με τις εφαρμογές σας.


## <a name="practicing-compatibility-level-130"></a>Εξάσκηση επίπεδο συμβατότητας 130


Πρώτα, ας ξεκινήσουμε ορισμένους πίνακες, τα ευρετήρια και τυχαία δεδομένων που έχουν δημιουργηθεί για να εξασκηθείτε με ορισμένες από αυτές τις νέες δυνατότητες. Τα παραδείγματα δέσμης ενεργειών TSQL μπορεί να εκτελεστεί στην περιοχή SQL Server 2016 ή στην περιοχή βάση δεδομένων SQL Azure. Ωστόσο, όταν δημιουργείτε μια βάση δεδομένων Azure SQL, βεβαιωθείτε ότι επιλέγετε την τουλάχιστον μια βάση δεδομένων P2 επειδή χρειάζεστε τουλάχιστον δύο πυρήνων να επιτρέπεται η πολυνηματική επεξεργασία και, επομένως, να επωφεληθείτε από αυτές τις δυνατότητες.


```
-- Create a Premium P2 Database in Azure SQL Database

CREATE DATABASE MyTestDB
    (EDITION=’Premium’, SERVICE_OBJECTIVE=’P2′);
GO

-- Create 2 tables with a column store index on
-- the second one (only available on Premium databases)

CREATE TABLE T_source
    (Color varchar(10), c1 bigint, c2 bigint);

CREATE TABLE T_target
    (c1 bigint, c2 bigint);

CREATE CLUSTERED COLUMNSTORE INDEX CCI ON T_target;
GO

-- Insert few rows.

INSERT T_source VALUES
    (‘Blue’, RAND() * 100000, RAND() * 100000),
    (‘Yellow’, RAND() * 100000, RAND() * 100000),
    (‘Red’, RAND() * 100000, RAND() * 100000),
    (‘Green’, RAND() * 100000, RAND() * 100000),
    (‘Black’, RAND() * 100000, RAND() * 100000);

GO 200

INSERT T_source SELECT * FROM T_source;

GO 10
```


Τώρα, ας ρίξουμε μια ματιά σε ορισμένες από τις δυνατότητες επεξεργασίας ερωτήματος σύντομα με το επίπεδο συμβατότητας 130.


## <a name="parallel-insert"></a>Παράλληλες εισαγωγή


Εκτέλεση τις παρακάτω προτάσεις TSQL εκτελεί τη λειτουργία ΕΙΣΑΓΩΓΉΣ στην περιοχή επιπέδου συμβατότητας 120 και 130 που αντίστοιχα εκτελεί τη λειτουργία ΕΙΣΑΓΩΓΉΣ σε ένα μόνο μοντέλο νήματος (120) και, σε ένα μοντέλο πολυνηματικού (130).


```
-- Parallel INSERT … SELECT … in heap or CCI
-- is available under 130 only

SET STATISTICS XML ON;

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 120;
GO 

-- The INSERT part is in serial

INSERT t_target WITH (tablock)
    SELECT C1, COUNT(C2) * 10 * RAND()
        FROM T_source
        GROUP BY C1
    OPTION (RECOMPILE);

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130
GO

-- The INSERT part is in parallel

INSERT t_target WITH (tablock)
    SELECT C1, COUNT(C2) * 10 * RAND()
        FROM T_source
        GROUP BY C1
    OPTION (RECOMPILE);

SET STATISTICS XML OFF;
```


Ζητώντας την πραγματική το πρόγραμμα του ερωτήματος, εξετάζοντας τις γραφική αναπαράσταση ή το περιεχόμενο XML, μπορείτε να προσδιορίσετε ποια εκτίμησης προτεραιότητα η συνάρτηση είναι στο αναπαραγωγής. Εξετάζοντας το πρόγραμμα δίπλα-δίπλα στην εικόνα 1, μπορούμε να με σαφήνεια δούμε ότι την εκτέλεση εισαγωγή Store στήλη μετάβαση από σειρά στο 120 παράλληλα στο 130. Επίσης, σημειώστε ότι η αλλαγή από το εικονίδιο επαναλήπτη στο 130 σχέδιο που εμφανίζει δύο παράλληλες βέλη, που απεικονίζει το γεγονός πλέον την εκτέλεση επαναλήπτη είναι στην πραγματικότητα παράλληλες. Εάν έχετε μεγάλη εισαγωγή λειτουργιών, για να ολοκληρώσετε, παράλληλη εκτέλεση, συνδεδεμένο με τον αριθμό των πυρήνα που έχετε στη διάθεσή σας για τη βάση δεδομένων, θα είναι καλύτερη; έως και μια ταχύτερη 100 φορές ανάλογα με την περίπτωσή σας!


*Εικόνα 1: Εισαγωγή λειτουργία αλλάζει από σειρά σε παράλληλα για συμβατότητα με το επίπεδο 130.*


![Σχήμα 1](./media/sql-database-compatibility-level-query-performance-130/figure-1.jpg)


## <a name="serial-batch-mode"></a>Κατάσταση λειτουργίας ΣΕΙΡΆ δέσμης


Ομοίως, μετακίνηση στο επίπεδο συμβατότητας 130 κατά την επεξεργασία γραμμές δεδομένων επιτρέπει την επεξεργασία λειτουργία δέσμης. Πρώτα, δέσμη λειτουργίες είναι διαθέσιμες μόνο όταν έχετε ένα ευρετήριο στήλης χώρο αποθήκευσης στη θέση. Δεύτερον, μια δέσμη συνήθως αντιπροσωπεύει ~ 900 γραμμές, και χρησιμοποιεί μια λογική κώδικα, βελτιστοποιημένη για πολλών πυρήνων CPU, υψηλότερη ταχύτητα μνήμης και απευθείας αξιοποιεί τα συμπιεσμένα δεδομένα του χώρου αποθήκευσης στήλη όποτε είναι δυνατό. Στην περιοχή αυτές τις συνθήκες, SQL Server 2016 μπορεί να επεξεργαστεί ~ 900 γραμμές ταυτόχρονα, αντί για γραμμή 1 κατά τη διάρκεια, και συνεπώς, η συνολική επιβάρυνσης κόστους της λειτουργίας είναι τώρα σε κοινή χρήση τη δέσμη ολόκληρο, τη μείωση του συνολικού κόστους, γραμμή. Αυτό το κοινόχρηστο ποσό των λειτουργιών που συνδυάζονται με τη συμπίεση store στήλης στην ουσία μειώνει το λανθάνων χρόνος που περιλαμβάνονται σε μια λειτουργία ΕΠΙΛΈΞΤΕ μαζική λειτουργία. Μπορείτε να δείτε περισσότερες λεπτομέρειες σχετικά με το χώρο αποθήκευσης στήλης και μαζική λειτουργία στο [Columnstore ευρετήρια Οδηγός](https://msdn.microsoft.com/library/gg492088.aspx).


```
-- Serial batch mode execution

SET STATISTICS XML ON;

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 120;
GO

-- The scan and aggregate are in row mode

SELECT C1, COUNT (C2)
    FROM T_target
    GROUP BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO 

– The scan and aggregate are in batch mode,
-- and force MAXDOP to 1 to show that batch mode
-- also now works in serial mode.

SELECT C1, COUNT(C2)
    FROM T_target
    GROUP BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Ως ορατό κάτω από το στοιχείο, βάσει του ερωτήματος προγράμματος δίπλα-δίπλα στην εικόνα 2, μπορούμε να δείτε ότι η κατάσταση λειτουργίας επεξεργασίας έχει αλλάξει με το επίπεδο συμβατότητας και, συνεπώς, κατά την εκτέλεση των ερωτημάτων και τα δύο επιπέδου συμβατότητας εντελώς, μπορούμε να δούμε ώστε το μεγαλύτερο μέρος του χρόνου επεξεργασίας δαπανάται σε κατάσταση λειτουργίας γραμμής (86%) σε σύγκριση με την κατάσταση λειτουργίας δέσμης (14%), όπου έχουν υποστεί επεξεργασία 2 δέσμες. Αύξηση του συνόλου δεδομένων, θα αυξήσετε το όφελος.


*Εικόνα 2: ΕΠΙΛΈΞΤΕ λειτουργία αλλαγών από σειρά μαζική λειτουργία με το επίπεδο συμβατότητας 130.*


![Εικόνα 2](./media/sql-database-compatibility-level-query-performance-130/figure-2.jpg)


## <a name="batch-mode-on-sort-execution"></a>Κατάσταση λειτουργίας δέσμης στην ταξινόμηση εκτέλεσης


Παρόμοια με τα παραπάνω, αλλά έχουν εφαρμοστεί σε μια λειτουργία ταξινόμησης, μετάβαση από τη λειτουργία γραμμής (επίπεδο συμβατότητας 120) σε κατάσταση λειτουργίας δέσμης (επίπεδο συμβατότητας 130) βελτιώνει τις επιδόσεις της λειτουργίας ΤΑΞΙΝΌΜΗΣΗΣ για τους ίδιους λόγους.


```
-- Batch mode on sort execution

SET STATISTICS XML ON;

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 120;
GO

-- The scan and aggregate are in row mode

SELECT C1, COUNT(C2)
    FROM T_target
    GROUP BY C1
    ORDER BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

-- The scan and aggregate are in batch mode,
-- and force MAXDOP to 1 to show that batch mode
-- also now works in serial mode.

SELECT C1, COUNT(C2)
    FROM T_target
    GROUP BY C1
    ORDER BY C1
    OPTION (MAXDOP 1, RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Ορατό δίπλα-δίπλα στην εικόνα 3, μπορούμε να δούμε ότι η λειτουργία ταξινόμησης σε κατάσταση λειτουργίας γραμμής αντιπροσωπεύει το 81% του κόστους, ενώ η κατάσταση λειτουργίας δέσμης αντιπροσωπεύει μόνο 19% του κόστους (αντίστοιχα 81 και 56% στην ταξινόμηση ίδια).


*Εικόνα 3: Λειτουργία ΤΑΞΙΝΌΜΗΣΗΣ αλλάζει από γραμμή σε κατάσταση λειτουργίας δέσμης με το επίπεδο συμβατότητας 130.*


![Εικόνα 3](./media/sql-database-compatibility-level-query-performance-130/figure-3.png)


Εμφανώς, αυτά τα δείγματα περιέχει μόνο δεκάδες χιλιάδες γραμμών, ποιο είναι τίποτα όταν βλέπετε τα δεδομένα που είναι διαθέσιμες στο περισσότεροι διακομιστές SQL αυτές τις ημέρες. Μόλις το project αυτά σε σχέση με εκατομμύρια γραμμές αντί για αυτό, και αυτό να μεταφράσετε σε μερικά λεπτά της εκτέλεσης αποφεύγεται καθημερινά σε εκκρεμότητα τη φύση των του φόρτου εργασίας σας.


## <a name="cardinality-estimation-ce-improvements"></a>Βελτιώσεις προτεραιότητα εκτίμησης (CE)


Έχουν εισαχθεί με SQL Server 2014, οποιαδήποτε βάση δεδομένων που εκτελούνται σε επίπεδο συμβατότητας 120 ή παραπάνω αξιοποιούν τη νέα εκτίμησης προτεραιότητα από λειτουργίες. Ουσιαστικά, προτεραιότητα εκτίμησης είναι η λογική που χρησιμοποιείται για να καθορίσετε τον τρόπο SQL server θα εκτελέσετε ένα ερώτημα με βάση τις εκτιμώμενες κόστος. Εκτίμηση υπολογίζεται με εισαγωγή δεδομένων από τα στοιχεία που σχετίζεται με αντικείμενα που περιλαμβάνονται σε αυτό το ερώτημα. Πρακτικά, στο υψηλού επιπέδου, οι συναρτήσεις προτεραιότητα εκτίμησης είναι υπολογίζει πλήθους γραμμών μαζί με πληροφορίες σχετικά με την κατανομή των τιμών, τιμή διακριτό πλήθος, και διπλότυπων καταμετρά που περιέχονται σε τους πίνακες και τα αντικείμενα στα οποία γίνεται αναφορά στο ερώτημα. Γρήγορα αυτές τις εκτιμήσεις λάθος, μπορεί να οδηγήσει περιττές είσοδος/έξοδος δίσκου λόγω ανεπαρκούς μνήμης επιχορηγήσεις (δηλαδή TempDB υγρά) ή σε μια επιλογή από μια σειρά πρόγραμμα εκτέλεσης πάνω από ένα πρόγραμμα παράλληλες εκτέλεσης, μερικά. Ολοκλήρωση, εσφαλμένη υπολογίζει μπορεί να οδηγήσει σε μια συνολική απόδοση υποβάθμιση η εκτέλεση του ερωτήματος. Από την άλλη πλευρά, καλύτερες εκτιμήσεις, πιο ακριβή υπολογίζει, οδηγεί σε καλύτερα εκτελέσεις ερωτήματος!

Όπως αναφέρθηκε πριν, βελτιστοποιήσεις ερωτήματος και υπολογίζει είναι μια σύνθετη θέματος, αλλά εάν θέλετε να μάθετε περισσότερα σχετικά με τα προγράμματα του ερωτήματος και εφαρμογή εκτίμησης σπιτιών προτεραιότητα, μπορείτε να ανατρέξετε στο έγγραφο στη [Βελτιστοποίηση των προγραμμάτων ερώτημα με την εφαρμογή εκτίμησης σπιτιών προτεραιότητα του SQL Server 2014](https://msdn.microsoft.com/library/dn673537.aspx) για βαθύτερη κατάρρευση.


## <a name="which-cardinality-estimation-do-you-currently-use"></a>Ποια εκτίμησης προτεραιότητα αυτήν τη στιγμή χρησιμοποιείτε;


Για να προσδιορίσετε στην περιοχή ποια εκτίμησης προτεραιότητα που χρησιμοποιούν τα ερωτήματά σας, ας απλώς να χρησιμοποιήσετε στα παρακάτω παραδείγματα ερωτήματος. Σημειώστε ότι αυτό το παράδειγμα πρώτη θα εκτελείται με επίπεδο συμβατότητας 110, πραγματική τους καταγωγή· τη χρήση των συναρτήσεων παλιά εκτίμησης προτεραιότητα.


```
-- Old CE

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 110;
GO

SET STATISTICS XML ON;

SELECT [c1]
    FROM [dbo].[T_target]
    WHERE [c1] > 20000;
GO

SET STATISTICS XML OFF;
```


Μόλις ολοκληρωθεί η εκτέλεση, κάντε κλικ στη σύνδεση XML και κοιτάξτε τις ιδιότητες από την πρώτη επαναλήπτη, όπως φαίνεται παρακάτω. Σημειώστε το όνομα της ιδιότητας που ονομάζεται ρύθμιση αυτήν τη στιγμή σε 70 CardinalityEstimationModelVersion. Αυτό δεν σημαίνει ότι το επίπεδο συμβατότητας βάσης δεδομένων έχει οριστεί στην έκδοση του SQL Server 7.0 (έχει οριστεί σε 110 ως ορατό στο τις προτάσεις TSQL παραπάνω), αλλά η τιμή 70 απλώς αντιπροσωπεύει τη λειτουργικότητα παλαιού τύπου εκτίμησης προτεραιότητα που διατίθεται από το SQL Server 7.0, η οποία είχε καμία κύρια αναθεωρήσεις μέχρι το SQL Server 2014 (το οποίο διατίθεται με ένα επίπεδο συμβατότητας 120).


*Εικόνα 4: Το CardinalityEstimationModelVersion έχει οριστεί σε 70, όταν χρησιμοποιείτε ένα επίπεδο συμβατότητας 110 ή κάτω από.*


![Εικόνα 4](./media/sql-database-compatibility-level-query-performance-130/figure-4.png)


Εναλλακτικά, μπορείτε να αλλάξετε το επίπεδο συμβατότητας σε 130 και να απενεργοποιήσετε τη χρήση της συνάρτησης εκτίμησης προτεραιότητα χρησιμοποιώντας το LEGACY_CARDINALITY_ESTIMATION οριστεί σε Ενεργο με [ΤΡΟΠΟΠΟΊΗΣΗ της ρύθμισης ΠΑΡΑΜΈΤΡΩΝ ΕΎΡΟΣ βάσης ΔΕΔΟΜΈΝΩΝ](https://msdn.microsoft.com/library/mt629158.aspx). Αυτό θα είναι ακριβώς ίδια με χρήση 110 από μια εκτίμηση προτεραιότητα συνάρτηση άποψη, ενώ χρησιμοποιείτε το πιο πρόσφατο ερώτημα επεξεργασίας επίπεδο συμβατότητας. Αυτή η ενέργεια, μπορείτε να επωφεληθείτε από το νέο ερώτημα επεξεργασίας δυνατότητες σύντομα με την πιο πρόσφατη επίπεδο συμβατότητας (δηλαδή δέσμη λειτουργίας), αλλά εξακολουθείτε να βασίζονται στην παλιά λειτουργικότητα εκτίμησης προτεραιότητα εάν είναι απαραίτητο.


```
-- Old CE

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = ON;
GO

SET STATISTICS XML ON;

SELECT [c1]
    FROM [dbo].[T_target]
    WHERE [c1] > 20000;
GO

SET STATISTICS XML OFF;
```


Μετακίνηση απλώς το επίπεδο συμβατότητας 120 ή 130 επιτρέπει τη νέα λειτουργικότητα εκτίμησης προτεραιότητα. Σε αυτήν την περίπτωση, η προεπιλεγμένη CardinalityEstimationModelVersion θα οριστεί αντίστοιχα 120 ή 130 ως ορατό κάτω από το στοιχείο.


```
-- New CE

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = OFF;
GO

SET STATISTICS XML ON;

SELECT [c1]
    FROM [dbo].[T_target]
    WHERE [c1] > 20000;
GO

SET STATISTICS XML OFF;
```


*Εικόνα 5: Το CardinalityEstimationModelVersion έχει οριστεί σε 130, όταν χρησιμοποιείτε ένα επίπεδο συμβατότητας 130.*


![Εικόνα 5](./media/sql-database-compatibility-level-query-performance-130/figure-5.jpg)


## <a name="witnessing-the-cardinality-estimation-differences"></a>Πρωτόκολλο τις διαφορές εκτίμησης προτεραιότητα


Τώρα, ας εκτελέστε μια λίγο πιο περίπλοκη ερωτήματος που αφορούν ένα INNER JOIN με έναν όρο WHERE με ορισμένες κατηγορήματα και ας δούμε την εκτίμηση γραμμής πλήθος από το παλιό συνάρτηση εκτίμησης προτεραιότητα πρώτα.


```
-- Old CE row estimate with INNER JOIN and WHERE clause

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = ON;
GO

SET STATISTICS XML ON;

SELECT T.[c2]
    FROM
                   [dbo].[T_source] S
        INNER JOIN [dbo].[T_target] T  ON T.c1=S.c1
    WHERE
        S.[Color] = ‘Red’  AND
        S.[c2] > 2000  AND
        T.[c2] > 2000
    OPTION (RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Αποτελεσματική εκτέλεση αυτού του ερωτήματος επιστρέφει 200,704 γραμμές, ενώ την εκτίμηση γραμμής με το παλιό λειτουργίες εκτίμησης προτεραιότητα ισχυρίζεται 194,284 γραμμών. Εμφανώς, όπως είπε πριν, αυτά τα αποτελέσματα count γραμμή θα επίσης εξαρτώνται από πόσο συχνά εκτελέσατε το προηγούμενο δείγματα, που συμπληρώνει τους πίνακες δείγμα ξανά και ξανά σε κάθε εκτέλεση. Εμφανώς, τα κατηγορήματα στο ερώτημά σας θα έχει επίσης επηρεάζουν την πραγματική εκτίμηση εκτός από το σχήμα του πίνακα, περιεχομένου, δεδομένα και ο τρόπος αυτών των δεδομένων στην πραγματικότητα συσχετισμός μεταξύ τους.


*Εικόνα 6: Την εκτίμηση γραμμής count είναι 194,284 ή 6.000 γραμμές εκτός από τις γραμμές 200,704 σύμφωνα με τα αναμενόμενα.*


![Εικόνα 6](./media/sql-database-compatibility-level-query-performance-130/figure-6.jpg)


Με τον ίδιο τρόπο, ας τώρα η εκτέλεση του ίδιου ερωτήματος με τις νέες λειτουργίες εκτίμησης προτεραιότητα.


```
-- New CE row estimate with INNER JOIN and WHERE clause

ALTER DATABASE MyTestDB
    SET COMPATIBILITY_LEVEL = 130;
GO

ALTER DATABASE
    SCOPED CONFIGURATION
    SET LEGACY_CARDINALITY_ESTIMATION = OFF;
GO

SET STATISTICS XML ON;

SELECT T.[c2]
    FROM
                   [dbo].[T_source] S
        INNER JOIN [dbo].[T_target] T  ON T.c1=S.c1
    WHERE
        S.[Color] = ‘Red’  AND
        S.[c2] > 2000  AND
        T.[c2] > 2000
    OPTION (RECOMPILE);
GO

SET STATISTICS XML OFF;
```


Εξετάζοντας το παρακάτω, τώρα βλέπουμε ότι την εκτίμηση γραμμής είναι 202,877, ή πολύ πιο κοντά και υψηλότερα από την παλιά εκτίμηση προτεραιότητα.

*Εικόνα 7: Την εκτίμηση γραμμής count είναι τώρα 202,877, αντί για 194,284.*


![Εικόνα 7](./media/sql-database-compatibility-level-query-performance-130/figure-7.jpg)


Στην πραγματικότητα, το σύνολο των αποτελεσμάτων είναι 200,704 γραμμές (αλλά όλα εξαρτάται από το πόσο συχνά εκτελείτε τα ερωτήματα των δειγμάτων προηγούμενες, αλλά το σημαντικότερο, επειδή το TSQL χρησιμοποιεί τη δήλωση RAND(), τις πραγματικές τιμές που επιστρέφεται μπορεί να διαφέρει από μία εκτέλεση στην επόμενη). Γι ' αυτό, στο συγκεκριμένο παράδειγμα, η νέα εκτίμησης προτεραιότητα κάνει μια καλύτερη εργασία στο εκτίμηση από τον αριθμό των γραμμών, επειδή είναι πιο πολύ κοντά στο 200,704, από 194,284 202,877! Επώνυμο, εάν αλλάξετε τον όρο WHERE κατηγορήματα να ισότητας (όχι ">" για παράδειγμα), αυτό μπορεί να κάνει τις προβλέψεις μεταξύ το παλιό και νέα προτεραιότητα συνάρτηση ακόμα πιο διαφέρει, ανάλογα με το πόσες αντιστοιχεί μπορείτε να λάβετε.

Εμφανώς, σε αυτήν την περίπτωση, που ~ 6000 γραμμές εκτός από το πραγματικό πλήθος δεν αντιπροσωπεύει πολλά δεδομένα σε ορισμένες περιπτώσεις. Τώρα, Αντιμετάθεση έτσι ώστε να εκατομμύρια γραμμές σε πολλούς πίνακες και πιο σύνθετα ερωτήματα και ορισμένες φορές την εκτίμηση μπορεί να είναι απενεργοποιημένη, εκατομμύρια γραμμές και, επομένως, ο κίνδυνος για την επιλογή προς τα επάνω στο πρόγραμμα λάθος εκτέλεσης ή αίτηση επιχορηγήσεις ανεπαρκούς μνήμης αποτέλεσμα TempDB υγρά και, επομένως, περισσότερες εισόδου/εξόδου, είναι πολύ υψηλότερα.

Εάν έχετε την ευκαιρία, πρακτική αυτή η σύγκριση με τις συνηθέστερες ερωτήματα και συνόλων δεδομένων, και δείτε για τον εαυτό σας από τον όγκο ορισμένες από τις προβλέψεις παλαιά και τα νέα επηρεάζονται, ενώ ορισμένες απλώς μπορεί να μετατραπεί περισσότερες εκτός από την πραγματικότητα ή κάποια άλλα άτομα απλώς απλώς πιο κοντά στην πραγματική γραμμή καταμετρά τα πραγματικά επιστρέφεται στο τα σύνολα αποτελεσμάτων. Όλα εξαρτάται από το σχήμα των ερωτημάτων, τα χαρακτηριστικά βάσης δεδομένων Azure SQL, τη φύση και το μέγεθος του σας σύνολα δεδομένων, καθώς και τα διαθέσιμα σχετικά με τα στατιστικά στοιχεία. Εάν σας παρουσία της βάσης δεδομένων SQL Azure που μόλις δημιουργήσατε, η βελτιστοποίηση ερώτημα θα πρέπει να δημιουργήσετε γνώση του από την αρχή αντί για επαναχρησιμοποίηση στατιστικά στοιχεία από το προηγούμενο ερώτημα εκτελείται. Επομένως, οι εκτιμήσεις είναι πολύ με βάση τα συμφραζόμενα και σχεδόν ειδικά για κάθε διακομιστή και εφαρμογή κατάστασης. Είναι σημαντική πτυχή για να έχετε υπόψη σας!


## <a name="some-considerations-to-take-into-account"></a>Ορισμένα ζητήματα να λάβετε υπόψη


Παρόλο που οι περισσότερες φόρτους εργασίας να επωφεληθείτε από το επίπεδο συμβατότητας 130, πριν από την έκδοση του επιπέδου συμβατότητας για το περιβάλλον παραγωγής, έχετε στην ουσία 3 επιλογές:

1. Μετακίνηση σε επίπεδο συμβατότητας 130 και, ανατρέξτε στο θέμα Πώς εκτελούν ενέργειες. Σε περίπτωση που παρατηρήσετε ότι ορισμένα παλινδρομήσεις, μπορείτε απλώς απλώς ορίστε τη συμβατότητα επιπέδου ξανά το αρχικό επίπεδο ή να διατηρήσετε 130 και μόνο αντίστροφη πάλι την εκτίμηση προτεραιότητα στη λειτουργία παλαιού τύπου (όπως περιγράφεται παραπάνω, αυτό μόνη θα μπορούσε να διευθύνσεων το ζήτημα).
2. Μπορείτε να ελέγξετε προσεκτικά τις υπάρχουσες εφαρμογές φόρτος παρόμοια παραγωγής τελειοποίηση και επικυρώστε τις επιδόσεις πριν μεταβείτε σε παραγωγής. Σε περίπτωση προβλημάτων, ίδιο με τα παραπάνω, μπορείτε να πάντα να επιστρέψετε στο αρχικό επίπεδο συμβατότητας ή απλώς να αναιρέσετε την εκτίμηση προτεραιότητα επιστρέψετε σε λειτουργία παλαιού τύπου.
3. Ως τελευταία επιλογή και την πιο πρόσφατη τρόπος για να διεύθυνση σε αυτές τις ερωτήσεις, είναι να αξιοποιήσετε το χώρο αποθήκευσης του ερωτήματος. Που είναι η προτεινόμενη επιλογή σημερινή! Για να βοηθήσει την ανάλυση των ερωτημάτων σας στην περιοχή συμβατότητας επίπεδο 120 ή κάτω από το έναντι 130, δεν είναι δυνατό να σας προτείνουμε αρκετά για να χρησιμοποιήσετε Store ερωτήματος. Ερώτημα χώρου αποθήκευσης είναι διαθέσιμο με την πιο πρόσφατη έκδοση του V12 βάσης δεδομένων SQL Azure και την έχει σχεδιαστεί για να σας βοηθήσει με την αντιμετώπιση προβλημάτων στις επιδόσεις ερωτημάτων. Σκεφτείτε του χώρου αποθήκευσης ερωτήματος ως μια καταγραφή δεδομένα πτήσεων για τη βάση δεδομένων, η συλλογή και παρουσίαση λεπτομερείς πληροφορίες ιστορικού σχετικά με όλα τα ερωτήματα. Αυτό απλοποιεί σημαντικά forensics επιδόσεων, μειώνοντας την ώρα για τη διάγνωση και επίλυση ζητημάτων. Μπορείτε να βρείτε περισσότερες πληροφορίες στο [ερώτημα αποθήκευσης: μια καταγραφή δεδομένα πτήσεων για τη βάση δεδομένων](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database/).


At το υψηλού επιπέδου, εάν έχετε ήδη ένα σύνολο βάσεις δεδομένων που εκτελούνται στο επίπεδο συμβατότητας 120 ή κάτω από το στοιχείο, και σχεδιασμός για τη μετακίνηση ορισμένες από αυτές για να 130 ή επειδή το φόρτο εργασίας προμήθεια αυτόματα νέες βάσεις δεδομένων που θα είναι σύντομα να οριστεί από προεπιλογή σε 130, εξετάστε το ενδεχόμενο το followings:

- Πριν να αλλάξετε στο νέο επίπεδο συμβατότητας στο παραγωγής, ενεργοποίηση αποθήκευσης ερωτήματος. Μπορείτε να χρησιμοποιείτε αναφορές για να [αλλάξετε την κατάσταση λειτουργίας συμβατότητας βάσης δεδομένων και χρήση του χώρου αποθήκευσης ερωτήματος](https://msdn.microsoft.com/library/bb895281.aspx) για περισσότερες πληροφορίες.
- Στη συνέχεια, δοκιμάστε όλες οι κρίσιμες φόρτους εργασίας χρησιμοποιώντας αντιπρόσωπος δεδομένων και ερωτημάτων από ένα περιβάλλον παραγωγής μοιάζουν και συγκρίνετε τις επιδόσεις αντιμετώπισε και ως αναφερόμενου από χώρο αποθήκευσης του ερωτήματος. Εάν αντιμετωπίσετε κάποια παλινδρομήσεις, μπορείτε να προσδιορίσετε την αναζήτηση ερωτημάτων με το χώρο αποθήκευσης του ερωτήματος και να χρησιμοποιήσετε το πρόγραμμα να επιβάλετε την επιλογή από το χώρο αποθήκευσης ερωτήματος (γνωστά και ως πρόγραμμα Καρφίτσωμα). Σε αυτήν την περίπτωση, που οριστικά παραμείνετε το επίπεδο συμβατότητας 130 και χρησιμοποιήστε το πρόγραμμα πρώην ερωτήματος ως προτεινόμενες από το χώρο αποθήκευσης του ερωτήματος.
- Εάν θέλετε να αξιοποιήσετε τις νέες δυνατότητες και τις δυνατότητες της βάσης δεδομένων SQL Azure (το οποίο εκτελείται το SQL Server 2016), αλλά διάκριση πεζών-κεφαλαίων σε αλλαγές έφερε από το επίπεδο συμβατότητας 130 ως τελευταία λύση, μπορείτε να να επιβάλετε το επίπεδο συμβατότητας πίσω στο επίπεδο που σας εξυπηρετεί το φόρτο εργασίας χρησιμοποιώντας μια εντολή ΤΡΟΠΟΠΟΊΗΣΗ βάσης ΔΕΔΟΜΈΝΩΝ. Αλλά πρώτα, να θυμάστε ότι το πρόγραμμα χώρου αποθήκευσης ερωτήματος Καρφίτσωμα επιλογή είναι η καλύτερη επιλογή σας, επειδή δεν χρησιμοποιείτε 130 στην ουσία μείνετε στο επίπεδο λειτουργικότητα από μια παλαιότερη έκδοση του SQL Server.
- Εάν έχετε multitenant εφαρμογές που εκτείνονται σε πολλές βάσεις δεδομένων, μπορεί να είναι απαραίτητες για την ενημέρωση της λογικής παροχής από τις βάσεις δεδομένων για να βεβαιωθείτε ότι ένα επίπεδο συνεπή συμβατότητας σε όλες τις βάσεις δεδομένων; παλαιά και τα πρόσφατα προμήθεια του φακέλου από αυτές. Την απόδοση της εφαρμογής φόρτο εργασίας μπορεί να είναι διάκριση πεζών-κεφαλαίων το γεγονός ότι ορισμένες βάσεις δεδομένων εκτελούνται σε διαφορετικές συμβατότητας επίπεδα, και γι ' αυτό, συμβατότητας επιπέδου συνέπειας σε οποιαδήποτε βάση δεδομένων μπορεί να απαιτείται για να παρέχουν την ίδια εμπειρία στους πελάτες σας ολόκληρο τον πίνακα. Σημειώστε ότι δεν είναι μια εντολή, πραγματικά εξαρτάται από τον τρόπο εφαρμογής σας επηρεάζεται από το επίπεδο συμβατότητας.
- Τελευταία, όσον αφορά την εκτίμηση προτεραιότητα και, όπως η αλλαγή του επιπέδου συμβατότητας, πριν να προχωρήσετε στην παραγωγή, συνιστάται να ελέγξετε το φόρτο εργασίας παραγωγής στις νέες συνθήκες για να προσδιορίσετε εάν η εφαρμογή σας οφέλη από τις βελτιώσεις εκτίμησης προτεραιότητα.


## <a name="conclusion"></a>Ολοκλήρωση


Με βάση δεδομένων SQL Azure για να επωφεληθείτε από όλες οι βελτιώσεις SQL Server 2016 με σαφήνεια να βελτιώσετε τις εκτελέσεις ερωτήματος. Όπως ακριβώς-είναι! Φυσικά, όπως οποιαδήποτε νέα δυνατότητα, πρέπει να εκτελεστούν σε κατάλληλη αξιολόγηση για να καθορίσετε τις ακριβείς συνθήκες βάσει της οποίας το φόρτο εργασίας βάσης δεδομένων λειτουργεί καλύτερα. Εμπειρία δείχνει ότι οι περισσότερες φόρτο εργασίας αναμένεται τουλάχιστον εκτέλεση με διαφάνεια στην περιοχή επίπεδο συμβατότητας 130, ενώ αξιοποίηση νέο ερώτημα επεξεργασίας συναρτήσεις και νέα εκτίμησης προτεραιότητα. Που είπε, ρεαλιστικά να, πάντα υπάρχουν μερικές εξαιρέσεις και κάνοντας proper παράδοσης επιμέλεια είναι σημαντικές αξιολόγηση για να καθορίσετε πόσο μπορείτε να επωφεληθείτε από αυτές τις βελτιώσεις. Και ξανά, ο χώρος αποθήκευσης ερωτήματος μπορεί να έχει μια εξαιρετική Βοήθεια σχετικά με την εκτέλεση αυτής της εργασίας!

Καθώς εξελίσσεται SQL Azure, μπορείτε να περιμένετε ένα επίπεδο συμβατότητας 140 στο μέλλον. Όταν κατάλληλη ώρα, θα σας θα ξεκινήσει συζήτησης σχετικά με το τι θα εμφανιστεί αυτό το επίπεδο μελλοντική συμβατότητας 140, ακριβώς όπως σύντομα αναφέρθηκε εδώ το επίπεδο συμβατότητας 130 μεταφέρετε σήμερα.

Για τώρα, ας μην ξεχάσετε, αρχίζοντας τον Ιούνιο 2016, βάση δεδομένων SQL Azure θα αλλάξει το προεπιλεγμένο επίπεδο συμβατότητας από 120 130 για βάσεις δεδομένων που έχουν δημιουργηθεί πρόσφατα. Λάβετε υπόψη!


## <a name="references"></a>Αναφορές


- [Τι νέο υπάρχει στο του μηχανισμού βάσεων δεδομένων](https://msdn.microsoft.com/library/bb510411.aspx#InMemory)

- [Ιστολόγιο: Ερώτημα αποθήκευσης: μια καταγραφή δεδομένα πτήσεων για τη βάση δεδομένων, με Borko Novakovic, 8 Ιουνίου 2016](https://azure.microsoft.com/blog/query-store-a-flight-data-recorder-for-your-database/)

- [Η πρόταση ALTER βάσης ΔΕΔΟΜΈΝΩΝ συμβατότητας επίπεδο (Transact-SQL)](https://msdn.microsoft.com/library/bb510680.aspx)

- [ΤΡΟΠΟΠΟΊΗΣΗ ΕΜΒΈΛΕΙΑΣ ΡΎΘΜΙΣΗ ΠΑΡΑΜΈΤΡΩΝ ΒΆΣΗΣ ΔΕΔΟΜΈΝΩΝ](https://msdn.microsoft.com/library/mt629158.aspx)

- [Επίπεδο συμβατότητας 130 για V12 βάσης δεδομένων Azure SQL](https://azure.microsoft.com/updates/compatibility-level-130-for-azure-sql-database-v12/)

- [Βελτιστοποίηση του ερωτήματος προγράμματος με τον SQL Server εφαρμογή εκτίμησης σπιτιών προτεραιότητα 2014](https://msdn.microsoft.com/library/dn673537.aspx)

- [Οδηγός ευρετήρια Columnstore](https://msdn.microsoft.com/library/gg492088.aspx)

- [Ιστολόγιο: Βελτιωμένες επιδόσεις του ερωτήματος με το επίπεδο συμβατότητας 130 στη βάση δεδομένων SQL Azure, με Alain Lissoir, 2016 6 Μαΐου](https://blogs.msdn.microsoft.com/sqlserverstorageengine/2016/05/06/improved-query-performance-with-compatibility-level-130-in-azure-sql-database/)



<!--
Improved Query Performance with Compatibility Level 130 in Azure SQL Database

May 6, 2016 by Alain Lissoir (AlainL), on GitHub 'alainlissoir'.

https://blogs.msdn.microsoft.com/sqlserverstorageengine/2016/05/06/improved-query-performance-with-compatibility-level-130-in-azure-sql-database/

..... Now, above.
....................
..... Soon, below?

CAPS / MSDN ideally, but instead on ACom:
.. # Assess effects of latest compatibility level on query performance, how to

sql-database-compatibility-level-query-performance-130.md

genemi = MightyPen , 2016-05-20  Friday  17:00pm
-->
