<properties 
    pageTitle="Χρήση της διαχείρισης ανάκτησης για να διορθώσετε προβλήματα στο χάρτη shard | Microsoft Azure" 
    description="Χρησιμοποιήστε την κλάση RecoveryManager για την επίλυση προβλημάτων με τους χάρτες shard" 
    services="sql-database" 
    documentationCenter=""  
    manager="jhubbard"
    authors="ddove"/>

<tags 
    ms.service="sql-database" 
    ms.workload="sql-database" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="05/05/2016" 
    ms.author="ddove"/>

# <a name="using-the-recoverymanager-class-to-fix-shard-map-problems"></a>Χρησιμοποιώντας την κλάση RecoveryManager για να διορθώσετε προβλήματα στο χάρτη shard

Η κλάση [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) παρέχει ADO.Net εφαρμογές τη δυνατότητα να εντοπίσουν εύκολα και να διορθώσετε τυχόν ασυνέπειες μεταξύ του χάρτη καθολικού shard (GSM) και το χάρτη τοπικό shard (LSM) σε ένα περιβάλλον sharded βάσης δεδομένων. 

Η GSM και LSM παρακολούθηση την αντιστοίχιση των κάθε βάση δεδομένων σε ένα περιβάλλον sharded. Περιστασιακά, παρουσιάζεται μια αλλαγή μεταξύ του GSM και το LSM. Σε αυτή την περίπτωση, χρησιμοποιήστε την κλάση RecoveryManager για να εντοπίσετε και να επιδιορθώσετε την αλλαγή.

Τάξη RecoveryManager αποτελεί τμήμα της [βιβλιοθήκης ελαστικότητας βάση δεδομένων προγράμματος-πελάτη](sql-database-elastic-database-client-library.md). 


![Shard χάρτη][1]


Για ορισμούς όρων, ανατρέξτε στο θέμα [Γλωσσάρι εργαλεία ελαστικότητας βάσης δεδομένων](sql-database-elastic-scale-glossary.md). Για να κατανοήσετε τον τρόπο χρήσης του **ShardMapManager** για τη διαχείριση δεδομένων σε μια λύση sharded, ανατρέξτε στο θέμα [Χάρτης διαχείρισης Shard](sql-database-elastic-scale-shard-map-management.md).


## <a name="why-use-the-recovery-manager"></a>Γιατί να χρησιμοποιήσετε τη διαχείριση αποκατάστασης;

Σε ένα περιβάλλον sharded βάσης δεδομένων, υπάρχει ένα μισθωτή ανά βάση δεδομένων και πολλές βάσεις δεδομένων ανά διακομιστή. Μπορεί επίσης να υπάρχει πολλοί διακομιστές στο περιβάλλον. Κάθε βάση δεδομένων έχει αντιστοιχιστεί στο χάρτη shard, ώστε να είναι δυνατό να δρομολογηθούν κλήσεων με το σωστό διακομιστή και βάσης δεδομένων. Βάσεις δεδομένων παρακολουθούνται σύμφωνα με ένα **πλήκτρο sharding**και κάθε shard έχει εκχωρηθεί μια **περιοχή τιμών κλειδιού**. Για παράδειγμα, έναν αριθμό-κλειδί sharding μπορεί να αντιπροσωπεύει τα ονόματα των πελατών από "Δ" σε "F." Η αντιστοίχιση όλα shards (γνωστά και ως βάσεις δεδομένων) και τις περιοχές αντιστοίχισης περιέχονται στο **καθολικό shard χάρτη (GSM)**. Κάθε βάση δεδομένων περιέχει επίσης ένα χάρτη των περιοχών που περιέχονται στην το shard — αυτό είναι γνωστό ως το **τοπικό shard αντιστοίχιση (LSM)**. Όταν μια εφαρμογή συνδέεται με ένα shard, είναι προσωρινά την αντιστοίχιση με την εφαρμογή για γρήγορη ανάκτηση. Το LSM χρησιμοποιείται για την επικύρωση δεδομένων στο cache. 

Η GSM και LSM μπορεί να είναι συγχρονισμένη για τους ακόλουθους λόγους:

1. Η διαγραφή μια shard των οποίων περιοχή θεωρείται δεν είναι πλέον της χρήσης ή μετονομασία από μια shard. Διαγραφή ενός αποτελέσματα shard σε **ορφανό shard αντιστοίχισης**. Similary, μια βάση δεδομένων που έχουν μετονομαστεί μπορεί να προκαλέσει μια αντιστοίχιση ορφανό shard. Ανάλογα με την πρόθεση της αλλαγής, το shard μπορεί να χρειαστεί να καταργηθούν ή της θέσης shard πρέπει να ενημερωθεί. Για να ανακτήσετε μια διαγραμμένη βάση δεδομένων, ανατρέξτε στο θέμα [Επαναφορά βάσης δεδομένων σε ένα προηγούμενο χρονικό σημείο, επαναφέρετε μια διαγραμμένη βάση δεδομένων, ή ανάκτηση από μια μη διαθεσιμότητα του κέντρου δεδομένων](sql-database-troubleshoot-backup-and-restore.md).
2. Προκύπτει ένα συμβάν παν ανακατεύθυνσης. Για να συνεχίσετε, μία πρέπει να ενημερώσετε το όνομα του διακομιστή και όνομα βάσης δεδομένων της διαχείρισης χάρτη shard στην εφαρμογή και, στη συνέχεια, ενημερώστε τις λεπτομέρειες αντιστοίχισης shard για κάθε shards σε ένα χάρτη shard. Σε περίπτωση παν-ανακατεύθυνσης, θα πρέπει να είναι αυτοματοποιημένη όπως λογικής ανάκτησης εντός της ροής εργασίας ανακατεύθυνσης. Αυτοματοποίηση ενεργειών αποκατάστασης ενεργοποιεί μια frictionless διαχειρισιμότητας για βάσεις δεδομένων με ενεργοποιημένη παν και αποφεύγεται η μη αυτόματη human ενέργειες.
3. Μια shard ή τη βάση δεδομένων ShardMapManager επαναφέρεται σε μια παλαιότερη έκδοση σημείο στο χρόνο.

Για περισσότερες πληροφορίες σχετικά με τα Εργαλεία βάσης δεδομένων ελαστικότητας βάση δεδομένων SQL Azure, παν αναπαραγωγής και επαναφορά, ανατρέξτε στο θέμα τα εξής: 

* [Επισκόπηση: Cloud επιχειρήσεις συνέχειας και βάσεων δεδομένων αποκατάσταση με βάση δεδομένων SQL](sql-database-business-continuity.md) 
* [Γρήγορα αποτελέσματα με εργαλεία ελαστικότητας βάσης δεδομένων](sql-database-elastic-scale-get-started.md)  
* [Διαχείριση ShardMap](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a>Ανάκτηση RecoveryManager από μια ShardMapManager 

Το πρώτο βήμα είναι να δημιουργήσετε μια παρουσία RecoveryManager. Η [μέθοδος GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) επιστρέφει τη Διαχείριση ανάκτησης για την τρέχουσα παρουσία [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) . Για να αντιμετωπίσετε τυχόν ασυνέπειες στο χάρτη shard, πρέπει να πρώτα να ανακτήσετε τα RecoveryManager για το συγκεκριμένο shard χάρτη. 

    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 

Σε αυτό το παράδειγμα, το RecoveryManager έχει προετοιμαστεί από το ShardMapManager. Το ShardMapManager που περιέχει ένα ShardMap έχει επίσης ήδη προετοιμαστεί. 

Επειδή αυτός ο κώδικας εφαρμογής χειρίζεται το χάρτη shard ίδια, τα διαπιστευτήρια που χρησιμοποιούνται στη μέθοδο εργοστασίου (στο παραπάνω παράδειγμα, smmConnectionString) πρέπει να είναι τα διαπιστευτήρια που έχουν δικαιώματα για ανάγνωση και εγγραφή από τη βάση δεδομένων GSM στα οποία γίνεται αναφορά από τη συμβολοσειρά σύνδεσης. Αυτά τα διαπιστευτήρια είναι συνήθως διαφορετικά από τα διαπιστευτήρια που χρησιμοποιούνται για να ανοίξετε τις συνδέσεις για τη δρομολόγηση εξαρτώνται από δεδομένα. Για περισσότερες πληροφορίες, ανατρέξτε στο θέμα [Χρήση διαπιστευτηρίων στο πρόγραμμα-πελάτη ελαστικότητας βάσης δεδομένων](sql-database-elastic-scale-manage-credentials.md).

## <a name="removing-a-shard-from-the-shardmap-after-a-shard-is-deleted"></a>Η κατάργηση ενός shard από το ShardMap μετά από τη διαγραφή μιας shard

Η [μέθοδος DetachShard](https://msdn.microsoft.com/library/azure/dn842083.aspx) αποσυνδέει τη δεδομένη shard από την αντιστοίχιση shard και διαγράφει αντιστοιχίσεων που σχετίζεται με το shard.  

* Η παράμετρος θέση είναι στη θέση shard, ειδικά το όνομα του διακομιστή και όνομα βάσης δεδομένων, από την shard να αποσυνδεθεί. 
* Η παράμετρος shardMapName είναι το όνομα της αντιστοίχισης shard. Αυτό είναι μόνο απαιτούνται όταν πολλές αντιστοιχίσεις shard πραγματοποιείται από τον ίδιο διευθυντή shard στο χάρτη. Προαιρετικό. 

**ΣΗΜΑΝΤΙΚΟ**: Χρησιμοποιήστε αυτήν την τεχνική, μόνο αν είστε βέβαιοι ότι η περιοχή για την αντιστοίχιση ενημερωμένη είναι κενό. Τις παραπάνω μεθόδους δεν επιλέξτε δεδομένα για την περιοχή για τη μετακίνηση, ώστε να είναι καλύτερα να συμπεριλάβετε ελέγχων στον κώδικά σας.

Αυτό το παράδειγμα καταργεί shards από την αντιστοίχιση shard. 

    rm.DetachShard(s.Location, customerMap); 

Ο χάρτης στη θέση shard το GSM πριν από τη διαγραφή του shard. Επειδή το shard έχει διαγραφεί, θεωρείται αυτή ήταν ηθελημένη και, στην περιοχή κλειδιού sharding δεν είναι πλέον χρησιμοποιείται. Εάν δεν συμβαίνει αυτό, μπορείτε να εκτελείτε επαναφορά σημείο στο χρόνο. Για να ανακτήσετε τα shard από μια παλαιότερη σε δεδομένη χρονική στιγμή. (Σε αυτήν την περίπτωση, διαβάστε την ενότητα παρακάτω για να εντοπίσετε ασυνέπειες shard.) Για να ανακτήσετε, ανατρέξτε στο θέμα [Επαναφορά βάσης δεδομένων σε ένα προηγούμενο χρονικό σημείο, επαναφέρετε μια διαγραμμένη βάση δεδομένων, ή ανάκτηση από μια μη διαθεσιμότητα του κέντρου δεδομένων](sql-database-troubleshoot-backup-and-restore.md).

Επειδή η διαγραφή βάσης δεδομένων ήταν ηθελημένη θεωρείται, η ενέργεια τελική εκκαθάριση διαχείρισης είναι για να διαγράψετε την καταχώρηση για να το shard στη Διαχείριση χάρτη shard. Αυτό δεν επιτρέπει την εφαρμογή από την κατά λάθος εγγραφή πληροφοριών σε μια περιοχή που δεν αναμένεται.

## <a name="to-detect-mapping-differences"></a>Για να εντοπίσετε διαφορές αντιστοίχισης 

Η [μέθοδος DetectMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) επιλέγει και επιστρέφει μια από τις αντιστοιχίσεις shard (τοπικά ή καθολικού) ως την προέλευση της αλήθειας και επιλύει αντιστοιχίσεις σε δύο χάρτες shard (GSM και LSM).

    rm.DetectMappingDifferences(location, shardMapName);

* Η *θέση* Καθορίζει το όνομα του διακομιστή και το όνομα της βάσης δεδομένων. 
* Η παράμετρος *shardMapName* είναι το όνομα της αντιστοίχισης shard. Αυτό είναι μόνο απαιτείται αν πολλές αντιστοιχίσεις shard πραγματοποιείται από τον ίδιο διευθυντή shard στο χάρτη. Προαιρετικό. 

## <a name="to-resolve-mapping-differences"></a>Για να επιλύσετε διαφορές αντιστοίχισης

Η [μέθοδος ResolveMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) επιλέγει μια από τις αντιστοιχίσεις shard (τοπικά ή καθολικού) ως την προέλευση της αλήθειας και επιλύει αντιστοιχίσεις σε δύο χάρτες shard (GSM και LSM).

    ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   
* Η παράμετρος *RecoveryToken* απαριθμεί τις διαφορές στις αντιστοιχίσεις μεταξύ του GSM και το LSM για το συγκεκριμένο shard. 

* Η [απαρίθμηση MappingDifferenceResolution](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) χρησιμοποιείται για να υποδείξετε ότι η μέθοδος για την επίλυση τη διαφορά μεταξύ των αντιστοιχίσεων shard. 
* Σε περίπτωση που το LSM περιέχει την ακριβή αντιστοίχιση και, επομένως, θα πρέπει να χρησιμοποιείται η αντιστοίχιση σε το shard, συνιστάται **MappingDifferenceResolution.KeepShardMapping** . Αυτό συνήθως συμβαίνει σε περίπτωση ανακατεύθυνσης: το shard βρίσκεται τώρα σε ένα νέο διακομιστή. Επειδή το shard πρέπει πρώτα να καταργηθούν από το GSM (χρησιμοποιώντας τη μέθοδο RecoveryManager.DetachShard), μια αντιστοίχιση δεν υπάρχει πλέον στο το GSM. Επομένως, το πρέπει να χρησιμοποιούνται τα LSM να αποκαταστήσει την αντιστοίχιση shard.

## <a name="attach-a-shard-to-the-shardmap-after-a-shard-is-restored"></a>Επισύναψη ενός shard το ShardMap μετά την επαναφορά ενός shard 

Η [μέθοδος AttachShard](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) επισυνάπτει τη δεδομένη shard shard χάρτη. Στη συνέχεια, εντοπίζει τυχόν ασυνέπειες χάρτη shard και ενημερώνει αντιστοιχίσεις ώστε να ταιριάζει με το shard στο σημείο της επαναφοράς shard. Θεωρείται ότι η βάση δεδομένων είναι επίσης μετονομαστεί ώστε να αντικατοπτρίζει το αρχικό όνομα βάσης δεδομένων (πριν από την όταν το shard αποκαταστάθηκε), από το σημείο στο χρόνο Επαναφορά προεπιλογών σε μια νέα βάση δεδομένων προσαρτημένο με τη χρονική σήμανση. 

    rm.AttachShard(location, shardMapName) 

* Η παράμετρος *θέση* είναι το όνομα του διακομιστή και όνομα βάσης δεδομένων, από την shard που έχουν επισυναφθεί. 

* Η παράμετρος *shardMapName* είναι το όνομα της αντιστοίχισης shard. Αυτό είναι μόνο απαιτούνται όταν πολλές αντιστοιχίσεις shard πραγματοποιείται από τον ίδιο διευθυντή shard στο χάρτη. Προαιρετικό. 

Αυτό το παράδειγμα προσθέτει μια shard shard χάρτη που έχει πρόσφατα ανακτηθεί από μια προηγούμενη έκδοση σημείο στο χρόνο. Δεδομένου ότι έχει γίνει επαναφορά του shard (δηλαδή η αντιστοίχιση για το shard στο το LSM), είναι πιθανώς χωρίς συνέπεια με την καταχώρηση shard από το GSM. Εκτός του κώδικα σε αυτό το παράδειγμα, το shard δεν ήταν δυνατή η επαναφορά και μετονομαστεί στο αρχικό όνομα της βάσης δεδομένων. Εφόσον έχει ανακτηθεί, λαμβάνεται η αντιστοίχιση σε το LSM είναι αξιόπιστη την αντιστοίχιση. 

    rm.AttachShard(s.Location, customerMap); 
    var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-the-shards"></a>Ενημέρωση shard θέσεις μετά παν-ανακατεύθυνσης (επαναφορά) από το shards

Σε περίπτωση παν-ανακατεύθυνσης, δευτερεύοντα βάσης δεδομένων πραγματοποιείται γράψετε προσβάσιμα και γίνεται η νέα κύρια βάση δεδομένων. Το όνομα του διακομιστή και πιθανώς η βάση δεδομένων (ανάλογα με τις ρυθμίσεις σας), ενδέχεται να είναι διαφορετικές από την αρχική πρωτεύοντα. Επομένως, πρέπει να διορθωθεί τις καταχωρήσεις αντιστοίχισης για την shard στο GSM και LSM. Ομοίως, εάν η βάση δεδομένων αποκατασταθεί ένα διαφορετικό όνομα ή θέση ή σε μια προγενέστερη χρονική στιγμή, αυτό μπορεί να προκαλέσει ασυνέπειες στους χάρτες shard. Ο διαχειριστής του χάρτη Shard χειρίζεται την κατανομή των ανοικτές συνδέσεις στη σωστή βάση δεδομένων. Κατανομή βασίζεται στα δεδομένα του χάρτη shard και την τιμή του κλειδιού sharding που είναι ο στόχος της αίτησης της εφαρμογής. Μετά την παν-ανακατεύθυνσης, πρέπει να ενημερωθούν αυτές τις πληροφορίες με το όνομα ακριβή διακομιστή, όνομα βάσης δεδομένων και αντιστοίχιση shard της βάσης δεδομένων που έχει ανακτηθεί. 

## <a name="best-practices"></a>Βέλτιστες πρακτικές

Παν ανακατεύθυνσης και αποκατάστασης είναι συνήθως διαχειριζόμενο από το διαχειριστή cloud της εφαρμογής σκόπιμα χρησιμοποιώντας μία από τις βάσεις δεδομένων SQL Azure επιχειρήσεις συνέχειας δυνατότητες λειτουργίες. Σχεδιασμός συνέχειας επιχειρήσεις απαιτεί διεργασίες, διαδικασίες και μετρήσεις για να βεβαιωθείτε ότι οι λειτουργίες επιχειρήσεις μπορούν να συνεχίσουν χωρίς διακοπή. Τις μεθόδους που είναι διαθέσιμες ως μέρος της κλάσης RecoveryManager θα πρέπει να χρησιμοποιηθεί μέσα σε αυτήν τη ροή εργασίας για να βεβαιωθείτε ότι η GSM και LSM θα ενημερώνονται με βάση την ενέργεια ανάκτησης που έχετε δημιουργήσει. Υπάρχουν 5 βασικά βήματα για να εξασφαλίσει σωστά η GSM και LSM αντικατοπτρίζουν τις ακριβείς πληροφορίες μετά από ένα συμβάν ανακατεύθυνσης. Τον κώδικα της εφαρμογής για να εκτελέσετε αυτά τα βήματα μπορεί να ενσωματώνει υπάρχοντα εργαλεία και τη ροή εργασίας. 

1. Ανακτήστε την RecoveryManager από το ShardMapManager. 
2. Απόσπαση το παλιό shard από την αντιστοίχιση shard.
3. Επισυνάψτε το νέο shard στο χάρτη shard, συμπεριλαμβανομένης της νέας θέσης shard.
4. Εντοπισμός ασυνέπειες στην αντιστοίχιση μεταξύ του GSM και LSM. 
5. Επίλυση διαφορές μεταξύ του GSM και το LSM, το LSM αξιοπιστία. 

Αυτό το παράδειγμα πραγματοποιεί τα εξής βήματα:
1. Καταργεί shards από την αντιστοίχιση Shard που αντικατοπτρίζουν τις θέσεις shard πριν από το συμβάν ανακατεύθυνσης.
2. Επισυνάπτει shards Shard χάρτη που αντικατοπτρίζουν τις νέες θέσεις shard (η παράμετρος "Configuration.SecondaryServer" είναι το νέο όνομα διακομιστή, αλλά το ίδιο όνομα βάσης δεδομένων).
3. Ανακτά τα διακριτικά αποκατάστασης εντοπίζοντας αντιστοίχισης διαφορές μεταξύ του GSM και το LSM για κάθε shard. 
4. Επιλύει τις ασυνέπειες με αξιοπιστία την αντιστοίχιση από το LSM από κάθε shard. 

    VAR shards = smm. GetShards();  foreach (shard s στα shards) {Εάν (s.Location.Server == Configuration.PrimaryServer) {ShardLocation slNew = νέα ShardLocation (Configuration.SecondaryServer, s.Location.Database) 
        
          rm.DetachShard(s.Location); 
        
          rm.AttachShard(slNew); 
        
          var gs = rm.DetectMappingDifferences(slNew); 
    
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 



[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]


<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png
 
