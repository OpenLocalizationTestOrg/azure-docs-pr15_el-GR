<properties 
    pageTitle="Χρήση βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη με Dapper | Microsoft Azure" 
    description="Χρήση βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη με Dapper." 
    services="sql-database" 
    documentationCenter="" 
    manager="jhubbard" 
    authors="torsteng"/>

<tags 
    ms.service="sql-database" 
    ms.workload="sql-database" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="05/27/2016" 
    ms.author="torsteng"/>

# <a name="using-elastic-database-client-library-with-dapper"></a>Χρήση βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη με Dapper 

Αυτό το έγγραφο είναι για τους προγραμματιστές που βασίζονται σε Dapper για να δημιουργήσετε εφαρμογές, αλλά επίσης να θέλετε να υιοθέτηση [tooling ελαστικά βάσης δεδομένων](sql-database-elastic-scale-introduction.md) για να δημιουργήσετε εφαρμογές που υλοποίηση sharding με κλίμακα τους σειρά δεδομένων.  Αυτό το έγγραφο παρουσιάζει τις αλλαγές σε εφαρμογές που βασίζονται σε Dapper που είναι απαραίτητα για την ενοποίηση με εργαλεία ελαστικότητας βάσης δεδομένων. Μας εστίαση στην τη σύνταξη τη Διαχείριση shard ελαστικά βάσης δεδομένων και ανάλογα με τα δεδομένα δρομολογεί με Dapper. 

**Δείγμα κώδικα**: [Εργαλεία ελαστικότητας βάσης δεδομένων για βάση δεδομένων SQL Azure - Dapper ενοποίησης](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).
 
Ενοποίηση **Dapper** και **DapperExtensions** με τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη για βάση δεδομένων SQL Azure είναι εύκολη. Εφαρμογές σας να χρησιμοποιήσετε δεδομένα εξαρτώμενα δρομολόγηση, αλλάζοντας τη δημιουργία και άνοιγμα νέων αντικειμένων [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) για να χρησιμοποιήσετε την κλήση [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) από τη [βιβλιοθήκη προγράμματος-πελάτη](http://msdn.microsoft.com/library/azure/dn765902.aspx). Αυτό περιορίζει αλλαγές στην εφαρμογή σας μόνο για να το σημείο όπου δημιουργούνται και ανοίξει νέες συνδέσεις. 

## <a name="dapper-overview"></a>Επισκόπηση dapper
**Dapper** είναι ένα πρόγραμμα αντιστοίχισης σχεσιακού αντικειμένου. Το αντιστοιχίζει .NET αντικειμένων από την εφαρμογή σας σε μια σχεσιακή βάση δεδομένων (και αντίστροφα). Το πρώτο τμήμα του δείγματος κώδικα παρουσιάζει πώς μπορείτε να ενσωματώσετε στη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη με εφαρμογές που βασίζονται σε Dapper. Το δεύτερο τμήμα του δείγματος κώδικα παρουσιάζει πώς μπορείτε να ενοποιήσετε κατά τη χρήση Dapper και DapperExtensions.  

Η λειτουργικότητα αντιστοίχισης στο Dapper παρέχει μεθόδους επέκταση σχετικά με τις συνδέσεις βάσης δεδομένων που απλοποιήσετε η υποβολή προτάσεων T-SQL για εκτέλεση ή υποβολή ερωτημάτων της βάσης δεδομένων. Για παράδειγμα, Dapper διευκολύνει να αντιστοιχίσετε μεταξύ τα αντικείμενα .NET και τις παραμέτρους των προτάσεων SQL για κλήσεις **Execute** ή για την εκμετάλλευση τα αποτελέσματα με τα ερωτήματα SQL σε αντικείμενα .NET με χρήση **ερωτήματος** κλήσεις από Dapper. 

Όταν χρησιμοποιείτε DapperExtensions, δεν χρειάζεται πλέον να δώσετε τις προτάσεις SQL. Επεκτάσεις μεθόδους όπως **GetList** ή **Εισαγωγή** επάνω από τη σύνδεση βάσης δεδομένων να δημιουργήσετε τις προτάσεις SQL στο παρασκήνιο.
 
Ένα άλλο πλεονέκτημα της Dapper και, επίσης, DapperExtensions είναι ότι η εφαρμογή ελέγχει τη δημιουργία της σύνδεσης βάσης δεδομένων. Αυτό σας βοηθά να αλληλεπιδράσετε με τη βιβλιοθήκη προγράμματος-πελάτη ελαστικότητας βάσης δεδομένων που μεσίτες συνδέσεις με βάση την αντιστοίχιση των shardlets σε βάσεις δεδομένων των βάσεων δεδομένων.

Για να λάβετε το Dapper συγκροτήσεις, ανατρέξτε στο θέμα [Dapper κουκκίδα καθαρή](http://www.nuget.org/packages/Dapper/). Για τις επεκτάσεις Dapper, ανατρέξτε στο θέμα [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).

## <a name="a-quick-look-at-the-elastic-database-client-library"></a>Μια γρήγορη ματιά στο στη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη

Με τη βιβλιοθήκη προγράμματος-πελάτη ελαστικότητας βάσης δεδομένων, που ορίζουν τα διαμερίσματα των δεδομένων σας εφαρμογή ονομάζεται *shardlets* , αντιστοίχισή τους στις βάσεις δεδομένων και τα αναγνωρίζετε με *πλήκτρα sharding*. Μπορείτε να έχετε όσες βάσεις δεδομένων που χρειάζεστε και διανομή σας shardlets σε αυτές τις βάσεις δεδομένων. Η αντιστοίχιση sharding κλειδιού τιμών για τις βάσεις δεδομένων αποθηκεύεται από ένα χάρτη shard που παρέχεται από τη βιβλιοθήκη API. Αυτή η δυνατότητα ονομάζεται **shard χάρτης διαχείρισης**. Ο χάρτης shard λειτουργεί επίσης ως μεσολαβητή συνδέσεων βάσεων δεδομένων για αιτήσεις που περιέχουν έναν αριθμό-κλειδί sharding. Αυτή η δυνατότητα αναφέρεται ως **εξαρτώμενα δρομολόγηση δεδομένων**.

![Shard χάρτες και εξαρτώμενα δρομολόγηση δεδομένων][1]

Ο διαχειριστής του χάρτη shard προστατεύει χρήστες από προβολές χωρίς συνέπεια σε δεδομένα shardlet που μπορεί να προκύψουν κατά την ταυτόχρονη shardlet λειτουργίες διαχείρισης συμβαίνει στην τις βάσεις δεδομένων. Για να το κάνετε αυτό, οι χάρτες shard broker των συνδέσεων βάσης δεδομένων για μια εφαρμογή που έχει δημιουργηθεί με τη βιβλιοθήκη. Όταν λειτουργίες διαχείρισης shard ενδέχεται να επηρεάσουν την shardlet, αυτό σας επιτρέπει τη λειτουργικότητα shard χάρτη για να τερματισμού αυτόματα μια σύνδεση βάσης δεδομένων. 

Αντί να χρησιμοποιήσετε τον παραδοσιακό τρόπο για να δημιουργήσετε συνδέσεις για Dapper, πρέπει να χρησιμοποιήσετε τη [μέθοδο OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn824099.aspx). Αυτό εξασφαλίζει ότι όλα τα επικύρωσης τίθεται σε ισχύ και συνδέσεις πραγματοποιείται σωστά όταν οποιαδήποτε δεδομένα μετακινείται μεταξύ των shards.

### <a name="requirements-for-dapper-integration"></a>Απαιτήσεις για την ενοποίηση Dapper

Όταν εργάζεστε με τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη και τα Dapper API, θέλουμε να διατηρήσετε τις ακόλουθες ιδιότητες:

* **Scaleout**: για να προσθέσετε ή να καταργήσετε βάσεις δεδομένων από τη σειρά δεδομένων της εφαρμογής sharded ως απαραίτητες για τις απαιτήσεις Δυναμικότητας της εφαρμογής. 

-    **Συνέπειας**: εφόσον μας εφαρμογή έχει κλιμακωθεί μέσω sharding, πρέπει να εκτελέσετε εξαρτώμενα δρομολόγηση δεδομένων. Θέλουμε να χρησιμοποιήσετε τα δεδομένα εξαρτώμενα δυνατοτήτων δρομολόγησης της βιβλιοθήκης για να το κάνετε. Συγκεκριμένα, για να διατηρήσετε την επικύρωση και συνέπειας εγγυήσεις που παρέχονται από τις συνδέσεις που είναι όπου μεσολαβούν μέσω της διαχείρισης χάρτη shard προκειμένου να αποφύγετε την καταστροφή ή αποτελέσματα ερωτήματος λάθος. Αυτό εξασφαλίζει ότι οι συνδέσεις σε μια δεδομένη shardlet είναι απορρίφθηκε ή διακοπή αν (για παράδειγμα) το shardlet μετακινηθεί αυτήν τη στιγμή σε μια διαφορετική shard χρησιμοποιώντας τη συγχώνευση/διαίρεση APIs.

-    **Αντιστοίχιση αντικειμένου**: θέλουμε να διατηρήσετε την άνεση της αντιστοιχίσεις που παρέχεται από Dapper για να μεταφράσετε μεταξύ κλάσεις στην εφαρμογή και το υποκείμενο δομές βάσης δεδομένων. 

Ενότητα που ακολουθεί παρέχει οδηγίες για αυτές τις απαιτήσεις για τις εφαρμογές που βασίζονται σε **Dapper** και **DapperExtensions**.

## <a name="technical-guidance"></a>Τεχνική καθοδήγηση
### <a name="data-dependent-routing-with-dapper"></a>Δεδομένα εξαρτώμενα δρομολόγηση με Dapper 

Με Dapper, η εφαρμογή είναι συνήθως υπεύθυνοι για τη δημιουργία και άνοιγμα τις συνδέσεις στην υποκείμενη βάση δεδομένων. Δεδομένο έναν τύπο T από την εφαρμογή, Dapper επιστρέφει αποτελέσματα ερωτήματος ως συλλογές .NET του τύπου τ Dapper εκτελεί την αντιστοίχιση από τις γραμμές αποτέλεσμα T-SQL για τα αντικείμενα του τύπου τ Ομοίως, Dapper χαρτών .NET αντικείμενα σε SQL τιμές ή παραμέτρους για προτάσεις γλώσσας (DML) χειρισμό δεδομένων. Dapper προσφέρει αυτή η λειτουργία μέσω μέθοδοι επέκταση στο κανονικό [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) αντικείμενο από τις βιβλιοθήκες ADO .NET SQL Client. Η σύνδεση SQL που επιστρέφονται από τα ελαστικά API κλίμακα για DDR είναι επίσης κανονικά [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) αντικείμενα. Αυτό σας επιτρέπει να χρησιμοποιήσετε απευθείας Dapper επεκτάσεις πάνω από τον τύπο που επιστρέφονται από τη βιβλιοθήκη του προγράμματος-πελάτη DDR API, όπως είναι επίσης μια απλή σύνδεση SQL Client.

Παρατηρήσεις αυτές καθιστούν απλές για να χρησιμοποιήσετε συνδέσεις όπου μεσολαβούν από τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη για Dapper.

Αυτό το παράδειγμα κώδικα (από το δείγμα συνοδευτικές) απεικονίζει την προσέγγιση όπου το πλήκτρο sharding παρέχεται από την εφαρμογή broker τη σύνδεση με το σωστό shard στη βιβλιοθήκη.   

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                     key: tenantId1, 
                     connectionString: connStrBldr.ConnectionString, 
                     options: ConnectionOptions.Validate))
    {
        var blog = new Blog { Name = name };
        sqlconn.Execute(@"
                      INSERT INTO
                            Blog (Name)
                            VALUES (@name)", new { name = blog.Name }
                        );
    }

Την κλήση [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API αντικαθιστά τη δημιουργία προεπιλογή και το άνοιγμα μιας σύνδεσης SQL Client. Η κλήση [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) μεταφέρει τα ορίσματα που απαιτούνται για τη δρομολόγηση εξαρτώμενα δεδομένων: 

-    Ο χάρτης shard για να αποκτήσετε πρόσβαση διασυνδέσεις εξαρτώμενα δρομολόγηση δεδομένων
-    Το κλειδί sharding για τον προσδιορισμό του shardlet
-    Τα διαπιστευτήρια (όνομα χρήστη και κωδικός πρόσβασης) για να συνδεθείτε με το shard

Το αντικείμενο χάρτη shard δημιουργεί μια σύνδεση με το shard όπου διατηρείται το shardlet για το κλειδί που δίνεται sharding. Το πρόγραμμα-πελάτη ελαστικότητας βάσης δεδομένων APIs tag επίσης τη σύνδεση για την υλοποίηση τις εγγυήσεις συνέπειας. Μετά την κλήση σε [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) επιστρέφει κανονικό αντικείμενο σύνδεσης SQL Client, από Dapper τις επόμενες κλήσεις στη μέθοδο επέκταση **Execute** ακολουθεί η τυπική Dapper εξάσκησης.

Μεγάλο βαθμό τον ίδιο τρόπο λειτουργίας των ερωτημάτων – μπορείτε πρώτα να ανοίξετε τη σύνδεση χρησιμοποιώντας [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) από το πρόγραμμα-πελάτη API. Στη συνέχεια, μπορείτε να χρησιμοποιήσετε τις κανονικές Dapper επέκταση μεθόδους για να αντιστοιχίσετε τα αποτελέσματα του ερωτήματος SQL σε αντικείμενα .NET:

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId1, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate ))
    {    
           // Display all Blogs for tenant 1
           IEnumerable<Blog> result = sqlconn.Query<Blog>(@"
                                SELECT * 
                                FROM Blog
                                ORDER BY Name");

           Console.WriteLine("All blogs for tenant id {0}:", tenantId1);
           foreach (var item in result)
           {
                Console.WriteLine(item.Name);
            }
    }

Σημειώστε ότι η **Χρήση** μπλοκ με τη σύνδεση DDR εμβελειών όλες οι λειτουργίες βάσης δεδομένων μέσα στο μπλοκ για τη μία shard όπου διατηρείται tenantId1. Το ερώτημα επιστρέφει μόνο ιστολόγια που είναι αποθηκευμένα στο την τρέχουσα shard, αλλά όχι αυτά είναι αποθηκευμένα σε οποιοδήποτε άλλο shards. 

## <a name="data-dependent-routing-with-dapper-and-dapperextensions"></a>Εξαρτώμενα δρομολόγηση με Dapper και DapperExtensions δεδομένων

Dapper συνοδεύεται από ένα περιβάλλον εμπορικής προσαρμογής με επιπλέον επεκτάσεις που μπορούν να παρέχουν περαιτέρω ευκολία και αφαίρεσης από τη βάση δεδομένων κατά την ανάπτυξη εφαρμογών βάσης δεδομένων. DapperExtensions είναι ένα παράδειγμα. 

Χρήση DapperExtensions στην εφαρμογή σας δεν αλλάζει πώς δημιουργούνται και ελέγχονται συνδέσεις βάσεων δεδομένων. Εξακολουθεί να είναι ευθύνη της εφαρμογής για να ανοίξετε τις συνδέσεις και κανονική αντικείμενα σύνδεσης SQL Client αναμένεται από τις μεθόδους επέκτασης. Θα σας μπορεί να εξαρτώνται από το [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) , όπως περιγράφεται παραπάνω. Όπως εμφανίζονται τα ακόλουθα δείγματα κώδικα, η μοναδική αλλαγή είναι ότι δεν είναι πλέον έχουμε για να γράψετε τις προτάσεις T SQL:

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           var blog = new Blog { Name = name2 };
           sqlconn.Insert(blog);
    }

Και το δείγμα κώδικα για το ερώτημα: 

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           // Display all Blogs for tenant 2
           IEnumerable<Blog> result = sqlconn.GetList<Blog>();
           Console.WriteLine("All blogs for tenant id {0}:", tenantId2);
           foreach (var item in result)
           {
               Console.WriteLine(item.Name);
           }
    }

### <a name="handling-transient-faults"></a>Μεταβατικές χειρισμού σφαλμάτων

Την ομάδα του Microsoft μοτίβα & πρακτικές δημοσιευτεί [Μεταβατικές σφαλμάτων χειρισμός μπλοκ εφαρμογής](http://msdn.microsoft.com/library/hh680934.aspx) για να βοηθήσει τους προγραμματιστές εφαρμογών να συμβάλει στην αντιμετώπιση κοινών σφαλμάτων μεταβατικές συνθήκες που απαντώνται όταν εκτελείται στο cloud. Για περισσότερες πληροφορίες, ανατρέξτε στο θέμα [Perseverance, μυστικό από όλες τις επιτυχίες τους σχετικά: χρησιμοποιώντας το μεταβατικές σφαλμάτων χειρισμός εφαρμογή μπλοκ](http://msdn.microsoft.com/library/dn440719.aspx).

Το δείγμα κώδικα εξαρτάται από τη βιβλιοθήκη μεταβατικές σφαλμάτων για να προστατευτείτε από μεταβατικές σφάλματα. 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() =>
    {
       using (SqlConnection sqlconn = 
          shardingLayer.ShardMap.OpenConnectionForKey(tenantId2, connStrBldr.ConnectionString, ConnectionOptions.Validate))
          {
              var blog = new Blog { Name = name2 };
              sqlconn.Insert(blog);
          }
    });

**SqlDatabaseUtils.SqlRetryPolicy** τον παραπάνω κώδικα ορίζεται ως μια **SqlDatabaseTransientErrorDetectionStrategy** με ένα πλήθος "Επανάληψη" 10 και 5 δευτερολέπτων αναμονής χρόνου μεταξύ των επαναλήψεων. Εάν χρησιμοποιείτε συναλλαγές, βεβαιωθείτε ότι το εύρος "Επανάληψη" Επιστροφή στην αρχή της κίνησης στην περίπτωση μεταβατικές ένα σφάλμα.

## <a name="limitations"></a>Περιορισμοί

Τις μεθόδους που περιγράφονται σε αυτό το έγγραφο συνεπάγεται ορισμένοι περιορισμοί:

* Το δείγμα κώδικα για αυτό το έγγραφο δεν δείχνουν πώς μπορείτε να διαχειριστείτε σχήματος σε shards.
* Δίνεται μια αίτηση, θα σας λαμβάνεται ως δεδομένο ότι όλα τα Επεξεργασία βάσης δεδομένων περιέχεται μέσα σε ένα μεμονωμένο shard όπως προσδιορίζεται από τον αριθμό-κλειδί sharding που παρέχεται από την αίτηση. Ωστόσο, αυτή την υπόθεση δεν πάντα κρατήστε, για παράδειγμα, όταν δεν είναι δυνατή για τη διάθεση έναν αριθμό-κλειδί sharding. Για να αντιμετωπίσετε, τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη περιλαμβάνει την [κλάση MultiShardQuery](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx). Τάξη υλοποιεί μια αφαίρεσης σύνδεσης για την υποβολή ερωτημάτων πάνω από διάφορες shards. Χρήση MultiShardQuery σε συνδυασμό με Dapper είναι πέρα από το πεδίο αυτού του εγγράφου.

## <a name="conclusion"></a>Ολοκλήρωση

Εφαρμογές που χρησιμοποιούν Dapper και DapperExtensions εύκολα μπορούν να επωφεληθούν από τα εργαλεία ελαστικότητας βάσης δεδομένων για βάση δεδομένων SQL Azure. Τα βήματα που περιγράφονται σε αυτό το έγγραφο, αυτές τις εφαρμογές να χρησιμοποιήσετε τη δυνατότητα του εργαλείου για εξαρτώμενα δρομολόγηση, αλλάζοντας τη δημιουργία και άνοιγμα νέων αντικειμένων [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) τα δεδομένα για να χρησιμοποιήσετε την κλήση [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) της βιβλιοθήκης ελαστικότητας βάση δεδομένων προγράμματος-πελάτη. Αυτό περιορίζει την εφαρμογή απαιτούμενες αλλαγές για αυτές τις θέσεις όπου δημιουργούνται και ανοίξει νέες συνδέσεις. 

[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-working-with-dapper/dapperimage1.png
 