<properties 
    pageTitle="Χρήση βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη με Framework οντότητα | Microsoft Azure" 
    description="Χρήση βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη και του Framework οντότητα για κωδικοποίησης βάσεις δεδομένων" 
    services="sql-database" 
    documentationCenter="" 
    manager="jhubbard" 
    authors="torsteng" 
    editor=""/>

<tags 
    ms.service="sql-database" 
    ms.workload="sql-database" 
    ms.tgt_pltfrm="na" 
    ms.devlang="na" 
    ms.topic="article" 
    ms.date="05/27/2016" 
    ms.author="torsteng"/>

# <a name="elastic-database-client-library-with-entity-framework"></a>Ελαστικά βιβλιοθήκη προγράμματος-πελάτη βάσης δεδομένων με πλαίσιο οντότητα 
 
Αυτό το έγγραφο εμφανίζει τις αλλαγές σε μια εφαρμογή Framework οντότητα που απαιτούνται για την ενοποίηση με τα [Εργαλεία ελαστικότητας βάσης δεδομένων](sql-database-elastic-scale-introduction.md). Η εστίαση είναι σε τη σύνταξη [shard αντιστοίχιση διαχείρισης](sql-database-elastic-scale-shard-map-management.md) και [δεδομένων εξαρτώνται από τη δρομολόγηση](sql-database-elastic-scale-data-dependent-routing.md) με Framework οντότητα **Κώδικα πρώτη** προσέγγιση. Το [Πρώτο κώδικα-η νέα βάση δεδομένων](http://msdn.microsoft.com/data/jj193542.aspx) πρόγραμμα εκμάθησης για EF λειτουργεί ως παράδειγμά μας εκτελείται σε όλο το έγγραφο. Το δείγμα κώδικα που συνοδεύουν αυτό το έγγραφο είναι μέρος των εργαλεία ελαστικότητας βάσης δεδομένων Ορισμός δείγματα στο Visual Studio δείγματα κώδικα.
  
## <a name="downloading-and-running-the-sample-code"></a>Λήψη και την εκτέλεση του δείγματος κώδικα
Για να κάνετε λήψη του κώδικα για αυτό το άρθρο:

* Απαιτείται το Visual Studio 2012 ή νεότερη έκδοση. 
* Ξεκινήστε το Visual Studio. 
* Στο Visual Studio, επιλέξτε Αρχείο -> νέο έργο. 
* Στο παράθυρο διαλόγου "Δημιουργία έργου", μεταβείτε τα **Online δείγματα** για **Visual C#** και πληκτρολογήστε "ελαστικότητας db" στο πλαίσιο αναζήτησης στην επάνω δεξιά γωνία.
    
    ![Πλαίσιο οντότητα και εφαρμογή δείγμα ελαστικότητας βάσης δεδομένων][1] 

    Επιλέξτε το δείγμα που ονομάζεται **Ελαστικότητας εργαλεία DB για SQL Azure – ενοποίηση Framework οντότητα**. Μετά την αποδοχή της άδειας χρήσης, το δείγμα φορτώνει. 

Για να εκτελέσετε το δείγμα, πρέπει να δημιουργήσετε τρεις κενή βάσεις δεδομένων σε βάση δεδομένων SQL Azure:

* Βάση δεδομένων διαχείρισης χάρτη shard
* Βάση δεδομένων shard 1
* Βάση δεδομένων shard 2

Αφού δημιουργήσετε αυτές τις βάσεις δεδομένων, συμπληρώστε τα σύμβολα κράτησης θέσης σε **Program.cs** με το όνομα του διακομιστή Azure SQL DB, τα ονόματα βάσης δεδομένων και τα διαπιστευτήριά σας για να συνδεθείτε με τις βάσεις δεδομένων. Δημιουργία της λύσης στο Visual Studio. Visual Studio θα κάνει λήψη τα απαιτούμενα NuGet πακέτα για τη βιβλιοθήκη προγράμματος-πελάτη ελαστικότητας βάσης δεδομένων, Framework οντότητα και μεταβατικές σφαλμάτων χειρισμός ως μέρος της διαδικασίας Δημιουργία. Βεβαιωθείτε ότι η επαναφορά NuGet πακέτων είναι ενεργοποιημένη για τη λύση. Μπορείτε να ενεργοποιήσετε αυτήν τη ρύθμιση κάνοντας δεξί κλικ στο αρχείο λύση στην Εξερεύνηση λύσεων του Visual Studio. 

## <a name="entity-framework-workflows"></a>Ροές εργασίας Framework οντότητα 

Προγραμματιστές Framework οντότητα που βασίζονται σε μία από τις παρακάτω τέσσερις ροές εργασίας για να δημιουργήσετε εφαρμογές και να διασφαλίσετε ότι διατήρησης για αντικείμενα εφαρμογής: 

* **Πρώτη κώδικα (νέα βάση δεδομένων)**: το EF προγραμματιστής δημιουργεί το μοντέλο στο τον κώδικα της εφαρμογής και, στη συνέχεια, EF τη βάση δεδομένων από αυτό. 
* **Πρώτη κώδικα (υπάρχουσα βάση δεδομένων)**: Ο προγραμματιστής σας επιτρέπει να EF δημιουργία του κώδικα εφαρμογής για το μοντέλο από μια υπάρχουσα βάση δεδομένων.
* **Πρώτη μοντέλο**: Ο προγραμματιστής δημιουργεί το μοντέλο στη σχεδίαση EF και, στη συνέχεια, EF δημιουργεί τη βάση δεδομένων από το μοντέλο.
* **Πρώτη βάσης δεδομένων**: Ο προγραμματιστής χρησιμοποιεί EF tooling να υπολογίσει το μοντέλο από μια υπάρχουσα βάση δεδομένων. 

Όλες οι προσεγγίσεις εξαρτώνται από την κλάση DbContext με διαφάνεια διαχείρισης συνδέσεις βάσεων δεδομένων και σχήμα της βάσης δεδομένων για μια εφαρμογή. Όπως θα αναλύονται με περισσότερες λεπτομέρειες αργότερα στο έγγραφο, διαφορετικά κατασκευές στη βασική κλάση DbContext επιτρέπουν διάφορα επίπεδα ελέγχου για τη δημιουργία σύνδεσης, της βάσης δεδομένων για τη δημιουργία εκκίνηση και σχήματος. Προκλήσεις ανακύπτουν κυρίως από το γεγονός ότι η διαχείριση της σύνδεσης βάσης δεδομένων που παρέχονται από EF διασταυρώνεται με τις δυνατότητες διαχείρισης σύνδεσης δεδομένων εξαρτώμενα δρομολόγησης διασυνδέσεις που παρέχονται από τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη. 

## <a name="elastic-database-tools-assumptions"></a>Υποθέσεις εργαλεία ελαστικότητας βάσης δεδομένων 

Για ορισμούς όρων, ανατρέξτε στο θέμα [Γλωσσάρι εργαλεία ελαστικότητας βάσης δεδομένων](sql-database-elastic-scale-glossary.md).

Με βιβλιοθήκη προγράμματος-πελάτη ελαστικότητας βάσης δεδομένων, μπορείτε να καθορίσετε τα διαμερίσματα των δεδομένων σας εφαρμογής που ονομάζεται shardlets. Shardlets επισημαίνονται με έναν αριθμό-κλειδί sharding και αντιστοιχίζονται σε συγκεκριμένες βάσεις δεδομένων. Μια εφαρμογή μπορεί να έχετε όσες βάσεις δεδομένων σύμφωνα με τις ανάγκες και να διανείμετε το shardlets για την παροχή αρκετή χωρητικότητα ή επιδόσεων δεδομένο τρέχουσα επιχειρηματικές απαιτήσεις. Την αντιστοίχιση των sharding βασικές τιμές για τις βάσεις δεδομένων αποθηκεύεται από ένα χάρτη shard που παρέχεται από το πρόγραμμα-πελάτη ελαστικότητας βάσης δεδομένων APIs. Ονομάζουμε αυτήν τη δυνατότητα **Διαχείρισης χάρτη Shard**ή SMM για συντομία. Ο χάρτης shard λειτουργεί επίσης ως μεσολαβητή συνδέσεων βάσεων δεδομένων για αιτήσεις που περιέχουν έναν αριθμό-κλειδί sharding. Θα σας αναφέρονται σε αυτήν τη δυνατότητα ως **δεδομένων εξαρτώνται από τη δρομολόγηση**. 
 
Ο διαχειριστής του χάρτη shard προστατεύει τους χρήστες από χωρίς συνέπεια προβολές σε δεδομένα shardlet που μπορεί να προκύψει όταν συμβαίνει λειτουργίες διαχείρισης ταυτόχρονες shardlet (όπως η μετακίνηση δεδομένων από ένα shard σε μια άλλη). Για να το κάνετε αυτό, τις αντιστοιχίσεις shard ελέγχονται από το πρόγραμμα-πελάτη broker βιβλιοθήκη των συνδέσεων βάσης δεδομένων για μια εφαρμογή. Αυτό σας επιτρέπει τη λειτουργικότητα χάρτη shard να τερματισμού αυτόματα μια σύνδεση βάσης δεδομένων όταν λειτουργίες διαχείρισης shard ενδέχεται να επηρεάσουν την shardlet που έχει δημιουργηθεί για τη σύνδεση. Αυτή η προσέγγιση πρέπει να ενοποιήσετε με ορισμένες λειτουργίες του EF, όπως η δημιουργία νέων συνδέσεων από ένα υπάρχον για να ελέγξετε για την ύπαρξη βάσης δεδομένων. Σε γενικές γραμμές, μας παρατηρήσεων έχει ότι λειτουργούν με το τυπικό κατασκευές DbContext λειτουργούν μόνο με αξιοπιστία για συνδέσεις κλειστή βάση δεδομένων που μπορούν να κλωνοποιηθούν με ασφάλεια για EF. Η αρχή σχεδίαση της βάσης δεδομένων ελαστικότητας αντί για αυτό είναι να μόνο broker ανοιχτό συνδέσεις. Μία πιστεύετε ότι το κλείσιμο μιας σύνδεσης όπου μεσολαβούν από τη βιβλιοθήκη του προγράμματος-πελάτη πριν να παραδίδει για να το DbContext EF μπορεί να επιλύσει αυτό το ζήτημα. Ωστόσο, κλείνοντας τη σύνδεση και βασίζεστε στο EF να το ανοίξετε ξανά, μία να foregoes τους ελέγχους επικύρωσης και τη συνέπεια που έχει εκτελεστεί από τη βιβλιοθήκη. Η λειτουργικότητα μετεγκαταστάσεις στο EF, ωστόσο, χρησιμοποιεί αυτές τις συνδέσεις για να διαχειριστείτε τα υποκείμενα σχήμα της βάσης δεδομένων με τον τρόπο που είναι διαφανή στην εφαρμογή. Ιδανικά, προτείνεται να διατηρήσετε και να συνδυάσετε όλες αυτές τις δυνατότητες τόσο από τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη και EF στην ίδια εφαρμογή. Στην παρακάτω ενότητα ασχολείται με αυτές τις ιδιότητες και τις απαιτήσεις με περισσότερες λεπτομέρειες. 


## <a name="requirements"></a>Απαιτήσεις 

Όταν εργάζεστε με τόσο τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη όσο και στο API δεδομένων του οντότητα Framework Te104090127, θέλουμε να διατηρήσετε τις ακόλουθες ιδιότητες: 

* **Κλίμακα ελέγχου**: για να προσθέσετε ή να καταργήσετε βάσεις δεδομένων από τη σειρά δεδομένων της εφαρμογής sharded ως απαραίτητες για τις απαιτήσεις Δυναμικότητας της εφαρμογής. Αυτό σημαίνει ότι ελέγχου πάνω από το τη δημιουργία και τη διαγραφή των βάσεων δεδομένων και χρησιμοποιώντας το shard ελαστικά βάσης δεδομένων αντιστοίχιση manager API για διαχείριση βάσεων δεδομένων και αντιστοιχίσεις shardlets. 

* **Συνέπειας**: Η εφαρμογή χρησιμοποιεί sharding και χρησιμοποιεί τα δεδομένα εξαρτώμενα δυνατοτήτων δρομολόγησης της βιβλιοθήκης του προγράμματος-πελάτη. Για να αποφύγετε την καταστροφή ή αποτελέσματα ερωτήματος λάθος, συνδέσεις είναι όπου μεσολαβούν μέσω της διαχείρισης χάρτη shard. Αυτό διατηρεί επίσης επικύρωσης και τη συνέπεια.
 
* **Πρώτη κώδικα**: για να διατηρήσετε την άνεση της πρώτης ριζική κώδικα του EF. Στο πρώτο κώδικα, κλάσεις στην εφαρμογή έχουν αντιστοιχιστεί με διαφάνεια τα υποκείμενα δομές βάσης δεδομένων. Ο κώδικας εφαρμογής αλληλεπιδρά με DbSets που μάσκα περισσότερα στοιχεία που περιλαμβάνονται στην υποκείμενη Επεξεργασία βάσης δεδομένων.
 
* **Σχήμα**: οντότητα Framework χειρίζεται Δημιουργία σχήματος αρχικής βάσης δεδομένων και οι επόμενες σχήματος εξέλιξη μέσω μετεγκαταστάσεις. Διατηρώντας αυτές τις δυνατότητες, την προσαρμογή της εφαρμογής σας είναι εύκολη καθώς εξελίσσεται τα δεδομένα. 

Οι παρακάτω οδηγίες καθοδηγεί τον τρόπο για να ικανοποιήσετε αυτές τις απαιτήσεις για το πρώτο κώδικα εφαρμογών χρησιμοποιώντας εργαλεία ελαστικότητας βάσης δεδομένων. 

## <a name="data-dependent-routing-using-ef-dbcontext"></a>Εξαρτώμενα δρομολόγηση χρησιμοποιώντας EF DbContext δεδομένων 

Συνδέσεις βάσεων δεδομένων με πλαίσιο οντότητα πραγματοποιείται συνήθως μέσω υποκατηγορίες της **DbContext**. Για να δημιουργήσετε αυτές τις δευτερεύουσες κλάσεις, που προέρχονται από **DbContext**. Αυτό είναι όπου μπορείτε να καθορίσετε το **DbSets** που υλοποίηση των συλλογών αντίγραφα βάσης δεδομένων CLR αντικειμένων για την εφαρμογή σας. Στο πλαίσιο εξαρτώμενα δρομολόγηση δεδομένων, περιγράφουμε πολλές χρήσιμες ιδιότητες που δεν διαθέτουν απαραίτητα για άλλα σενάρια πρώτη εφαρμογή EF κώδικα: 

* Υπάρχει ήδη στη βάση δεδομένων και έχει καταχωρηθεί στην αντιστοίχιση shard ελαστικά βάσης δεδομένων. 
* Το σχήμα της εφαρμογής έχει ήδη αναπτυχθεί στη βάση δεδομένων (που περιγράφεται παρακάτω). 
* Συνδέσεις δρομολόγησης εξαρτώνται από δεδομένα στη βάση δεδομένων είναι όπου μεσολαβούν shard χάρτη. 

Για να ενσωματώσετε **DbContexts** με δεδομένα εξαρτώνται από τη δρομολόγηση για ανάληψη κλίμακα:

1. Δημιουργία συνδέσεων φυσική βάση δεδομένων μέσω του διασυνδέσεων ελαστικότητας βάση δεδομένων προγράμματος-πελάτη από τη Διαχείριση χάρτη shard, 
2. Αναδίπλωση τη σύνδεση με την υποκατηγορία **DbContext**
3. Μεταβίβαση της σύνδεσης προς τα κάτω σε τις βασικές κλάσεις **DbContext** για να βεβαιωθείτε ότι όλα τα επεξεργασίας στην πλευρά EF συμβαίνει καθώς και. 

Το παρακάτω παράδειγμα κώδικα παρουσιάζει αυτήν την προσέγγιση. (Αυτός ο κώδικας είναι επίσης στο έργο Visual Studio συνοδευτικές)

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed to the proper shard by the shard map manager. 
        // Note that the base class c'tor call will fail for an open connection
        // if migrations need to be done and SQL credentials are used. This is the reason for the 
        // separation of c'tors into the data-dependent routing case (this c'tor) and the internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map to broker a validated connection for the given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a>Κύρια σημεία
* Μια νέα κατασκευή αντικαθιστά την προεπιλεγμένη κατασκευή στη δευτερεύουσα κλάση DbContext 
* Η νέα κατασκευή μεταφέρει τα ορίσματα που απαιτούνται για δεδομένα εξαρτώμενα δρομολόγηση μέσω βιβλιοθήκης ελαστικότητας βάση δεδομένων προγράμματος-πελάτη:
    * ο χάρτης shard για τη δρομολόγηση που εξαρτώνται από δεδομένα, πρόσβαση
    * το κλειδί sharding για τον προσδιορισμό του shardlet,
    * μια συμβολοσειρά σύνδεσης με τα διαπιστευτήρια για τη σύνδεση δρομολόγησης εξαρτώνται από δεδομένα με το shard. 
 
* Η κλήση για την κατασκευή της βασικής κλάσης σας μεταφέρει ένα detour σε στατική μέθοδο που εκτελεί όλα τα βήματα είναι απαραίτητο για τη δρομολόγηση εξαρτώνται από δεδομένα. 
   * Χρησιμοποιεί την κλήση OpenConnectionForKey διασυνδέσεις ελαστικότητας βάση δεδομένων προγράμματος-πελάτη στο χάρτη shard για τον καθορισμό μιας ανοιχτής σύνδεσης.
   * Ο χάρτης shard δημιουργεί τη σύνδεση Άνοιγμα με την shard όπου διατηρείται το shardlet για το κλειδί που δίνεται sharding.
   * Άνοιγμα αυτής της σύνδεσης που του μεταβιβάστηκε πίσω κατασκευή βασικής κλάσης του DbContext για να υποδείξει ότι αυτή η σύνδεση είναι να χρησιμοποιηθούν από EF αντί να εκφράζετε EF αυτόματη δημιουργία μιας νέας σύνδεσης. Με αυτόν τον τρόπο σύνδεσης έχει σημανθεί από το πρόγραμμα-πελάτη ελαστικότητας βάσης δεδομένων API, έτσι ώστε το να εξασφαλιστεί συνέπεια στην περιοχή shard λειτουργίες διαχείρισης χάρτη.
 
  
Χρησιμοποιήστε τη νέα συνάρτηση κατασκευής για την υποκατηγορία DbContext αντί για την προεπιλεγμένη κατασκευή στον κώδικά σας. Ακολουθεί ένα παράδειγμα: 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

Η νέα κατασκευή ανοίγει η σύνδεση με το shard που περιέχει τα δεδομένα για τα shardlet που έχουν προσδιοριστεί από την τιμή της **tenantid1**. Ο κώδικας στο μπλοκ **με χρήση** παραμένει αμετάβλητη για να αποκτήσετε πρόσβαση του **DbSet** για ιστολόγια χρησιμοποιείτε EF στο το shard για **tenantid1**. Αυτό αλλάζει σημασιολογία για τον κωδικό χρησιμοποιώντας το αποκλείσετε ώστε όλες οι λειτουργίες βάσης δεδομένων περιορίζονται τώρα για να τη μία shard όπου διατηρείται **tenantid1** . Για παράδειγμα, ένα ερώτημα LINQ στα ιστολόγια **DbSet** θα επιστρέψει μόνο ιστολόγια που είναι αποθηκευμένα στο την τρέχουσα shard, αλλά όχι αυτά είναι αποθηκευμένα σε άλλες shards.  

#### <a name="transient-faults-handling"></a>Μεταβατικές σφάλματα χειρισμός
Την ομάδα του Microsoft μοτίβα & πρακτικές δημοσιευτεί [Η μεταβατικές σφαλμάτων χειρισμός εφαρμογή μπλοκ](https://msdn.microsoft.com/library/dn440719.aspx). Στη βιβλιοθήκη χρησιμοποιείται με τη βιβλιοθήκη προγράμματος-πελάτη ελαστικότητας κλίμακα σε συνδυασμό με EF. Ωστόσο, βεβαιωθείτε ότι κάθε εξαίρεση μεταβατικές επιστρέφει ένα σημείο όπου θα σας να εξασφαλίσετε ότι η νέα κατασκευή χρησιμοποιείται μετά από ένα σφάλμα μεταβατικές ώστε να πραγματοποιηθεί οποιαδήποτε νέα απόπειρα σύνδεσης χρησιμοποιώντας την κατασκευές θα σας έχουν tweaked. Διαφορετικά, μια σύνδεση με το σωστό shard δεν εγγυάται και υπάρχουν δεν διατηρείται η σύνδεση όταν προκύπτουν αλλαγές στο χάρτη shard διασφαλίσεις. 

Το παρακάτω δείγμα κώδικα δείχνει πώς μπορεί να χρησιμοποιηθεί μια πολιτική "Επανάληψη" SQL γύρω από το νέο κατασκευές υποκατηγορίας **DbContext** : 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

**SqlDatabaseUtils.SqlRetryPolicy** τον παραπάνω κώδικα ορίζεται ως μια **SqlDatabaseTransientErrorDetectionStrategy** με ένα πλήθος "Επανάληψη" 10 και 5 δευτερολέπτων αναμονής χρόνου μεταξύ των επαναλήψεων. Αυτή η προσέγγιση είναι παρόμοια με τις οδηγίες για EF και συναλλαγές προετοιμασία από το χρήστη (ανατρέξτε στο θέμα [περιορισμοί με επανάληψη στρατηγικές εκτέλεσης (EF6 και μετά)](http://msdn.microsoft.com/data/dn307226). Και οι δύο περιπτώσεις απαιτούν ότι το πρόγραμμα εφαρμογής ελέγχει το εύρος στο οποίο επιστρέφει την εξαίρεση μεταβατικές: για να ανοίξετε τη συναλλαγή, ή να (όπως φαίνεται) Δημιουργήστε ξανά το περιβάλλον από το πρώτο γράμμα κάθε λέξης κατασκευή που χρησιμοποιεί τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη.

Χρειάζεστε για να ελέγξετε όπου μεταβατικές εξαιρέσεις χρειαστεί πίσω στο εύρος αποκλείει επίσης τη χρήση των ενσωματωμένων **SqlAzureExecutionStrategy** που παρέχεται με το EF. **SqlAzureExecutionStrategy** θα ανοίξει ξανά μια σύνδεση, αλλά δεν χρησιμοποιήσετε **OpenConnectionForKey** και, επομένως, να παρακάμψει όλα τα επικύρωσης που εκτελείται ως μέρος της κλήσης **OpenConnectionForKey** . Αντί για αυτό, το δείγμα κώδικα χρησιμοποιεί την ενσωματωμένη **DefaultExecutionStrategy** που παρέχεται επίσης με EF. Σε αντίθεση με **SqlAzureExecutionStrategy**, λειτουργεί σωστά σε συνδυασμό με την πολιτική "Επανάληψη" από μεταβατικές χειρισμού σφαλμάτων. Η πολιτική εκτέλεσης έχει οριστεί στην τάξη **ElasticScaleDbConfiguration** . Σημειώστε ότι θα σας αποφασίσει να μην χρησιμοποιήσετε **DefaultSqlExecutionStrategy** εφόσον προτείνει να χρησιμοποιήσετε **SqlAzureExecutionStrategy** Εάν παρουσιαστεί μεταβατικές εξαιρέσεις - που μπορεί να οδηγήσει σε λάθος συμπεριφορά όπως περιγράφεται. Για περισσότερες πληροφορίες σχετικά με τις πολιτικές διαφορετικό "Επανάληψη" και EF, ανατρέξτε στο θέμα [Σύνδεση υποστηρίζεται στο EF](http://msdn.microsoft.com/data/dn456835.aspx).     

#### <a name="constructor-rewrites"></a>Εξετάζονται κατασκευή
Τα παραδείγματα κώδικα παραπάνω απεικόνιση την προεπιλεγμένη κατασκευή κάνει επανεγγραφή απαραίτητη για την εφαρμογή σας, για να χρησιμοποιήσετε δεδομένα εξαρτώμενα δρομολόγησης με το πλαίσιο οντότητα. Ο παρακάτω πίνακας generalizes αυτήν την προσέγγιση για άλλες κατασκευές. 


Τρέχουσα κατασκευή  | Επανεγγραφή κατασκευή για τα δεδομένα | Βασική κατασκευή | Σημειώσεις
---------- | ----------- | ------------|----------
MyContext() |ElasticScaleContext (ShardMap, TKey) |DbContext (DbConnection, bool) |Η σύνδεση πρέπει να είναι μια συνάρτηση του χάρτη shard και το πλήκτρο δρομολόγησης εξαρτώνται από δεδομένα. Χρειάζεται να παράκαμψη αυτόματης σύνδεσης δημιουργίας από EF και αντί για αυτό να χρησιμοποιήσετε το χάρτη shard για broker τη σύνδεση. 
MyContext(string)|ElasticScaleContext (ShardMap, TKey) |DbContext (DbConnection, bool) |Η σύνδεση είναι μια συνάρτηση του χάρτη shard και το πλήκτρο δρομολόγησης εξαρτώνται από δεδομένα. Μια συμβολοσειρά σύνδεσης ή όνομα σταθερό βάσης δεδομένων δεν θα λειτουργούν καθώς παράκαμψη επικύρωσης κατά την αντιστοίχιση shard. 
MyContext(DbCompiledModel) |ElasticScaleContext (ShardMap, TKey, DbCompiledModel) |DbContext (δυαδικός DbConnection, DbCompiledModel) |Η σύνδεση θα δημιουργούνται για το κλειδί που δίνεται shard χάρτη και sharding με το μοντέλο που παρέχονται. Οι μεταγλωττισμένες μοντέλο θα μεταβιβαστεί τη βασική c'tor.
MyContext (DbConnection, bool) |ElasticScaleContext (δυαδικός ShardMap, TKey) |DbContext (DbConnection, bool) |Η σύνδεση πρέπει να είναι προκύπτουν από shard χάρτη και τον αριθμό-κλειδί. Δεν είναι δυνατό να παρέχεται ως εισαγωγή (εκτός αν εισαγωγής που έχει ήδη χρησιμοποιώντας χάρτη shard και τον αριθμό-κλειδί). Η δυαδική τιμή θα είναι αντανάκλαση. 
MyContext (συμβολοσειρά, DbCompiledModel) |ElasticScaleContext (ShardMap, TKey, DbCompiledModel) |DbContext (δυαδικός DbConnection, DbCompiledModel) |Η σύνδεση πρέπει να είναι προκύπτουν από shard χάρτη και τον αριθμό-κλειδί. Δεν είναι δυνατό να παρέχεται ως εισαγωγή (εκτός αν η εισαγωγή αυτών των δεδομένων έχει χρησιμοποιώντας χάρτη shard και του αριθμού-κλειδιού). Οι μεταγλωττισμένες μοντέλο θα είναι αντανάκλαση. 
MyContext (ObjectContext, bool) |ElasticScaleContext (ShardMap, TKey, ObjectContext, bool) |DbContext (ObjectContext, bool) |Η νέα κατασκευή πρέπει να βεβαιωθείτε ότι είναι εκ νέου δρομολόγηση σε μια σύνδεση που ελέγχονται από ελαστικότητας κλίμακα οποιαδήποτε σύνδεση στο το ObjectContext που εισήχθησαν ως εισαγωγή. Μια λεπτομερή ανάλυση του ObjectContexts είναι πέρα από το πεδίο αυτού του εγγράφου.
MyContext (δυαδικός DbConnection, DbCompiledModel) |ElasticScaleContext (ShardMap, TKey, DbCompiledModel, bool)| DbContext (δυαδικός DbConnection, DbCompiledModel,); |Η σύνδεση πρέπει να είναι προκύπτουν από shard χάρτη και τον αριθμό-κλειδί. Η σύνδεση δεν είναι δυνατό να παρέχεται ως εισαγωγή (εκτός αν εισαγωγής που έχει ήδη χρησιμοποιώντας χάρτη shard και τον αριθμό-κλειδί). Μοντέλο και Boolean μεταβιβάζονται την κατασκευή της βασικής κλάσης. 

## <a name="shard-schema-deployment-through-ef-migrations"></a>Ανάπτυξη του σχήματος shard μέσω μετεγκαταστάσεις EF 

Διαχείριση Αυτόματων σχήματος είναι εξυπηρέτηση που παρέχεται από το πλαίσιο οντότητα. Στο περιβάλλον της εφαρμογών χρησιμοποιώντας εργαλεία ελαστικότητας βάσης δεδομένων, θέλουμε να διατηρούνται αυτήν τη δυνατότητα να παρέχετε αυτόματα το σχήμα για να που έχουν δημιουργηθεί πρόσφατα shards όταν προστίθενται στην εφαρμογή sharded βάσεις δεδομένων. Το περίπτωσης χρήσης πρωτεύοντος είναι να αυξήσετε δυναμικού σε η σειρά δεδομένων για sharded εφαρμογές που χρησιμοποιούν EF. Βασίζεται στις δυνατότητες του EF για διαχείριση σχήματος μειώνει τις προσπάθειες διαχείρισης βάσης δεδομένων με μια εφαρμογή sharded ενσωματωμένη σε EF. 

Ανάπτυξη του σχήματος μέσω μετεγκαταστάσεις EF λειτουργεί καλύτερα σε **κλειστό συνδέσεις**. Αυτό σε αντίθεση με το σενάριο για ανάλογα με τα δεδομένα δρομολόγησης που βασίζεται στην ανοιχτή σύνδεση που παρέχεται από το πρόγραμμα-πελάτη ελαστικότητας βάσης δεδομένων API. Μια άλλη διαφορά είναι η απαίτηση συνέπειας: ενώ ευκταίο για να βεβαιωθείτε ότι συνέπειας για όλες δεδομένων εξαρτώνται από τις δρομολόγησης συνδέσεις για να προστατευτείτε από χειρισμό χάρτη ταυτόχρονες shard, δεν είναι ένα πρόβλημα με το αρχικό σχήμα ανάπτυξης σε μια νέα βάση δεδομένων που διαθέτει δεν έχουν ακόμα καταχωρηθεί στο χάρτη shard και δεν έχουν ακόμα έχουν εκχωρηθεί σε shardlets. Θα σας, επομένως, να βασίζονται σε τακτική βάση δεδομένων συνδέσεις για αυτό σενάρια, αντί για τη δρομολόγηση εξαρτώνται από δεδομένα.  

Αυτό οδηγεί σε μια προσέγγιση όπου ανάπτυξης σχήματος μέσω μετεγκαταστάσεις EF είναι στενά συνδεδεμένων με τη δήλωση της νέας βάσης δεδομένων ως μια shard στο χάρτη shard της εφαρμογής. Αυτό εξαρτάται από τις ακόλουθες προϋποθέσεις: 

* Η βάση δεδομένων έχει ήδη δημιουργηθεί. 
* Η βάση δεδομένων είναι κενή-κατέχει δεν υπάρχει σχήμα χρήστη και δεν υπάρχουν δεδομένα χρήστη.
* Ακόμα δεν είναι δυνατή η βάση δεδομένων μέσω του προγράμματος-πελάτη ελαστικότητας βάσης δεδομένων APIs για τη δρομολόγηση δεδομένων εξαρτώνται από. 

Με αυτές τις προϋποθέσεις στη θέση, μπορούμε να δημιουργήσουμε μια κανονική κατάργησης ανοιχτό **SqlConnection** για να ξεκινήσετε μετεγκαταστάσεις EF για ανάπτυξη του σχήματος. Το παρακάτω δείγμα κώδικα απεικονίζει αυτήν την προσέγγιση. 

        // Enter a new shard - i.e. an empty database - to the shard map, allocate a first tenant to it  
        // and kick off EF intialization of the database to deploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext to trigger migrations and schema deployment for the new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query to engage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register the mapping of the tenant to the shard in the shard map. 
            // After this step, data-dependent routing on the shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 
 

Αυτό το δείγμα δείχνει τη μέθοδο **RegisterNewShard** που καταχωρεί τα shard στο χάρτη shard και αναπτύσσει το σχήμα μέσω μετεγκαταστάσεις EF αποθηκεύει μια αντιστοίχιση ενός κλειδιού sharding για να το shard. Βασίζεται σε κατασκευή με την υποκατηγορία **DbContext** (**ElasticScaleContext** στο δείγμα) που τίθεται σε μια συμβολοσειρά σύνδεσης του SQL ως είσοδο. Ο κώδικας από αυτή την κατασκευή είναι απλή, όπως φαίνεται στο ακόλουθο παράδειγμα: 


        // C'tor to deploy schema and migrations to a new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that the schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 
 
Μία ενδέχεται να έχουν χρησιμοποιήσει την έκδοση της κατασκευής έχουν μεταβιβαστεί από τη βασική κλάση. Αλλά ο κώδικας πρέπει να βεβαιωθείτε ότι η προεπιλεγμένη προετοιμασία για EF χρησιμοποιείται κατά τη σύνδεση. Ως εκ τούτου η σύντομη detour σε τη στατική μέθοδο πριν από την κλήση σε την κατασκευή της βασικής κλάσης με τη συμβολοσειρά σύνδεσης. Σημειώστε ότι θα πρέπει να εκτελέσετε την καταχώρηση του shards σε μια διαφορετική εφαρμογή τομέα ή διαδικασία για να εξασφαλίσετε ότι οι ρυθμίσεις προετοιμασίας για EF έρχονται σε διένεξη. 


## <a name="limitations"></a>Περιορισμοί 

Τις μεθόδους που περιγράφονται σε αυτό το έγγραφο συνεπάγεται ορισμένοι περιορισμοί: 

* EF εφαρμογές που χρησιμοποιούν **LocalDb** πρέπει πρώτα να μετεγκαταστήσετε μια κανονική βάση δεδομένων SQL Server πριν χρησιμοποιήσετε τη βιβλιοθήκη ελαστικότητας βάση δεδομένων προγράμματος-πελάτη. Κλιμάκωση ανάληψη μια εφαρμογή μέσω sharding με ελαστικά κλίμακα δεν είναι δυνατή με **LocalDb**. Σημειώστε ότι ανάπτυξης εξακολουθούν να μπορούν να χρησιμοποιούν **LocalDb**. 

* Οι αλλαγές στην εφαρμογή που συνεπάγεται αλλαγές σχήματος βάσης δεδομένων πρέπει να ακολουθήσετε EF μετεγκαταστάσεις σε όλους shards. Το δείγμα κώδικα για αυτό το έγγραφο δεν δείχνουν πώς μπορείτε να το κάνετε αυτό. Εξετάστε το ενδεχόμενο χρήσης ενημέρωση-βάσης δεδομένων με μια παράμετρο συμβολοσειρά σύνδεσης για τη συνεχή επανάληψη όλων shards; ή να εξαγάγετε τη δέσμη ενεργειών T-SQL για τη μετεγκατάσταση σε εκκρεμότητα χρήση ενημέρωση-βάσης δεδομένων με τη – δέσμη ενεργειών option και να εφαρμόσετε τη δέσμη ενεργειών T-SQL shards σας.  

* Δίνεται μια αίτηση, θεωρείται ότι όλα τα Επεξεργασία βάσης δεδομένων περιέχεται μέσα σε ένα μεμονωμένο shard όπως προσδιορίζεται από τον αριθμό-κλειδί sharding που παρέχεται από την αίτηση. Ωστόσο, αυτή την υπόθεση όχι πάντα κρατήστε true. Για παράδειγμα, όταν δεν μπορείτε να κάνετε διαθέσιμο έναν αριθμό-κλειδί sharding. Για να το αντιμετωπίσετε, η βιβλιοθήκη προγράμματος-πελάτη παρέχει την κλάση **MultiShardQuery** που υλοποιεί μια αφαίρεσης σύνδεσης για την υποβολή ερωτημάτων πάνω από διάφορες shards. Εκμάθηση της χρήσης του **MultiShardQuery** σε συνδυασμό με EF είναι πέρα από το πεδίο αυτού του εγγράφου

## <a name="conclusion"></a>Ολοκλήρωση

Τα βήματα που περιγράφονται σε αυτό το έγγραφο, EF εφαρμογές να χρησιμοποιήσετε τη δυνατότητα στη βιβλιοθήκη του προγράμματος-πελάτη ελαστικότητας βάσης δεδομένων για δεδομένα εξαρτώμενα τη δρομολόγηση από επανασχεδιασμός προγράμματος κατασκευές τις δευτερεύουσες κλάσεις **DbContext** που χρησιμοποιούνται στην εφαρμογή EF. Αυτό περιορίζει τις αλλαγές που απαιτούνται για αυτές τις θέσεις όπου **DbContext** κλάσεις υπάρχουν ήδη. Επιπλέον, εφαρμογές EF να συνεχίσετε να επωφεληθείτε από αυτόματο σχήμα ανάπτυξης συνδυάζοντας τα βήματα που είναι απαραίτητο μετεγκαταστάσεις EF με την καταχώρηση του νέου shards και αντιστοιχίσεις shard κλήση. 


[AZURE.INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
 