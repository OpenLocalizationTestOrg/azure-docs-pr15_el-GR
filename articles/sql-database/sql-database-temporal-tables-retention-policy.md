<properties
   pageTitle="Διαχείριση ιστορικού δεδομένων σε πίνακες χρονικό με την πολιτική διατήρησης | Microsoft Azure"
   description="Μάθετε πώς να χρησιμοποιείτε πολιτικής διατήρησης χρονικό για να διατηρήσετε ιστορικού δεδομένα κάτω από το στοιχείο ελέγχου."
   services="sql-database"
   documentationCenter=""
   authors="bonova"
   manager="drasumic"
   editor=""/>

<tags
   ms.service="sql-database"
   ms.devlang="NA"
   ms.topic="article"
   ms.tgt_pltfrm="NA"
   ms.workload="sql-database"
   ms.date="10/12/2016"
   ms.author="bonova"/>

#<a name="manage-historical-data-in-temporal-tables-with-retention-policy"></a>Διαχείριση ιστορικού δεδομένων σε πίνακες χρονικό με την πολιτική διατήρησης

Χρονικό πίνακες μπορούν να αυξήσουν μέγεθος της βάσης δεδομένων περισσότερες από κανονική πίνακες, ειδικά εάν διατηρείτε ιστορικού δεδομένα για ένα μεγαλύτερο χρονικό διάστημα. Ως εκ τούτου, πολιτικής διατήρησης για ιστορικών δεδομένων είναι σημαντική πτυχή του σχεδιασμού και τη διαχείριση του κύκλου ζωής του κάθε χρονικό πίνακα. Χρονικό πίνακες σε βάση δεδομένων SQL Azure που παρέχονται με το μηχανισμό εύκολο για χρήση διατήρησης που σας βοηθά να ολοκληρώσετε αυτήν την εργασία.

Χρονικό ιστορικού διατήρησης μπορεί να ρυθμιστεί σε επίπεδο μεμονωμένων πίνακα, γεγονός που επιτρέπει στους χρήστες να δημιουργούν ευέλικτη παλιών πολιτικές. Εφαρμογή χρονικό διατήρησης είναι απλή: απαιτεί μόνο μία παράμετρο για να ορίσετε κατά την αλλαγή δημιουργίας ή διάταξη πίνακα.

Αφού προσδιορίσετε πολιτικής διατήρησης, βάση δεδομένων SQL Azure θα ξεκινήσει ελέγχοντας τακτικά εάν υπάρχουν ιστορικού γραμμών που πληρούν τις απαιτήσεις για αυτόματη δεδομένων εκκαθάριση. Προσδιορισμός των γραμμών που συμφωνούν και τους κατάργησης από τον πίνακα ιστορικού προκύψουν με διαφάνεια, στην εργασία φόντου που είναι προγραμματισμένη και εκτελούνται από το σύστημα. Συνθήκη ηλικίας για τις γραμμές πίνακα ιστορικού ελέγχεται με βάση τη στήλη που αντιπροσωπεύει το τέλος της περιόδου SYSTEM_TIME. Εάν η περίοδος διατήρησης, για παράδειγμα, έχει οριστεί σε έξι μήνες, οι γραμμές πίνακα που πληρούν τις απαιτήσεις για την εκκαθάριση ικανοποιούν τη συνθήκη παρακάτω:

````
ValidTo < DATEADD (MONTH, -6, SYSUTCDATETIME())
````

Στο παραπάνω παράδειγμα σας ίσα ότι **ValidTo** στήλη αντιστοιχεί στο τέλος της περιόδου SYSTEM_TIME.

##<a name="how-to-configure-retention-policy"></a>Πώς να ρυθμίσετε τις παραμέτρους πολιτικής διατήρησης;

Πριν ρυθμίσετε τις παραμέτρους πολιτικής διατήρησης για χρονικό πίνακα, επιλέξτε πρώτα εάν χρονικό ιστορικού διατήρησης είναι ενεργοποιημένο *στο επίπεδο της βάσης δεδομένων*.

````
SELECT is_temporal_history_retention_enabled, name
FROM sys.databases
````

Βάση δεδομένων της σημαίας **is_temporal_history_retention_enabled** έχει οριστεί σε Ενεργο από προεπιλογή, αλλά οι χρήστες μπορούν να αλλάξουν με πρόταση ALTER Database. Ορίζεται επίσης αυτόματα για να ΑΠΕΝΕΡΓΟΠΟΙΉΣΤΕ μετά [τοποθετήστε το δείκτη στην ώρα επαναφορά](sql-database-point-in-time-restore-portal.md) λειτουργία. Για να ενεργοποιήσετε την εκκαθάριση διατήρησης χρονικό ιστορικού για τη βάση δεδομένων, εκτελέστε την ακόλουθη δήλωση:

````
ALTER DATABASE <myDB>
SET TEMPORAL_HISTORY_RETENTION  ON
````

> [AZURE.IMPORTANT] Μπορείτε να ρυθμίσετε διατήρησης για χρονικό πίνακες, ακόμα και αν **is_temporal_history_retention_enabled** είναι ΑΠΕΝΕΡΓΟΠΟΙΗΜΈΝΗ, αλλά Αυτόματη Εκκαθάριση παλαιών γραμμών δεν θα ενεργοποιηθεί σε αυτήν την περίπτωση.


Έχει ρυθμιστεί η πολιτική διατήρησης κατά τη δημιουργία πίνακα καθορίζοντας την τιμή για την παράμετρο HISTORY_RETENTION_PERIOD:

````
CREATE TABLE dbo.WebsiteUserInfo
(  
    [UserID] int NOT NULL PRIMARY KEY CLUSTERED
  , [UserName] nvarchar(100) NOT NULL
  , [PagesVisited] int NOT NULL
  , [ValidFrom] datetime2 (0) GENERATED ALWAYS AS ROW START
  , [ValidTo] datetime2 (0) GENERATED ALWAYS AS ROW END
  , PERIOD FOR SYSTEM_TIME (ValidFrom, ValidTo)
 )  
 WITH
 (
     SYSTEM_VERSIONING = ON
     (
        HISTORY_TABLE = dbo.WebsiteUserInfoHistory,
        HISTORY_RETENTION_PERIOD = 6 MONTHS
     )
 );
````

Βάση δεδομένων SQL του Azure σάς επιτρέπει να καθορίσετε περίοδος διατήρησης χρησιμοποιώντας διαφορετικές μονάδες χρόνου: ΗΜΈΡΕΣ, ΕΒΔΟΜΆΔΕΣ, ΜΗΝΏΝ και ΕΤΏΝ. Εάν παραλειφθεί το όρισμα HISTORY_RETENTION_PERIOD, λαμβάνεται ΆΠΕΙΡΟ διατήρησης. Μπορείτε επίσης να χρησιμοποιήσετε ρητά ΆΠΕΙΡΟ λέξεων-κλειδιών.

Σε ορισμένα σενάρια, ενδέχεται να θέλετε να ρυθμίσετε τις παραμέτρους διατήρησης μετά τη δημιουργία πίνακα ή να αλλάξετε προηγουμένως έχει ρυθμιστεί τιμή. Σε περίπτωση που χρησιμοποιήσετε πρόταση ALTER TABLE:

````
ALTER TABLE dbo.WebsiteUserInfo
SET (SYSTEM_VERSIONING = ON (HISTORY_RETENTION_PERIOD = 9 MONTHS));
````

> [AZURE.IMPORTANT]  Ρύθμιση SYSTEM_VERSIONING σε ΑΠΕΝΕΡΓΟΠΟΊΗΣΗ *δεν διατηρεί* διατήρησης τιμή της χρονικής περιόδου. Ρύθμιση SYSTEM_VERSIONING σε Ενεργοποιηση χωρίς HISTORY_RETENTION_PERIOD που καθορίζεται ρητά αποτελέσματα της περιόδου διατήρησης ΆΠΕΙΡΟ.

Για να δείτε την τρέχουσα κατάσταση της πολιτικής διατήρησης, χρησιμοποιήστε το ακόλουθο ερώτημα που ενώνει χρονικό διατήρησης ενεργοποίησης σημαίας στο επίπεδο της βάσης δεδομένων με τις περιόδους διατήρησης για μεμονωμένους πίνακες:

````
SELECT DB.is_temporal_history_retention_enabled,
SCHEMA_NAME(T1.schema_id) AS TemporalTableSchema,
T1.name as TemporalTableName,  SCHEMA_NAME(T2.schema_id) AS HistoryTableSchema,
T2.name as HistoryTableName,T1.history_retention_period,
T1.history_retention_period_unit_desc
FROM sys.tables T1  
OUTER APPLY (select is_temporal_history_retention_enabled from sys.databases
where name = DB_NAME()) AS DB
LEFT JOIN sys.tables T2   
ON T1.history_table_id = T2.object_id WHERE T1.temporal_type = 2
````


##<a name="how-sql-database-deletes-aged-rows"></a>Πώς βάση δεδομένων SQL διαγράφει ηλικίας γραμμών;

Η διαδικασία εκκαθάρισης εξαρτάται από τη διάταξη ευρετήριο του πίνακα ιστορικού. Είναι σημαντικό να παρατηρήσετε αυτό *μόνο ιστορικού πίνακες με ένα συγκεντρωτικό ευρετήριο (B δέντρου ή columnstore) μπορούν να έχουν ρυθμιστεί πολιτική διατήρησης πεπερασμένο*. Για να εκτελέσετε την Εκκαθάριση παλαιών δεδομένων για όλους τους πίνακες χρονικό με περίοδος διατήρησης πεπερασμένο δημιουργείται μια εργασία στο παρασκήνιο.
Εκκαθάριση λογική για το ευρετήριο ομαδοποιημένων rowstore (B-δέντρου) διαγράφει παλαιών γραμμή σε μικρότερο μέγεθος μπλοκ (έως και 10 K) Ελαχιστοποίηση πίεση στο αρχείο καταγραφής βάσης δεδομένων και υποσυστήματος εισόδου/εξόδου. Παρόλο που χρησιμοποιεί την εκκαθάριση λογικής απαιτείται το ευρετήριο B δέντρου, σειρά των διαγραφές για τις γραμμές που είναι παλαιότερα από περίοδος διατήρησης δεν μπορεί να εξασφαλιστεί σταθερά. Επομένως, *δεν θα οποιαδήποτε εξάρτηση από τη σειρά εκκαθάριση στις εφαρμογές σας*.

Η εργασία εκκαθάρισης για την ομαδοποιημένη columnstore καταργεί ολόκληρες [ομάδες γραμμής](https://msdn.microsoft.com/library/gg492088.aspx) ταυτόχρονα (συνήθως περιέχει 1 εκατομμύριο γραμμές κάθε), που είναι πολύ αποτελεσματική, ιδίως όταν δημιουργείται δεδομένα ιστορικού υψηλό ρυθμό.

![Ομαδοποιημένη columnstore διατήρησης](./media/sql-database-temporal-tables-retention-policy/cciretention.png)


Συμπίεση εξαιρετική δεδομένων και κάνει εκκαθάριση μικρότερες απαιτήσεις διατήρησης ομαδοποιημένη columnstore ευρετήριο ιδανική επιλογή για σενάρια, όταν το φόρτο εργασίας δημιουργεί γρήγορα υψηλή ποσό των δεδομένων του ιστορικού. Αυτό το μοτίβο είναι τυπικές για εντατική [συναλλαγών επεξεργασίας φόρτους εργασίας που χρησιμοποιούν χρονικό πίνακες](https://msdn.microsoft.com/library/mt631669.aspx) για παρακολούθηση αλλαγών και έλεγχος, ανάλυση τάσεων ή IoT κατάποσης δεδομένων.

##<a name="index-considerations"></a>Ζητήματα ευρετηρίου

Η εργασία εκκαθάρισης για πίνακες με ευρετήριο συμπλέγματος rowstore απαιτεί ευρετήριο για να ξεκινήσετε με τη στήλη που αντιστοιχεί στο τέλος της περιόδου SYSTEM_TIME. Εάν δεν υπάρχει ευρετήριο, δεν θα μπορείτε να ρυθμίσετε τις παραμέτρους περίοδος διατήρησης πεπερασμένο:

*Μήνυμα λάθους 13765, 16 επίπεδο, κατάσταση 1 <br> </br> ρύθμιση περίοδος διατήρησης πεπερασμένο απέτυχε στην έκδοση συστήματος χρονικό πίνακα 'temporalstagetestdb.dbo.WebsiteUserInfo' επειδή πίνακα ιστορικού 'temporalstagetestdb.dbo.WebsiteUserInfoHistory' δεν περιέχει απαιτείται συγκεντρωτικό ευρετήριο. Μπορείτε να δημιουργήσετε μια ομαδοποιημένη columnstore ή B δέντρου ευρετηρίου ξεκινώντας από τη στήλη που ταιριάζει με το τέλος της SYSTEM_TIME περιόδου, στον πίνακα "Ιστορικό".*

Είναι σημαντικό να παρατηρήσετε ότι το προεπιλεγμένο πίνακα ιστορικού δημιουργήθηκε από βάση δεδομένων SQL Azure ήδη έχει ομαδοποιημένη ευρετήριο, το οποίο είναι συμβατό με το για την πολιτική διατήρησης. Εάν προσπαθήσετε να καταργήσετε αυτού του ευρετηρίου σε έναν πίνακα με περίοδος διατήρησης πεπερασμένο, η λειτουργία αποτυγχάνει με το ακόλουθο σφάλμα:

*Μήνυμα λάθους 13766, 16 επίπεδο, κατάσταση 1 <br> </br> δεν είναι δυνατό να αποθέστε το συγκεντρωτικό ευρετήριο 'WebsiteUserInfoHistory.IX_WebsiteUserInfoHistory', επειδή χρησιμοποιείται για αυτόματη εκκαθάριση παλαιών δεδομένων. Εξετάστε το ενδεχόμενο ρύθμιση HISTORY_RETENTION_PERIOD ΆΠΕΙΡΟ του αντίστοιχου συστήματος έκδοση χρονικό πίνακα εάν πρέπει να αποθέσετε αυτό το ευρετήριο.*

Εκκαθάριση στο ευρετήριο ομαδοποιημένων columnstore λειτουργεί καλύτερα εάν ιστορικού γραμμές εισάγονται με την αύξουσα σειρά (ταξινομημένα μέχρι το τέλος της περιόδου στήλης), που είναι πάντα πεζών και κεφαλαίων γραμμάτων κατά τον πίνακα ιστορικού συμπληρώνεται από το μηχανισμό SYSTEM_VERSIONIOING για αποκλειστική χρήση. Εάν γραμμών στον πίνακα ιστορικού δεν είναι σύμφωνα με την λήξη της περιόδου στήλη (η οποία μπορεί να συμβεί εάν μετεγκατασταθεί υπάρχοντα δεδομένα ιστορικού), θα πρέπει να μπορείτε να δημιουργήσετε ευρετήριο ομαδοποιημένων columnstore επάνω σε ευρετήριο rowstore B δέντρου που έχει παραγγελθεί σωστά, για να επιτύχετε βέλτιστη απόδοση ξανά.

Αποφύγετε να φτιάχνετε ομαδοποιημένων columnstore ευρετήριο για τον πίνακα ιστορικού με την περίοδο πεπερασμένο διατήρησης, επειδή μπορεί να αλλάξει την ταξινόμηση των ομάδων γραμμής ομαλά που επιβάλλονται από τη λειτουργία συστήματος-διαχείριση εκδόσεων. Εάν πρέπει να ξαναδημιουργήσετε το ευρετήριό ομαδοποιημένων columnstore στον πίνακα ιστορικού, κάνετε κατά την εκ νέου δημιουργία της επάνω σε συμβατή με ευρετήριο B δέντρου, διατηρώντας την ταξινόμηση σε το rowgroups είναι απαραίτητο για την εκκαθάριση κανονική δεδομένων. Η ίδια προσέγγιση θα πρέπει να ληφθούν εάν δημιουργείτε χρονικό πίνακα με υπάρχοντα πίνακα ιστορικού που περιλαμβάνει ομαδοποιημένη στήλη ευρετήριο χωρίς δεδομένα εγγυημένη σειρά:

````
/*Create B-tree ordered by the end of period column*/
CREATE CLUSTERED INDEX IX_WebsiteUserInfoHistory ON WebsiteUserInfoHistory (ValidTo)
WITH (DROP_EXISTING = ON);
GO
/*Re-create clustered columnstore index*/
CREATE CLUSTERED COLUMNSTORE INDEX IX_WebsiteUserInfoHistory ON WebsiteUserInfoHistory
WITH (DROP_EXISTING = ON);
````

Όταν περίοδος διατήρησης πεπερασμένο ρυθμίζεται για τον πίνακα ιστορικού με το ευρετήριο ομαδοποιημένων columnstore, δεν μπορείτε να δημιουργήσετε πρόσθετες μη ομαδοποιημένη ευρετήρια B δέντρου σε αυτόν τον πίνακα:

````
CREATE NONCLUSTERED INDEX IX_WebHistNCI ON WebsiteUserInfoHistory ([UserName])
````

Η προσπάθεια να εκτελέσει παραπάνω πρόταση θα αποτύχει με το ακόλουθο σφάλμα:

*Μήνυμα λάθους 13772, 16 επίπεδο, κατάσταση 1 <br> </br> δεν είναι δυνατό να δημιουργήσετε μη ομαδοποιημένη ευρετήριο σε έναν πίνακα ιστορικού χρονικό 'WebsiteUserInfoHistory' εφόσον έχει περίοδος διατήρησης πεπερασμένο και ομαδοποιημένων columnstore ευρετήριο που ορίζονται από το.*

##<a name="querying-tables-with-retention-policy"></a>Υποβολή ερωτημάτων πίνακες με πολιτικής διατήρησης

Όλα τα ερωτήματα του πίνακα χρονικό φιλτράρετε αυτόματα ιστορικού γραμμές που ταιριάζουν με πολιτική διατήρησης πεπερασμένο, για να αποφύγετε αποτελέσματα απρόσμενα και χωρίς συνέπεια, επειδή παλαιών γραμμές μπορούν να διαγραφούν από την εργασία εκκαθάρισης, *σε οποιοδήποτε σημείο στο χρόνο και στο αυθαίρετο σειρά*.

Η παρακάτω εικόνα εμφανίζει το πρόγραμμα ερωτήματος για ενός απλού ερωτήματος:

````
SELECT * FROM dbo.WebsiteUserInfo FROM SYSTEM_TIME ALL;
````

Το πρόγραμμα ερωτήματος περιλαμβάνει επιπλέον φίλτρο στο τέλος της περιόδου στήλης (ValidTo) σε τον τελεστή "Ομαδοποιημένη σάρωση ευρετηρίου" στον πίνακα ιστορικού (επισημαίνεται). Αυτό το παράδειγμα προϋποθέτει που περίοδος διατήρησης 1 ΜΉΝΑΣ ορίστηκε WebsiteUserInfo πίνακα.

![Φίλτρο ερωτημάτων διατήρησης](./media/sql-database-temporal-tables-retention-policy/queryexecplanwithretention.png)

Ωστόσο, εάν κάνετε ερώτημα απευθείας σε πίνακα ιστορικού, ενδέχεται να μπορείτε να δείτε γραμμές που είναι παλαιότερα από διατήρησης καθορισμένο χρονικό διάστημα, αλλά χωρίς οποιαδήποτε εγγύηση για αποτελέσματα επαναλαμβανόμενο ερωτήματος. Η παρακάτω εικόνα εμφανίζει σχέδιο εκτέλεσης ερωτήματος για το ερώτημα στον πίνακα ιστορικού χωρίς επιπλέον φίλτρα που έχουν εφαρμοστεί:

![Υποβολή ερωτημάτων ιστορικού χωρίς φίλτρο διατήρησης](./media/sql-database-temporal-tables-retention-policy/queryexecplanhistorytable.png)

Βασίζεστε επιχειρηματικής λογικής στη ανάγνωσης πίνακα ιστορικού πέρα από περίοδος διατήρησης, όπως ενδέχεται να εμφανιστεί χωρίς συνέπεια ή μη αναμενόμενα αποτελέσματα. Συνιστάται να χρησιμοποιήσετε χρονικό ερωτημάτων με SYSTEM_TIME για τον όρο FROM για την ανάλυση δεδομένων σε πίνακες χρονικό.

##<a name="point-in-time-restore-considerations"></a>Τοποθετήστε το δείκτη στο χρόνο επαναφορά ζητήματα

Κατά τη δημιουργία νέας βάσης δεδομένων με [την επαναφορά υπάρχουσας βάσης δεδομένων σε ένα συγκεκριμένο χρονικό σημείο](sql-database-point-in-time-restore-portal.md), που έχει χρονικό διατήρησης απενεργοποιηθεί στο επίπεδο της βάσης δεδομένων. (**is_temporal_history_retention_enabled** σημαία τιμή ΑΝΕΝΕΡΓΌ). Αυτή η λειτουργία σάς επιτρέπει να εξετάσετε όλες τις γραμμές ιστορικού κατά την επαναφορά, χωρίς να ανησυχείτε ότι έχετε καταργήσει παλαιών γραμμές πριν λάβετε ερώτημα για τους. Μπορείτε να το χρησιμοποιήσετε για να *ελέγξετε δεδομένα ιστορικού πέρα από περίοδος διατήρησης έχει ρυθμιστεί*.

Υποθέσουμε ότι ένα χρονικό πίνακας έχει ένα ΜΉΝΑ διατήρησης περίοδο που καθορίστηκε. Εάν η βάση δεδομένων δημιουργήθηκε στο επίπεδο Premium υπηρεσιών, θα μπορείτε να δημιουργήσετε αντίγραφο της βάσης δεδομένων με την κατάσταση της βάσης δεδομένων προς τα επάνω για να 35 ημέρες πίσω στο παρελθόν. Που αποτελεσματική θα σάς επιτρέπουν να αναλύσετε ιστορικού γραμμές που βρίσκονται επάνω στο 65 ημερών από την υποβολή ερωτημάτων πίνακα ιστορικού για απευθείας.

Εάν θέλετε να ενεργοποιήσετε την εκκαθάριση χρονικό διατήρησης, εκτελέστε την ακόλουθη πρόταση Transact-SQL μετά το σημείο στο χρόνο επαναφοράς:

````
ALTER DATABASE <myDB>
SET TEMPORAL_HISTORY_RETENTION  ON
````

##<a name="next-steps"></a>Επόμενα βήματα

Για να μάθετε πώς να χρησιμοποιείτε το χρονικό πίνακες στις εφαρμογές σας δείτε [Γρήγορα αποτελέσματα με το χρονικό πίνακες σε βάση δεδομένων SQL Azure](sql-database-temporal-tables.md).

Επισκεφθείτε 9 καναλιού για να ακούσετε ένα [ιστορίας επιτυχίας πελατών πραγματικό χρονικό υλοποίηση](https://channel9.msdn.com/Blogs/jsturtevant/Azure-SQL-Temporal-Tables-with-RockStep-Solutions) και να παρακολουθήσετε ένα [πραγματικό χρονικό επίδειξης](https://channel9.msdn.com/Shows/Data-Exposed/Temporal-in-SQL-Server-2016).

Για λεπτομερείς πληροφορίες σχετικά με τους πίνακες χρονικό, αναθεωρήστε [MSDN τεκμηρίωση](https://msdn.microsoft.com/library/dn935015.aspx).
