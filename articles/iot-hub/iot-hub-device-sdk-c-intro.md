<properties
    pageTitle="Χρήση της συσκευής Azure IoT SDK για C | Microsoft Azure"
    description="Μάθετε περισσότερα σχετικά με και να ξεκινήσετε να εργάζεστε με το δείγμα κώδικα στη συσκευή Azure IoT SDK για C."
    services="iot-hub"
    documentationCenter=""
    authors="olivierbloch"
    manager="timlt"
    editor=""/>

<tags
     ms.service="iot-hub"
     ms.devlang="cpp"
     ms.topic="article"
     ms.tgt_pltfrm="na"
     ms.workload="na"
     ms.date="09/06/2016"
     ms.author="obloch"/>

# <a name="introducing-the-azure-iot-device-sdk-for-c"></a>Εισαγωγή στη συσκευή Azure IoT SDK για C

Η **συσκευή Azure IoT SDK** είναι ένα σύνολο των βιβλιοθηκών που έχει σχεδιαστεί για να απλοποιήσετε τη διαδικασία συμβάντων αποστολή και λήψη μηνυμάτων από την υπηρεσία **Azure IoT διανομέα** . Υπάρχουν διαφορετικές παραλλαγές του SDK, κάθε στόχευσης μια ειδική πλατφόρμα, αλλά αυτό το άρθρο περιγράφει τη **συσκευή Azure IoT SDK για C**.

Η συσκευή Azure IoT SDK για C είναι γραμμένο σε ANSI C (C99) για να μεγιστοποιήσετε τη δυνατότητα μεταφοράς. Με αυτόν τον τρόπο κατάλληλη για τη λειτουργία σε ορισμένες πλατφόρμες και συσκευές, ιδίως όταν Ελαχιστοποίηση δίσκου και αποτύπωμα μνήμης έχει προτεραιότητα.  

Υπάρχουν ένα ευρύ φάσμα πλατφόρμες στην οποία έχει ελεγχθεί στο SDK (ανατρέξτε στο θέμα το [Azure πιστοποιηθεί για τον κατάλογο συσκευή IoT](https://catalog.azureiotsuite.com/) για λεπτομέρειες). Αν και σε αυτό το άρθρο περιλαμβάνει αναλυτικές δείγμα κώδικα που εκτελείται σε πλατφόρμας των Windows, λάβετε υπόψη ότι ο κώδικας που περιγράφονται σε αυτό το άρθρο είναι ακριβώς ίδια κατά μήκος της περιοχής υποστηριζόμενες πλατφόρμες.

Σε αυτό το άρθρο που θα εισαχθούν στην αρχιτεκτονική της συσκευής Azure IoT SDK για C. Θα σας δείξουμε πώς μπορείτε να προετοιμασία της βιβλιοθήκης συσκευή, να στείλετε συμβάντα IoT διανομέα, καθώς και λαμβάνετε μηνύματα από αυτόν. Οι πληροφορίες σε αυτό το άρθρο θα πρέπει να είναι αρκετά για να ξεκινήσετε τη χρήση του SDK, αλλά παρέχει επίσης δείκτες για πρόσθετες πληροφορίες σχετικά με τις βιβλιοθήκες.

## <a name="sdk-architecture"></a>Αρχιτεκτονική SDK

Μπορείτε να βρείτε τη **συσκευή Azure IoT SDK για C** στο αποθετήριο δεδομένων [Microsoft Azure IoT SDK](https://github.com/Azure/azure-iot-sdks) GitHub και να προβάλετε λεπτομέρειες του API της [αναφοράς C API](http://azure.github.io/azure-iot-sdks/c/api_reference/index.html).

Μπορείτε να βρείτε την πιο πρόσφατη έκδοση των βιβλιοθηκών στον **κύριο** κλάδο της αυτό το αποθετήριο δεδομένων:

  ![](media/iot-hub-device-sdk-c-intro/01-MasterBranch.PNG)

Αυτό το αποθετήριο δεδομένων περιέχει ολόκληρη η οικογένεια της συσκευής Azure IoT SDK. Ωστόσο, αυτό το άρθρο είναι σχετικά με τη συσκευή Azure IoT SDK *για C* που μπορείτε να βρείτε στο φάκελο **c** .

  ![](media/iot-hub-device-sdk-c-intro/02-CFolder.PNG)

* Μπορείτε να βρείτε την εφαρμογή πυρήνα του SDK στην το **iothub\_προγράμματος-πελάτη** φάκελο που περιέχει την εφαρμογή του επιπέδου API μικρότερο στο SDK: στη βιβλιοθήκη **IoTHubClient** . Η βιβλιοθήκη **IoTHubClient** περιέχει API εφαρμογής ανεπεξέργαστα ανταλλαγής μηνυμάτων για αποστολή μηνυμάτων με IoT διανομέα, καθώς και να λαμβάνετε μηνύματα από αυτόν. Κατά τη χρήση αυτής της βιβλιοθήκης, είστε υπεύθυνοι για την εφαρμογή σειριοποίησης μήνυμα (τελικά χρησιμοποιώντας το δείγμα σειριοποιητής περιγράφεται παρακάτω), αλλά άλλες λεπτομέρειες επικοινωνεί με διανομέα IoT αντιμετωπίζονται για εσάς.
* Ο φάκελος **σειριοποιητής** περιέχει συναρτήσεις Βοήθειας και δείγματα που δείχνει τον τρόπο σειριοποίηση δεδομένων πριν από την αποστολή με χρήση της βιβλιοθήκης του προγράμματος-πελάτη το Azure IoT διανομέα. Σημειώστε ότι χρησιμοποιείτε το πρόγραμμα σειριοποίησης δεν είναι υποχρεωτικά και μόνο που παρέχεται για τη διευκόλυνσή. Εάν χρησιμοποιείτε τη βιβλιοθήκη **σειριοποιητής** , ξεκινάτε ορίζοντας ένα μοντέλο που καθορίζει τα συμβάντα που θέλετε να στείλετε IoT διανομέα, καθώς και τα μηνύματα που περιμένετε να λάβετε από το. Όταν έχει οριστεί στο μοντέλο, το SDK σάς παρέχει μια επιφάνεια API που σας επιτρέπει να διευκόλυνση εργασιών με συμβάντα και τα μηνύματα, χωρίς να χρειάζεται να ανησυχείτε σχετικά με τις λεπτομέρειες σειριοποίησης.
Η βιβλιοθήκη εξαρτάται από άλλες βιβλιοθήκες Άνοιγμα αρχείου προέλευσης που υλοποίηση μεταφοράς χρησιμοποιώντας διάφορες πρωτόκολλα (MQTT, AMQP).
* Η βιβλιοθήκη **IoTHubClient** εξαρτάται από άλλες βιβλιοθήκες Άνοιγμα αρχείου προέλευσης:
   * Στη βιβλιοθήκη [Azure C θέσει σε κοινή χρήση βοηθητικού προγράμματος](https://github.com/Azure/azure-c-shared-utility) που παρέχει κοινές λειτουργίες για βασικές εργασίες (όπως συμβολοσειρά, λίστα χειρισμού, εισόδου/ΕΞΌΔΟΥ, κ.λπ...) είναι απαραίτητο σε διάφορες SDK C που σχετίζονται με το Azure
   * Η βιβλιοθήκη [Azure uAMQP](https://github.com/Azure/azure-uamqp-c) που είναι υλοποίηση πλευρά του προγράμματος-πελάτη του AMQP βελτιστοποιημένη για συσκευές περιορισμού πόρων.
   * Στη βιβλιοθήκη [Azure uMQTT](https://github.com/Azure/azure-umqtt-c) που είναι μια βιβλιοθήκη γενικής χρήσης εφαρμογής το πρωτόκολλο MQTT και βελτιστοποιημένη για συσκευές περιορισμού πόρων.

Όλα τα παρακάτω είναι πιο κατανοητό, εξετάζοντας παράδειγμα κώδικα. Οι παρακάτω ενότητες καθοδηγήσουμε μερικά τα δείγματα εφαρμογών που περιλαμβάνονται στο SDK. Αυτό θα πρέπει να σας δώσει μια καλή αίσθηση για τις διάφορες δυνατότητες τα επίπεδα αρχιτεκτονικής του SDK, καθώς και μια εισαγωγή σχετικά με τον τρόπο που λειτουργούν τα API.

## <a name="before-running-the-samples"></a>Πριν από την εκτέλεση των δειγμάτων

Για να εκτελέσετε τα δείγματα στη συσκευή Azure IoT SDK για C πρέπει να δημιουργήσετε μια παρουσία της υπηρεσίας στη συνδρομή σας στο Azure εάν έχετε ήδη δεν έχει ένα και να ολοκληρώσετε τις εργασίες 2:
* προετοιμάσετε το περιβάλλον ανάπτυξης
* Αποκτήστε τα διαπιστευτήρια συσκευή.

Εάν χρειάζεστε για να δημιουργήσετε μια παρουσία του Azure IoT διανομέα στη συνδρομή σας στο Azure, ακολουθήστε τις οδηγίες [εδώ](https://github.com/Azure/azure-iot-sdks/blob/master/doc/setup_iothub.md).

Το [αρχείο readme που](https://github.com/Azure/azure-iot-sdks/tree/master/c) περιλαμβάνεται στο SDK παρέχει οδηγίες για την προετοιμασία περιβάλλον ανάπτυξής σας και αποκτήσετε διαπιστευτήρια συσκευή.
Οι παρακάτω ενότητες περιλαμβάνουν ορισμένες επιπλέον σχόλια σχετικά με αυτές τις οδηγίες.

### <a name="preparing-your-development-environment"></a>Προετοιμασία του περιβάλλοντός σας ανάπτυξης

Ενώ πακέτων παρέχονται για ορισμένες πλατφόρμες (όπως NuGet για Windows ή apt_get για Debian και Ubuntu) και τα δείγματα χρησιμοποιήσετε αυτά τα πακέτα όταν είναι διαθέσιμες, το παρακάτω οδηγίες με λεπτομέρειες τον τρόπο για να δημιουργήσετε τη βιβλιοθήκη και τα δείγματα φορμών απευθείας τον κώδικα.

Πρώτα, θα πρέπει να αποκτήσετε ένα αντίγραφο του SDK από GitHub και, στη συνέχεια, δημιουργήστε την προέλευση. Θα πρέπει να λάβετε ένα αντίγραφο του αρχείου προέλευσης από την **κύρια** κλάδο του [αποθετηρίου GitHub](https://github.com/Azure/azure-iot-sdks).

Όταν έχετε λάβει ένα αντίγραφο του αρχείου προέλευσης, πρέπει να ολοκληρώσετε τα βήματα που περιγράφονται στο άρθρο SDK ["Προετοιμασία περιβάλλον ανάπτυξής σας"](https://github.com/Azure/azure-iot-sdks/blob/master/c/doc/devbox_setup.md).


Ακολουθούν μερικές συμβουλές που θα σας βοηθήσει να ολοκληρώσετε τη διαδικασία που περιγράφεται στον Οδηγό προετοιμασίας:

-   Όταν εγκαθιστάτε το βοηθητικό πρόγραμμα **CMake** , ορίστε την επιλογή για να προσθέσετε **CMake** στο σύστημα ΔΙΑΔΡΟΜΉ για **όλους τους χρήστες** (Προσθήκη καθώς και λειτουργεί **τον τρέχοντα χρήστη** ):

  ![](media/iot-hub-device-sdk-c-intro/08-CMake.PNG)


-   Πριν να ανοίξετε τη **γραμμή εντολών για προγραμματιστές για VS2015**, εγκαταστήστε τα εργαλεία της γραμμής εντολών Git. Για να εγκαταστήσετε αυτά τα εργαλεία, ολοκληρώστε τα ακόλουθα βήματα:

    1. Εκκινήστε το πρόγραμμα εγκατάστασης του **Visual Studio 2015** (ή επιλέξτε **Microsoft Visual Studio 2015** από τα **προγράμματα και δυνατότητες** του πίνακα ελέγχου και επιλέξτε **Αλλαγή**).
    
    2. Βεβαιωθείτε ότι είναι επιλεγμένο το πλαίσιο **Git για Windows** στο πρόγραμμα εγκατάστασης, αλλά μπορεί επίσης να θέλετε να ενεργοποιήσετε την επιλογή **GitHub επέκταση για το Visual Studio** για την παροχή ενοποίησης IDE:

        ![](media/iot-hub-device-sdk-c-intro/10-GitTools.PNG)

    3. Ολοκληρώστε τον Οδηγό εγκατάστασης για να εγκαταστήσετε τα εργαλεία.

    4. Προσθέστε τον κατάλογο Git εργαλεία **Ανακύκλωσης** μεταβλητή περιβάλλοντος **PATH** του συστήματος. Στα Windows, αυτό είναι κάπως τα εξής:

        ![](media/iot-hub-device-sdk-c-intro/11-GitToolsPath.PNG)


Όταν έχετε ολοκληρώσει όλα τα βήματα που περιγράφονται στη σελίδα ["Προετοιμασία περιβάλλον ανάπτυξής σας"](https://github.com/Azure/azure-iot-sdks/blob/master/c/doc/devbox_setup.md) , είστε έτοιμοι για να μεταγλωττίσετε τα δείγματα εφαρμογών.

### <a name="obtaining-device-credentials"></a>Απόκτηση διαπιστευτήρια συσκευή

Περιβάλλον ανάπτυξής σας έχει ρυθμιστεί, το επόμενο πράγμα που πρέπει να κάνετε είναι να λάβετε ένα σύνολο διαπιστευτηρίων συσκευή.  Για να έχετε τη δυνατότητα να αποκτήσετε πρόσβαση σε μια ενότητα IoT μια συσκευή, πρέπει πρώτα να προσθέσετε τη συσκευή στο μητρώο συσκευή IoT διανομέα. Όταν προσθέτετε τη συσκευή σας θα λάβετε ένα σύνολο διαπιστευτηρίων συσκευή που θα χρειαστείτε για τη συσκευή για να μπορέσετε να συνδεθείτε με ένα διανομέα IoT. Τα δείγματα εφαρμογών που θα εξετάσουμε στην επόμενη ενότητα θεωρείτε ότι αυτά τα διαπιστευτήρια με τη μορφή της **συσκευής συμβολοσειρά σύνδεσης**.

Υπάρχουν μερικά εργαλεία που παρέχονται στο αποθετήριο SDK Άνοιγμα αρχείου προέλευσης για να τη Διαχείριση ενότητα IoT. Ένα είναι μια εφαρμογή ονομάζεται Explorer συσκευής, στο δεύτερο παράδειγμα είναι μια node.js βάσει εργαλείο CLI διασταύρωσης πλατφόρμα που ονομάζεται iothub Εξερεύνηση των Windows. Μπορείτε να μάθετε περισσότερα σχετικά με αυτά τα εργαλεία [εδώ](https://github.com/Azure/azure-iot-sdks/blob/master/doc/manage_iot_hub.md).

Όπως θα μέσω εκτελούνται τα δείγματα των Windows σε αυτό το άρθρο, χρησιμοποιούμε το εργαλείο Explorer συσκευή. Αλλά μπορείτε επίσης να χρησιμοποιήσετε iothub explorer Εάν προτιμάτε CLI εργαλεία.

Το εργαλείο [Explorer συσκευή](https://github.com/Azure/azure-iot-sdks/tree/master/tools/DeviceExplorer) χρησιμοποιεί τις βιβλιοθήκες Azure IoT υπηρεσίας για να εκτελέσετε διάφορες λειτουργίες στην ενότητα IoT, συμπεριλαμβανομένης της προσθήκης συσκευές. Εάν χρησιμοποιείτε συσκευή Explorer για να προσθέσετε μια συσκευή, θα λάβετε μια αντίστοιχη συμβολοσειρά σύνδεσης. Χρειάζεστε αυτήν τη συμβολοσειρά σύνδεσης για να κάνετε το δείγμα εφαρμογές εκτελούνται.

Σε περίπτωση που δεν είστε ήδη εξοικειωμένοι με τη διαδικασία, η παρακάτω διαδικασία περιγράφει πώς μπορείτε να χρησιμοποιήσετε συσκευή Explorer για να προσθέσετε μια συσκευή και να αποκτήσετε μια συμβολοσειρά σύνδεσης συσκευή.

Μπορείτε να βρείτε μια του Windows installer για το εργαλείο Explorer συσκευή στην το [SDK αφήστε σελίδας](https://github.com/Azure/azure-iot-sdks/releases). Αλλά μπορείτε επίσης να εκτελέσετε το εργαλείο απευθείας από τον κώδικά Άνοιγμα **[DeviceExplorer.sln](https://github.com/Azure/azure-iot-sdks/blob/master/tools/DeviceExplorer/DeviceExplorer.sln)** στο **Visual Studio 2015** και τη δημιουργία της λύσης.

Όταν εκτελείτε το πρόγραμμα θα δείτε αυτό το περιβάλλον εργασίας:

  ![](media/iot-hub-device-sdk-c-intro/03-DeviceExplorer.PNG)

Πληκτρολογήστε τη **Συμβολοσειρά σύνδεσης διανομέα IoT** στο πρώτο πεδίο και κάντε κλικ στην επιλογή **Ενημέρωση**. Αυτό ρυθμίζει τις παραμέτρους του εργαλείου, ώστε να μπορεί να επικοινωνήσει με IoT διανομέα.

Όταν έχει ρυθμιστεί η συμβολοσειρά σύνδεσης διανομέα IoT κάντε κλικ στην καρτέλα **διαχείρισης** :

  ![](media/iot-hub-device-sdk-c-intro/04-ManagementTab.PNG)

Αυτό είναι όπου θα μπορείτε να διαχειριστείτε τις συσκευές που έχουν καταχωρηθεί στο κέντρο IoT σας.

Μπορείτε να δημιουργήσετε μια συσκευή, κάνοντας κλικ στο κουμπί **Δημιουργία** . Εμφανίζεται ένα παράθυρο διαλόγου με ένα σύνολο εκ των προτέρων συμπληρωμένες κλειδιών (κύριας και δευτερεύουσας). Μόνο που έχετε να κάνετε είναι να εισαγάγετε ένα **Αναγνωριστικό συσκευής** και, στη συνέχεια, κάντε κλικ στην επιλογή **Δημιουργία**.

  ![](media/iot-hub-device-sdk-c-intro/05-CreateDevice.PNG)

Όταν δημιουργηθεί η συσκευή, η λίστα συσκευές ενημερώνεται με όλες τις συσκευές καταχωρημένες, όπως μια που μόλις δημιουργήσατε. Εάν κάνετε δεξιό κλικ σε νέα σας συσκευή, θα δείτε αυτό το μενού:

  ![](media/iot-hub-device-sdk-c-intro/06-RightClickDevice.PNG)

Εάν επιλέξετε την επιλογή **Αντιγράψτε συμβολοσειρά σύνδεσης για την επιλεγμένη συσκευή** , τη συμβολοσειρά σύνδεσης για τη συσκευή σας αντιγράφεται στο Πρόχειρο. Διατηρήστε ένα αντίγραφο της συμβολοσειράς σύνδεσης. Θα χρειαστεί το κατά την εκτέλεση των υποδειγμάτων εφαρμογών που περιγράφεται στις επόμενες ενότητες.

Όταν έχετε ολοκληρώσει τα παραπάνω βήματα, είστε έτοιμοι να ξεκινήσετε την εκτέλεση ορισμένες κώδικα. Δείγματα και τα δύο έχουν μια σταθερά στο επάνω μέρος του αρχείου προέλευσης κύριο που σας επιτρέπει να εισαγάγετε μια συμβολοσειρά σύνδεσης. Για παράδειγμα, η αντίστοιχη γραμμή από το **iothub\_προγράμματος-πελάτη\_δείγμα\_amqp** εφαρμογής εμφανίζεται ως εξής.

```
static const char* connectionString = "[device connection string]";
```

Εάν θέλετε να παρακολουθήσετε κατά μήκος, πληκτρολογήστε τη συμβολοσειρά σύνδεσης συσκευή εδώ μεταγλωττίσετε ξανά τη λύση και θα έχετε τη δυνατότητα να εκτελέσετε το δείγμα.

## <a name="iothubclient"></a>IoTHubClient

Εντός του **iothub\_προγράμματος-πελάτη** φακέλου στο αποθετήριο azure-iot-sdks, υπάρχει ένας φάκελος **δείγματα** που περιέχει μια εφαρμογή που ονομάζεται **iothub\_προγράμματος-πελάτη\_δείγμα\_amqp**.

Την έκδοση των Windows από το **iothub\_προγράμματος-πελάτη\_δείγμα\_ampq** εφαρμογή περιλαμβάνει τα παρακάτω λύση Visual Studio:

  ![](media/iot-hub-device-sdk-c-intro/12-iothub-client-sample-amqp.PNG)

Αυτή η λύση περιέχει ένα έργο. Είναι αξίζει να αναφερθούν ότι υπάρχουν τέσσερις NuGet πακέτων εγκατασταθεί σε αυτήν τη λύση:

- Microsoft.Azure.C.SharedUtility
- Microsoft.Azure.IoTHub.AmqpTransport
- Microsoft.Azure.IoTHub.IoTHubClient
- Microsoft.Azure.uamqp

Το πακέτο **Microsoft.Azure.C.SharedUtility** πρέπει πάντα όταν εργάζεστε με το SDK. Επειδή αυτό το δείγμα βασίζεται σε AMQP, πρέπει να συμπεριλάβετε τα πακέτα **Microsoft.Azure.uamqp** και **Microsoft.Azure.IoTHub.AmqpTransport** (υπάρχουν ισοδύναμη πακέτα για MQTT και HTTP). Επειδή το παράδειγμα χρησιμοποιεί τη βιβλιοθήκη **IoTHubClient** , πρέπει επίσης να συμπεριλάβετε το πακέτο **Microsoft.Azure.IoTHub.IoTHubClient** στη λύση σας.

Μπορείτε να βρείτε την εφαρμογή για το δείγμα εφαρμογής στο το **iothub\_προγράμματος-πελάτη\_δείγμα\_amqp.c** αρχείο προέλευσης.

Θα χρησιμοποιήσουμε αυτού του δείγματος εφαρμογής για να σας καθοδηγήσει τι είναι απαραίτητη για να χρησιμοποιήσετε τη βιβλιοθήκη **IoTHubClient** .

### <a name="initializing-the-library"></a>Προετοιμασία της βιβλιοθήκης

> [AZURE.NOTE] Πριν ξεκινήσετε να εργάζεστε με τις βιβλιοθήκες, ίσως χρειαστεί να εκτελέσετε κάποια συγκεκριμένη προετοιμασίας πλατφόρμας. Για παράδειγμα, εάν σκοπεύετε να χρησιμοποιήσετε AMQP σε Linux πρέπει να προετοιμάσετε στη βιβλιοθήκη OpenSSL. Τα δείγματα στο [αποθετήριο δεδομένων GitHub](https://github.com/Azure/azure-iot-sdks) κλήση τη συνάρτηση βοηθητικού προγράμματος **platform_init** όταν ο υπολογιστής-πελάτης ξεκινά και να καλέσετε τη συνάρτηση **platform_deinit** πριν από την έξοδο. Αυτές οι συναρτήσεις έχουν δηλωθεί σε αρχείο κεφαλίδας "platform.h". Πρέπει να εξετάσετε των ορισμών από αυτές τις συναρτήσεις για την πλατφόρμα σας προορισμού στο [αποθετήριο δεδομένων](https://github.com/Azure/azure-iot-sdks) για να καθορίσετε εάν θέλετε να συμπεριλάβετε οποιονδήποτε κωδικό προετοιμασίας πλατφόρμα στο πρόγραμμα-πελάτη.

Για να ξεκινήσετε να εργάζεστε με τις βιβλιοθήκες πρώτα πρέπει να δεσμεύσετε μια λαβή διανομέα IoT προγράμματος-πελάτη:

```
IOTHUB_CLIENT_HANDLE iotHubClientHandle;
iotHubClientHandle = IoTHubClient_CreateFromConnectionString(connectionString, AMQP_Protocol);
```

Σημειώστε ότι θα σας περνάτε ένα αντίγραφο του μας συσκευή συμβολοσειρά σύνδεσης σε αυτήν τη συνάρτηση (αυτήν που θα σας που λαμβάνονται από την Εξερεύνηση των συσκευών). Επίσης, θα σας να ορίσετε το πρωτόκολλο που θέλετε να χρησιμοποιήσετε. Αυτό το παράδειγμα χρησιμοποιεί AMQP, αλλά MQTT και HTTP είναι επίσης μια επιλογή.

Όταν έχετε μια έγκυρη **IOTHUB\_προγράμματος-ΠΕΛΆΤΗ\_ΧΕΙΡΙΣΜΟΎ**, μπορείτε να ξεκινήσετε την κλήση του API για συμβάντα αποστολή και λήψη μηνυμάτων από διανομέα IoT. Θα εξετάσουμε που Επόμενο.

### <a name="sending-events"></a>Αποστολή συμβάντων

Αποστολή συμβάντων σε διανομέα IoT απαιτεί να ολοκληρώσετε τα παρακάτω βήματα:

Πρώτα, δημιουργήστε ένα μήνυμα:

```
EVENT_INSTANCE message;
sprintf_s(msgText, sizeof(msgText), "Message_%d_From_IoTHubClient_Over_AMQP", i);
message.messageHandle = IoTHubMessage_CreateFromByteArray((const unsigned char*)msgText, strlen(msgText);
```

Στη συνέχεια, στείλτε το μήνυμα:

```
IoTHubClient_SendEventAsync(iotHubClientHandle, message.messageHandle, SendConfirmationCallback, &message);
```

Κάθε φορά που στέλνετε ένα μήνυμα, μπορείτε να καθορίσετε μια αναφορά σε μια συνάρτηση επιστροφής κλήσης που ενεργοποιείται όταν τα δεδομένα αποστέλλονται:

```
static void SendConfirmationCallback(IOTHUB_CLIENT_CONFIRMATION_RESULT result, void* userContextCallback)
{
    EVENT_INSTANCE* eventInstance = (EVENT_INSTANCE*)userContextCallback;
    (void)printf("Confirmation[%d] received for message tracking id = %d with result = %s\r\n", callbackCounter, eventInstance->messageTrackingId, ENUM_TO_STRING(IOTHUB_CLIENT_CONFIRMATION_RESULT, result));
    /* Some device specific action code goes here... */
    callbackCounter++;
    IoTHubMessage_Destroy(eventInstance->messageHandle);
}
```

Σημειώστε την κλήση του **IoTHubMessage\_καταστροφής** λειτουργίας, όταν ολοκληρώσετε την εργασία με το μήνυμα. Πρέπει να κάνετε αυτήν την κλήση για να ελευθερωθεί των πόρων που διατίθενται όταν δημιουργήσατε το μήνυμα.

### <a name="receiving-messages"></a>Λήψη μηνυμάτων

Λαμβάνετε ένα μήνυμα είναι μια ασύγχρονη λειτουργία. Πρώτα, μπορείτε να καταχωρήσετε μια επιστροφή κλήσης για να είναι δυνατή όταν η συσκευή λάβει ένα μήνυμα:

```
int receiveContext = 0;
IoTHubClient_SetMessageCallback(iotHubClientHandle, ReceiveMessageCallback, &receiveContext);
```

Η τελευταία παράμετρος είναι ένας δείκτης void για ό, τι θέλετε. Στο δείγμα, είναι ένας δείκτης προς έναν ακέραιο αλλά μπορεί να είναι ένα δείκτη σε μια πιο σύνθετη δομή δεδομένων. Αυτή η δυνατότητα επιτρέπει τη συνάρτηση επιστροφής κλήσης για να λειτουργεί σε κατάστασης κοινής χρήσης με τον καλούντα αυτής της συνάρτησης.

Όταν η συσκευή λάβει ένα μήνυμα, η συνάρτηση καταχωρημένες επιστροφής κλήσης ενεργοποιείται:

```
static IOTHUBMESSAGE_DISPOSITION_RESULT ReceiveMessageCallback(IOTHUB_MESSAGE_HANDLE message, void* userContextCallback)
{
    int* counter = (int*)userContextCallback;
    const char* buffer;
    size_t size;
    if (IoTHubMessage_GetByteArray(message, (const unsigned char**)&buffer, &size) == IOTHUB_MESSAGE_OK)
    {
        (void)printf("Received Message [%d] with Data: <<<%.*s>>> & Size=%d\r\n", *counter, (int)size, buffer, (int)size);
    }

    /* Some device specific action code goes here... */
    (*counter)++;
    return IOTHUBMESSAGE_ACCEPTED;
}
```

Σημειώστε ότι μπορείτε να χρησιμοποιήσετε το **IoTHubMessage\_GetByteArray** συνάρτηση για να ανακτήσετε το μήνυμα, το οποίο σε αυτό το παράδειγμα είναι μια συμβολοσειρά.

### <a name="uninitializing-the-library"></a>Κατάργηση προετοιμασίας στη βιβλιοθήκη

Όταν ολοκληρώσετε τη διαδικασία συμβάντων αποστολή και λήψη μηνυμάτων, μπορείτε να αναίρεσης προετοιμασίας στη βιβλιοθήκη IoT. Για να το κάνετε, ζητήματος η ακόλουθη συνάρτηση κλήση:

```
IoTHubClient_Destroy(iotHubClientHandle);
```

Αυτό ελευθερώνει τους πόρους που έχουν εκχωρηθεί προηγουμένως από το **IoTHubClient\_CreateFromConnectionString** συνάρτηση.

Όπως μπορείτε να δείτε, είναι εύκολο να συμβάντα αποστολή και λήψη μηνυμάτων με τη βιβλιοθήκη **IoTHubClient** . Η βιβλιοθήκη χειρίζεται τις λεπτομέρειες της επικοινωνίας με το διανομέα IoT, όπως το πρωτόκολλο που να χρησιμοποιήσετε (από την προοπτική από τον προγραμματιστή, αυτή είναι μια απλή ρύθμισης παραμέτρων επιλογή).

Η βιβλιοθήκη **IoTHubClient** παρέχει επίσης ακριβή έλεγχο του πώς μπορείτε να τα συμβάντα σας συσκευή στέλνει IoT διανομέα σειριοποίηση. Σε ορισμένες περιπτώσεις, αυτό είναι ένα πλεονέκτημα, αλλά σε άλλες περιπτώσεις αυτή είναι μια λεπτομέρεια εφαρμογής με τα οποία δεν θέλετε να ενδιαφέρονται. Εάν πρόκειται για την περίπτωση, μπορείτε να χρησιμοποιήσετε τη βιβλιοθήκη **σειριοποιητής** , το οποίο θα περιγραφή στην επόμενη ενότητα.

## <a name="serializer"></a>Πρόγραμμα σειριοποίησης

Εννοιολογικά στη βιβλιοθήκη **σειριοποιητής** βρίσκεται επάνω από τη βιβλιοθήκη **IoTHubClient** στο SDK. Χρησιμοποιεί τη βιβλιοθήκη **IoTHubClient** για τα υποκείμενα επικοινωνία με IoT διανομέα, αλλά προσθέτει δυνατότητες μοντελοποίησης κατάργησης το βάρος της αντιμετώπιση σειριοποίησης μήνυμα από τον προγραμματιστή της. Πώς λειτουργεί αυτό βιβλιοθήκη είναι η καλύτερη επιδεικνύεται από ένα παράδειγμα.

Μέσα σε ο **σειριοποιητής** φακέλου στο αποθετήριο azure-iot-sdks είναι ένας φάκελος **δείγματα** που περιέχει μια εφαρμογή που ονομάζεται **simplesample\_amqp**. Η έκδοση Windows αυτού του δείγματος περιλαμβάνει τα παρακάτω λύση Visual Studio:

  ![](media/iot-hub-device-sdk-c-intro/14-simplesample_amqp.PNG)

Όπως και με το προηγούμενο δείγμα, αυτό μία περιλαμβάνει πολλές NuGet πακέτων:

- Microsoft.Azure.C.SharedUtility
- Microsoft.Azure.IoTHub.AmqpTransport
- Microsoft.Azure.IoTHub.IoTHubClient
- Microsoft.Azure.IoTHub.Serializer
- Microsoft.Azure.uamqp

Θα σας έχετε δει περισσότερες από αυτές τις στο προηγούμενο δείγμα, αλλά **Microsoft.Azure.IoTHub.Serializer** είναι νέα. Αυτό είναι απαραίτητο όταν χρησιμοποιούμε τη βιβλιοθήκη **σειριοποιητής** .

Μπορείτε να βρείτε την εφαρμογή από το δείγμα εφαρμογής στο το **simplesample\_amqp.c** αρχείου.

Οι παρακάτω ενότητες καθοδηγήσουμε τα βασικά τμήματα αυτού του δείγματος.

### <a name="initializing-the-library"></a>Προετοιμασία της βιβλιοθήκης

Για να ξεκινήσετε να εργάζεστε με τη βιβλιοθήκη **σειριοποιητής** , πρέπει να καλέσετε την προετοιμασία APIs:

```
serializer_init(NULL);

IOTHUB_CLIENT_HANDLE iotHubClientHandle = IoTHubClient_CreateFromConnectionString(connectionString, AMQP_Protocol);

ContosoAnemometer* myWeather = CREATE_MODEL_INSTANCE(WeatherStation, ContosoAnemometer);
```

Την κλήση του **σειριοποιητής\_προετοιμασία** λειτουργία είναι μια μεμονωμένη κλήση και χρησιμοποιείται για την προετοιμασία της υποκείμενης βιβλιοθήκης. Στη συνέχεια, καλέστε την **IoTHubClient\_CreateFromConnectionString** συνάρτηση, η οποία είναι το ίδιο API όπως στο δείγμα **IoTHubClient** . Αυτή η κλήση ορίζει τη συμβολοσειρά σύνδεσης σας συσκευή (αυτό είναι επίσης όπου μπορείτε να επιλέξετε το πρωτόκολλο που θέλετε να χρησιμοποιήσετε). Σημειώστε ότι αυτό το δείγμα χρησιμοποιεί AMQP ως τη μεταφορά, αλλά ενδέχεται να έχετε χρησιμοποιήσει HTTP.

Τέλος, καλέστε την **ΔΗΜΙΟΥΡΓΊΑ\_ΜΟΝΤΈΛΟ\_ΠΑΡΟΥΣΊΑ** συνάρτηση. Σημειώστε ότι **WeatherStation** είναι το χώρο ονομάτων του μοντέλου και **ContosoAnemometer** είναι το όνομα του μοντέλου. Όταν δημιουργηθεί η παρουσία μοντέλο, μπορείτε να το χρησιμοποιήσετε για να ξεκινήσετε συμβάντα αποστολή και λήψη μηνυμάτων. Ωστόσο, είναι σημαντικό να κατανοήσετε τι μοντέλου είναι.

### <a name="defining-the-model"></a>Καθορίζει το μοντέλο

Ένα μοντέλο στη βιβλιοθήκη **σειριοποιητής** ορίζει τα συμβάντα που μπορεί να στείλει τη συσκευή σας IoT διανομέα και τα μηνύματα, που ονομάζεται *Ενέργειες* στη γλώσσα μοντελοποίησης, που να κάνει λήψη. Μπορείτε να καθορίσετε ένα μοντέλο χρησιμοποιώντας ένα σύνολο C μακροεντολών ως σε το **simplesample\_amqp** δείγμα εφαρμογής:

```
BEGIN_NAMESPACE(WeatherStation);

DECLARE_MODEL(ContosoAnemometer,
WITH_DATA(ascii_char_ptr, DeviceId),
WITH_DATA(double, WindSpeed),
WITH_ACTION(TurnFanOn),
WITH_ACTION(TurnFanOff),
WITH_ACTION(SetAirResistance, int, Position)
);

END_NAMESPACE(WeatherStation);
```

Το **ΞΕΚΙΝΟΎΝ\_χώρο ΟΝΟΜΆΤΩΝ** και **ΤΈΛΟΣ\_χώρο ΟΝΟΜΆΤΩΝ** μακροεντολές και οι δύο λαμβάνει το χώρο ονομάτων του μοντέλου ως όρισμα. Αναμένεται ότι όλα τα στοιχεία μεταξύ αυτών των μακροεντολών είναι τον ορισμό των σας μοντέλα και τις δομές δεδομένων που χρησιμοποιούν τα μοντέλα.

Σε αυτό το παράδειγμα, υπάρχει ένα μόνο μοντέλο που ονομάζεται **ContosoAnemometer**. Αυτό το μοντέλο καθορίζει δύο συμβάντα που μπορεί να στείλει τη συσκευή σας με διανομέα IoT: **DeviceId** και **ταχύτητα ανέμου**. Καθορίζει επίσης τρεις ενέργειες (μηνύματα) που μπορεί να λάβει τη συσκευή σας: **TurnFanOn**, **TurnFanOff**και **SetAirResistance**. Κάθε συμβάντος έχει έναν τύπο και κάθε ενέργεια έχει ένα όνομα (και προαιρετικά ένα σύνολο παραμέτρων).

Τα συμβάντα και ενέργειες που ορίζονται στο μοντέλο Ορισμός μια επιφάνεια API που μπορείτε να χρησιμοποιήσετε για να στείλετε συμβάντα IoT διανομέα, καθώς και να απαντούν σε μηνύματα που αποστέλλονται στη συσκευή. Αυτό είναι κατανοητή καλύτερα μέσω ένα παράδειγμα.

### <a name="sending-events"></a>Αποστολή συμβάντων

Το μοντέλο ορίζει τα συμβάντα που μπορείτε να στείλετε σε διανομέα IoT. Σε αυτό το παράδειγμα, αυτό σημαίνει ότι ένα από τα δύο συμβάντα που ορίζονται από το χρησιμοποιώντας τη μακροεντολή **WITH_DATA** . Για παράδειγμα, εάν θέλετε να στείλετε ένα συμβάν **ταχύτητα ανέμου** με ένα διανομέα IoT, υπάρχουν ορισμένα βήματα που εμπλέκονται στην αυτό συμβεί. Το πρώτο είναι για να ορίσετε τα δεδομένα που θέλετε να στείλετε:

```
myWeather->WindSpeed = 15;
```

Το μοντέλο ορίσαμε παλαιότερη έκδοση σάς επιτρέπει να το κάνετε αυτό, ορίζοντας ένα μέλος από μια **δομή**. Στη συνέχεια, σειριοποίηση το συμβάν που θέλετε να στείλετε:

```
unsigned char* destination;
size_t destinationSize;

SERIALIZE(&destination, &destinationSize, myWeather->WindSpeed);
```

Αυτός ο κωδικός τοποθετεί σειριακά το συμβάν σε ένα buffer (στα οποία γίνεται αναφορά από **προορισμό**). Τέλος, θα σας στείλουμε το συμβάν σε διανομέα IoT με αυτόν τον κώδικα:

```
sendMessage(iotHubClientHandle, destination, destinationSize);
```

Αυτή είναι μια συνάρτηση Βοήθειας στην εφαρμογή του δείγματος που στέλνει μας αλληλουχίας συμβάντος σε διανομέα IoT:

```
static void sendMessage(IOTHUB_CLIENT_HANDLE iotHubClientHandle, const unsigned char* buffer, size_t size)
{
    static unsigned int messageTrackingId;
    IOTHUB_MESSAGE_HANDLE messageHandle = IoTHubMessage_CreateFromByteArray(buffer, size);
    if (messageHandle != NULL)
    {
        if (IoTHubClient_SendEventAsync(iotHubClientHandle, messageHandle, sendCallback, (void*)(uintptr_t)messageTrackingId) != IOTHUB_CLIENT_OK)
        {
            printf("failed to hand over the message to IoTHubClient");
        }
        else
        {
            printf("IoTHubClient accepted the message for delivery\r\n");
        }

        IoTHubMessage_Destroy(messageHandle);
    }
    free((void*)buffer);
    messageTrackingId++;
}
```

Αυτός ο κώδικας είναι παρόμοια με τι θα σας περιγράφηκε στην το **iothub\_προγράμματος-πελάτη\_δείγμα\_amqp** εφαρμογή, στην οποία θα σας δημιουργήσει ένα μήνυμα από ένα πίνακα byte και, στη συνέχεια, χρησιμοποιούνται **IoTHubClient\_SendEventAsync** για να το στείλετε σε διανομέα IoT. Μετά από αυτό θα σας μόλις πρέπει να ελευθερωθεί τη λαβή μήνυμα και σειριοποιηθεί buffer δεδομένων που θα σας έχει εκχωρηθεί προηγουμένως.

Η δεύτερη τελευταία παράμετρο της **IoTHubClient\_SendEventAsync** είναι μια αναφορά σε μια συνάρτηση επιστροφής κλήσης που ονομάζεται όταν τα δεδομένα αποστέλλονται με επιτυχία. Ακολουθεί ένα παράδειγμα μιας συνάρτησης επιστροφής κλήσης:

```
void sendCallback(IOTHUB_CLIENT_CONFIRMATION_RESULT result, void* userContextCallback)
{
    int messageTrackingId = (intptr_t)userContextCallback;

    (void)printf("Message Id: %d Received.\r\n", messageTrackingId);

    (void)printf("Result Call Back Called! Result is: %s \r\n", ENUM_TO_STRING(IOTHUB_CLIENT_CONFIRMATION_RESULT, result));
}
```

Η δεύτερη παράμετρος είναι ένας δείκτης σε περιβάλλον χρήστη; το ίδιο δείκτη που θα σας που του μεταβιβάστηκε **IoTHubClient\_SendEventAsync**. Σε αυτήν την περίπτωση το περιβάλλον είναι μια απλή μετρητή, αλλά μπορεί να είναι οτιδήποτε που θέλετε.

Που είναι όλα υπάρχει με την αποστολή συμβάντα. Το μόνο προς τα αριστερά για να καλύψετε είναι πώς μπορείτε να λαμβάνετε μηνύματα.

### <a name="receiving-messages"></a>Λήψη μηνυμάτων

Λαμβάνετε ένα μήνυμα που λειτουργεί κατά τον ίδιο τρόπο για την εμφάνιση των μηνυμάτων εργασία στη βιβλιοθήκη **IoTHubClient** . Πρώτα, μπορείτε να καταχωρήσετε μια συνάρτηση επιστροφής κλήσης μήνυμα:

```
IoTHubClient_SetMessageCallback(iotHubClientHandle, IoTHubMessage, myWeather)
```

Στη συνέχεια, μπορείτε να συντάξετε τη συνάρτηση επιστροφής κλήσης που ενεργοποιείται όταν λαμβάνετε ένα μήνυμα:

```
static IOTHUBMESSAGE_DISPOSITION_RESULT IoTHubMessage(IOTHUB_MESSAGE_HANDLE message, void* userContextCallback)
{
    IOTHUBMESSAGE_DISPOSITION_RESULT result;
    const unsigned char* buffer;
    size_t size;
    if (IoTHubMessage_GetByteArray(message, &buffer, &size) != IOTHUB_MESSAGE_OK)
    {
        printf("unable to IoTHubMessage_GetByteArray\r\n");
        result = EXECUTE_COMMAND_ERROR;
    }
    else
    {
        /*buffer is not zero terminated*/
        char* temp = malloc(size + 1);
        if (temp == NULL)
        {
            printf("failed to malloc\r\n");
            result = EXECUTE_COMMAND_ERROR;
        }
        else
        {
            memcpy(temp, buffer, size);
            temp[size] = '\0';
            EXECUTE_COMMAND_RESULT executeCommandResult = EXECUTE_COMMAND(userContextCallback, temp);
            result =
                (executeCommandResult == EXECUTE_COMMAND_ERROR) ? IOTHUBMESSAGE_ABANDONED :
                (executeCommandResult == EXECUTE_COMMAND_SUCCESS) ? IOTHUBMESSAGE_ACCEPTED :
                IOTHUBMESSAGE_REJECTED;
            free(temp);
        }
    }
    return result;
}
```

Αυτός ο κωδικός είναι στερεότυπο--είναι το ίδιο για οποιαδήποτε λύση. Αυτή η συνάρτηση λαμβάνει το μήνυμα και αναλαμβάνει δρομολογήσετε της κατάλληλης συνάρτησης μέσω της κλήσης στο **EXECUTE\_ΕΝΤΟΛΉ**. Η συνάρτηση που ονομάζεται εξαρτάται σε αυτό το σημείο από τον ορισμό των ενεργειών στο μοντέλο μας.

Όταν ορίζετε μια ενέργεια στο μοντέλο σας, θα πρέπει να υλοποιήσετε μια συνάρτηση που ονομάζεται όταν τη συσκευή σας λαμβάνει το αντίστοιχο μήνυμα. Για παράδειγμα, εάν το μοντέλο ορίζει αυτήν την ενέργεια:

```
WITH_ACTION(SetAirResistance, int, Position)
```

Πρέπει να καθορίσετε μια συνάρτηση με αυτήν την υπογραφή:

```
EXECUTE_COMMAND_RESULT SetAirResistance(ContosoAnemometer* device, int Position)
{
    (void)device;
    (void)printf("Setting Air Resistance Position to %d.\r\n", Position);
    return EXECUTE_COMMAND_SUCCESS;
}
```

Σημειώστε ότι το όνομα της συνάρτησης συμφωνεί με το όνομα της ενέργειας του μοντέλου και ότι οι παράμετροι της συνάρτησης ταιριάζουν με τις παραμέτρους που έχουν καθοριστεί για την ενέργεια. Η πρώτη παράμετρος πάντα απαιτείται και περιέχει ένα δείκτη για να την παρουσία του μοντέλου μας.

Όταν η συσκευή λάβει ένα μήνυμα που να ταιριάζει με αυτήν την υπογραφή, η αντίστοιχη λειτουργία ονομάζεται. Επομένως, εκτός από χρειάζεται να συμπεριλάβετε τον κωδικό στερεότυπο από **IoTHubMessage**, λήψη μηνυμάτων είναι απλώς θέμα καθορίζει μια απλή συνάρτηση για κάθε ενέργεια που ορίζονται στο μοντέλο σας.

### <a name="uninitializing-the-library"></a>Κατάργηση προετοιμασίας στη βιβλιοθήκη

Όταν ολοκληρώσετε τη διαδικασία δεδομένων αποστολή και λήψη μηνυμάτων, μπορείτε να αναίρεσης προετοιμασίας στη βιβλιοθήκη IoT:

```
        DESTROY_MODEL_INSTANCE(myWeather);
    }
    IoTHubClient_Destroy(iotHubClientHandle);
}
serializer_deinit();
```

Κάθε μία από αυτές τις τρεις λειτουργίες Στοιχίζει με τις τρεις λειτουργίες προετοιμασίας που περιγράφονται προηγουμένως. Κλήση αυτά τα API εξασφαλίζει ότι δωρεάν προηγουμένως εκχωρημένων πόρων.

## <a name="next-steps"></a>Επόμενα βήματα

Σε αυτό το άρθρο, καλύπτονται τα βασικά στοιχεία της χρήσης των βιβλιοθηκών στη **συσκευή Azure IoT SDK για C**. Που παρέχεται με αρκετές πληροφορίες για να κατανοήσετε τι περιλαμβάνεται στο SDK, την αρχιτεκτονική και πώς μπορείτε να ξεκινήσετε την εργασία με τα δείγματα των Windows. Το επόμενο άρθρο συνεχίζεται η περιγραφή του SDK εξηγώντας [περισσότερα σχετικά με τη βιβλιοθήκη IoTHubClient](iot-hub-device-sdk-c-iothubclient.md).

Για να μάθετε περισσότερα σχετικά με την ανάπτυξη IoT διανομέα, ανατρέξτε στο θέμα το [SDK διανομέα IoT][lnk-sdks].

Για να εξερευνήσετε περαιτέρω τις δυνατότητες του IoT διανομέα, ανατρέξτε στα θέματα:

- [Προσομοίωση μια συσκευή με το SDK IoT πύλης][lnk-gateway]


[lnk-file upload]: iot-hub-csharp-csharp-file-upload.md
[lnk-create-hub]: iot-hub-rm-template-powershell.md
[lnk-c-sdk]: iot-hub-device-sdk-c-intro.md
[lnk-sdks]: iot-hub-devguide-sdks.md

[lnk-gateway]: iot-hub-linux-gateway-sdk-simulated-device.md
