<properties 
    pageTitle="Πώς να χρησιμοποιείτε ουρές Bus υπηρεσίας στο Node.js | Microsoft Azure" 
    description="Μάθετε πώς μπορείτε να χρησιμοποιήσετε ουρές Bus υπηρεσίας στο Azure από μια εφαρμογή Node.js." 
    services="service-bus" 
    documentationCenter="nodejs" 
    authors="sethmanheim" 
    manager="timlt" 
    editor=""/>

<tags 
    ms.service="service-bus" 
    ms.workload="tbd" 
    ms.tgt_pltfrm="na" 
    ms.devlang="nodejs" 
    ms.topic="article" 
    ms.date="10/03/2016" 
    ms.author="sethm"/>

# <a name="how-to-use-service-bus-queues"></a>Πώς μπορείτε να χρησιμοποιήσετε ουρές Bus υπηρεσίας

[AZURE.INCLUDE [service-bus-selector-queues](../../includes/service-bus-selector-queues.md)]

Σε αυτό το άρθρο περιγράφει τον τρόπο χρήσης της υπηρεσίας Bus ουρές στο Node.js. Τα δείγματα είναι γραμμένες σε JavaScript και να χρησιμοποιήσετε τη λειτουργική μονάδα Node.js Azure. Τα σενάρια καλύπτεται περιλαμβάνουν **τη δημιουργία ουρές**, **Αποστολή και λήψη μηνυμάτων**και **τη διαγραφή ουρές**. Για περισσότερες πληροφορίες σχετικά με ουρές, ανατρέξτε στην ενότητα [επόμενα βήματα](#next-steps) .

[AZURE.INCLUDE [howto-service-bus-queues](../../includes/howto-service-bus-queues.md)]

## <a name="create-a-nodejs-application"></a>Δημιουργία μιας εφαρμογής Node.js

Δημιουργήστε μια κενή εφαρμογή Node.js. Για οδηγίες σχετικά με τον τρόπο για να δημιουργήσετε μια εφαρμογή Node.js, ανατρέξτε στο θέμα [Δημιουργία και ανάπτυξη μιας εφαρμογής Node.js σε μια τοποθεσία Web Azure][], ή μια [Υπηρεσία Cloud Node.js][] χρησιμοποιώντας το Windows PowerShell.

## <a name="configure-your-application-to-use-service-bus"></a>Ρύθμιση των παραμέτρων σας εφαρμογής για να χρησιμοποιήσετε Bus υπηρεσίας

Για να χρησιμοποιήσετε Bus υπηρεσίας Azure, κάντε λήψη και χρήση του πακέτου Node.js Azure. Αυτό το πακέτο περιλαμβάνει ένα σύνολο των βιβλιοθηκών που επικοινωνία με τις υπηρεσίες ΥΠΌΛΟΙΠΑ Bus υπηρεσίας.

### <a name="use-node-package-manager-npm-to-obtain-the-package"></a>Χρήση διαχείρισης πακέτου κόμβου (NPM) για να αποκτήσετε το πακέτο

1. Χρησιμοποιήστε το παράθυρο εντολών **Του Windows PowerShell για Node.js** για να περιηγηθείτε το **c:\\κόμβου\\sbqueues\\WebRole1** φακέλου στο οποίο δημιουργήσατε το δείγμα εφαρμογής.

2. Πληκτρολογήστε **npm εγκατάσταση azure** στο παράθυρο εντολών, το οποίο θα πρέπει να έχει ως αποτέλεσμα εξόδου παρόμοια με τα εξής:

    ```
    azure@0.7.5 node_modules\azure
        ├── dateformat@1.0.2-1.2.3
        ├── xmlbuilder@0.4.2
        ├── node-uuid@1.2.0
        ├── mime@1.2.9
        ├── underscore@1.4.4
        ├── validator@1.1.1
        ├── tunnel@0.0.2
        ├── wns@0.5.3
        ├── xml2js@0.2.7 (sax@0.5.2)
        └── request@2.21.0 (json-stringify-safe@4.0.0, forever-agent@0.5.0, aws-sign@0.3.0, tunnel-agent@0.3.0, oauth-sign@0.3.0, qs@0.6.5, cookie-jar@0.3.0, node-uuid@1.4.0, http-signature@0.9.11, form-data@0.0.8, hawk@0.13.1)
    ```

3. Μπορείτε να εκτελέσετε με μη αυτόματο τρόπο την εντολή **ls** για να επιβεβαιώσετε ότι ένα **κόμβου\_λειτουργικές μονάδες** που δημιουργήθηκε το φάκελο. Μέσα σε αυτόν το φάκελο, βρείτε το πακέτο **azure** , η οποία περιέχει τις βιβλιοθήκες που πρέπει να έχουν πρόσβαση ουρές Bus υπηρεσίας.

### <a name="import-the-module"></a>Εισαγωγή της λειτουργικής μονάδας

Χρησιμοποιείτε το Σημειωματάριο ή κάποιο άλλο πρόγραμμα επεξεργασίας κειμένου, προσθέστε τα ακόλουθα στο επάνω μέρος του αρχείου **server.js** της εφαρμογής:

```
var azure = require('azure');
```

### <a name="set-up-an-azure-service-bus-connection"></a>Ρύθμιση σύνδεσης Bus υπηρεσίας Azure

Η λειτουργική μονάδα Azure διαβάζει τις μεταβλητές περιβάλλοντος AZURE\_SERVICEBUS\_χώρο ΟΝΟΜΆΤΩΝ και AZURE\_SERVICEBUS\_ACCESS\_ΚΛΕΙΔΊ για να λάβετε τις πληροφορίες που απαιτούνται για σύνδεση σε υπηρεσία Bus. Εάν δεν έχουν οριστεί αυτές τις μεταβλητές περιβάλλοντος, πρέπει να καθορίσετε τις πληροφορίες λογαριασμού κατά την κλήση **createServiceBusService**.

Για ένα παράδειγμα της ρύθμισης των μεταβλητών περιβάλλοντος σε ένα αρχείο ρύθμισης παραμέτρων για μια υπηρεσία Cloud Azure, ανατρέξτε στο θέμα [Node.js υπηρεσία Cloud με το χώρο αποθήκευσης][].

Ένα παράδειγμα για τη ρύθμιση των μεταβλητών περιβάλλοντος στην [πύλη του Azure κλασική][] για μια τοποθεσία Web του Azure, ανατρέξτε στο θέμα [Node.js εφαρμογής Web με το χώρο αποθήκευσης][].

## <a name="create-a-queue"></a>Δημιουργία ουράς

Το αντικείμενο **ServiceBusService** σάς επιτρέπει να εργαστείτε με ουρές Bus υπηρεσίας. Ο ακόλουθος κώδικας δημιουργεί ένα αντικείμενο **ServiceBusService** . Προσθέστε την κοντά στο επάνω μέρος του αρχείου **server.js** , μετά την πρόταση για να εισαγάγετε τη λειτουργική μονάδα Azure:

```
var serviceBusService = azure.createServiceBusService();
```

Καλώντας την **createQueueIfNotExists** στο αντικείμενο **ServiceBusService** , επιστρέφεται η καθορισμένη ουρά (εάν υπάρχει) ή δημιουργείται μια νέα ουρά με το καθορισμένο όνομα. Ο ακόλουθος κώδικας χρησιμοποιεί **createQueueIfNotExists** για να δημιουργήσετε ή να συνδεθείτε στην ουρά με το όνομα `myqueue`:

```
serviceBusService.createQueueIfNotExists('myqueue', function(error){
    if(!error){
        // Queue exists
    }
});
```

**createServiceBusService** υποστηρίζει επίσης πρόσθετες επιλογές, οι οποίες σας επιτρέπουν να Παράκαμψη προεπιλεγμένων ρυθμίσεων ουρά όπως χρόνο μήνυμα ουρά live ή μέγιστο μέγεθος. Το παρακάτω παράδειγμα ρυθμίζει το μέγεθος της μέγιστο ουρά 5 GB και μια ώρα με live (TTL) τιμή του 1 λεπτό:

```
var queueOptions = {
      MaxSizeInMegabytes: '5120',
      DefaultMessageTimeToLive: 'PT1M'
    };

serviceBusService.createQueueIfNotExists('myqueue', queueOptions, function(error){
    if(!error){
        // Queue exists
    }
});
```

### <a name="filters"></a>Φίλτρα

Προαιρετικό λειτουργίες φιλτραρίσματος μπορούν να εφαρμοστούν σε διάφορες λειτουργίες που εκτελούνται με χρήση **ServiceBusService**. Φιλτράρισμα λειτουργίες μπορούν να περιλαμβάνουν καταγραφής, αυτόματη επανάληψη, κ.λπ. Φίλτρα είναι αντικείμενα τα οποία υλοποίηση της μεθόδου με την υπογραφή:

```
function handle (requestOptions, next)
```

Μετά την εκτέλεση τις προ-επεξεργασία σχετικά με τις επιλογές αίτηση, πρέπει να καλέσετε τη μέθοδο `next`, που περνά μέσα επιστροφή κλήσης με την υπογραφή παρακάτω:

```
function (returnObject, finalCallback, next)
```

Με αυτήν την επιστροφή κλήσης, και μετά την επεξεργασία του **returnObject** (απάντηση από την αίτηση στο διακομιστή), είτε πρέπει να καλέσετε την επιστροφή κλήσης `next` εάν υπάρχει για να συνεχίσετε την επεξεργασία τα άλλα φίλτρα ή απλώς κλήση `finalCallback`, που τελειώνει το Ενεργοποίηση υπηρεσίας.

Με το Azure SDK για Node.js, **ExponentialRetryPolicyFilter** και **LinearRetryPolicyFilter**περιλαμβάνονται δύο φίλτρα που υλοποίηση της λογικής "Επανάληψη". Το ακόλουθο παράδειγμα δημιουργεί ένα αντικείμενο **ServiceBusService** που χρησιμοποιεί το **ExponentialRetryPolicyFilter**:

```
var retryOperations = new azure.ExponentialRetryPolicyFilter();
var serviceBusService = azure.createServiceBusService().withFilter(retryOperations);
```

## <a name="send-messages-to-a-queue"></a>Αποστολή μηνυμάτων σε μια ουρά

Για να στείλετε ένα μήνυμα σε ουρά Bus υπηρεσίας, η εφαρμογή σας καλεί τη μέθοδο **sendQueueMessage** στο αντικείμενο **ServiceBusService** . Μηνύματα ουρές Bus υπηρεσία αποστολής για να (και λήψης από) είναι **BrokeredMessage** αντικείμενα και έχουν ένα σύνολο τυπικές ιδιότητες (όπως **ετικέτα** και **το TimeToLive**), ένα λεξικό που χρησιμοποιείται για τη διατήρηση προσαρμοσμένες ιδιότητες συγκεκριμένη εφαρμογή, και ένα κύριο σώμα των δεδομένων αυθαίρετο εφαρμογής. Μια εφαρμογή να ορίσετε το σώμα του μηνύματος, μεταφέροντας μια συμβολοσειρά με το μήνυμα. Τις απαιτούμενες ιδιότητες τυπική συμπληρώνονται με προεπιλεγμένες τιμές.

Το παρακάτω παράδειγμα παρουσιάζει πώς μπορείτε να στείλετε ένα δοκιμαστικό μήνυμα στην ουρά με το όνομα `myqueue` χρησιμοποιώντας **sendQueueMessage**:

```
var message = {
    body: 'Test message',
    customProperties: {
        testproperty: 'TestValue'
    }};
serviceBusService.sendQueueMessage('myqueue', message, function(error){
    if(!error){
        // message sent
    }
});
```

Υπηρεσία Bus ουρές υποστηρίζουν μέγιστο μέγεθος αρχείου των 256 KB η [τυπική σειρά](service-bus-premium-messaging.md) και 1 MB στο [επίπεδο Premium](service-bus-premium-messaging.md). Την επικεφαλίδα, η οποία περιλαμβάνει τις ιδιότητες τυπικών και προσαρμοσμένων εφαρμογών, μπορεί να έχει ένα μέγιστο μέγεθος των 64 KB. Υπάρχει όριο στον αριθμό των μηνυμάτων που θα διατηρούνται σε ουρά, αλλά υπάρχει μια καπέλο το συνολικό μέγεθος των μηνυμάτων που διαθέτει μια ουρά. Αυτό το μέγεθος ουρά ορίζεται κατά τη δημιουργία, με ένα ανώτερο όριο των 5 GB. Για περισσότερες πληροφορίες σχετικά με τα όρια, ανατρέξτε στο θέμα [όρια Bus υπηρεσίας][].

## <a name="receive-messages-from-a-queue"></a>Λήψη μηνυμάτων από μια ουρά

Λήψη των μηνυμάτων από μια ουρά χρησιμοποιώντας τη μέθοδο **receiveQueueMessage** στο αντικείμενο **ServiceBusService** . Από προεπιλογή, τα μηνύματα διαγράφονται από την ουρά όπως διαβάζονται; Ωστόσο, μπορείτε να διαβάσετε (σύνοψη) και να κλειδώσετε το μήνυμα χωρίς να το διαγράψετε από την ουρά, ορίζοντας την προαιρετική παράμετρος **isPeekLock** στην **τιμή true**.

Η προεπιλεγμένη συμπεριφορά της ανάγνωσης και τη διαγραφή του μηνύματος ως μέρος του η λειτουργία λήψης είναι απλούστερο μοντέλο και λειτουργεί καλύτερα για σενάρια στις οποίες μια εφαρμογή μπορεί να αποδεχτεί τις δεν επεξεργασία ενός μηνύματος σε περίπτωση αποτυχίας. Για να κατανοήσετε αυτήν, εξετάστε το ενδεχόμενο να ένα σενάριο που ζητήματα της αίτησης λήψης του καταναλωτή και, στη συνέχεια, παρουσιάζει σφάλμα πριν από την επεξεργασία του. Επειδή η υπηρεσία Bus θα έχουν σήμανση του μηνύματος ως που καταναλώνεται, στη συνέχεια, όταν η εφαρμογή επανεκκίνηση του και αρχίζει κατανάλωση ξανά τα μηνύματα, το θα έχετε παραβλέψει το μήνυμα που καταναλώθηκε πριν από το σφάλμα.

Εάν η παράμετρος **isPeekLock** έχει οριστεί στην **τιμή true**, η λήψη γίνεται μια λειτουργία δύο στάδιο, γεγονός που επιτρέπει σε εφαρμογές υποστήριξης που δεν θέλετε να γίνει μηνύματα που λείπουν. Όταν Bus υπηρεσία λαμβάνει μια αίτηση, βρίσκει στο επόμενο μήνυμα να καταναλωθεί, κλειδώνει για να αποτρέψετε άλλους καταναλωτές πραγματοποιεί λήψη του και, στη συνέχεια, επιστρέφει το στην εφαρμογή. Μετά την εφαρμογή ολοκληρώσει την επεξεργασία του μηνύματος (ή αποθηκεύει αξιόπιστα για μελλοντική επεξεργασία), ολοκληρώνει δεύτερου σταδίου της διαδικασίας παραλαβής κλήση μεθόδου **deleteMessage** και παρέχοντας το μήνυμα που θα διαγραφεί ως παράμετρο. Η μέθοδος **deleteMessage** θα επισημάνετε το μήνυμα ως που καταναλώνεται και να την καταργήσετε από την ουρά.

Το παρακάτω παράδειγμα παρουσιάζει πώς μπορείτε να λαμβάνει και να επεξεργάζεται μηνύματα χρησιμοποιώντας το **receiveQueueMessage**. Το παράδειγμα πρώτα λαμβάνει και διαγράφει ένα μήνυμα, και, στη συνέχεια, θα λάβει ένα μήνυμα με χρήση **isPeekLock** οριστεί στην **τιμή true**, στη συνέχεια, διαγράφει το μήνυμα με χρήση **deleteMessage**:

```
serviceBusService.receiveQueueMessage('myqueue', function(error, receivedMessage){
    if(!error){
        // Message received and deleted
    }
});
serviceBusService.receiveQueueMessage('myqueue', { isPeekLock: true }, function(error, lockedMessage){
    if(!error){
        // Message received and locked
        serviceBusService.deleteMessage(lockedMessage, function (deleteError){
            if(!deleteError){
                // Message deleted
            }
        });
    }
});
```

## <a name="how-to-handle-application-crashes-and-unreadable-messages"></a>Πώς να χειριστείτε σφάλματα εφαρμογών και αναγνώσιμα μηνύματα

Υπηρεσία Bus παρέχει λειτουργικότητα που θα σας βοηθήσουν να ανακτήσετε ομαλά από σφάλματα στο εφαρμογής ή δυσκολίες επεξεργασία ενός μηνύματος. Εάν μια εφαρμογή ακουστικό είναι δυνατή η επεξεργασία του μηνύματος για κάποιο λόγο, στη συνέχεια, το να καλέσετε τη μέθοδο **unlockMessage** στο αντικείμενο **ServiceBusService** . Αυτό θα προκαλέσει Bus υπηρεσίας για να ξεκλειδώσετε το μήνυμα μέσα στην ουρά και να την κάνετε διαθέσιμη θα ληφθεί ξανά, με την ίδια εφαρμογή καταναλώνει ή από άλλη εφαρμογή καταναλώνει.

Υπάρχει επίσης ένα χρονικό όριο που σχετίζεται με ένα μήνυμα κλειδωμένο μέσα στην ουρά και, εάν η εφαρμογή δεν μπορεί να επεξεργαστεί το μήνυμα πριν από την κλείδωμα λήξει το χρονικό όριο (π.χ., εάν η εφαρμογή παρουσιάζει σφάλμα), στη συνέχεια, υπηρεσία Bus θα ξεκλειδώσετε αυτόματα το μήνυμα και να την κάνετε διαθέσιμη θα ληφθεί ξανά.

Σε περίπτωση που η εφαρμογή παρουσιάζει σφάλμα μετά την επεξεργασία του μηνύματος, αλλά πριν από την κλήση της μεθόδου **deleteMessage** , στη συνέχεια, το μήνυμα θα είναι redelivered στην εφαρμογή κατά την επανεκκίνηση. Συχνά αυτό ονομάζεται **Τουλάχιστον αφού επεξεργασίας**, αυτό σημαίνει ότι θα υποβληθούν τουλάχιστον μία φορά σε κάθε μήνυμα αλλά σε ορισμένες περιπτώσεις ίσως redelivered το ίδιο μήνυμα. Εάν το σενάριο δεν θέλετε να γίνει διπλότυπων επεξεργασίας, στη συνέχεια, προγραμματιστές εφαρμογών πρέπει να Προσθήκη επιπλέον λογικής σε εφαρμογή τους χειρισμού διπλότυπων μήνυμα παράδοσης. Συχνά, αυτό είναι δυνατό χρησιμοποιώντας την ιδιότητα **αναγνωριστικού μηνύματος** του μηνύματος, η οποία θα παραμένει σταθερή κατά μήκος προσπαθειών παράδοσης.

## <a name="next-steps"></a>Επόμενα βήματα

Για να μάθετε περισσότερα σχετικά με ουρές, ανατρέξτε στους ακόλουθους πόρους.

-   [Ουρές, θέματα και συνδρομών][]
-   Αρχείο φύλαξης [Azure SDK για κόμβο][] στο GitHub
-   [Κέντρο για προγραμματιστές του node.js](/develop/nodejs/)

  [Azure SDK για κόμβου]: https://github.com/Azure/azure-sdk-for-node
  [Azure κλασική πύλη]: http://manage.windowsazure.com
  
  [Υπηρεσία node.js Cloud]: ../cloud-services/cloud-services-nodejs-develop-deploy-app.md
  [Ουρές, θέματα και συνδρομών]: service-bus-queues-topics-subscriptions.md
  [Δημιουργία και ανάπτυξη μιας εφαρμογής Node.js σε μια τοποθεσία Web του Azure]: ../app-service-web/web-sites-nodejs-develop-deploy-mac.md
  [Υπηρεσία node.js Cloud με το χώρο αποθήκευσης]: ../cloud-services/storage-nodejs-use-table-storage-cloud-service-app.md
  [Εφαρμογή node.js Web με χώρου αποθήκευσης]: ../storage/storage-nodejs-how-to-use-table-storage.md
  [Υπηρεσία Bus ορίων]: service-bus-quotas.md
 
